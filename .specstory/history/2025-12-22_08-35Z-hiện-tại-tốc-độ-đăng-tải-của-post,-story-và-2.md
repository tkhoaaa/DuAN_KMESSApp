<!-- Generated by SpecStory, Markdown v2.1.0 -->

<!-- cursor Session 79f84c57-19d5-4cf3-9fb7-9a5f6017b9c8 (2025-12-22 08:35Z) -->

# Hiện tại tốc độ đăng tải của post, story và (2025-12-22 08:35Z)

_**User (2025-12-22 08:33Z)**_

Khi không có story vẫn có chức năng xem ảnh đại diện và hêm hiệu ứng Hero từ avatar trên profile sang màn hình fullscreen

---

_**Agent (model claude-4.5-opus-high-thinking, mode Agent)**_

<think><details><summary>Thought Process</summary>
**Ensuring hero functionality**

I need to make sure the hero works even if it's not being navigated through the AvatarFullscreenViewer from the story sheet. Hmm, since the navigation is actually pushing that widget, that's a good sign. It looks like I’ll need to update the code, so I’ll run some tools to modify it as needed. Let’s keep things running smoothly!</details></think>

---

Tôi sẽ cho option “Xem ảnh đại diện” xuất hiện cả khi không có story và thêm Hero quanh avatar trên profile để chạy animation sang màn hình xem full.

---

<tool-use data-tool-type="unknown" data-tool-name="apply_patch">
<details>
<summary>Tool use: **apply_patch**</summary>


Parameters:

```json
{
  "relativeWorkspacePath": "lib/features/profile/profile_screen.dart"
}
```
Additional data:

```json
{
  "codeblockId": "3ac864ca-1b64-4f7b-bb5d-b4aed4ec895c",
  "codeblock": {
    "uri": {
      "scheme": "file",
      "authority": "",
      "path": "/c:/Users/Admin/StudioProjects/duan_kmessapp/lib/features/profile/profile_screen.dart",
      "query": "",
      "fragment": "",
      "_formatted": "file:///c%3A/Users/Admin/StudioProjects/duan_kmessapp/lib/features/profile/profile_screen.dart",
      "_fsPath": null
    },
    "codeblockId": "3ac864ca-1b64-4f7b-bb5d-b4aed4ec895c",
    "codeBlockIdx": 0,
    "content": "import 'dart:async';\nimport 'dart:io';\n\nimport 'package:firebase_storage/firebase_storage.dart';\nimport 'package:flutter/foundation.dart';\nimport 'package:flutter/material.dart';\nimport 'package:image_picker/image_picker.dart';\n\nimport 'user_profile_repository.dart';\nimport '../admin/pages/admin_dashboard_page.dart';\nimport '../admin/repositories/admin_repository.dart';\nimport 'package:firebase_auth/firebase_auth.dart';\n\nimport '../auth/auth_gate.dart';\nimport '../auth/auth_repository.dart';\nimport '../auth/login_screen.dart';\nimport '../auth/saved_accounts_repository.dart';\nimport '../auth/saved_credentials_repository.dart';\nimport '../follow/services/follow_service.dart';\nimport '../../services/cloudinary_service.dart';\nimport '../saved_posts/pages/saved_posts_page.dart';\nimport '../settings/pages/privacy_settings_page.dart';\nimport '../auth/pages/change_password_page.dart';\nimport '../stories/pages/story_create_page.dart';\nimport '../stories/pages/story_viewer_page.dart';\nimport '../stories/repositories/story_repository.dart';\nimport '../stories/models/story.dart';\nimport '../posts/pages/post_create_page.dart';\nimport '../posts/pages/post_permalink_page.dart';\nimport '../posts/repositories/post_repository.dart';\nimport '../posts/models/post.dart';\nimport 'widgets/profile_posts_widgets.dart';\nimport 'widgets/avatar_fullscreen_viewer.dart';\nimport 'pages/manage_highlight_stories_page.dart';\nimport '../../theme/colors.dart';\n\nenum _ProfileMenuAction {\n  personalInfo,\n  privacySettings,\n  privateAccount,\n  highlightStories,\n  savedPosts,\n  changePassword,\n  adminDashboard,\n  logout,\n}\n\nenum _LogoutChoice {\n  saveAndSignOut,\n  signOutOnly,\n}\n\nenum _CreateAction { story, post }\nenum _AccountMenuAction { switchAccount, logout }\n\nclass ProfileScreen extends StatefulWidget {\n  const ProfileScreen({super.key});\n\n  @override\n  State&lt;ProfileScreen&gt; createState() =&gt; _ProfileScreenState();\n}\n\nclass _ProfileScreenState extends State&lt;ProfileScreen&gt; {\n  final TextEditingController displayNameController = TextEditingController();\n  final TextEditingController photoUrlController = TextEditingController();\n  final TextEditingController bioController = TextEditingController();\n  final TextEditingController noteController = TextEditingController();\n  final ImagePicker _picker = ImagePicker();\n  final AdminRepository _adminRepository = AdminRepository();\n  final PostRepository _postRepository = PostRepository();\n  bool isSaving = false;\n  bool isUploading = false;\n  bool _loadedInitial = false;\n  bool _isPrivate = false;\n  String? _themeColor;\n  List&lt;ProfileLink&gt; _links = [];\n  bool _isAdmin = false;\n  late final FollowService _followService;\n  List&lt;Post&gt; _pinnedPosts = [];\n  List&lt;Post&gt; _allPosts = [];\n  bool _isLoadingPosts = false;\n\n  @override\n  void initState() {\n    super.initState();\n    _followService = FollowService();\n    _checkAdminStatus();\n    _loadPinnedPosts();\n    _loadAllPosts();\n  }\n\n  Future&lt;void&gt; _loadPinnedPosts() async {\n    try {\n      final user = authRepository.currentUser();\n      if (user == null) return;\n      final profile = await userProfileRepository.fetchProfile(user.uid);\n      if (profile == null || profile.pinnedPostIds.isEmpty) {\n        if (mounted) {\n          setState(() {\n            _pinnedPosts = [];\n          });\n        }\n        return;\n      }\n\n      final posts = &lt;Post&gt;[];\n      for (final postId in profile.pinnedPostIds) {\n        try {\n          final post = await _postRepository.watchPost(postId).first;\n          posts.add(post);\n        } catch (_) {\n          continue;\n        }\n      }\n\n      if (mounted) {\n        setState(() {\n          _pinnedPosts = posts;\n        });\n      }\n    } catch (_) {\n      // ignore\n    }\n  }\n\n  Future&lt;void&gt; _loadAllPosts() async {\n    final user = authRepository.currentUser();\n    if (user == null) return;\n\n    setState(() {\n      _isLoadingPosts = true;\n    });\n\n    try {\n      final pageResult = await _postRepository.fetchPostsByAuthor(\n        authorUid: user.uid,\n        limit: 50,\n      );\n\n      final posts = pageResult.docs.map((doc) =&gt; Post.fromDoc(doc)).toList();\n\n      if (mounted) {\n        setState(() {\n          _allPosts = posts;\n          _isLoadingPosts = false;\n        });\n      }\n    } catch (_) {\n      if (mounted) {\n        setState(() {\n          _isLoadingPosts = false;\n        });\n      }\n    }\n  }\n\n  Future&lt;void&gt; _checkAdminStatus() async {\n    final user = authRepository.currentUser();\n    if (user != null) {\n      final isAdmin = await _adminRepository.isAdmin(user.uid);\n      if (mounted) {\n        setState(() {\n          _isAdmin = isAdmin;\n        });\n      }\n    }\n  }\n\n  @override\n  void dispose() {\n    displayNameController.dispose();\n    photoUrlController.dispose();\n    bioController.dispose();\n    noteController.dispose();\n    super.dispose();\n  }\n\n  Future&lt;void&gt; _saveProfile(String uid) async {\n    setState(() {\n      isSaving = true;\n    });\n    try {\n      await userProfileRepository.updateProfile(\n        uid,\n        displayName: displayNameController.text.trim(),\n        photoUrl: photoUrlController.text.trim().isEmpty\n            ? null\n            : photoUrlController.text.trim(),\n        removePhoto: photoUrlController.text.trim().isEmpty,\n        bio: bioController.text.trim(),\n        note: noteController.text.trim(),\n        isPrivate: _isPrivate,\n        themeColor: _themeColor,\n        links: _links,\n      );\n      _loadedInitial = false;\n      if (!mounted) return;\n      ScaffoldMessenger.of(context).showSnackBar(\n        const SnackBar(content: Text('Đã cập nhật hồ sơ.')),\n      );\n    } catch (e) {\n      if (!mounted) return;\n      ScaffoldMessenger.of(context).showSnackBar(\n        SnackBar(content: Text('Lỗi cập nhật: $e')),\n      );\n    } finally {\n      if (mounted) {\n        setState(() {\n          isSaving = false;\n        });\n      }\n    }\n  }\n\n  /// Chọn storage backend: 'firebase' hoặc 'cloudinary'\n  /// Phải khớp với PostService.storageBackend\n  static const String storageBackend = 'cloudinary'; // Thay đổi thành 'firebase' nếu muốn dùng Firebase Storage\n\n  Future&lt;void&gt; _pickAndUploadImage(String uid, ImageSource source) async {\n    setState(() {\n      isUploading = true;\n    });\n    try {\n      final XFile? picked = await _picker.pickImage(\n        source: source,\n        maxWidth: 1024,\n        imageQuality: 85,\n      );\n      if (picked == null) {\n        setState(() {\n          isUploading = false;\n        });\n        return;\n      }\n\n      String url;\n      \n      if (storageBackend == 'cloudinary') {\n        // Dùng Cloudinary\n        final result = await CloudinaryService.uploadImage(\n          file: picked,\n          folder: 'user_profiles/$uid',\n          publicId: 'avatar',\n        );\n        url = result['url']!;\n      } else {\n        // Dùng Firebase Storage (code cũ)\n        final storageRef =\n            FirebaseStorage.instance.ref().child('user_profiles/$uid/avatar.jpg');\n\n        if (kIsWeb) {\n          final bytes = await picked.readAsBytes();\n          await storageRef.putData(\n            bytes,\n            SettableMetadata(contentType: picked.mimeType ?? 'image/jpeg'),\n          );\n        } else {\n          final file = File(picked.path);\n          await storageRef.putFile(\n            file,\n            SettableMetadata(contentType: 'image/jpeg'),\n          );\n        }\n\n        url = await storageRef.getDownloadURL();\n      }\n\n      await userProfileRepository.updateProfile(uid, photoUrl: url);\n      _loadedInitial = false;\n      if (mounted) {\n        photoUrlController.text = url;\n        ScaffoldMessenger.of(context).showSnackBar(\n          const SnackBar(content: Text('Đã cập nhật ảnh đại diện.')),\n        );\n      }\n    } catch (e) {\n      if (mounted) {\n        ScaffoldMessenger.of(context).showSnackBar(\n          SnackBar(content: Text('Lỗi tải ảnh: $e')),\n        );\n      }\n    } finally {\n      if (mounted) {\n        setState(() {\n          isUploading = false;\n        });\n      }\n    }\n  }\n\n  Future&lt;void&gt; _removePhoto(String uid) async {\n    setState(() {\n      isUploading = true;\n    });\n    try {\n      await userProfileRepository.updateProfile(\n        uid,\n        photoUrl: '',\n        removePhoto: true,\n      );\n      _loadedInitial = false;\n      if (mounted) {\n        photoUrlController.clear();\n        ScaffoldMessenger.of(context).showSnackBar(\n          const SnackBar(content: Text('Đã xoá ảnh đại diện.')),\n        );\n      }\n    } catch (e) {\n      if (mounted) {\n        ScaffoldMessenger.of(context).showSnackBar(\n          SnackBar(content: Text('Không thể xoá ảnh: $e')),\n        );\n      }\n    } finally {\n      if (mounted) {\n        setState(() {\n          isUploading = false;\n        });\n      }\n    }\n  }\n\n  Future&lt;void&gt; _showCreateChooser() async {\n    final action = await showModalBottomSheet&lt;_CreateAction&gt;(\n      context: context,\n      builder: (context) =&gt; SafeArea(\n        child: Column(\n          mainAxisSize: MainAxisSize.min,\n          children: [\n            ListTile(\n              leading: const Icon(Icons.history_edu),\n              title: const Text('Đăng story'),\n              onTap: () =&gt; Navigator.pop(context, _CreateAction.story),\n            ),\n            ListTile(\n              leading: const Icon(Icons.add_photo_alternate_outlined),\n              title: const Text('Thêm bài viết'),\n              onTap: () =&gt; Navigator.pop(context, _CreateAction.post),\n            ),\n          ],\n        ),\n      ),\n    );\n\n    if (!mounted || action == null) return;\n    switch (action) {\n      case _CreateAction.story:\n              Navigator.of(context).push(\n          MaterialPageRoute(builder: (_) =&gt; const StoryCreatePage()),\n        );\n        break;\n      case _CreateAction.post:\n              Navigator.of(context).push(\n          MaterialPageRoute(builder: (_) =&gt; const PostCreatePage()),\n        );\n        break;\n    }\n  }\n\n  Future&lt;void&gt; _showAccountMenu() async {\n    final action = await showModalBottomSheet&lt;_AccountMenuAction&gt;(\n      context: context,\n      builder: (context) =&gt; SafeArea(\n        child: Column(\n          mainAxisSize: MainAxisSize.min,\n          children: [\n            ListTile(\n              leading: const Icon(Icons.switch_account),\n              title: const Text('Chuyển tài khoản'),\n              onTap: () =&gt; Navigator.pop(context, _AccountMenuAction.switchAccount),\n            ),\n            ListTile(\n              leading: const Icon(Icons.logout),\n              title: const Text('Đăng xuất'),\n              onTap: () =&gt; Navigator.pop(context, _AccountMenuAction.logout),\n            ),\n          ],\n        ),\n      ),\n    );\n\n    if (!mounted || action == null) return;\n    switch (action) {\n      case _AccountMenuAction.switchAccount:\n        await _showSwitchAccountSheet();\n        break;\n      case _AccountMenuAction.logout:\n        await _confirmLogoutAndMaybeSave(\n          currentUser: authRepository.currentUser(),\n          forSwitchAccount: false,\n        );\n        break;\n    }\n  }\n\n  Future&lt;void&gt; _confirmLogoutAndMaybeSave({\n    User? currentUser,\n    bool forSwitchAccount = false,\n  }) async {\n    final user = currentUser ?? authRepository.currentUser();\n    if (user == null) return;\n\n    final choice = await showDialog&lt;_LogoutChoice&gt;(\n      context: context,\n      builder: (ctx) =&gt; AlertDialog(\n        title: const Text('Đăng xuất'),\n        content: const Text('Bạn có muốn lưu tài khoản này để chuyển đổi nhanh sau này không?'),\n        actions: [\n          TextButton(\n            onPressed: () =&gt; Navigator.pop(ctx, _LogoutChoice.signOutOnly),\n            child: const Text('Đăng xuất'),\n          ),\n          FilledButton(\n            onPressed: () =&gt; Navigator.pop(ctx, _LogoutChoice.saveAndSignOut),\n            child: const Text('Lưu tài khoản'),\n          ),\n        ],\n      ),\n    );\n\n    if (!mounted || choice == null) return;\n\n    if (choice == _LogoutChoice.saveAndSignOut) {\n      await SavedAccountsRepository.instance.saveAccountFromUser(user);\n      ScaffoldMessenger.of(context).showSnackBar(\n        const SnackBar(content: Text('Đã lưu tài khoản trên thiết bị.')),\n      );\n    } else {\n      await SavedAccountsRepository.instance.removeAccount(user.uid);\n      await SavedCredentialsRepository.instance.removePassword(user.uid);\n    }\n\n    await userProfileRepository.setPresence(user.uid, false);\n    // Với flow đăng xuất bình thường: set offline + signOut để quay về màn hình login/AuthGate\n    // Với flow chuyển đổi tài khoản: chỉ set offline, KHÔNG signOut, sẽ signIn tài khoản khác ngay sau đó\n    if (!forSwitchAccount) {\n      await authRepository.signOut();\n    }\n    if (mounted) {\n      Navigator.of(context).pop();\n    }\n  }\n\n  Future&lt;void&gt; _showSwitchAccountSheet() async {\n    final accounts = await SavedAccountsRepository.instance.getAccounts();\n    if (!mounted) return;\n\n    if (accounts.isEmpty) {\n      ScaffoldMessenger.of(context).showSnackBar(\n        const SnackBar(content: Text('Chưa có tài khoản nào được lưu trên thiết bị.')),\n      );\n      return;\n    }\n\n    final selected = await showModalBottomSheet&lt;SavedAccount&gt;(\n      context: context,\n      builder: (ctx) =&gt; SafeArea(\n        child: Column(\n          mainAxisSize: MainAxisSize.min,\n          children: [\n            const ListTile(\n              title: Text(\n                'Chuyển đổi tài khoản',\n                style: TextStyle(fontWeight: FontWeight.bold),\n              ),\n            ),\n            ...accounts.map(\n              (acc) =&gt; ListTile(\n                leading: CircleAvatar(\n                  backgroundImage:\n                      acc.photoUrl != null &amp;&amp; acc.photoUrl!.isNotEmpty ? NetworkImage(acc.photoUrl!) : null,\n                  child: acc.photoUrl == null || acc.photoUrl!.isEmpty\n                      ? const Icon(Icons.person)\n                      : null,\n                ),\n                title: Text(acc.displayName ?? acc.email ?? acc.uid),\n                subtitle: acc.email != null ? Text(acc.email!) : null,\n                onTap: () =&gt; Navigator.pop(ctx, acc),\n              ),\n            ),\n            const SizedBox(height: 8),\n          ],\n        ),\n      ),\n    );\n\n    if (!mounted || selected == null) return;\n\n    // Khi chọn tài khoản khác: hỏi có lưu tài khoản hiện tại không\n    final current = authRepository.currentUser();\n    if (current != null) {\n      await _confirmLogoutAndMaybeSave(\n        currentUser: current,\n        forSwitchAccount: true,\n      );\n    }\n\n    if (!mounted) return;\n\n    // Thử đăng nhập nhanh vào tài khoản đã lưu\n    final quickSuccess = await _quickSignInToSavedAccount(selected);\n\n    if (!mounted) return;\n\n    if (quickSuccess) {\n      // Điều hướng về AuthGate để toàn bộ app rebuild theo user mới\n      Navigator.of(context).pushAndRemoveUntil(\n                MaterialPageRoute(\n          builder: (_) =&gt; const AuthGate(),\n        ),\n        (route) =&gt; false,\n      );\n    } else {\n      // Fallback: chuyển sang màn hình login với email được điền sẵn\n      final identifier = selected.email ?? selected.displayName ?? selected.uid;\n      ScaffoldMessenger.of(context).showSnackBar(\n        const SnackBar(\n          content: Text(\n            'Tài khoản này chưa lưu mật khẩu an toàn. Vui lòng đăng nhập lại một lần.',\n          ),\n        ),\n      );\n      Navigator.of(context).pushAndRemoveUntil(\n                MaterialPageRoute(\n          builder: (_) =&gt; LoginScreen(initialIdentifier: identifier),\n        ),\n        (route) =&gt; false,\n      );\n    }\n  }\n\n  Future&lt;bool&gt; _quickSignInToSavedAccount(SavedAccount account) async {\n    try {\n      // Chỉ hỗ trợ auto-login nhanh cho tài khoản đăng nhập bằng email/mật khẩu\n      if (account.providerId == 'password' &amp;&amp; account.email != null) {\n        final password =\n            await SavedCredentialsRepository.instance.getPassword(account.uid);\n        if (password == null || password.isEmpty) {\n          return false;\n        }\n\n        // SignIn vào tài khoản mới\n        await authRepository.signInWithEmail(account.email!, password);\n\n        // Đợi auth state thay đổi để đảm bảo signIn hoàn tất\n        // Sử dụng Stream để đợi auth state change hoặc timeout sau 3 giây\n        final completer = Completer&lt;bool&gt;();\n        StreamSubscription&lt;User?&gt;? subscription;\n        Timer? timeoutTimer;\n\n        subscription = authRepository.authState().listen((user) {\n          if (user != null &amp;&amp; user.uid == account.uid) {\n            subscription?.cancel();\n            timeoutTimer?.cancel();\n            if (!completer.isCompleted) {\n              completer.complete(true);\n            }\n          }\n        });\n\n        // Timeout sau 3 giây nếu không nhận được auth state change\n        timeoutTimer = Timer(const Duration(seconds: 3), () {\n          subscription?.cancel();\n          final currentUser = authRepository.currentUser();\n          final success = currentUser != null &amp;&amp; currentUser.uid == account.uid;\n          if (!completer.isCompleted) {\n            completer.complete(success);\n          }\n        });\n\n        // Đợi kết quả\n        final result = await completer.future;\n        subscription.cancel();\n        timeoutTimer.cancel();\n\n        return result;\n      }\n      // Các provider khác (Google/Facebook) hiện tại không auto-login để tránh chọn sai account\n      return false;\n    } catch (_) {\n      return false;\n    }\n  }\n\n  /// Hiển thị bottom sheet khi chạm avatar trên trang hồ sơ\n  /// - Nếu người dùng có story (kể cả đã xem hết): thêm hành động \"Xem tin\"\n  /// - Dù có story hay không, luôn có tuỳ chọn \"Xem ảnh đại diện\" (nếu có ảnh)\n  void _handleAvatarTap(String uid, StoryRingStatus ringStatus) {\n    final hasStory = ringStatus != StoryRingStatus.none;\n\n    if (!hasStory) {\n      // Không có story -&gt; dùng sheet ảnh đại diện (vẫn có Xem ảnh đại diện)\n      _showAvatarOptions(uid);\n      return;\n    }\n\n    showModalBottomSheet(\n      context: context,\n      builder: (context) =&gt; SafeArea(\n        child: Column(\n          mainAxisSize: MainAxisSize.min,\n          children: [\n            ListTile(\n              leading: const Icon(Icons.history_edu),\n              title: const Text('Xem tin'),\n              onTap: () {\n                Navigator.pop(context);\n                Navigator.of(context).push(\n                  MaterialPageRoute(\n                    builder: (_) =&gt; StoryViewerPage(\n                      initialAuthorUid: uid,\n                      userIdsWithStories: [uid],\n                    ),\n                  ),\n                );\n              },\n            ),\n            if (photoUrlController.text.isNotEmpty)\n              ListTile(\n                leading: const Icon(Icons.remove_red_eye),\n                title: const Text('Xem ảnh đại diện'),\n                onTap: () {\n                  Navigator.pop(context);\n                  Navigator.of(context).push(\n                    MaterialPageRoute(\n                      builder: (_) =&gt; AvatarFullscreenViewer(\n                        photoUrl: photoUrlController.text,\n                      ),\n                    ),\n                  );\n                },\n              ),\n            ListTile(\n              leading: const Icon(Icons.photo_library),\n              title: const Text('Chọn ảnh từ thư viện'),\n              onTap: () {\n                Navigator.pop(context);\n                _pickAndUploadImage(uid, ImageSource.gallery);\n              },\n            ),\n            ListTile(\n              leading: const Icon(Icons.camera_alt),\n              title: const Text('Chụp ảnh'),\n              onTap: () {\n                Navigator.pop(context);\n                _pickAndUploadImage(uid, ImageSource.camera);\n              },\n            ),\n            if (photoUrlController.text.isNotEmpty)\n              ListTile(\n                leading: const Icon(Icons.delete_outline, color: Colors.red),\n                title: const Text(\n                  'Xoá ảnh đại diện',\n                  style: TextStyle(color: Colors.red),\n                ),\n                onTap: () {\n                  Navigator.pop(context);\n                  _removePhoto(uid);\n                },\n              ),\n          ],\n        ),\n      ),\n    );\n  }\n\n  void _showAvatarOptions(String uid) {\n    showModalBottomSheet(\n      context: context,\n      builder: (context) =&gt; SafeArea(\n        child: Column(\n          mainAxisSize: MainAxisSize.min,\n          children: [\n            if (photoUrlController.text.isNotEmpty)\n              ListTile(\n                leading: const Icon(Icons.remove_red_eye),\n                title: const Text('Xem ảnh đại diện'),\n                onTap: () {\n                  Navigator.pop(context);\n                  Navigator.of(context).push(\n                    MaterialPageRoute(\n                      builder: (_) =&gt; AvatarFullscreenViewer(\n                        photoUrl: photoUrlController.text,\n                      ),\n                    ),\n                  );\n                },\n              ),\n            ListTile(\n              leading: const Icon(Icons.photo_library),\n              title: const Text('Chọn ảnh từ thư viện'),\n              onTap: () {\n                Navigator.pop(context);\n                _pickAndUploadImage(uid, ImageSource.gallery);\n              },\n            ),\n            ListTile(\n              leading: const Icon(Icons.camera_alt),\n              title: const Text('Chụp ảnh'),\n              onTap: () {\n                Navigator.pop(context);\n                _pickAndUploadImage(uid, ImageSource.camera);\n              },\n            ),\n            if (photoUrlController.text.isNotEmpty)\n              ListTile(\n                leading: const Icon(Icons.delete_outline, color: Colors.red),\n                title: const Text('Xoá ảnh đại diện', style: TextStyle(color: Colors.red)),\n                onTap: () {\n                  Navigator.pop(context);\n                  _removePhoto(uid);\n                },\n              ),\n          ],\n        ),\n      ),\n    );\n  }\n\n  String _formatLastSeen(DateTime lastSeen) {\n    final diff = DateTime.now().difference(lastSeen);\n    if (diff.inMinutes &lt; 1) {\n      return 'Vừa mới hoạt động';\n    } else if (diff.inHours &lt; 1) {\n      return 'Hoạt động ${diff.inMinutes} phút trước';\n    } else if (diff.inDays &lt; 1) {\n      return 'Hoạt động ${diff.inHours} giờ trước';\n    } else {\n      return 'Hoạt động ${diff.inDays} ngày trước';\n    }\n  }\n\n  @override\n  Widget build(BuildContext context) {\n    final user = authRepository.currentUser();\n    if (user == null) {\n      return const Scaffold(\n        body: Center(child: Text('Không tìm thấy người dùng.')),\n      );\n    }\n\n    return Scaffold(\n      appBar: AppBar(\n        title: const Text(\n          'Hồ sơ của bạn',\n          style: TextStyle(color: AppColors.primaryPink),\n        ),\n        iconTheme: const IconThemeData(color: AppColors.primaryPink),\n        actions: [\n          IconButton(\n            icon: const Icon(Icons.menu),\n            onPressed: () {\n              _showProfileOptionsSheet(user);\n            },\n          ),\n        ],\n      ),\n      body: StreamBuilder&lt;UserProfile?&gt;(\n        stream: userProfileRepository.watchProfile(user.uid),\n        builder: (context, snapshot) {\n          final profile = snapshot.data;\n          if (!_loadedInitial &amp;&amp; profile != null) {\n            displayNameController.text = profile.displayName ?? '';\n            photoUrlController.text = profile.photoUrl ?? '';\n            bioController.text = profile.bio ?? '';\n          noteController.text = profile.note ?? '';\n            _isPrivate = profile.isPrivate;\n            _themeColor = profile.themeColor;\n            _links = List&lt;ProfileLink&gt;.from(profile.links);\n            _loadedInitial = true;\n          }\n\n          final themeColor = _themeColor != null ? _parseColor(_themeColor!) : null;\n          final displayName = displayNameController.text.isNotEmpty\n              ? displayNameController.text\n              : (user.email ?? user.uid);\n          final statusText = profile?.isOnline == true\n              ? 'Đang hoạt động'\n              : profile?.lastSeen != null\n                  ? _formatLastSeen(profile!.lastSeen!)\n                  : 'Ngoại tuyến';\n\n          return SingleChildScrollView(\n            padding: const EdgeInsets.symmetric(horizontal: 16, vertical: 20),\n            child: Column(\n              crossAxisAlignment: CrossAxisAlignment.stretch,\n              children: [\n                FutureBuilder&lt;StoryRingStatus&gt;(\n                  future: StoryRepository().fetchStoryRingStatus(\n                    ownerUid: user.uid,\n                    viewerUid: user.uid,\n                  ),\n                  builder: (context, ringSnapshot) {\n                    final ringStatus =\n                        ringSnapshot.data ?? StoryRingStatus.none;\n                    final hasActiveStory =\n                        ringStatus != StoryRingStatus.none;\n                    Color? ringColor;\n                    if (ringStatus == StoryRingStatus.unseen) {\n                      ringColor = AppColors.primaryPink;\n                    } else if (ringStatus == StoryRingStatus.allSeen) {\n                      // Vòng tròn xám đậm hơn để dễ thấy khi đã xem hết story\n                      ringColor = Colors.grey.shade600;\n                    }\n\n                    return _EditProfileHeader(\n                      displayName: displayName,\n                      photoUrl: photoUrlController.text,\n                      statusText: statusText,\n                      themeColor: themeColor,\n                      isUploading: isUploading,\n                      hasActiveStory: hasActiveStory,\n                      storyRingColor: ringColor,\n                      onAddPressed: _showCreateChooser,\n                      onAccountMenuPressed: _showAccountMenu,\n                      // Khi chạm avatar: mở sheet mới với tuỳ chọn xem tin + đổi ảnh\n                      onAvatarTap: () =&gt; _handleAvatarTap(user.uid, ringStatus),\n                      note: noteController.text,\n                      onNoteTap: () =&gt; _showEditNoteDialog(user.uid),\n                    );\n                  },\n                ),\n                const SizedBox(height: 16),\n                if (profile != null) ...[\n                  Row(\n                    mainAxisAlignment: MainAxisAlignment.spaceEvenly,\n                    children: [\n                      _StatChip(\n                        label: 'Người theo dõi',\n                        value: profile.followersCount,\n                      ),\n                      _StatChip(\n                        label: 'Đang theo dõi',\n                        value: profile.followingCount,\n                      ),\n                    ],\n                  ),\n                  const SizedBox(height: 24),\n                ],\n                // Highlight Stories section\n                StreamBuilder&lt;UserProfile?&gt;(\n                  stream: userProfileRepository.watchProfile(user.uid),\n                  builder: (context, profileSnapshot) {\n                    final profile = profileSnapshot.data;\n                    final highlightedStories = profile?.highlightedStories ?? [];\n                    if (highlightedStories.isEmpty) {\n                      return const SizedBox.shrink();\n                    }\n                    return StreamBuilder&lt;List&lt;Story&gt;&gt;(\n                      stream: StoryRepository().fetchStoriesByAuthor(user.uid),\n                      builder: (context, storiesSnapshot) {\n                        final allStories = storiesSnapshot.data ?? [];\n                        \n                        // Filter highlights để chỉ hiển thị những highlight có ít nhất 1 story tồn tại\n                        final validHighlights = highlightedStories\n                            .where((h) =&gt; h.storyIds.any((id) =&gt;\n                                allStories.any((s) =&gt; s.id == id)))\n                            .toList();\n                        \n                        if (validHighlights.isEmpty) {\n                          return const SizedBox.shrink();\n                        }\n                        \n                        return Column(\n                          crossAxisAlignment: CrossAxisAlignment.start,\n                          children: [\n                            const Padding(\n                              padding: EdgeInsets.symmetric(horizontal: 4),\n                              child: Row(\n                                children: [\n                                  Icon(Icons.auto_awesome, size: 20, color: Colors.purple),\n                                  SizedBox(width: 8),\n                                  Text(\n                                    'Highlight Stories',\n                                    style: TextStyle(\n                                      fontSize: 16,\n                                      fontWeight: FontWeight.bold,\n                                    ),\n                                  ),\n                                ],\n                              ),\n                            ),\n                            const SizedBox(height: 8),\n                            SizedBox(\n                              height: 100,\n                              child: ListView.builder(\n                                scrollDirection: Axis.horizontal,\n                                padding: const EdgeInsets.symmetric(horizontal: 4),\n                                itemCount: validHighlights.length,\n                                itemBuilder: (context, index) {\n                                  final highlight = validHighlights[index];\n                                  final highlightStories = allStories\n                                      .where((s) =&gt; highlight.storyIds.contains(s.id))\n                                      .toList();\n                                  if (highlightStories.isEmpty) {\n                                    return const SizedBox.shrink();\n                                  }\n                                  return _HighlightStoryBubble(\n                                    highlight: highlight,\n                                    firstStory: highlightStories.first,\n                                    authorUid: user.uid,\n                                    onTap: () {\n                                      // Navigate to story viewer với stories của highlight\n                                      Navigator.of(context).push(\n                                        MaterialPageRoute(\n                                          builder: (_) =&gt; StoryViewerPage(\n                                            initialAuthorUid: user.uid,\n                                            userIdsWithStories: [user.uid],\n                                            initialStoryIds: highlight.storyIds,\n                                            highlightId: highlight.id,\n                                          ),\n                                        ),\n                                      );\n                                    },\n                                  );\n                                },\n                              ),\n                            ),\n                            const SizedBox(height: 16),\n                          ],\n                        );\n                      },\n                    );\n                  },\n                ),\n                // Pinned posts section\n                if (_pinnedPosts.isNotEmpty) ...[\n                const SizedBox(height: 8),\n                  const Padding(\n                    padding: EdgeInsets.symmetric(horizontal: 4),\n                    child: Row(\n                      children: [\n                        Icon(Icons.push_pin, size: 20, color: Colors.orange),\n                        SizedBox(width: 8),\n                        Text(\n                          'Bài viết đã ghim',\n                  style: TextStyle(\n                            fontSize: 16,\n                    fontWeight: FontWeight.bold,\n                  ),\n                ),\n                      ],\n                    ),\n                  ),\n                  const SizedBox(height: 8),\n                  SizedBox(\n                    height: 120,\n                    child: ListView.builder(\n                      scrollDirection: Axis.horizontal,\n                      padding: const EdgeInsets.symmetric(horizontal: 4),\n                      itemCount: _pinnedPosts.length,\n                      itemBuilder: (context, index) {\n                        final post = _pinnedPosts[index];\n                        return ProfilePinnedPostItem(\n                          post: post,\n                          onTap: () {\n                            Navigator.of(context).push(\n                              MaterialPageRoute(\n                                builder: (_) =&gt; PostPermalinkPage(postId: post.id),\n                              ),\n                            );\n                          },\n                        );\n                      },\n                    ),\n                  ),\n                  const SizedBox(height: 16),\n                ],\n                // Posts grid section\n                const Padding(\n                  padding: EdgeInsets.symmetric(horizontal: 4),\n                  child: Row(\n                    children: [\n                      Icon(Icons.grid_on, size: 20),\n                      SizedBox(width: 8),\n                      Text(\n                        'Bài viết',\n                        style: TextStyle(\n                          fontSize: 16,\n                          fontWeight: FontWeight.bold,\n                        ),\n                      ),\n                    ],\n                  ),\n                ),\n                const SizedBox(height: 8),\n                if (_isLoadingPosts)\n                  const Padding(\n                    padding: EdgeInsets.all(32),\n                    child: Center(child: CircularProgressIndicator()),\n                  )\n                else if (_allPosts.isEmpty)\n                  const Padding(\n                    padding: EdgeInsets.all(32),\n                    child: Center(\n                      child: Text(\n                        'Chưa có bài viết nào',\n                        style: TextStyle(color: Colors.grey),\n                      ),\n                    ),\n                  )\n                else\n                  GridView.builder(\n                    shrinkWrap: true,\n                    physics: const NeverScrollableScrollPhysics(),\n                    padding: const EdgeInsets.all(8),\n                    gridDelegate: const SliverGridDelegateWithFixedCrossAxisCount(\n                      crossAxisCount: 3,\n                      crossAxisSpacing: 4,\n                      mainAxisSpacing: 4,\n                    ),\n                    itemCount: _allPosts.length,\n                    itemBuilder: (context, index) {\n                      final post = _allPosts[index];\n                      return ProfilePostGridItem(\n                        post: post,\n                        onTap: () {\n                          Navigator.of(context).push(\n                            MaterialPageRoute(\n                              builder: (_) =&gt; PostPermalinkPage(postId: post.id),\n                            ),\n                          );\n                        },\n                      );\n                    },\n                  ),\n                // Follow requests section\n                if (profile != null &amp;&amp; _isPrivate)\n                  StreamBuilder&lt;List&lt;FollowRequestEntry&gt;&gt;(\n                    stream: _followService.watchIncomingRequestEntries(user.uid),\n                    builder: (context, requestSnapshot) {\n                      final requests = requestSnapshot.data ?? [];\n                      if (requests.isEmpty) {\n                          return const SizedBox.shrink();\n                        }\n                      return Card(\n                        child: Padding(\n                          padding: const EdgeInsets.all(16),\n                          child: Column(\n                        crossAxisAlignment: CrossAxisAlignment.start,\n                        children: [\n                              Row(\n                                children: [\n                                  const Icon(Icons.person_add, color: AppColors.primaryPink),\n                                  const SizedBox(width: 8),\n                                  Text(\n                                    'Yêu cầu theo dõi (${requests.length})',\n                                    style: const TextStyle(\n                              fontSize: 16,\n                                      fontWeight: FontWeight.bold,\n                            ),\n                          ),\n                                ],\n                              ),\n                              const SizedBox(height: 12),\n                          ...requests.map(\n                            (entry) =&gt; Card(\n                                  margin: const EdgeInsets.only(bottom: 8),\n                              child: ListTile(\n                                leading: CircleAvatar(\n                                      backgroundImage: entry.profile?.photoUrl != null\n                                      ? NetworkImage(entry.profile!.photoUrl!)\n                                      : null,\n                                  child: entry.profile?.photoUrl == null\n                                      ? const Icon(Icons.person)\n                                      : null,\n                                ),\n                                title: Text(\n                                      entry.profile?.displayName?.isNotEmpty == true\n                                      ? entry.profile!.displayName!\n                                          : (entry.profile?.email?.isNotEmpty == true\n                                          ? entry.profile!.email!\n                                          : entry.uid),\n                                ),\n                                subtitle: entry.createdAt != null\n                                        ? Text('Yêu cầu lúc ${entry.createdAt}')\n                                    : null,\n                                    trailing: Row(\n                                      mainAxisSize: MainAxisSize.min,\n                                  children: [\n                                    TextButton(\n                                          onPressed: () =&gt; _followService.acceptRequest(entry.uid),\n                                          style: TextButton.styleFrom(\n                                            foregroundColor: Colors.green,\n                                          ),\n                                      child: const Text('Chấp nhận'),\n                                    ),\n                                    TextButton(\n                                          onPressed: () =&gt; _followService.declineRequest(entry.uid),\n                                          style: TextButton.styleFrom(\n                                            foregroundColor: Colors.red,\n                                          ),\n                                      child: const Text('Từ chối'),\n                                    ),\n                                  ],\n                                ),\n                              ),\n                            ),\n                          ),\n                        ],\n                          ),\n                        ),\n                      );\n                    },\n                  ),\n              ],\n            ),\n          );\n        },\n      ),\n    );\n  }\n\n  Color _parseColor(String hexColor) {\n    try {\n      return Color(int.parse(hexColor.replaceFirst('#', '0xFF')));\n    } catch (e) {\n      return Colors.blue;\n    }\n  }\n\n  void _showColorPicker(BuildContext context) {\n    final presetColors = [\n      '#FF5733', '#33FF57', '#3357FF', '#FF33F5', '#F5FF33',\n      '#33FFF5', '#FF8C33', '#8C33FF', '#33FF8C', '#FF3333',\n      '#33FF33', '#3333FF', '#FFFF33', '#FF33FF', '#33FFFF',\n    ];\n\n    showModalBottomSheet(\n      context: context,\n      builder: (context) =&gt; Container(\n        padding: const EdgeInsets.all(16),\n        child: Column(\n          mainAxisSize: MainAxisSize.min,\n          crossAxisAlignment: CrossAxisAlignment.start,\n          children: [\n            const Text(\n              'Chọn màu chủ đạo',\n              style: TextStyle(fontSize: 18, fontWeight: FontWeight.bold),\n            ),\n            const SizedBox(height: 16),\n            Wrap(\n              spacing: 12,\n              runSpacing: 12,\n              children: [\n                // Preset colors\n                ...presetColors.map((color) {\n                  return GestureDetector(\n                    onTap: () {\n                      setState(() {\n                        _themeColor = color;\n                      });\n                      Navigator.pop(context);\n                    },\n                    child: Container(\n                      width: 48,\n                      height: 48,\n                      decoration: BoxDecoration(\n                        color: _parseColor(color),\n                        shape: BoxShape.circle,\n                        border: Border.all(color: Colors.grey.shade300),\n                      ),\n                    ),\n                  );\n                }),\n                // Custom color picker (simple text input)\n                GestureDetector(\n                  onTap: () =&gt; _showCustomColorDialog(context),\n                  child: Container(\n                    width: 48,\n                    height: 48,\n                    decoration: BoxDecoration(\n                      color: Colors.grey.shade200,\n                      shape: BoxShape.circle,\n                      border: Border.all(color: Colors.grey.shade300),\n                    ),\n                    child: const Icon(Icons.tune),\n                  ),\n                ),\n              ],\n            ),\n            const SizedBox(height: 16),\n            TextButton(\n              onPressed: () {\n                setState(() {\n                  _themeColor = null;\n                });\n                Navigator.pop(context);\n              },\n              child: const Text('Xóa màu'),\n            ),\n          ],\n        ),\n      ),\n    );\n  }\n\n  void _showCustomColorDialog(BuildContext context) {\n    final controller = TextEditingController(text: _themeColor ?? '#');\n    showDialog(\n      context: context,\n      builder: (context) =&gt; AlertDialog(\n        title: const Text('Màu tùy chỉnh'),\n        content: TextField(\n          controller: controller,\n          decoration: const InputDecoration(\n            labelText: 'Mã màu hex (ví dụ: #FF5733)',\n            hintText: '#FF5733',\n          ),\n        ),\n        actions: [\n          TextButton(\n            onPressed: () =&gt; Navigator.pop(context),\n            child: const Text('Hủy'),\n          ),\n          FilledButton(\n            onPressed: () {\n              final color = controller.text.trim();\n              if (color.isNotEmpty &amp;&amp; color.startsWith('#')) {\n                try {\n                  _parseColor(color); // Validate\n                  setState(() {\n                    _themeColor = color;\n                  });\n                  Navigator.pop(context);\n                  Navigator.pop(context); // Close color picker too\n                } catch (e) {\n                  ScaffoldMessenger.of(context).showSnackBar(\n                    const SnackBar(content: Text('Mã màu không hợp lệ')),\n                  );\n                }\n              } else {\n                ScaffoldMessenger.of(context).showSnackBar(\n                  const SnackBar(content: Text('Mã màu phải bắt đầu bằng #')),\n                );\n              }\n            },\n            child: const Text('Lưu'),\n          ),\n        ],\n      ),\n    );\n  }\n\n  void _showAddLinkDialog(BuildContext context) {\n    final labelController = TextEditingController();\n    final urlController = TextEditingController();\n\n    showDialog(\n      context: context,\n      builder: (context) =&gt; AlertDialog(\n        title: const Text('Thêm liên kết'),\n        content: Column(\n          mainAxisSize: MainAxisSize.min,\n          children: [\n            TextField(\n              controller: labelController,\n              decoration: const InputDecoration(\n                labelText: 'Nhãn (ví dụ: Website, Instagram)',\n              ),\n            ),\n            const SizedBox(height: 12),\n            TextField(\n              controller: urlController,\n              decoration: const InputDecoration(\n                labelText: 'URL',\n                hintText: 'https://example.com',\n              ),\n              keyboardType: TextInputType.url,\n            ),\n          ],\n        ),\n        actions: [\n          TextButton(\n            onPressed: () =&gt; Navigator.pop(context),\n            child: const Text('Hủy'),\n          ),\n          FilledButton(\n            onPressed: () {\n              final label = labelController.text.trim();\n              final url = urlController.text.trim();\n              if (label.isEmpty || url.isEmpty) {\n                ScaffoldMessenger.of(context).showSnackBar(\n                  const SnackBar(content: Text('Vui lòng điền đầy đủ thông tin')),\n                );\n                return;\n              }\n              if (!url.startsWith('http://') &amp;&amp; !url.startsWith('https://')) {\n                ScaffoldMessenger.of(context).showSnackBar(\n                  const SnackBar(content: Text('URL phải bắt đầu bằng http:// hoặc https://')),\n                );\n                return;\n              }\n              setState(() {\n                _links.add(ProfileLink(url: url, label: label));\n              });\n              Navigator.pop(context);\n            },\n            child: const Text('Thêm'),\n          ),\n        ],\n      ),\n    );\n  }\n\n  Future&lt;void&gt; _showEditNoteDialog(String uid) async {\n    final controller = TextEditingController(text: noteController.text);\n    final result = await showDialog&lt;String&gt;(\n      context: context,\n      builder: (context) =&gt; AlertDialog(\n        title: const Text('Cập nhật ghi chú'),\n        content: TextField(\n          controller: controller,\n          maxLength: 50,\n          decoration: const InputDecoration(\n            hintText: 'Nhập ghi chú (tối đa 50 ký tự)',\n          ),\n        ),\n        actions: [\n          TextButton(\n            onPressed: () =&gt; Navigator.pop(context),\n            child: const Text('Hủy'),\n          ),\n          FilledButton(\n            onPressed: () {\n              final text = controller.text.trim();\n              if (text.length &gt; 50) {\n                ScaffoldMessenger.of(context).showSnackBar(\n                  const SnackBar(\n                    content: Text('Ghi chú tối đa 50 ký tự'),\n                  ),\n                );\n                return;\n              }\n              Navigator.pop(context, text);\n            },\n            child: const Text('Lưu'),\n          ),\n        ],\n      ),\n    );\n\n    if (result == null) return;\n\n    try {\n      await userProfileRepository.updateProfile(uid, note: result);\n      setState(() {\n        noteController.text = result;\n      });\n      if (mounted) {\n        ScaffoldMessenger.of(context).showSnackBar(\n          const SnackBar(content: Text('Đã cập nhật ghi chú.')),\n        );\n      }\n    } catch (e) {\n      if (!mounted) return;\n      ScaffoldMessenger.of(context).showSnackBar(\n        SnackBar(content: Text('Không thể cập nhật ghi chú: $e')),\n      );\n    }\n  }\n\n  Future&lt;void&gt; _handleMenuAction(_ProfileMenuAction action) async {\n    final user = authRepository.currentUser();\n    if (user == null) return;\n\n    switch (action) {\n      case _ProfileMenuAction.personalInfo:\n        await _showPersonalInfoModal(user.uid);\n        break;\n      case _ProfileMenuAction.privateAccount:\n        await _togglePrivateAccount(user.uid);\n        break;\n      case _ProfileMenuAction.highlightStories:\n        await Navigator.of(context).push(\n          MaterialPageRoute(\n            builder: (_) =&gt; ManageHighlightStoriesPage(uid: user.uid),\n          ),\n        );\n        break;\n      case _ProfileMenuAction.privacySettings:\n        await Navigator.of(context).push(\n          MaterialPageRoute(builder: (_) =&gt; PrivacySettingsPage()),\n        );\n        break;\n      case _ProfileMenuAction.savedPosts:\n        await Navigator.of(context).push(\n          MaterialPageRoute(builder: (_) =&gt; const SavedPostsPage()),\n        );\n        break;\n      case _ProfileMenuAction.changePassword:\n        await Navigator.of(context).push(\n          MaterialPageRoute(builder: (_) =&gt; const ChangePasswordPage()),\n        );\n        break;\n      case _ProfileMenuAction.adminDashboard:\n        await Navigator.of(context).push(\n          MaterialPageRoute(builder: (_) =&gt; const AdminDashboardPage()),\n        );\n        break;\n      case _ProfileMenuAction.logout:\n        await _confirmLogoutAndMaybeSave(currentUser: user);\n        break;\n    }\n  }\n\n  Future&lt;void&gt; _showPersonalInfoModal(String uid) async {\n    final displayNameCtrl = TextEditingController(text: displayNameController.text);\n    final bioCtrl = TextEditingController(text: bioController.text);\n    final photoUrlCtrl = TextEditingController(text: photoUrlController.text);\n\n    await showDialog(\n      context: context,\n      builder: (context) =&gt; AlertDialog(\n        title: const Text('Thông tin cá nhân'),\n        content: SingleChildScrollView(\n          child: Column(\n            mainAxisSize: MainAxisSize.min,\n            children: [\n              TextField(\n                controller: displayNameCtrl,\n                decoration: const InputDecoration(\n                  labelText: 'Tên hiển thị',\n                  prefixIcon: Icon(Icons.person),\n                ),\n              ),\n              const SizedBox(height: 16),\n              TextField(\n                controller: bioCtrl,\n                minLines: 1,\n                maxLines: 4,\n                decoration: const InputDecoration(\n                  labelText: 'Tiểu sử (bio)',\n                  prefixIcon: Icon(Icons.description),\n                ),\n              ),\n              const SizedBox(height: 16),\n              TextField(\n                controller: photoUrlCtrl,\n                decoration: const InputDecoration(\n                  labelText: 'Ảnh đại diện (URL)',\n                  prefixIcon: Icon(Icons.image),\n                ),\n              ),\n              const SizedBox(height: 16),\n              OutlinedButton.icon(\n                onPressed: () {\n                  Navigator.pop(context);\n                  _showAvatarOptions(uid);\n                },\n                icon: const Icon(Icons.photo_library),\n                label: const Text('Chọn ảnh từ thiết bị'),\n              ),\n            ],\n          ),\n        ),\n        actions: [\n          TextButton(\n            onPressed: () =&gt; Navigator.pop(context),\n            child: const Text('Hủy'),\n          ),\n          FilledButton(\n            onPressed: () async {\n              Navigator.pop(context);\n              displayNameController.text = displayNameCtrl.text;\n              bioController.text = bioCtrl.text;\n              photoUrlController.text = photoUrlCtrl.text;\n              await _saveProfile(uid);\n            },\n            child: const Text('Lưu'),\n          ),\n        ],\n      ),\n    );\n  }\n\n  Future&lt;void&gt; _togglePrivateAccount(String uid) async {\n    final newValue = !_isPrivate;\n    setState(() {\n      _isPrivate = newValue;\n    });\n    try {\n      await userProfileRepository.updateProfile(uid, isPrivate: newValue);\n      if (mounted) {\n        ScaffoldMessenger.of(context).showSnackBar(\n          SnackBar(\n            content: Text(\n              newValue\n                  ? 'Đã bật tài khoản riêng tư'\n                  : 'Đã tắt tài khoản riêng tư',\n            ),\n          ),\n        );\n      }\n    } catch (e) {\n      setState(() {\n        _isPrivate = !newValue;\n      });\n      if (mounted) {\n        ScaffoldMessenger.of(context).showSnackBar(\n          SnackBar(content: Text('Lỗi cập nhật: $e')),\n        );\n      }\n    }\n  }\n\n  Future&lt;void&gt; _showCustomizationModal(String uid) async {\n    await showDialog(\n      context: context,\n      builder: (context) =&gt; AlertDialog(\n        title: const Text('Tùy biến'),\n        content: SingleChildScrollView(\n          child: Column(\n            mainAxisSize: MainAxisSize.min,\n            crossAxisAlignment: CrossAxisAlignment.start,\n            children: [\n              ListTile(\n                contentPadding: EdgeInsets.zero,\n                title: const Text('Màu chủ đạo'),\n                subtitle: Text(_themeColor ?? 'Chưa chọn màu'),\n                trailing: Row(\n                  mainAxisSize: MainAxisSize.min,\n                  children: [\n                    if (_themeColor != null)\n                      Container(\n                        width: 32,\n                        height: 32,\n                        decoration: BoxDecoration(\n                          color: _parseColor(_themeColor!),\n                          shape: BoxShape.circle,\n                          border: Border.all(color: Colors.grey),\n                        ),\n                      ),\n                    const SizedBox(width: 8),\n                    IconButton(\n                      icon: const Icon(Icons.color_lens, color: AppColors.primaryPink),\n                      onPressed: () {\n                        Navigator.pop(context);\n                        _showColorPicker(context);\n                      },\n                    ),\n                    if (_themeColor != null)\n                      IconButton(\n                        icon: const Icon(Icons.clear),\n                        onPressed: () {\n                          setState(() {\n                            _themeColor = null;\n                          });\n                          Navigator.pop(context);\n                          _saveProfile(uid);\n                        },\n                      ),\n                  ],\n                ),\n              ),\n              const SizedBox(height: 16),\n              const Text(\n                'Liên kết ngoài',\n                style: TextStyle(fontWeight: FontWeight.w600),\n              ),\n              const SizedBox(height: 8),\n              if (_links.isEmpty)\n                const Text(\n                  'Chưa có liên kết nào',\n                  style: TextStyle(color: Colors.grey),\n                )\n              else\n                Wrap(\n                  spacing: 8,\n                  runSpacing: 8,\n                  children: _links.asMap().entries.map((entry) {\n                    final index = entry.key;\n                    final link = entry.value;\n                    return Chip(\n                      label: Text(link.label),\n                      deleteIcon: const Icon(Icons.close, size: 18),\n                      onDeleted: () {\n                        setState(() {\n                          _links.removeAt(index);\n                        });\n                        _saveProfile(uid);\n                      },\n                    );\n                  }).toList(),\n                ),\n              if (_links.length &lt; 5) ...[\n                const SizedBox(height: 8),\n                OutlinedButton.icon(\n                  onPressed: () {\n                    Navigator.pop(context);\n                    _showAddLinkDialog(context);\n                  },\n                  icon: const Icon(Icons.add, color: AppColors.primaryPink),\n                  label: const Text('Thêm liên kết'),\n                ),\n              ],\n            ],\n          ),\n        ),\n        actions: [\n          TextButton(\n            onPressed: () =&gt; Navigator.pop(context),\n            child: const Text('Đóng'),\n          ),\n        ],\n      ),\n    );\n  }\n\n  void _showProfileOptionsSheet(User user) {\n    showModalBottomSheet(\n      context: context,\n      builder: (context) =&gt; SafeArea(\n        child: Column(\n          mainAxisSize: MainAxisSize.min,\n          children: [\n            const ListTile(\n              title: Text(\n                'Tùy chọn tài khoản',\n                style: TextStyle(fontWeight: FontWeight.bold),\n              ),\n            ),\n            ListTile(\n              leading: const Icon(Icons.person, color: AppColors.primaryPink),\n              title: const Text('Thông tin cá nhân'),\n              trailing: const Icon(Icons.chevron_right),\n              onTap: () {\n                Navigator.pop(context);\n                _handleMenuAction(_ProfileMenuAction.personalInfo);\n              },\n            ),\n            ListTile(\n              leading: const Icon(Icons.lock_outline, color: AppColors.primaryPink),\n              title: const Text('Tài khoản riêng tư'),\n              trailing: StreamBuilder&lt;UserProfile?&gt;(\n                stream: userProfileRepository.watchProfile(user.uid),\n                builder: (context, snapshot) {\n                  final isPrivate = snapshot.data?.isPrivate ?? false;\n                  return Switch(\n                    value: isPrivate,\n                    onChanged: (value) {\n                      Navigator.pop(context);\n                      _handleMenuAction(_ProfileMenuAction.privateAccount);\n                    },\n                  );\n                },\n              ),\n            ),\n            ListTile(\n              leading: const Icon(Icons.auto_awesome, color: AppColors.primaryPink),\n              title: const Text('Highlight Stories'),\n              trailing: const Icon(Icons.chevron_right),\n              onTap: () {\n                Navigator.pop(context);\n                _handleMenuAction(_ProfileMenuAction.highlightStories);\n              },\n            ),\n            const Divider(),\n            ListTile(\n              leading: const Icon(Icons.privacy_tip, color: AppColors.primaryPink),\n              title: const Text('Quyền riêng tư'),\n              trailing: const Icon(Icons.chevron_right),\n              onTap: () {\n                Navigator.pop(context);\n                _handleMenuAction(_ProfileMenuAction.privacySettings);\n              },\n            ),\n            ListTile(\n              leading: const Icon(Icons.bookmark, color: AppColors.primaryPink),\n              title: const Text('Đã lưu'),\n              trailing: const Icon(Icons.chevron_right),\n              onTap: () {\n                Navigator.pop(context);\n                _handleMenuAction(_ProfileMenuAction.savedPosts);\n              },\n            ),\n            if (user.email != null &amp;&amp;\n                user.providerData.any((p) =&gt; p.providerId == 'password'))\n              ListTile(\n                leading: const Icon(Icons.lock, color: AppColors.primaryPink),\n                title: const Text('Đổi mật khẩu'),\n                trailing: const Icon(Icons.chevron_right),\n                onTap: () {\n                  Navigator.pop(context);\n                  _handleMenuAction(_ProfileMenuAction.changePassword);\n                },\n              ),\n            if (_isAdmin)\n              ListTile(\n                leading:\n                    const Icon(Icons.admin_panel_settings, color: AppColors.primaryPink),\n                title: const Text('Admin Dashboard'),\n                trailing: const Icon(Icons.chevron_right),\n                onTap: () {\n                  Navigator.pop(context);\n                  _handleMenuAction(_ProfileMenuAction.adminDashboard);\n                },\n              ),\n          ],\n        ),\n      ),\n    );\n  }\n}\n\nclass _EditProfileHeader extends StatelessWidget {\n  const _EditProfileHeader({\n    required this.displayName,\n    required this.photoUrl,\n    required this.statusText,\n    required this.onAddPressed,\n    required this.onAccountMenuPressed,\n    required this.onAvatarTap,\n    required this.note,\n    required this.onNoteTap,\n    required this.hasActiveStory,\n    required this.storyRingColor,\n    this.themeColor,\n    this.isUploading = false,\n  });\n\n  final String displayName;\n  final String photoUrl;\n  final String statusText;\n  final String note;\n  final Color? themeColor;\n  final bool isUploading;\n  final VoidCallback onAddPressed;\n  final VoidCallback onAccountMenuPressed;\n  final VoidCallback onAvatarTap;\n  final VoidCallback onNoteTap;\n  final bool hasActiveStory;\n  final Color? storyRingColor;\n\n  @override\n  Widget build(BuildContext context) {\n    return Column(\n      crossAxisAlignment: CrossAxisAlignment.stretch,\n      children: [\n        Center(\n          child: Row(\n            mainAxisSize: MainAxisSize.min,\n            children: [\n              // Icon ảo bên trái để cân đối layout, không nhận tương tác\n              IgnorePointer(\n                child: Opacity(\n                  opacity: 0,\n                  child: IconButton(\n                    onPressed: () {},\n                    icon: const Icon(Icons.keyboard_arrow_down, size: 22),\n                    padding: EdgeInsets.zero,\n                    constraints: const BoxConstraints(),\n                    splashRadius: 20,\n                  ),\n                ),\n              ),\n              const SizedBox(width: 6),\n              Flexible(\n                child: Text(\n                  displayName,\n                  style: const TextStyle(\n                    fontSize: 20,\n                    fontWeight: FontWeight.w800,\n                  ),\n                  maxLines: 1,\n                  overflow: TextOverflow.ellipsis,\n                  textAlign: TextAlign.center,\n                ),\n              ),\n              const SizedBox(width: 6),\n              IconButton(\n                onPressed: onAccountMenuPressed,\n                icon: const Icon(Icons.keyboard_arrow_down, size: 22),\n                padding: EdgeInsets.zero,\n                constraints: const BoxConstraints(),\n                splashRadius: 20,\n              ),\n            ],\n          ),\n        ),\n        const SizedBox(height: 16),\n        Center(\n          child: Stack(\n            clipBehavior: Clip.none,\n            children: [\n              // Avatar (tap để đổi ảnh) + vòng story (hồng/xám)\n              GestureDetector(\n                onTap: onAvatarTap,\n                child: Container(\n                  decoration: hasActiveStory &amp;&amp; storyRingColor != null\n                      ? BoxDecoration(\n                          shape: BoxShape.circle,\n                          border: Border.all(\n                            color: storyRingColor!,\n                            width: 3.5,\n                          ),\n                        )\n                      : null,\n                  child: CircleAvatar(\n                    radius: 48,\n                    backgroundImage:\n                        photoUrl.isNotEmpty ? NetworkImage(photoUrl) : null,\n                    child: photoUrl.isEmpty\n                        ? const Icon(Icons.person, size: 48)\n                        : isUploading\n                            ? Container(\n                                color: Colors.black54,\n                                child: const Center(\n                                  child: CircularProgressIndicator(\n                                    valueColor:\n                                        AlwaysStoppedAnimation&lt;Color&gt;(Colors.white),\n                                  ),\n                                ),\n                              )\n                            : null,\n                  ),\n                ),\n              ),\n              // Nút + đăng story/post\n              Positioned(\n                right: -6,\n                bottom: -6,\n                child: GestureDetector(\n                  // Dấu + để đăng story / post\n                  onTap: onAddPressed,\n                  child: Container(\n                    padding: const EdgeInsets.all(8),\n                    decoration: BoxDecoration(\n                      shape: BoxShape.circle,\n                      color: AppColors.primaryPink,\n                      border: Border.all(color: Colors.white, width: 3),\n                    ),\n                    child: const Icon(Icons.add, color: Colors.white, size: 20),\n                  ),\n                ),\n              ),\n              // Bong bóng ghi chú đè lên avatar\n              Positioned(\n                top: 6,\n                left: 0,\n                right: 0,\n                child: GestureDetector(\n                  behavior: HitTestBehavior.translucent,\n                  onTap: onNoteTap,\n                  child: TweenAnimationBuilder&lt;double&gt;(\n                    tween: Tween(begin: 0.95, end: 1.0),\n                    duration: const Duration(milliseconds: 800),\n                    curve: Curves.easeInOut,\n                    builder: (context, value, child) {\n                      return Transform.scale(scale: value, child: child);\n                    },\n                    child: Center(\n                      child: Container(\n                        constraints: const BoxConstraints(maxWidth: 180),\n                        padding: const EdgeInsets.symmetric(\n                          horizontal: 12,\n                          vertical: 6,\n                        ),\n                        decoration: BoxDecoration(\n                          color: Colors.white,\n                          borderRadius: BorderRadius.circular(18),\n                          boxShadow: [\n                            BoxShadow(\n                              color: Colors.black.withOpacity(0.08),\n                              blurRadius: 8,\n                              offset: const Offset(0, 4),\n                            ),\n                          ],\n                        ),\n                        child: Text(\n                          note.isNotEmpty ? note : 'Thêm ghi chú...',\n                          maxLines: 1,\n                          overflow: TextOverflow.ellipsis,\n                          style: const TextStyle(\n                            fontSize: 12,\n                            fontWeight: FontWeight.w600,\n                          ),\n                        ),\n                      ),\n                    ),\n                  ),\n                ),\n              ),\n            ],\n          ),\n        ),\n        const SizedBox(height: 12),\n        Center(\n          child: Text(\n            displayName,\n            style: const TextStyle(\n              fontSize: 20,\n              fontWeight: FontWeight.bold,\n            ),\n          ),\n        ),\n        const SizedBox(height: 4),\n        Center(\n          child: Text(\n            statusText,\n            style: TextStyle(\n              fontSize: 14,\n              color: Theme.of(context).colorScheme.onSurfaceVariant,\n            ),\n          ),\n        ),\n      ],\n    );\n  }\n}\n\nclass _HighlightStoryBubble extends StatelessWidget {\n  const _HighlightStoryBubble({\n    required this.highlight,\n    required this.firstStory,\n    required this.authorUid,\n    required this.onTap,\n  });\n\n  final HighlightStory highlight;\n  final Story firstStory;\n  final String authorUid;\n  final VoidCallback onTap;\n\n  @override\n  Widget build(BuildContext context) {\n    return GestureDetector(\n      onTap: onTap,\n      child: Container(\n        width: 70,\n        margin: const EdgeInsets.symmetric(horizontal: 6),\n        child: Column(\n          mainAxisSize: MainAxisSize.min,\n          children: [\n            Container(\n              width: 70,\n              height: 70,\n              decoration: BoxDecoration(\n                shape: BoxShape.circle,\n                border: Border.all(color: Colors.purple, width: 2.5),\n              ),\n              child: ClipOval(\n                child: firstStory.thumbnailUrl != null\n                    ? Image.network(\n                        firstStory.thumbnailUrl!,\n                        fit: BoxFit.cover,\n                        errorBuilder: (_, __, ___) =&gt; _buildPlaceholder(),\n                      )\n                    : firstStory.type == StoryMediaType.image\n                        ? Image.network(\n                            firstStory.mediaUrl,\n                            fit: BoxFit.cover,\n                            errorBuilder: (_, __, ___) =&gt; _buildPlaceholder(),\n                          )\n                        : _buildPlaceholder(),\n              ),\n            ),\n            const SizedBox(height: 6),\n            Text(\n              highlight.name,\n              style: const TextStyle(\n                fontSize: 11,\n                fontWeight: FontWeight.w500,\n              ),\n              maxLines: 1,\n              overflow: TextOverflow.ellipsis,\n              textAlign: TextAlign.center,\n            ),\n          ],\n        ),\n      ),\n    );\n  }\n\n  Widget _buildPlaceholder() {\n    return Container(\n      color: Colors.grey[300],\n      child: Icon(\n        firstStory.type == StoryMediaType.video ? Icons.videocam : Icons.image,\n        color: Colors.grey[600],\n        size: 30,\n      ),\n    );\n  }\n}\n\nclass _StatChip extends StatelessWidget {\n  const _StatChip({\n    required this.label,\n    required this.value,\n  });\n\n  final String label;\n  final int value;\n\n  @override\n  Widget build(BuildContext context) {\n    return Container(\n      padding: const EdgeInsets.symmetric(horizontal: 24, vertical: 12),\n      decoration: BoxDecoration(\n        color: AppColors.primaryPink.withOpacity(0.1),\n        borderRadius: BorderRadius.circular(20),\n        border: Border.all(color: AppColors.primaryPink.withOpacity(0.3)),\n      ),\n      child: Column(\n      children: [\n        Text(\n          '$value',\n          style: const TextStyle(\n              fontSize: 20,\n            fontWeight: FontWeight.bold,\n              color: AppColors.primaryPink,\n          ),\n        ),\n        const SizedBox(height: 4),\n          Text(\n            label,\n            style: const TextStyle(\n              fontSize: 12,\n              color: AppColors.primaryPink,\n            ),\n          ),\n        ],\n      ),\n    );\n  }\n}\n\n\n",
    "languageId": "dart"
  }
}
```
Result:

```json
{
  "diff": {
    "chunks": [
      {
        "diffString": "  \n    /// Hiển thị bottom sheet khi chạm avatar trên trang hồ sơ\n-   /// - Nếu người dùng có story (kể cả đã xem hết): hiện thêm hành động \"Xem tin\"\n-   /// - Nếu không có story: chỉ hiện các tuỳ chọn ảnh đại diện\n+   /// - Nếu người dùng có story (kể cả đã xem hết): thêm hành động \"Xem tin\"\n+   /// - Dù có story hay không, luôn có tuỳ chọn \"Xem ảnh đại diện\" (nếu có ảnh)\n    void _handleAvatarTap(String uid, StoryRingStatus ringStatus) {\n      final hasStory = ringStatus != StoryRingStatus.none;\n  \n      if (!hasStory) {\n-       // Không có story -&gt; dùng sheet cũ chỉ cho phép đổi/xoá ảnh đại diện\n+       // Không có story -&gt; dùng sheet ảnh đại diện (vẫn có Xem ảnh đại diện)\n        _showAvatarOptions(uid);\n        return;",
        "oldStart": 584,
        "newStart": 584,
        "oldLines": 11,
        "newLines": 11,
        "linesRemoved": 3,
        "linesAdded": 3
      },
      {
        "diffString": "            mainAxisSize: MainAxisSize.min,\n            children: [\n+             if (photoUrlController.text.isNotEmpty)\n+               ListTile(\n+                 leading: const Icon(Icons.remove_red_eye),\n+                 title: const Text('Xem ảnh đại diện'),\n+                 onTap: () {\n+                   Navigator.pop(context);\n+                   Navigator.of(context).push(\n+                     MaterialPageRoute(\n+                       builder: (_) =&gt; AvatarFullscreenViewer(\n+                         photoUrl: photoUrlController.text,\n+                       ),\n+                     ),\n+                   );\n+                 },\n+               ),\n              ListTile(\n                leading: const Icon(Icons.photo_library),",
        "oldStart": 672,
        "newStart": 672,
        "oldLines": 4,
        "newLines": 19,
        "linesAdded": 15
      }
    ],
    "editor": "EDITOR_AI"
  },
  "shouldAutoFixLints": true,
  "resultForModel": "Success. Updated the following files:\nM lib/features/profile/profile_screen.dart",
  "contentsAfterEdit": "import 'dart:async';\nimport 'dart:io';\n\nimport 'package:firebase_storage/firebase_storage.dart';\nimport 'package:flutter/foundation.dart';\nimport 'package:flutter/material.dart';\nimport 'package:image_picker/image_picker.dart';\n\nimport 'user_profile_repository.dart';\nimport '../admin/pages/admin_dashboard_page.dart';\nimport '../admin/repositories/admin_repository.dart';\nimport 'package:firebase_auth/firebase_auth.dart';\n\nimport '../auth/auth_gate.dart';\nimport '../auth/auth_repository.dart';\nimport '../auth/login_screen.dart';\nimport '../auth/saved_accounts_repository.dart';\nimport '../auth/saved_credentials_repository.dart';\nimport '../follow/services/follow_service.dart';\nimport '../../services/cloudinary_service.dart';\nimport '../saved_posts/pages/saved_posts_page.dart';\nimport '../settings/pages/privacy_settings_page.dart';\nimport '../auth/pages/change_password_page.dart';\nimport '../stories/pages/story_create_page.dart';\nimport '../stories/pages/story_viewer_page.dart';\nimport '../stories/repositories/story_repository.dart';\nimport '../stories/models/story.dart';\nimport '../posts/pages/post_create_page.dart';\nimport '../posts/pages/post_permalink_page.dart';\nimport '../posts/repositories/post_repository.dart';\nimport '../posts/models/post.dart';\nimport 'widgets/profile_posts_widgets.dart';\nimport 'widgets/avatar_fullscreen_viewer.dart';\nimport 'pages/manage_highlight_stories_page.dart';\nimport '../../theme/colors.dart';\n\nenum _ProfileMenuAction {\n  personalInfo,\n  privacySettings,\n  privateAccount,\n  highlightStories,\n  savedPosts,\n  changePassword,\n  adminDashboard,\n  logout,\n}\n\nenum _LogoutChoice {\n  saveAndSignOut,\n  signOutOnly,\n}\n\nenum _CreateAction { story, post }\nenum _AccountMenuAction { switchAccount, logout }\n\nclass ProfileScreen extends StatefulWidget {\n  const ProfileScreen({super.key});\n\n  @override\n  State&lt;ProfileScreen&gt; createState() =&gt; _ProfileScreenState();\n}\n\nclass _ProfileScreenState extends State&lt;ProfileScreen&gt; {\n  final TextEditingController displayNameController = TextEditingController();\n  final TextEditingController photoUrlController = TextEditingController();\n  final TextEditingController bioController = TextEditingController();\n  final TextEditingController noteController = TextEditingController();\n  final ImagePicker _picker = ImagePicker();\n  final AdminRepository _adminRepository = AdminRepository();\n  final PostRepository _postRepository = PostRepository();\n  bool isSaving = false;\n  bool isUploading = false;\n  bool _loadedInitial = false;\n  bool _isPrivate = false;\n  String? _themeColor;\n  List&lt;ProfileLink&gt; _links = [];\n  bool _isAdmin = false;\n  late final FollowService _followService;\n  List&lt;Post&gt; _pinnedPosts = [];\n  List&lt;Post&gt; _allPosts = [];\n  bool _isLoadingPosts = false;\n\n  @override\n  void initState() {\n    super.initState();\n    _followService = FollowService();\n    _checkAdminStatus();\n    _loadPinnedPosts();\n    _loadAllPosts();\n  }\n\n  Future&lt;void&gt; _loadPinnedPosts() async {\n    try {\n      final user = authRepository.currentUser();\n      if (user == null) return;\n      final profile = await userProfileRepository.fetchProfile(user.uid);\n      if (profile == null || profile.pinnedPostIds.isEmpty) {\n        if (mounted) {\n          setState(() {\n            _pinnedPosts = [];\n          });\n        }\n        return;\n      }\n\n      final posts = &lt;Post&gt;[];\n      for (final postId in profile.pinnedPostIds) {\n        try {\n          final post = await _postRepository.watchPost(postId).first;\n          posts.add(post);\n        } catch (_) {\n          continue;\n        }\n      }\n\n      if (mounted) {\n        setState(() {\n          _pinnedPosts = posts;\n        });\n      }\n    } catch (_) {\n      // ignore\n    }\n  }\n\n  Future&lt;void&gt; _loadAllPosts() async {\n    final user = authRepository.currentUser();\n    if (user == null) return;\n\n    setState(() {\n      _isLoadingPosts = true;\n    });\n\n    try {\n      final pageResult = await _postRepository.fetchPostsByAuthor(\n        authorUid: user.uid,\n        limit: 50,\n      );\n\n      final posts = pageResult.docs.map((doc) =&gt; Post.fromDoc(doc)).toList();\n\n      if (mounted) {\n        setState(() {\n          _allPosts = posts;\n          _isLoadingPosts = false;\n        });\n      }\n    } catch (_) {\n      if (mounted) {\n        setState(() {\n          _isLoadingPosts = false;\n        });\n      }\n    }\n  }\n\n  Future&lt;void&gt; _checkAdminStatus() async {\n    final user = authRepository.currentUser();\n    if (user != null) {\n      final isAdmin = await _adminRepository.isAdmin(user.uid);\n      if (mounted) {\n        setState(() {\n          _isAdmin = isAdmin;\n        });\n      }\n    }\n  }\n\n  @override\n  void dispose() {\n    displayNameController.dispose();\n    photoUrlController.dispose();\n    bioController.dispose();\n    noteController.dispose();\n    super.dispose();\n  }\n\n  Future&lt;void&gt; _saveProfile(String uid) async {\n    setState(() {\n      isSaving = true;\n    });\n    try {\n      await userProfileRepository.updateProfile(\n        uid,\n        displayName: displayNameController.text.trim(),\n        photoUrl: photoUrlController.text.trim().isEmpty\n            ? null\n            : photoUrlController.text.trim(),\n        removePhoto: photoUrlController.text.trim().isEmpty,\n        bio: bioController.text.trim(),\n        note: noteController.text.trim(),\n        isPrivate: _isPrivate,\n        themeColor: _themeColor,\n        links: _links,\n      );\n      _loadedInitial = false;\n      if (!mounted) return;\n      ScaffoldMessenger.of(context).showSnackBar(\n        const SnackBar(content: Text('Đã cập nhật hồ sơ.')),\n      );\n    } catch (e) {\n      if (!mounted) return;\n      ScaffoldMessenger.of(context).showSnackBar(\n        SnackBar(content: Text('Lỗi cập nhật: $e')),\n      );\n    } finally {\n      if (mounted) {\n        setState(() {\n          isSaving = false;\n        });\n      }\n    }\n  }\n\n  /// Chọn storage backend: 'firebase' hoặc 'cloudinary'\n  /// Phải khớp với PostService.storageBackend\n  static const String storageBackend = 'cloudinary'; // Thay đổi thành 'firebase' nếu muốn dùng Firebase Storage\n\n  Future&lt;void&gt; _pickAndUploadImage(String uid, ImageSource source) async {\n    setState(() {\n      isUploading = true;\n    });\n    try {\n      final XFile? picked = await _picker.pickImage(\n        source: source,\n        maxWidth: 1024,\n        imageQuality: 85,\n      );\n      if (picked == null) {\n        setState(() {\n          isUploading = false;\n        });\n        return;\n      }\n\n      String url;\n      \n      if (storageBackend == 'cloudinary') {\n        // Dùng Cloudinary\n        final result = await CloudinaryService.uploadImage(\n          file: picked,\n          folder: 'user_profiles/$uid',\n          publicId: 'avatar',\n        );\n        url = result['url']!;\n      } else {\n        // Dùng Firebase Storage (code cũ)\n        final storageRef =\n            FirebaseStorage.instance.ref().child('user_profiles/$uid/avatar.jpg');\n\n        if (kIsWeb) {\n          final bytes = await picked.readAsBytes();\n          await storageRef.putData(\n            bytes,\n            SettableMetadata(contentType: picked.mimeType ?? 'image/jpeg'),\n          );\n        } else {\n          final file = File(picked.path);\n          await storageRef.putFile(\n            file,\n            SettableMetadata(contentType: 'image/jpeg'),\n          );\n        }\n\n        url = await storageRef.getDownloadURL();\n      }\n\n      await userProfileRepository.updateProfile(uid, photoUrl: url);\n      _loadedInitial = false;\n      if (mounted) {\n        photoUrlController.text = url;\n        ScaffoldMessenger.of(context).showSnackBar(\n          const SnackBar(content: Text('Đã cập nhật ảnh đại diện.')),\n        );\n      }\n    } catch (e) {\n      if (mounted) {\n        ScaffoldMessenger.of(context).showSnackBar(\n          SnackBar(content: Text('Lỗi tải ảnh: $e')),\n        );\n      }\n    } finally {\n      if (mounted) {\n        setState(() {\n          isUploading = false;\n        });\n      }\n    }\n  }\n\n  Future&lt;void&gt; _removePhoto(String uid) async {\n    setState(() {\n      isUploading = true;\n    });\n    try {\n      await userProfileRepository.updateProfile(\n        uid,\n        photoUrl: '',\n        removePhoto: true,\n      );\n      _loadedInitial = false;\n      if (mounted) {\n        photoUrlController.clear();\n        ScaffoldMessenger.of(context).showSnackBar(\n          const SnackBar(content: Text('Đã xoá ảnh đại diện.')),\n        );\n      }\n    } catch (e) {\n      if (mounted) {\n        ScaffoldMessenger.of(context).showSnackBar(\n          SnackBar(content: Text('Không thể xoá ảnh: $e')),\n        );\n      }\n    } finally {\n      if (mounted) {\n        setState(() {\n          isUploading = false;\n        });\n      }\n    }\n  }\n\n  Future&lt;void&gt; _showCreateChooser() async {\n    final action = await showModalBottomSheet&lt;_CreateAction&gt;(\n      context: context,\n      builder: (context) =&gt; SafeArea(\n        child: Column(\n          mainAxisSize: MainAxisSize.min,\n          children: [\n            ListTile(\n              leading: const Icon(Icons.history_edu),\n              title: const Text('Đăng story'),\n              onTap: () =&gt; Navigator.pop(context, _CreateAction.story),\n            ),\n            ListTile(\n              leading: const Icon(Icons.add_photo_alternate_outlined),\n              title: const Text('Thêm bài viết'),\n              onTap: () =&gt; Navigator.pop(context, _CreateAction.post),\n            ),\n          ],\n        ),\n      ),\n    );\n\n    if (!mounted || action == null) return;\n    switch (action) {\n      case _CreateAction.story:\n              Navigator.of(context).push(\n          MaterialPageRoute(builder: (_) =&gt; const StoryCreatePage()),\n        );\n        break;\n      case _CreateAction.post:\n              Navigator.of(context).push(\n          MaterialPageRoute(builder: (_) =&gt; const PostCreatePage()),\n        );\n        break;\n    }\n  }\n\n  Future&lt;void&gt; _showAccountMenu() async {\n    final action = await showModalBottomSheet&lt;_AccountMenuAction&gt;(\n      context: context,\n      builder: (context) =&gt; SafeArea(\n        child: Column(\n          mainAxisSize: MainAxisSize.min,\n          children: [\n            ListTile(\n              leading: const Icon(Icons.switch_account),\n              title: const Text('Chuyển tài khoản'),\n              onTap: () =&gt; Navigator.pop(context, _AccountMenuAction.switchAccount),\n            ),\n            ListTile(\n              leading: const Icon(Icons.logout),\n              title: const Text('Đăng xuất'),\n              onTap: () =&gt; Navigator.pop(context, _AccountMenuAction.logout),\n            ),\n          ],\n        ),\n      ),\n    );\n\n    if (!mounted || action == null) return;\n    switch (action) {\n      case _AccountMenuAction.switchAccount:\n        await _showSwitchAccountSheet();\n        break;\n      case _AccountMenuAction.logout:\n        await _confirmLogoutAndMaybeSave(\n          currentUser: authRepository.currentUser(),\n          forSwitchAccount: false,\n        );\n        break;\n    }\n  }\n\n  Future&lt;void&gt; _confirmLogoutAndMaybeSave({\n    User? currentUser,\n    bool forSwitchAccount = false,\n  }) async {\n    final user = currentUser ?? authRepository.currentUser();\n    if (user == null) return;\n\n    final choice = await showDialog&lt;_LogoutChoice&gt;(\n      context: context,\n      builder: (ctx) =&gt; AlertDialog(\n        title: const Text('Đăng xuất'),\n        content: const Text('Bạn có muốn lưu tài khoản này để chuyển đổi nhanh sau này không?'),\n        actions: [\n          TextButton(\n            onPressed: () =&gt; Navigator.pop(ctx, _LogoutChoice.signOutOnly),\n            child: const Text('Đăng xuất'),\n          ),\n          FilledButton(\n            onPressed: () =&gt; Navigator.pop(ctx, _LogoutChoice.saveAndSignOut),\n            child: const Text('Lưu tài khoản'),\n          ),\n        ],\n      ),\n    );\n\n    if (!mounted || choice == null) return;\n\n    if (choice == _LogoutChoice.saveAndSignOut) {\n      await SavedAccountsRepository.instance.saveAccountFromUser(user);\n      ScaffoldMessenger.of(context).showSnackBar(\n        const SnackBar(content: Text('Đã lưu tài khoản trên thiết bị.')),\n      );\n    } else {\n      await SavedAccountsRepository.instance.removeAccount(user.uid);\n      await SavedCredentialsRepository.instance.removePassword(user.uid);\n    }\n\n    await userProfileRepository.setPresence(user.uid, false);\n    // Với flow đăng xuất bình thường: set offline + signOut để quay về màn hình login/AuthGate\n    // Với flow chuyển đổi tài khoản: chỉ set offline, KHÔNG signOut, sẽ signIn tài khoản khác ngay sau đó\n    if (!forSwitchAccount) {\n      await authRepository.signOut();\n    }\n    if (mounted) {\n      Navigator.of(context).pop();\n    }\n  }\n\n  Future&lt;void&gt; _showSwitchAccountSheet() async {\n    final accounts = await SavedAccountsRepository.instance.getAccounts();\n    if (!mounted) return;\n\n    if (accounts.isEmpty) {\n      ScaffoldMessenger.of(context).showSnackBar(\n        const SnackBar(content: Text('Chưa có tài khoản nào được lưu trên thiết bị.')),\n      );\n      return;\n    }\n\n    final selected = await showModalBottomSheet&lt;SavedAccount&gt;(\n      context: context,\n      builder: (ctx) =&gt; SafeArea(\n        child: Column(\n          mainAxisSize: MainAxisSize.min,\n          children: [\n            const ListTile(\n              title: Text(\n                'Chuyển đổi tài khoản',\n                style: TextStyle(fontWeight: FontWeight.bold),\n              ),\n            ),\n            ...accounts.map(\n              (acc) =&gt; ListTile(\n                leading: CircleAvatar(\n                  backgroundImage:\n                      acc.photoUrl != null &amp;&amp; acc.photoUrl!.isNotEmpty ? NetworkImage(acc.photoUrl!) : null,\n                  child: acc.photoUrl == null || acc.photoUrl!.isEmpty\n                      ? const Icon(Icons.person)\n                      : null,\n                ),\n                title: Text(acc.displayName ?? acc.email ?? acc.uid),\n                subtitle: acc.email != null ? Text(acc.email!) : null,\n                onTap: () =&gt; Navigator.pop(ctx, acc),\n              ),\n            ),\n            const SizedBox(height: 8),\n          ],\n        ),\n      ),\n    );\n\n    if (!mounted || selected == null) return;\n\n    // Khi chọn tài khoản khác: hỏi có lưu tài khoản hiện tại không\n    final current = authRepository.currentUser();\n    if (current != null) {\n      await _confirmLogoutAndMaybeSave(\n        currentUser: current,\n        forSwitchAccount: true,\n      );\n    }\n\n    if (!mounted) return;\n\n    // Thử đăng nhập nhanh vào tài khoản đã lưu\n    final quickSuccess = await _quickSignInToSavedAccount(selected);\n\n    if (!mounted) return;\n\n    if (quickSuccess) {\n      // Điều hướng về AuthGate để toàn bộ app rebuild theo user mới\n      Navigator.of(context).pushAndRemoveUntil(\n                MaterialPageRoute(\n          builder: (_) =&gt; const AuthGate(),\n        ),\n        (route) =&gt; false,\n      );\n    } else {\n      // Fallback: chuyển sang màn hình login với email được điền sẵn\n      final identifier = selected.email ?? selected.displayName ?? selected.uid;\n      ScaffoldMessenger.of(context).showSnackBar(\n        const SnackBar(\n          content: Text(\n            'Tài khoản này chưa lưu mật khẩu an toàn. Vui lòng đăng nhập lại một lần.',\n          ),\n        ),\n      );\n      Navigator.of(context).pushAndRemoveUntil(\n                MaterialPageRoute(\n          builder: (_) =&gt; LoginScreen(initialIdentifier: identifier),\n        ),\n        (route) =&gt; false,\n      );\n    }\n  }\n\n  Future&lt;bool&gt; _quickSignInToSavedAccount(SavedAccount account) async {\n    try {\n      // Chỉ hỗ trợ auto-login nhanh cho tài khoản đăng nhập bằng email/mật khẩu\n      if (account.providerId == 'password' &amp;&amp; account.email != null) {\n        final password =\n            await SavedCredentialsRepository.instance.getPassword(account.uid);\n        if (password == null || password.isEmpty) {\n          return false;\n        }\n\n        // SignIn vào tài khoản mới\n        await authRepository.signInWithEmail(account.email!, password);\n\n        // Đợi auth state thay đổi để đảm bảo signIn hoàn tất\n        // Sử dụng Stream để đợi auth state change hoặc timeout sau 3 giây\n        final completer = Completer&lt;bool&gt;();\n        StreamSubscription&lt;User?&gt;? subscription;\n        Timer? timeoutTimer;\n\n        subscription = authRepository.authState().listen((user) {\n          if (user != null &amp;&amp; user.uid == account.uid) {\n            subscription?.cancel();\n            timeoutTimer?.cancel();\n            if (!completer.isCompleted) {\n              completer.complete(true);\n            }\n          }\n        });\n\n        // Timeout sau 3 giây nếu không nhận được auth state change\n        timeoutTimer = Timer(const Duration(seconds: 3), () {\n          subscription?.cancel();\n          final currentUser = authRepository.currentUser();\n          final success = currentUser != null &amp;&amp; currentUser.uid == account.uid;\n          if (!completer.isCompleted) {\n            completer.complete(success);\n          }\n        });\n\n        // Đợi kết quả\n        final result = await completer.future;\n        subscription.cancel();\n        timeoutTimer.cancel();\n\n        return result;\n      }\n      // Các provider khác (Google/Facebook) hiện tại không auto-login để tránh chọn sai account\n      return false;\n    } catch (_) {\n      return false;\n    }\n  }\n\n  /// Hiển thị bottom sheet khi chạm avatar trên trang hồ sơ\n  /// - Nếu người dùng có story (kể cả đã xem hết): thêm hành động \"Xem tin\"\n  /// - Dù có story hay không, luôn có tuỳ chọn \"Xem ảnh đại diện\" (nếu có ảnh)\n  void _handleAvatarTap(String uid, StoryRingStatus ringStatus) {\n    final hasStory = ringStatus != StoryRingStatus.none;\n\n    if (!hasStory) {\n      // Không có story -&gt; dùng sheet ảnh đại diện (vẫn có Xem ảnh đại diện)\n      _showAvatarOptions(uid);\n      return;\n    }\n\n    showModalBottomSheet(\n      context: context,\n      builder: (context) =&gt; SafeArea(\n        child: Column(\n          mainAxisSize: MainAxisSize.min,\n          children: [\n            ListTile(\n              leading: const Icon(Icons.history_edu),\n              title: const Text('Xem tin'),\n              onTap: () {\n                Navigator.pop(context);\n                Navigator.of(context).push(\n                  MaterialPageRoute(\n                    builder: (_) =&gt; StoryViewerPage(\n                      initialAuthorUid: uid,\n                      userIdsWithStories: [uid],\n                    ),\n                  ),\n                );\n              },\n            ),\n            if (photoUrlController.text.isNotEmpty)\n              ListTile(\n                leading: const Icon(Icons.remove_red_eye),\n                title: const Text('Xem ảnh đại diện'),\n                onTap: () {\n                  Navigator.pop(context);\n                  Navigator.of(context).push(\n                    MaterialPageRoute(\n                      builder: (_) =&gt; AvatarFullscreenViewer(\n                        photoUrl: photoUrlController.text,\n                      ),\n                    ),\n                  );\n                },\n              ),\n            ListTile(\n              leading: const Icon(Icons.photo_library),\n              title: const Text('Chọn ảnh từ thư viện'),\n              onTap: () {\n                Navigator.pop(context);\n                _pickAndUploadImage(uid, ImageSource.gallery);\n              },\n            ),\n            ListTile(\n              leading: const Icon(Icons.camera_alt),\n              title: const Text('Chụp ảnh'),\n              onTap: () {\n                Navigator.pop(context);\n                _pickAndUploadImage(uid, ImageSource.camera);\n              },\n            ),\n            if (photoUrlController.text.isNotEmpty)\n              ListTile(\n                leading: const Icon(Icons.delete_outline, color: Colors.red),\n                title: const Text(\n                  'Xoá ảnh đại diện',\n                  style: TextStyle(color: Colors.red),\n                ),\n                onTap: () {\n                  Navigator.pop(context);\n                  _removePhoto(uid);\n                },\n              ),\n          ],\n        ),\n      ),\n    );\n  }\n\n  void _showAvatarOptions(String uid) {\n    showModalBottomSheet(\n      context: context,\n      builder: (context) =&gt; SafeArea(\n        child: Column(\n          mainAxisSize: MainAxisSize.min,\n          children: [\n            if (photoUrlController.text.isNotEmpty)\n              ListTile(\n                leading: const Icon(Icons.remove_red_eye),\n                title: const Text('Xem ảnh đại diện'),\n                onTap: () {\n                  Navigator.pop(context);\n                  Navigator.of(context).push(\n                    MaterialPageRoute(\n                      builder: (_) =&gt; AvatarFullscreenViewer(\n                        photoUrl: photoUrlController.text,\n                      ),\n                    ),\n                  );\n                },\n              ),\n            ListTile(\n              leading: const Icon(Icons.photo_library),\n              title: const Text('Chọn ảnh từ thư viện'),\n              onTap: () {\n                Navigator.pop(context);\n                _pickAndUploadImage(uid, ImageSource.gallery);\n              },\n            ),\n            ListTile(\n              leading: const Icon(Icons.camera_alt),\n              title: const Text('Chụp ảnh'),\n              onTap: () {\n                Navigator.pop(context);\n                _pickAndUploadImage(uid, ImageSource.camera);\n              },\n            ),\n            if (photoUrlController.text.isNotEmpty)\n              ListTile(\n                leading: const Icon(Icons.delete_outline, color: Colors.red),\n                title: const Text('Xoá ảnh đại diện', style: TextStyle(color: Colors.red)),\n                onTap: () {\n                  Navigator.pop(context);\n                  _removePhoto(uid);\n                },\n              ),\n          ],\n        ),\n      ),\n    );\n  }\n\n  String _formatLastSeen(DateTime lastSeen) {\n    final diff = DateTime.now().difference(lastSeen);\n    if (diff.inMinutes &lt; 1) {\n      return 'Vừa mới hoạt động';\n    } else if (diff.inHours &lt; 1) {\n      return 'Hoạt động ${diff.inMinutes} phút trước';\n    } else if (diff.inDays &lt; 1) {\n      return 'Hoạt động ${diff.inHours} giờ trước';\n    } else {\n      return 'Hoạt động ${diff.inDays} ngày trước';\n    }\n  }\n\n  @override\n  Widget build(BuildContext context) {\n    final user = authRepository.currentUser();\n    if (user == null) {\n      return const Scaffold(\n        body: Center(child: Text('Không tìm thấy người dùng.')),\n      );\n    }\n\n    return Scaffold(\n      appBar: AppBar(\n        title: const Text(\n          'Hồ sơ của bạn',\n          style: TextStyle(color: AppColors.primaryPink),\n        ),\n        iconTheme: const IconThemeData(color: AppColors.primaryPink),\n        actions: [\n          IconButton(\n            icon: const Icon(Icons.menu),\n            onPressed: () {\n              _showProfileOptionsSheet(user);\n            },\n          ),\n        ],\n      ),\n      body: StreamBuilder&lt;UserProfile?&gt;(\n        stream: userProfileRepository.watchProfile(user.uid),\n        builder: (context, snapshot) {\n          final profile = snapshot.data;\n          if (!_loadedInitial &amp;&amp; profile != null) {\n            displayNameController.text = profile.displayName ?? '';\n            photoUrlController.text = profile.photoUrl ?? '';\n            bioController.text = profile.bio ?? '';\n          noteController.text = profile.note ?? '';\n            _isPrivate = profile.isPrivate;\n            _themeColor = profile.themeColor;\n            _links = List&lt;ProfileLink&gt;.from(profile.links);\n            _loadedInitial = true;\n          }\n\n          final themeColor = _themeColor != null ? _parseColor(_themeColor!) : null;\n          final displayName = displayNameController.text.isNotEmpty\n              ? displayNameController.text\n              : (user.email ?? user.uid);\n          final statusText = profile?.isOnline == true\n              ? 'Đang hoạt động'\n              : profile?.lastSeen != null\n                  ? _formatLastSeen(profile!.lastSeen!)\n                  : 'Ngoại tuyến';\n\n          return SingleChildScrollView(\n            padding: const EdgeInsets.symmetric(horizontal: 16, vertical: 20),\n            child: Column(\n              crossAxisAlignment: CrossAxisAlignment.stretch,\n              children: [\n                FutureBuilder&lt;StoryRingStatus&gt;(\n                  future: StoryRepository().fetchStoryRingStatus(\n                    ownerUid: user.uid,\n                    viewerUid: user.uid,\n                  ),\n                  builder: (context, ringSnapshot) {\n                    final ringStatus =\n                        ringSnapshot.data ?? StoryRingStatus.none;\n                    final hasActiveStory =\n                        ringStatus != StoryRingStatus.none;\n                    Color? ringColor;\n                    if (ringStatus == StoryRingStatus.unseen) {\n                      ringColor = AppColors.primaryPink;\n                    } else if (ringStatus == StoryRingStatus.allSeen) {\n                      // Vòng tròn xám đậm hơn để dễ thấy khi đã xem hết story\n                      ringColor = Colors.grey.shade600;\n                    }\n\n                    return _EditProfileHeader(\n                      displayName: displayName,\n                      photoUrl: photoUrlController.text,\n                      statusText: statusText,\n                      themeColor: themeColor,\n                      isUploading: isUploading,\n                      hasActiveStory: hasActiveStory,\n                      storyRingColor: ringColor,\n                      onAddPressed: _showCreateChooser,\n                      onAccountMenuPressed: _showAccountMenu,\n                      // Khi chạm avatar: mở sheet mới với tuỳ chọn xem tin + đổi ảnh\n                      onAvatarTap: () =&gt; _handleAvatarTap(user.uid, ringStatus),\n                      note: noteController.text,\n                      onNoteTap: () =&gt; _showEditNoteDialog(user.uid),\n                    );\n                  },\n                ),\n                const SizedBox(height: 16),\n                if (profile != null) ...[\n                  Row(\n                    mainAxisAlignment: MainAxisAlignment.spaceEvenly,\n                    children: [\n                      _StatChip(\n                        label: 'Người theo dõi',\n                        value: profile.followersCount,\n                      ),\n                      _StatChip(\n                        label: 'Đang theo dõi',\n                        value: profile.followingCount,\n                      ),\n                    ],\n                  ),\n                  const SizedBox(height: 24),\n                ],\n                // Highlight Stories section\n                StreamBuilder&lt;UserProfile?&gt;(\n                  stream: userProfileRepository.watchProfile(user.uid),\n                  builder: (context, profileSnapshot) {\n                    final profile = profileSnapshot.data;\n                    final highlightedStories = profile?.highlightedStories ?? [];\n                    if (highlightedStories.isEmpty) {\n                      return const SizedBox.shrink();\n                    }\n                    return StreamBuilder&lt;List&lt;Story&gt;&gt;(\n                      stream: StoryRepository().fetchStoriesByAuthor(user.uid),\n                      builder: (context, storiesSnapshot) {\n                        final allStories = storiesSnapshot.data ?? [];\n                        \n                        // Filter highlights để chỉ hiển thị những highlight có ít nhất 1 story tồn tại\n                        final validHighlights = highlightedStories\n                            .where((h) =&gt; h.storyIds.any((id) =&gt;\n                                allStories.any((s) =&gt; s.id == id)))\n                            .toList();\n                        \n                        if (validHighlights.isEmpty) {\n                          return const SizedBox.shrink();\n                        }\n                        \n                        return Column(\n                          crossAxisAlignment: CrossAxisAlignment.start,\n                          children: [\n                            const Padding(\n                              padding: EdgeInsets.symmetric(horizontal: 4),\n                              child: Row(\n                                children: [\n                                  Icon(Icons.auto_awesome, size: 20, color: Colors.purple),\n                                  SizedBox(width: 8),\n                                  Text(\n                                    'Highlight Stories',\n                                    style: TextStyle(\n                                      fontSize: 16,\n                                      fontWeight: FontWeight.bold,\n                                    ),\n                                  ),\n                                ],\n                              ),\n                            ),\n                            const SizedBox(height: 8),\n                            SizedBox(\n                              height: 100,\n                              child: ListView.builder(\n                                scrollDirection: Axis.horizontal,\n                                padding: const EdgeInsets.symmetric(horizontal: 4),\n                                itemCount: validHighlights.length,\n                                itemBuilder: (context, index) {\n                                  final highlight = validHighlights[index];\n                                  final highlightStories = allStories\n                                      .where((s) =&gt; highlight.storyIds.contains(s.id))\n                                      .toList();\n                                  if (highlightStories.isEmpty) {\n                                    return const SizedBox.shrink();\n                                  }\n                                  return _HighlightStoryBubble(\n                                    highlight: highlight,\n                                    firstStory: highlightStories.first,\n                                    authorUid: user.uid,\n                                    onTap: () {\n                                      // Navigate to story viewer với stories của highlight\n                                      Navigator.of(context).push(\n                                        MaterialPageRoute(\n                                          builder: (_) =&gt; StoryViewerPage(\n                                            initialAuthorUid: user.uid,\n                                            userIdsWithStories: [user.uid],\n                                            initialStoryIds: highlight.storyIds,\n                                            highlightId: highlight.id,\n                                          ),\n                                        ),\n                                      );\n                                    },\n                                  );\n                                },\n                              ),\n                            ),\n                            const SizedBox(height: 16),\n                          ],\n                        );\n                      },\n                    );\n                  },\n                ),\n                // Pinned posts section\n                if (_pinnedPosts.isNotEmpty) ...[\n                const SizedBox(height: 8),\n                  const Padding(\n                    padding: EdgeInsets.symmetric(horizontal: 4),\n                    child: Row(\n                      children: [\n                        Icon(Icons.push_pin, size: 20, color: Colors.orange),\n                        SizedBox(width: 8),\n                        Text(\n                          'Bài viết đã ghim',\n                  style: TextStyle(\n                            fontSize: 16,\n                    fontWeight: FontWeight.bold,\n                  ),\n                ),\n                      ],\n                    ),\n                  ),\n                  const SizedBox(height: 8),\n                  SizedBox(\n                    height: 120,\n                    child: ListView.builder(\n                      scrollDirection: Axis.horizontal,\n                      padding: const EdgeInsets.symmetric(horizontal: 4),\n                      itemCount: _pinnedPosts.length,\n                      itemBuilder: (context, index) {\n                        final post = _pinnedPosts[index];\n                        return ProfilePinnedPostItem(\n                          post: post,\n                          onTap: () {\n                            Navigator.of(context).push(\n                              MaterialPageRoute(\n                                builder: (_) =&gt; PostPermalinkPage(postId: post.id),\n                              ),\n                            );\n                          },\n                        );\n                      },\n                    ),\n                  ),\n                  const SizedBox(height: 16),\n                ],\n                // Posts grid section\n                const Padding(\n                  padding: EdgeInsets.symmetric(horizontal: 4),\n                  child: Row(\n                    children: [\n                      Icon(Icons.grid_on, size: 20),\n                      SizedBox(width: 8),\n                      Text(\n                        'Bài viết',\n                        style: TextStyle(\n                          fontSize: 16,\n                          fontWeight: FontWeight.bold,\n                        ),\n                      ),\n                    ],\n                  ),\n                ),\n                const SizedBox(height: 8),\n                if (_isLoadingPosts)\n                  const Padding(\n                    padding: EdgeInsets.all(32),\n                    child: Center(child: CircularProgressIndicator()),\n                  )\n                else if (_allPosts.isEmpty)\n                  const Padding(\n                    padding: EdgeInsets.all(32),\n                    child: Center(\n                      child: Text(\n                        'Chưa có bài viết nào',\n                        style: TextStyle(color: Colors.grey),\n                      ),\n                    ),\n                  )\n                else\n                  GridView.builder(\n                    shrinkWrap: true,\n                    physics: const NeverScrollableScrollPhysics(),\n                    padding: const EdgeInsets.all(8),\n                    gridDelegate: const SliverGridDelegateWithFixedCrossAxisCount(\n                      crossAxisCount: 3,\n                      crossAxisSpacing: 4,\n                      mainAxisSpacing: 4,\n                    ),\n                    itemCount: _allPosts.length,\n                    itemBuilder: (context, index) {\n                      final post = _allPosts[index];\n                      return ProfilePostGridItem(\n                        post: post,\n                        onTap: () {\n                          Navigator.of(context).push(\n                            MaterialPageRoute(\n                              builder: (_) =&gt; PostPermalinkPage(postId: post.id),\n                            ),\n                          );\n                        },\n                      );\n                    },\n                  ),\n                // Follow requests section\n                if (profile != null &amp;&amp; _isPrivate)\n                  StreamBuilder&lt;List&lt;FollowRequestEntry&gt;&gt;(\n                    stream: _followService.watchIncomingRequestEntries(user.uid),\n                    builder: (context, requestSnapshot) {\n                      final requests = requestSnapshot.data ?? [];\n                      if (requests.isEmpty) {\n                          return const SizedBox.shrink();\n                        }\n                      return Card(\n                        child: Padding(\n                          padding: const EdgeInsets.all(16),\n                          child: Column(\n                        crossAxisAlignment: CrossAxisAlignment.start,\n                        children: [\n                              Row(\n                                children: [\n                                  const Icon(Icons.person_add, color: AppColors.primaryPink),\n                                  const SizedBox(width: 8),\n                                  Text(\n                                    'Yêu cầu theo dõi (${requests.length})',\n                                    style: const TextStyle(\n                              fontSize: 16,\n                                      fontWeight: FontWeight.bold,\n                            ),\n                          ),\n                                ],\n                              ),\n                              const SizedBox(height: 12),\n                          ...requests.map(\n                            (entry) =&gt; Card(\n                                  margin: const EdgeInsets.only(bottom: 8),\n                              child: ListTile(\n                                leading: CircleAvatar(\n                                      backgroundImage: entry.profile?.photoUrl != null\n                                      ? NetworkImage(entry.profile!.photoUrl!)\n                                      : null,\n                                  child: entry.profile?.photoUrl == null\n                                      ? const Icon(Icons.person)\n                                      : null,\n                                ),\n                                title: Text(\n                                      entry.profile?.displayName?.isNotEmpty == true\n                                      ? entry.profile!.displayName!\n                                          : (entry.profile?.email?.isNotEmpty == true\n                                          ? entry.profile!.email!\n                                          : entry.uid),\n                                ),\n                                subtitle: entry.createdAt != null\n                                        ? Text('Yêu cầu lúc ${entry.createdAt}')\n                                    : null,\n                                    trailing: Row(\n                                      mainAxisSize: MainAxisSize.min,\n                                  children: [\n                                    TextButton(\n                                          onPressed: () =&gt; _followService.acceptRequest(entry.uid),\n                                          style: TextButton.styleFrom(\n                                            foregroundColor: Colors.green,\n                                          ),\n                                      child: const Text('Chấp nhận'),\n                                    ),\n                                    TextButton(\n                                          onPressed: () =&gt; _followService.declineRequest(entry.uid),\n                                          style: TextButton.styleFrom(\n                                            foregroundColor: Colors.red,\n                                          ),\n                                      child: const Text('Từ chối'),\n                                    ),\n                                  ],\n                                ),\n                              ),\n                            ),\n                          ),\n                        ],\n                          ),\n                        ),\n                      );\n                    },\n                  ),\n              ],\n            ),\n          );\n        },\n      ),\n    );\n  }\n\n  Color _parseColor(String hexColor) {\n    try {\n      return Color(int.parse(hexColor.replaceFirst('#', '0xFF')));\n    } catch (e) {\n      return Colors.blue;\n    }\n  }\n\n  void _showColorPicker(BuildContext context) {\n    final presetColors = [\n      '#FF5733', '#33FF57', '#3357FF', '#FF33F5', '#F5FF33',\n      '#33FFF5', '#FF8C33', '#8C33FF', '#33FF8C', '#FF3333',\n      '#33FF33', '#3333FF', '#FFFF33', '#FF33FF', '#33FFFF',\n    ];\n\n    showModalBottomSheet(\n      context: context,\n      builder: (context) =&gt; Container(\n        padding: const EdgeInsets.all(16),\n        child: Column(\n          mainAxisSize: MainAxisSize.min,\n          crossAxisAlignment: CrossAxisAlignment.start,\n          children: [\n            const Text(\n              'Chọn màu chủ đạo',\n              style: TextStyle(fontSize: 18, fontWeight: FontWeight.bold),\n            ),\n            const SizedBox(height: 16),\n            Wrap(\n              spacing: 12,\n              runSpacing: 12,\n              children: [\n                // Preset colors\n                ...presetColors.map((color) {\n                  return GestureDetector(\n                    onTap: () {\n                      setState(() {\n                        _themeColor = color;\n                      });\n                      Navigator.pop(context);\n                    },\n                    child: Container(\n                      width: 48,\n                      height: 48,\n                      decoration: BoxDecoration(\n                        color: _parseColor(color),\n                        shape: BoxShape.circle,\n                        border: Border.all(color: Colors.grey.shade300),\n                      ),\n                    ),\n                  );\n                }),\n                // Custom color picker (simple text input)\n                GestureDetector(\n                  onTap: () =&gt; _showCustomColorDialog(context),\n                  child: Container(\n                    width: 48,\n                    height: 48,\n                    decoration: BoxDecoration(\n                      color: Colors.grey.shade200,\n                      shape: BoxShape.circle,\n                      border: Border.all(color: Colors.grey.shade300),\n                    ),\n                    child: const Icon(Icons.tune),\n                  ),\n                ),\n              ],\n            ),\n            const SizedBox(height: 16),\n            TextButton(\n              onPressed: () {\n                setState(() {\n                  _themeColor = null;\n                });\n                Navigator.pop(context);\n              },\n              child: const Text('Xóa màu'),\n            ),\n          ],\n        ),\n      ),\n    );\n  }\n\n  void _showCustomColorDialog(BuildContext context) {\n    final controller = TextEditingController(text: _themeColor ?? '#');\n    showDialog(\n      context: context,\n      builder: (context) =&gt; AlertDialog(\n        title: const Text('Màu tùy chỉnh'),\n        content: TextField(\n          controller: controller,\n          decoration: const InputDecoration(\n            labelText: 'Mã màu hex (ví dụ: #FF5733)',\n            hintText: '#FF5733',\n          ),\n        ),\n        actions: [\n          TextButton(\n            onPressed: () =&gt; Navigator.pop(context),\n            child: const Text('Hủy'),\n          ),\n          FilledButton(\n            onPressed: () {\n              final color = controller.text.trim();\n              if (color.isNotEmpty &amp;&amp; color.startsWith('#')) {\n                try {\n                  _parseColor(color); // Validate\n                  setState(() {\n                    _themeColor = color;\n                  });\n                  Navigator.pop(context);\n                  Navigator.pop(context); // Close color picker too\n                } catch (e) {\n                  ScaffoldMessenger.of(context).showSnackBar(\n                    const SnackBar(content: Text('Mã màu không hợp lệ')),\n                  );\n                }\n              } else {\n                ScaffoldMessenger.of(context).showSnackBar(\n                  const SnackBar(content: Text('Mã màu phải bắt đầu bằng #')),\n                );\n              }\n            },\n            child: const Text('Lưu'),\n          ),\n        ],\n      ),\n    );\n  }\n\n  void _showAddLinkDialog(BuildContext context) {\n    final labelController = TextEditingController();\n    final urlController = TextEditingController();\n\n    showDialog(\n      context: context,\n      builder: (context) =&gt; AlertDialog(\n        title: const Text('Thêm liên kết'),\n        content: Column(\n          mainAxisSize: MainAxisSize.min,\n          children: [\n            TextField(\n              controller: labelController,\n              decoration: const InputDecoration(\n                labelText: 'Nhãn (ví dụ: Website, Instagram)',\n              ),\n            ),\n            const SizedBox(height: 12),\n            TextField(\n              controller: urlController,\n              decoration: const InputDecoration(\n                labelText: 'URL',\n                hintText: 'https://example.com',\n              ),\n              keyboardType: TextInputType.url,\n            ),\n          ],\n        ),\n        actions: [\n          TextButton(\n            onPressed: () =&gt; Navigator.pop(context),\n            child: const Text('Hủy'),\n          ),\n          FilledButton(\n            onPressed: () {\n              final label = labelController.text.trim();\n              final url = urlController.text.trim();\n              if (label.isEmpty || url.isEmpty) {\n                ScaffoldMessenger.of(context).showSnackBar(\n                  const SnackBar(content: Text('Vui lòng điền đầy đủ thông tin')),\n                );\n                return;\n              }\n              if (!url.startsWith('http://') &amp;&amp; !url.startsWith('https://')) {\n                ScaffoldMessenger.of(context).showSnackBar(\n                  const SnackBar(content: Text('URL phải bắt đầu bằng http:// hoặc https://')),\n                );\n                return;\n              }\n              setState(() {\n                _links.add(ProfileLink(url: url, label: label));\n              });\n              Navigator.pop(context);\n            },\n            child: const Text('Thêm'),\n          ),\n        ],\n      ),\n    );\n  }\n\n  Future&lt;void&gt; _showEditNoteDialog(String uid) async {\n    final controller = TextEditingController(text: noteController.text);\n    final result = await showDialog&lt;String&gt;(\n      context: context,\n      builder: (context) =&gt; AlertDialog(\n        title: const Text('Cập nhật ghi chú'),\n        content: TextField(\n          controller: controller,\n          maxLength: 50,\n          decoration: const InputDecoration(\n            hintText: 'Nhập ghi chú (tối đa 50 ký tự)',\n          ),\n        ),\n        actions: [\n          TextButton(\n            onPressed: () =&gt; Navigator.pop(context),\n            child: const Text('Hủy'),\n          ),\n          FilledButton(\n            onPressed: () {\n              final text = controller.text.trim();\n              if (text.length &gt; 50) {\n                ScaffoldMessenger.of(context).showSnackBar(\n                  const SnackBar(\n                    content: Text('Ghi chú tối đa 50 ký tự'),\n                  ),\n                );\n                return;\n              }\n              Navigator.pop(context, text);\n            },\n            child: const Text('Lưu'),\n          ),\n        ],\n      ),\n    );\n\n    if (result == null) return;\n\n    try {\n      await userProfileRepository.updateProfile(uid, note: result);\n      setState(() {\n        noteController.text = result;\n      });\n      if (mounted) {\n        ScaffoldMessenger.of(context).showSnackBar(\n          const SnackBar(content: Text('Đã cập nhật ghi chú.')),\n        );\n      }\n    } catch (e) {\n      if (!mounted) return;\n      ScaffoldMessenger.of(context).showSnackBar(\n        SnackBar(content: Text('Không thể cập nhật ghi chú: $e')),\n      );\n    }\n  }\n\n  Future&lt;void&gt; _handleMenuAction(_ProfileMenuAction action) async {\n    final user = authRepository.currentUser();\n    if (user == null) return;\n\n    switch (action) {\n      case _ProfileMenuAction.personalInfo:\n        await _showPersonalInfoModal(user.uid);\n        break;\n      case _ProfileMenuAction.privateAccount:\n        await _togglePrivateAccount(user.uid);\n        break;\n      case _ProfileMenuAction.highlightStories:\n        await Navigator.of(context).push(\n          MaterialPageRoute(\n            builder: (_) =&gt; ManageHighlightStoriesPage(uid: user.uid),\n          ),\n        );\n        break;\n      case _ProfileMenuAction.privacySettings:\n        await Navigator.of(context).push(\n          MaterialPageRoute(builder: (_) =&gt; PrivacySettingsPage()),\n        );\n        break;\n      case _ProfileMenuAction.savedPosts:\n        await Navigator.of(context).push(\n          MaterialPageRoute(builder: (_) =&gt; const SavedPostsPage()),\n        );\n        break;\n      case _ProfileMenuAction.changePassword:\n        await Navigator.of(context).push(\n          MaterialPageRoute(builder: (_) =&gt; const ChangePasswordPage()),\n        );\n        break;\n      case _ProfileMenuAction.adminDashboard:\n        await Navigator.of(context).push(\n          MaterialPageRoute(builder: (_) =&gt; const AdminDashboardPage()),\n        );\n        break;\n      case _ProfileMenuAction.logout:\n        await _confirmLogoutAndMaybeSave(currentUser: user);\n        break;\n    }\n  }\n\n  Future&lt;void&gt; _showPersonalInfoModal(String uid) async {\n    final displayNameCtrl = TextEditingController(text: displayNameController.text);\n    final bioCtrl = TextEditingController(text: bioController.text);\n    final photoUrlCtrl = TextEditingController(text: photoUrlController.text);\n\n    await showDialog(\n      context: context,\n      builder: (context) =&gt; AlertDialog(\n        title: const Text('Thông tin cá nhân'),\n        content: SingleChildScrollView(\n          child: Column(\n            mainAxisSize: MainAxisSize.min,\n            children: [\n              TextField(\n                controller: displayNameCtrl,\n                decoration: const InputDecoration(\n                  labelText: 'Tên hiển thị',\n                  prefixIcon: Icon(Icons.person),\n                ),\n              ),\n              const SizedBox(height: 16),\n              TextField(\n                controller: bioCtrl,\n                minLines: 1,\n                maxLines: 4,\n                decoration: const InputDecoration(\n                  labelText: 'Tiểu sử (bio)',\n                  prefixIcon: Icon(Icons.description),\n                ),\n              ),\n              const SizedBox(height: 16),\n              TextField(\n                controller: photoUrlCtrl,\n                decoration: const InputDecoration(\n                  labelText: 'Ảnh đại diện (URL)',\n                  prefixIcon: Icon(Icons.image),\n                ),\n              ),\n              const SizedBox(height: 16),\n              OutlinedButton.icon(\n                onPressed: () {\n                  Navigator.pop(context);\n                  _showAvatarOptions(uid);\n                },\n                icon: const Icon(Icons.photo_library),\n                label: const Text('Chọn ảnh từ thiết bị'),\n              ),\n            ],\n          ),\n        ),\n        actions: [\n          TextButton(\n            onPressed: () =&gt; Navigator.pop(context),\n            child: const Text('Hủy'),\n          ),\n          FilledButton(\n            onPressed: () async {\n              Navigator.pop(context);\n              displayNameController.text = displayNameCtrl.text;\n              bioController.text = bioCtrl.text;\n              photoUrlController.text = photoUrlCtrl.text;\n              await _saveProfile(uid);\n            },\n            child: const Text('Lưu'),\n          ),\n        ],\n      ),\n    );\n  }\n\n  Future&lt;void&gt; _togglePrivateAccount(String uid) async {\n    final newValue = !_isPrivate;\n    setState(() {\n      _isPrivate = newValue;\n    });\n    try {\n      await userProfileRepository.updateProfile(uid, isPrivate: newValue);\n      if (mounted) {\n        ScaffoldMessenger.of(context).showSnackBar(\n          SnackBar(\n            content: Text(\n              newValue\n                  ? 'Đã bật tài khoản riêng tư'\n                  : 'Đã tắt tài khoản riêng tư',\n            ),\n          ),\n        );\n      }\n    } catch (e) {\n      setState(() {\n        _isPrivate = !newValue;\n      });\n      if (mounted) {\n        ScaffoldMessenger.of(context).showSnackBar(\n          SnackBar(content: Text('Lỗi cập nhật: $e')),\n        );\n      }\n    }\n  }\n\n  Future&lt;void&gt; _showCustomizationModal(String uid) async {\n    await showDialog(\n      context: context,\n      builder: (context) =&gt; AlertDialog(\n        title: const Text('Tùy biến'),\n        content: SingleChildScrollView(\n          child: Column(\n            mainAxisSize: MainAxisSize.min,\n            crossAxisAlignment: CrossAxisAlignment.start,\n            children: [\n              ListTile(\n                contentPadding: EdgeInsets.zero,\n                title: const Text('Màu chủ đạo'),\n                subtitle: Text(_themeColor ?? 'Chưa chọn màu'),\n                trailing: Row(\n                  mainAxisSize: MainAxisSize.min,\n                  children: [\n                    if (_themeColor != null)\n                      Container(\n                        width: 32,\n                        height: 32,\n                        decoration: BoxDecoration(\n                          color: _parseColor(_themeColor!),\n                          shape: BoxShape.circle,\n                          border: Border.all(color: Colors.grey),\n                        ),\n                      ),\n                    const SizedBox(width: 8),\n                    IconButton(\n                      icon: const Icon(Icons.color_lens, color: AppColors.primaryPink),\n                      onPressed: () {\n                        Navigator.pop(context);\n                        _showColorPicker(context);\n                      },\n                    ),\n                    if (_themeColor != null)\n                      IconButton(\n                        icon: const Icon(Icons.clear),\n                        onPressed: () {\n                          setState(() {\n                            _themeColor = null;\n                          });\n                          Navigator.pop(context);\n                          _saveProfile(uid);\n                        },\n                      ),\n                  ],\n                ),\n              ),\n              const SizedBox(height: 16),\n              const Text(\n                'Liên kết ngoài',\n                style: TextStyle(fontWeight: FontWeight.w600),\n              ),\n              const SizedBox(height: 8),\n              if (_links.isEmpty)\n                const Text(\n                  'Chưa có liên kết nào',\n                  style: TextStyle(color: Colors.grey),\n                )\n              else\n                Wrap(\n                  spacing: 8,\n                  runSpacing: 8,\n                  children: _links.asMap().entries.map((entry) {\n                    final index = entry.key;\n                    final link = entry.value;\n                    return Chip(\n                      label: Text(link.label),\n                      deleteIcon: const Icon(Icons.close, size: 18),\n                      onDeleted: () {\n                        setState(() {\n                          _links.removeAt(index);\n                        });\n                        _saveProfile(uid);\n                      },\n                    );\n                  }).toList(),\n                ),\n              if (_links.length &lt; 5) ...[\n                const SizedBox(height: 8),\n                OutlinedButton.icon(\n                  onPressed: () {\n                    Navigator.pop(context);\n                    _showAddLinkDialog(context);\n                  },\n                  icon: const Icon(Icons.add, color: AppColors.primaryPink),\n                  label: const Text('Thêm liên kết'),\n                ),\n              ],\n            ],\n          ),\n        ),\n        actions: [\n          TextButton(\n            onPressed: () =&gt; Navigator.pop(context),\n            child: const Text('Đóng'),\n          ),\n        ],\n      ),\n    );\n  }\n\n  void _showProfileOptionsSheet(User user) {\n    showModalBottomSheet(\n      context: context,\n      builder: (context) =&gt; SafeArea(\n        child: Column(\n          mainAxisSize: MainAxisSize.min,\n          children: [\n            const ListTile(\n              title: Text(\n                'Tùy chọn tài khoản',\n                style: TextStyle(fontWeight: FontWeight.bold),\n              ),\n            ),\n            ListTile(\n              leading: const Icon(Icons.person, color: AppColors.primaryPink),\n              title: const Text('Thông tin cá nhân'),\n              trailing: const Icon(Icons.chevron_right),\n              onTap: () {\n                Navigator.pop(context);\n                _handleMenuAction(_ProfileMenuAction.personalInfo);\n              },\n            ),\n            ListTile(\n              leading: const Icon(Icons.lock_outline, color: AppColors.primaryPink),\n              title: const Text('Tài khoản riêng tư'),\n              trailing: StreamBuilder&lt;UserProfile?&gt;(\n                stream: userProfileRepository.watchProfile(user.uid),\n                builder: (context, snapshot) {\n                  final isPrivate = snapshot.data?.isPrivate ?? false;\n                  return Switch(\n                    value: isPrivate,\n                    onChanged: (value) {\n                      Navigator.pop(context);\n                      _handleMenuAction(_ProfileMenuAction.privateAccount);\n                    },\n                  );\n                },\n              ),\n            ),\n            ListTile(\n              leading: const Icon(Icons.auto_awesome, color: AppColors.primaryPink),\n              title: const Text('Highlight Stories'),\n              trailing: const Icon(Icons.chevron_right),\n              onTap: () {\n                Navigator.pop(context);\n                _handleMenuAction(_ProfileMenuAction.highlightStories);\n              },\n            ),\n            const Divider(),\n            ListTile(\n              leading: const Icon(Icons.privacy_tip, color: AppColors.primaryPink),\n              title: const Text('Quyền riêng tư'),\n              trailing: const Icon(Icons.chevron_right),\n              onTap: () {\n                Navigator.pop(context);\n                _handleMenuAction(_ProfileMenuAction.privacySettings);\n              },\n            ),\n            ListTile(\n              leading: const Icon(Icons.bookmark, color: AppColors.primaryPink),\n              title: const Text('Đã lưu'),\n              trailing: const Icon(Icons.chevron_right),\n              onTap: () {\n                Navigator.pop(context);\n                _handleMenuAction(_ProfileMenuAction.savedPosts);\n              },\n            ),\n            if (user.email != null &amp;&amp;\n                user.providerData.any((p) =&gt; p.providerId == 'password'))\n              ListTile(\n                leading: const Icon(Icons.lock, color: AppColors.primaryPink),\n                title: const Text('Đổi mật khẩu'),\n                trailing: const Icon(Icons.chevron_right),\n                onTap: () {\n                  Navigator.pop(context);\n                  _handleMenuAction(_ProfileMenuAction.changePassword);\n                },\n              ),\n            if (_isAdmin)\n              ListTile(\n                leading:\n                    const Icon(Icons.admin_panel_settings, color: AppColors.primaryPink),\n                title: const Text('Admin Dashboard'),\n                trailing: const Icon(Icons.chevron_right),\n                onTap: () {\n                  Navigator.pop(context);\n                  _handleMenuAction(_ProfileMenuAction.adminDashboard);\n                },\n              ),\n          ],\n        ),\n      ),\n    );\n  }\n}\n\nclass _EditProfileHeader extends StatelessWidget {\n  const _EditProfileHeader({\n    required this.displayName,\n    required this.photoUrl,\n    required this.statusText,\n    required this.onAddPressed,\n    required this.onAccountMenuPressed,\n    required this.onAvatarTap,\n    required this.note,\n    required this.onNoteTap,\n    required this.hasActiveStory,\n    required this.storyRingColor,\n    this.themeColor,\n    this.isUploading = false,\n  });\n\n  final String displayName;\n  final String photoUrl;\n  final String statusText;\n  final String note;\n  final Color? themeColor;\n  final bool isUploading;\n  final VoidCallback onAddPressed;\n  final VoidCallback onAccountMenuPressed;\n  final VoidCallback onAvatarTap;\n  final VoidCallback onNoteTap;\n  final bool hasActiveStory;\n  final Color? storyRingColor;\n\n  @override\n  Widget build(BuildContext context) {\n    return Column(\n      crossAxisAlignment: CrossAxisAlignment.stretch,\n      children: [\n        Center(\n          child: Row(\n            mainAxisSize: MainAxisSize.min,\n            children: [\n              // Icon ảo bên trái để cân đối layout, không nhận tương tác\n              IgnorePointer(\n                child: Opacity(\n                  opacity: 0,\n                  child: IconButton(\n                    onPressed: () {},\n                    icon: const Icon(Icons.keyboard_arrow_down, size: 22),\n                    padding: EdgeInsets.zero,\n                    constraints: const BoxConstraints(),\n                    splashRadius: 20,\n                  ),\n                ),\n              ),\n              const SizedBox(width: 6),\n              Flexible(\n                child: Text(\n                  displayName,\n                  style: const TextStyle(\n                    fontSize: 20,\n                    fontWeight: FontWeight.w800,\n                  ),\n                  maxLines: 1,\n                  overflow: TextOverflow.ellipsis,\n                  textAlign: TextAlign.center,\n                ),\n              ),\n              const SizedBox(width: 6),\n              IconButton(\n                onPressed: onAccountMenuPressed,\n                icon: const Icon(Icons.keyboard_arrow_down, size: 22),\n                padding: EdgeInsets.zero,\n                constraints: const BoxConstraints(),\n                splashRadius: 20,\n              ),\n            ],\n          ),\n        ),\n        const SizedBox(height: 16),\n        Center(\n          child: Stack(\n            clipBehavior: Clip.none,\n            children: [\n              // Avatar (tap để đổi ảnh) + vòng story (hồng/xám)\n              GestureDetector(\n                onTap: onAvatarTap,\n                child: Container(\n                  decoration: hasActiveStory &amp;&amp; storyRingColor != null\n                      ? BoxDecoration(\n                          shape: BoxShape.circle,\n                          border: Border.all(\n                            color: storyRingColor!,\n                            width: 3.5,\n                          ),\n                        )\n                      : null,\n                  child: CircleAvatar(\n                    radius: 48,\n                    backgroundImage:\n                        photoUrl.isNotEmpty ? NetworkImage(photoUrl) : null,\n                    child: photoUrl.isEmpty\n                        ? const Icon(Icons.person, size: 48)\n                        : isUploading\n                            ? Container(\n                                color: Colors.black54,\n                                child: const Center(\n                                  child: CircularProgressIndicator(\n                                    valueColor:\n                                        AlwaysStoppedAnimation&lt;Color&gt;(Colors.white),\n                                  ),\n                                ),\n                              )\n                            : null,\n                  ),\n                ),\n              ),\n              // Nút + đăng story/post\n              Positioned(\n                right: -6,\n                bottom: -6,\n                child: GestureDetector(\n                  // Dấu + để đăng story / post\n                  onTap: onAddPressed,\n                  child: Container(\n                    padding: const EdgeInsets.all(8),\n                    decoration: BoxDecoration(\n                      shape: BoxShape.circle,\n                      color: AppColors.primaryPink,\n                      border: Border.all(color: Colors.white, width: 3),\n                    ),\n                    child: const Icon(Icons.add, color: Colors.white, size: 20),\n                  ),\n                ),\n              ),\n              // Bong bóng ghi chú đè lên avatar\n              Positioned(\n                top: 6,\n                left: 0,\n                right: 0,\n                child: GestureDetector(\n                  behavior: HitTestBehavior.translucent,\n                  onTap: onNoteTap,\n                  child: TweenAnimationBuilder&lt;double&gt;(\n                    tween: Tween(begin: 0.95, end: 1.0),\n                    duration: const Duration(milliseconds: 800),\n                    curve: Curves.easeInOut,\n                    builder: (context, value, child) {\n                      return Transform.scale(scale: value, child: child);\n                    },\n                    child: Center(\n                      child: Container(\n                        constraints: const BoxConstraints(maxWidth: 180),\n                        padding: const EdgeInsets.symmetric(\n                          horizontal: 12,\n                          vertical: 6,\n                        ),\n                        decoration: BoxDecoration(\n                          color: Colors.white,\n                          borderRadius: BorderRadius.circular(18),\n                          boxShadow: [\n                            BoxShadow(\n                              color: Colors.black.withOpacity(0.08),\n                              blurRadius: 8,\n                              offset: const Offset(0, 4),\n                            ),\n                          ],\n                        ),\n                        child: Text(\n                          note.isNotEmpty ? note : 'Thêm ghi chú...',\n                          maxLines: 1,\n                          overflow: TextOverflow.ellipsis,\n                          style: const TextStyle(\n                            fontSize: 12,\n                            fontWeight: FontWeight.w600,\n                          ),\n                        ),\n                      ),\n                    ),\n                  ),\n                ),\n              ),\n            ],\n          ),\n        ),\n        const SizedBox(height: 12),\n        Center(\n          child: Text(\n            displayName,\n            style: const TextStyle(\n              fontSize: 20,\n              fontWeight: FontWeight.bold,\n            ),\n          ),\n        ),\n        const SizedBox(height: 4),\n        Center(\n          child: Text(\n            statusText,\n            style: TextStyle(\n              fontSize: 14,\n              color: Theme.of(context).colorScheme.onSurfaceVariant,\n            ),\n          ),\n        ),\n      ],\n    );\n  }\n}\n\nclass _HighlightStoryBubble extends StatelessWidget {\n  const _HighlightStoryBubble({\n    required this.highlight,\n    required this.firstStory,\n    required this.authorUid,\n    required this.onTap,\n  });\n\n  final HighlightStory highlight;\n  final Story firstStory;\n  final String authorUid;\n  final VoidCallback onTap;\n\n  @override\n  Widget build(BuildContext context) {\n    return GestureDetector(\n      onTap: onTap,\n      child: Container(\n        width: 70,\n        margin: const EdgeInsets.symmetric(horizontal: 6),\n        child: Column(\n          mainAxisSize: MainAxisSize.min,\n          children: [\n            Container(\n              width: 70,\n              height: 70,\n              decoration: BoxDecoration(\n                shape: BoxShape.circle,\n                border: Border.all(color: Colors.purple, width: 2.5),\n              ),\n              child: ClipOval(\n                child: firstStory.thumbnailUrl != null\n                    ? Image.network(\n                        firstStory.thumbnailUrl!,\n                        fit: BoxFit.cover,\n                        errorBuilder: (_, __, ___) =&gt; _buildPlaceholder(),\n                      )\n                    : firstStory.type == StoryMediaType.image\n                        ? Image.network(\n                            firstStory.mediaUrl,\n                            fit: BoxFit.cover,\n                            errorBuilder: (_, __, ___) =&gt; _buildPlaceholder(),\n                          )\n                        : _buildPlaceholder(),\n              ),\n            ),\n            const SizedBox(height: 6),\n            Text(\n              highlight.name,\n              style: const TextStyle(\n                fontSize: 11,\n                fontWeight: FontWeight.w500,\n              ),\n              maxLines: 1,\n              overflow: TextOverflow.ellipsis,\n              textAlign: TextAlign.center,\n            ),\n          ],\n        ),\n      ),\n    );\n  }\n\n  Widget _buildPlaceholder() {\n    return Container(\n      color: Colors.grey[300],\n      child: Icon(\n        firstStory.type == StoryMediaType.video ? Icons.videocam : Icons.image,\n        color: Colors.grey[600],\n        size: 30,\n      ),\n    );\n  }\n}\n\nclass _StatChip extends StatelessWidget {\n  const _StatChip({\n    required this.label,\n    required this.value,\n  });\n\n  final String label;\n  final int value;\n\n  @override\n  Widget build(BuildContext context) {\n    return Container(\n      padding: const EdgeInsets.symmetric(horizontal: 24, vertical: 12),\n      decoration: BoxDecoration(\n        color: AppColors.primaryPink.withOpacity(0.1),\n        borderRadius: BorderRadius.circular(20),\n        border: Border.all(color: AppColors.primaryPink.withOpacity(0.3)),\n      ),\n      child: Column(\n      children: [\n        Text(\n          '$value',\n          style: const TextStyle(\n              fontSize: 20,\n            fontWeight: FontWeight.bold,\n              color: AppColors.primaryPink,\n          ),\n        ),\n        const SizedBox(height: 4),\n          Text(\n            label,\n            style: const TextStyle(\n              fontSize: 12,\n              color: AppColors.primaryPink,\n            ),\n          ),\n        ],\n      ),\n    );\n  }\n}\n\n\n"
}
```
User decision: **accepted**

Status: **completed**


</details>
</tool-use>

---

<tool-use data-tool-type="unknown" data-tool-name="apply_patch">
<details>
<summary>Tool use: **apply_patch**</summary>


Parameters:

```json
{
  "relativeWorkspacePath": "lib/features/profile/profile_screen.dart"
}
```
Additional data:

```json
{
  "codeblockId": "5eef27aa-384c-4325-a17b-9a5f5957b83b",
  "codeblock": {
    "uri": {
      "scheme": "file",
      "authority": "",
      "path": "/c:/Users/Admin/StudioProjects/duan_kmessapp/lib/features/profile/profile_screen.dart",
      "query": "",
      "fragment": "",
      "_formatted": "file:///c%3A/Users/Admin/StudioProjects/duan_kmessapp/lib/features/profile/profile_screen.dart",
      "_fsPath": null
    },
    "codeblockId": "5eef27aa-384c-4325-a17b-9a5f5957b83b",
    "codeBlockIdx": 0,
    "content": "import 'dart:async';\nimport 'dart:io';\n\nimport 'package:firebase_storage/firebase_storage.dart';\nimport 'package:flutter/foundation.dart';\nimport 'package:flutter/material.dart';\nimport 'package:image_picker/image_picker.dart';\n\nimport 'user_profile_repository.dart';\nimport '../admin/pages/admin_dashboard_page.dart';\nimport '../admin/repositories/admin_repository.dart';\nimport 'package:firebase_auth/firebase_auth.dart';\n\nimport '../auth/auth_gate.dart';\nimport '../auth/auth_repository.dart';\nimport '../auth/login_screen.dart';\nimport '../auth/saved_accounts_repository.dart';\nimport '../auth/saved_credentials_repository.dart';\nimport '../follow/services/follow_service.dart';\nimport '../../services/cloudinary_service.dart';\nimport '../saved_posts/pages/saved_posts_page.dart';\nimport '../settings/pages/privacy_settings_page.dart';\nimport '../auth/pages/change_password_page.dart';\nimport '../stories/pages/story_create_page.dart';\nimport '../stories/pages/story_viewer_page.dart';\nimport '../stories/repositories/story_repository.dart';\nimport '../stories/models/story.dart';\nimport '../posts/pages/post_create_page.dart';\nimport '../posts/pages/post_permalink_page.dart';\nimport '../posts/repositories/post_repository.dart';\nimport '../posts/models/post.dart';\nimport 'widgets/profile_posts_widgets.dart';\nimport 'widgets/avatar_fullscreen_viewer.dart';\nimport 'pages/manage_highlight_stories_page.dart';\nimport '../../theme/colors.dart';\n\nenum _ProfileMenuAction {\n  personalInfo,\n  privacySettings,\n  privateAccount,\n  highlightStories,\n  savedPosts,\n  changePassword,\n  adminDashboard,\n  logout,\n}\n\nenum _LogoutChoice {\n  saveAndSignOut,\n  signOutOnly,\n}\n\nenum _CreateAction { story, post }\nenum _AccountMenuAction { switchAccount, logout }\n\nclass ProfileScreen extends StatefulWidget {\n  const ProfileScreen({super.key});\n\n  @override\n  State&lt;ProfileScreen&gt; createState() =&gt; _ProfileScreenState();\n}\n\nclass _ProfileScreenState extends State&lt;ProfileScreen&gt; {\n  final TextEditingController displayNameController = TextEditingController();\n  final TextEditingController photoUrlController = TextEditingController();\n  final TextEditingController bioController = TextEditingController();\n  final TextEditingController noteController = TextEditingController();\n  final ImagePicker _picker = ImagePicker();\n  final AdminRepository _adminRepository = AdminRepository();\n  final PostRepository _postRepository = PostRepository();\n  bool isSaving = false;\n  bool isUploading = false;\n  bool _loadedInitial = false;\n  bool _isPrivate = false;\n  String? _themeColor;\n  List&lt;ProfileLink&gt; _links = [];\n  bool _isAdmin = false;\n  late final FollowService _followService;\n  List&lt;Post&gt; _pinnedPosts = [];\n  List&lt;Post&gt; _allPosts = [];\n  bool _isLoadingPosts = false;\n\n  @override\n  void initState() {\n    super.initState();\n    _followService = FollowService();\n    _checkAdminStatus();\n    _loadPinnedPosts();\n    _loadAllPosts();\n  }\n\n  Future&lt;void&gt; _loadPinnedPosts() async {\n    try {\n      final user = authRepository.currentUser();\n      if (user == null) return;\n      final profile = await userProfileRepository.fetchProfile(user.uid);\n      if (profile == null || profile.pinnedPostIds.isEmpty) {\n        if (mounted) {\n          setState(() {\n            _pinnedPosts = [];\n          });\n        }\n        return;\n      }\n\n      final posts = &lt;Post&gt;[];\n      for (final postId in profile.pinnedPostIds) {\n        try {\n          final post = await _postRepository.watchPost(postId).first;\n          posts.add(post);\n        } catch (_) {\n          continue;\n        }\n      }\n\n      if (mounted) {\n        setState(() {\n          _pinnedPosts = posts;\n        });\n      }\n    } catch (_) {\n      // ignore\n    }\n  }\n\n  Future&lt;void&gt; _loadAllPosts() async {\n    final user = authRepository.currentUser();\n    if (user == null) return;\n\n    setState(() {\n      _isLoadingPosts = true;\n    });\n\n    try {\n      final pageResult = await _postRepository.fetchPostsByAuthor(\n        authorUid: user.uid,\n        limit: 50,\n      );\n\n      final posts = pageResult.docs.map((doc) =&gt; Post.fromDoc(doc)).toList();\n\n      if (mounted) {\n        setState(() {\n          _allPosts = posts;\n          _isLoadingPosts = false;\n        });\n      }\n    } catch (_) {\n      if (mounted) {\n        setState(() {\n          _isLoadingPosts = false;\n        });\n      }\n    }\n  }\n\n  Future&lt;void&gt; _checkAdminStatus() async {\n    final user = authRepository.currentUser();\n    if (user != null) {\n      final isAdmin = await _adminRepository.isAdmin(user.uid);\n      if (mounted) {\n        setState(() {\n          _isAdmin = isAdmin;\n        });\n      }\n    }\n  }\n\n  @override\n  void dispose() {\n    displayNameController.dispose();\n    photoUrlController.dispose();\n    bioController.dispose();\n    noteController.dispose();\n    super.dispose();\n  }\n\n  Future&lt;void&gt; _saveProfile(String uid) async {\n    setState(() {\n      isSaving = true;\n    });\n    try {\n      await userProfileRepository.updateProfile(\n        uid,\n        displayName: displayNameController.text.trim(),\n        photoUrl: photoUrlController.text.trim().isEmpty\n            ? null\n            : photoUrlController.text.trim(),\n        removePhoto: photoUrlController.text.trim().isEmpty,\n        bio: bioController.text.trim(),\n        note: noteController.text.trim(),\n        isPrivate: _isPrivate,\n        themeColor: _themeColor,\n        links: _links,\n      );\n      _loadedInitial = false;\n      if (!mounted) return;\n      ScaffoldMessenger.of(context).showSnackBar(\n        const SnackBar(content: Text('Đã cập nhật hồ sơ.')),\n      );\n    } catch (e) {\n      if (!mounted) return;\n      ScaffoldMessenger.of(context).showSnackBar(\n        SnackBar(content: Text('Lỗi cập nhật: $e')),\n      );\n    } finally {\n      if (mounted) {\n        setState(() {\n          isSaving = false;\n        });\n      }\n    }\n  }\n\n  /// Chọn storage backend: 'firebase' hoặc 'cloudinary'\n  /// Phải khớp với PostService.storageBackend\n  static const String storageBackend = 'cloudinary'; // Thay đổi thành 'firebase' nếu muốn dùng Firebase Storage\n\n  Future&lt;void&gt; _pickAndUploadImage(String uid, ImageSource source) async {\n    setState(() {\n      isUploading = true;\n    });\n    try {\n      final XFile? picked = await _picker.pickImage(\n        source: source,\n        maxWidth: 1024,\n        imageQuality: 85,\n      );\n      if (picked == null) {\n        setState(() {\n          isUploading = false;\n        });\n        return;\n      }\n\n      String url;\n      \n      if (storageBackend == 'cloudinary') {\n        // Dùng Cloudinary\n        final result = await CloudinaryService.uploadImage(\n          file: picked,\n          folder: 'user_profiles/$uid',\n          publicId: 'avatar',\n        );\n        url = result['url']!;\n      } else {\n        // Dùng Firebase Storage (code cũ)\n        final storageRef =\n            FirebaseStorage.instance.ref().child('user_profiles/$uid/avatar.jpg');\n\n        if (kIsWeb) {\n          final bytes = await picked.readAsBytes();\n          await storageRef.putData(\n            bytes,\n            SettableMetadata(contentType: picked.mimeType ?? 'image/jpeg'),\n          );\n        } else {\n          final file = File(picked.path);\n          await storageRef.putFile(\n            file,\n            SettableMetadata(contentType: 'image/jpeg'),\n          );\n        }\n\n        url = await storageRef.getDownloadURL();\n      }\n\n      await userProfileRepository.updateProfile(uid, photoUrl: url);\n      _loadedInitial = false;\n      if (mounted) {\n        photoUrlController.text = url;\n        ScaffoldMessenger.of(context).showSnackBar(\n          const SnackBar(content: Text('Đã cập nhật ảnh đại diện.')),\n        );\n      }\n    } catch (e) {\n      if (mounted) {\n        ScaffoldMessenger.of(context).showSnackBar(\n          SnackBar(content: Text('Lỗi tải ảnh: $e')),\n        );\n      }\n    } finally {\n      if (mounted) {\n        setState(() {\n          isUploading = false;\n        });\n      }\n    }\n  }\n\n  Future&lt;void&gt; _removePhoto(String uid) async {\n    setState(() {\n      isUploading = true;\n    });\n    try {\n      await userProfileRepository.updateProfile(\n        uid,\n        photoUrl: '',\n        removePhoto: true,\n      );\n      _loadedInitial = false;\n      if (mounted) {\n        photoUrlController.clear();\n        ScaffoldMessenger.of(context).showSnackBar(\n          const SnackBar(content: Text('Đã xoá ảnh đại diện.')),\n        );\n      }\n    } catch (e) {\n      if (mounted) {\n        ScaffoldMessenger.of(context).showSnackBar(\n          SnackBar(content: Text('Không thể xoá ảnh: $e')),\n        );\n      }\n    } finally {\n      if (mounted) {\n        setState(() {\n          isUploading = false;\n        });\n      }\n    }\n  }\n\n  Future&lt;void&gt; _showCreateChooser() async {\n    final action = await showModalBottomSheet&lt;_CreateAction&gt;(\n      context: context,\n      builder: (context) =&gt; SafeArea(\n        child: Column(\n          mainAxisSize: MainAxisSize.min,\n          children: [\n            ListTile(\n              leading: const Icon(Icons.history_edu),\n              title: const Text('Đăng story'),\n              onTap: () =&gt; Navigator.pop(context, _CreateAction.story),\n            ),\n            ListTile(\n              leading: const Icon(Icons.add_photo_alternate_outlined),\n              title: const Text('Thêm bài viết'),\n              onTap: () =&gt; Navigator.pop(context, _CreateAction.post),\n            ),\n          ],\n        ),\n      ),\n    );\n\n    if (!mounted || action == null) return;\n    switch (action) {\n      case _CreateAction.story:\n              Navigator.of(context).push(\n          MaterialPageRoute(builder: (_) =&gt; const StoryCreatePage()),\n        );\n        break;\n      case _CreateAction.post:\n              Navigator.of(context).push(\n          MaterialPageRoute(builder: (_) =&gt; const PostCreatePage()),\n        );\n        break;\n    }\n  }\n\n  Future&lt;void&gt; _showAccountMenu() async {\n    final action = await showModalBottomSheet&lt;_AccountMenuAction&gt;(\n      context: context,\n      builder: (context) =&gt; SafeArea(\n        child: Column(\n          mainAxisSize: MainAxisSize.min,\n          children: [\n            ListTile(\n              leading: const Icon(Icons.switch_account),\n              title: const Text('Chuyển tài khoản'),\n              onTap: () =&gt; Navigator.pop(context, _AccountMenuAction.switchAccount),\n            ),\n            ListTile(\n              leading: const Icon(Icons.logout),\n              title: const Text('Đăng xuất'),\n              onTap: () =&gt; Navigator.pop(context, _AccountMenuAction.logout),\n            ),\n          ],\n        ),\n      ),\n    );\n\n    if (!mounted || action == null) return;\n    switch (action) {\n      case _AccountMenuAction.switchAccount:\n        await _showSwitchAccountSheet();\n        break;\n      case _AccountMenuAction.logout:\n        await _confirmLogoutAndMaybeSave(\n          currentUser: authRepository.currentUser(),\n          forSwitchAccount: false,\n        );\n        break;\n    }\n  }\n\n  Future&lt;void&gt; _confirmLogoutAndMaybeSave({\n    User? currentUser,\n    bool forSwitchAccount = false,\n  }) async {\n    final user = currentUser ?? authRepository.currentUser();\n    if (user == null) return;\n\n    final choice = await showDialog&lt;_LogoutChoice&gt;(\n      context: context,\n      builder: (ctx) =&gt; AlertDialog(\n        title: const Text('Đăng xuất'),\n        content: const Text('Bạn có muốn lưu tài khoản này để chuyển đổi nhanh sau này không?'),\n        actions: [\n          TextButton(\n            onPressed: () =&gt; Navigator.pop(ctx, _LogoutChoice.signOutOnly),\n            child: const Text('Đăng xuất'),\n          ),\n          FilledButton(\n            onPressed: () =&gt; Navigator.pop(ctx, _LogoutChoice.saveAndSignOut),\n            child: const Text('Lưu tài khoản'),\n          ),\n        ],\n      ),\n    );\n\n    if (!mounted || choice == null) return;\n\n    if (choice == _LogoutChoice.saveAndSignOut) {\n      await SavedAccountsRepository.instance.saveAccountFromUser(user);\n      ScaffoldMessenger.of(context).showSnackBar(\n        const SnackBar(content: Text('Đã lưu tài khoản trên thiết bị.')),\n      );\n    } else {\n      await SavedAccountsRepository.instance.removeAccount(user.uid);\n      await SavedCredentialsRepository.instance.removePassword(user.uid);\n    }\n\n    await userProfileRepository.setPresence(user.uid, false);\n    // Với flow đăng xuất bình thường: set offline + signOut để quay về màn hình login/AuthGate\n    // Với flow chuyển đổi tài khoản: chỉ set offline, KHÔNG signOut, sẽ signIn tài khoản khác ngay sau đó\n    if (!forSwitchAccount) {\n      await authRepository.signOut();\n    }\n    if (mounted) {\n      Navigator.of(context).pop();\n    }\n  }\n\n  Future&lt;void&gt; _showSwitchAccountSheet() async {\n    final accounts = await SavedAccountsRepository.instance.getAccounts();\n    if (!mounted) return;\n\n    if (accounts.isEmpty) {\n      ScaffoldMessenger.of(context).showSnackBar(\n        const SnackBar(content: Text('Chưa có tài khoản nào được lưu trên thiết bị.')),\n      );\n      return;\n    }\n\n    final selected = await showModalBottomSheet&lt;SavedAccount&gt;(\n      context: context,\n      builder: (ctx) =&gt; SafeArea(\n        child: Column(\n          mainAxisSize: MainAxisSize.min,\n          children: [\n            const ListTile(\n              title: Text(\n                'Chuyển đổi tài khoản',\n                style: TextStyle(fontWeight: FontWeight.bold),\n              ),\n            ),\n            ...accounts.map(\n              (acc) =&gt; ListTile(\n                leading: CircleAvatar(\n                  backgroundImage:\n                      acc.photoUrl != null &amp;&amp; acc.photoUrl!.isNotEmpty ? NetworkImage(acc.photoUrl!) : null,\n                  child: acc.photoUrl == null || acc.photoUrl!.isEmpty\n                      ? const Icon(Icons.person)\n                      : null,\n                ),\n                title: Text(acc.displayName ?? acc.email ?? acc.uid),\n                subtitle: acc.email != null ? Text(acc.email!) : null,\n                onTap: () =&gt; Navigator.pop(ctx, acc),\n              ),\n            ),\n            const SizedBox(height: 8),\n          ],\n        ),\n      ),\n    );\n\n    if (!mounted || selected == null) return;\n\n    // Khi chọn tài khoản khác: hỏi có lưu tài khoản hiện tại không\n    final current = authRepository.currentUser();\n    if (current != null) {\n      await _confirmLogoutAndMaybeSave(\n        currentUser: current,\n        forSwitchAccount: true,\n      );\n    }\n\n    if (!mounted) return;\n\n    // Thử đăng nhập nhanh vào tài khoản đã lưu\n    final quickSuccess = await _quickSignInToSavedAccount(selected);\n\n    if (!mounted) return;\n\n    if (quickSuccess) {\n      // Điều hướng về AuthGate để toàn bộ app rebuild theo user mới\n      Navigator.of(context).pushAndRemoveUntil(\n                MaterialPageRoute(\n          builder: (_) =&gt; const AuthGate(),\n        ),\n        (route) =&gt; false,\n      );\n    } else {\n      // Fallback: chuyển sang màn hình login với email được điền sẵn\n      final identifier = selected.email ?? selected.displayName ?? selected.uid;\n      ScaffoldMessenger.of(context).showSnackBar(\n        const SnackBar(\n          content: Text(\n            'Tài khoản này chưa lưu mật khẩu an toàn. Vui lòng đăng nhập lại một lần.',\n          ),\n        ),\n      );\n      Navigator.of(context).pushAndRemoveUntil(\n                MaterialPageRoute(\n          builder: (_) =&gt; LoginScreen(initialIdentifier: identifier),\n        ),\n        (route) =&gt; false,\n      );\n    }\n  }\n\n  Future&lt;bool&gt; _quickSignInToSavedAccount(SavedAccount account) async {\n    try {\n      // Chỉ hỗ trợ auto-login nhanh cho tài khoản đăng nhập bằng email/mật khẩu\n      if (account.providerId == 'password' &amp;&amp; account.email != null) {\n        final password =\n            await SavedCredentialsRepository.instance.getPassword(account.uid);\n        if (password == null || password.isEmpty) {\n          return false;\n        }\n\n        // SignIn vào tài khoản mới\n        await authRepository.signInWithEmail(account.email!, password);\n\n        // Đợi auth state thay đổi để đảm bảo signIn hoàn tất\n        // Sử dụng Stream để đợi auth state change hoặc timeout sau 3 giây\n        final completer = Completer&lt;bool&gt;();\n        StreamSubscription&lt;User?&gt;? subscription;\n        Timer? timeoutTimer;\n\n        subscription = authRepository.authState().listen((user) {\n          if (user != null &amp;&amp; user.uid == account.uid) {\n            subscription?.cancel();\n            timeoutTimer?.cancel();\n            if (!completer.isCompleted) {\n              completer.complete(true);\n            }\n          }\n        });\n\n        // Timeout sau 3 giây nếu không nhận được auth state change\n        timeoutTimer = Timer(const Duration(seconds: 3), () {\n          subscription?.cancel();\n          final currentUser = authRepository.currentUser();\n          final success = currentUser != null &amp;&amp; currentUser.uid == account.uid;\n          if (!completer.isCompleted) {\n            completer.complete(success);\n          }\n        });\n\n        // Đợi kết quả\n        final result = await completer.future;\n        subscription.cancel();\n        timeoutTimer.cancel();\n\n        return result;\n      }\n      // Các provider khác (Google/Facebook) hiện tại không auto-login để tránh chọn sai account\n      return false;\n    } catch (_) {\n      return false;\n    }\n  }\n\n  /// Hiển thị bottom sheet khi chạm avatar trên trang hồ sơ\n  /// - Nếu người dùng có story (kể cả đã xem hết): thêm hành động \"Xem tin\"\n  /// - Dù có story hay không, luôn có tuỳ chọn \"Xem ảnh đại diện\" (nếu có ảnh)\n  void _handleAvatarTap(String uid, StoryRingStatus ringStatus) {\n    final hasStory = ringStatus != StoryRingStatus.none;\n\n    if (!hasStory) {\n      // Không có story -&gt; dùng sheet ảnh đại diện (vẫn có Xem ảnh đại diện)\n      _showAvatarOptions(uid);\n      return;\n    }\n\n    showModalBottomSheet(\n      context: context,\n      builder: (context) =&gt; SafeArea(\n        child: Column(\n          mainAxisSize: MainAxisSize.min,\n          children: [\n            ListTile(\n              leading: const Icon(Icons.history_edu),\n              title: const Text('Xem tin'),\n              onTap: () {\n                Navigator.pop(context);\n                Navigator.of(context).push(\n                  MaterialPageRoute(\n                    builder: (_) =&gt; StoryViewerPage(\n                      initialAuthorUid: uid,\n                      userIdsWithStories: [uid],\n                    ),\n                  ),\n                );\n              },\n            ),\n            if (photoUrlController.text.isNotEmpty)\n              ListTile(\n                leading: const Icon(Icons.remove_red_eye),\n                title: const Text('Xem ảnh đại diện'),\n                onTap: () {\n                  Navigator.pop(context);\n                  Navigator.of(context).push(\n                    MaterialPageRoute(\n                      builder: (_) =&gt; AvatarFullscreenViewer(\n                        photoUrl: photoUrlController.text,\n                      ),\n                    ),\n                  );\n                },\n              ),\n            ListTile(\n              leading: const Icon(Icons.photo_library),\n              title: const Text('Chọn ảnh từ thư viện'),\n              onTap: () {\n                Navigator.pop(context);\n                _pickAndUploadImage(uid, ImageSource.gallery);\n              },\n            ),\n            ListTile(\n              leading: const Icon(Icons.camera_alt),\n              title: const Text('Chụp ảnh'),\n              onTap: () {\n                Navigator.pop(context);\n                _pickAndUploadImage(uid, ImageSource.camera);\n              },\n            ),\n            if (photoUrlController.text.isNotEmpty)\n              ListTile(\n                leading: const Icon(Icons.delete_outline, color: Colors.red),\n                title: const Text(\n                  'Xoá ảnh đại diện',\n                  style: TextStyle(color: Colors.red),\n                ),\n                onTap: () {\n                  Navigator.pop(context);\n                  _removePhoto(uid);\n                },\n              ),\n          ],\n        ),\n      ),\n    );\n  }\n\n  void _showAvatarOptions(String uid) {\n    showModalBottomSheet(\n      context: context,\n      builder: (context) =&gt; SafeArea(\n        child: Column(\n          mainAxisSize: MainAxisSize.min,\n          children: [\n            if (photoUrlController.text.isNotEmpty)\n              ListTile(\n                leading: const Icon(Icons.remove_red_eye),\n                title: const Text('Xem ảnh đại diện'),\n                onTap: () {\n                  Navigator.pop(context);\n                  Navigator.of(context).push(\n                    MaterialPageRoute(\n                      builder: (_) =&gt; AvatarFullscreenViewer(\n                        photoUrl: photoUrlController.text,\n                      ),\n                    ),\n                  );\n                },\n              ),\n            ListTile(\n              leading: const Icon(Icons.photo_library),\n              title: const Text('Chọn ảnh từ thư viện'),\n              onTap: () {\n                Navigator.pop(context);\n                _pickAndUploadImage(uid, ImageSource.gallery);\n              },\n            ),\n            ListTile(\n              leading: const Icon(Icons.camera_alt),\n              title: const Text('Chụp ảnh'),\n              onTap: () {\n                Navigator.pop(context);\n                _pickAndUploadImage(uid, ImageSource.camera);\n              },\n            ),\n            if (photoUrlController.text.isNotEmpty)\n              ListTile(\n                leading: const Icon(Icons.delete_outline, color: Colors.red),\n                title: const Text('Xoá ảnh đại diện', style: TextStyle(color: Colors.red)),\n                onTap: () {\n                  Navigator.pop(context);\n                  _removePhoto(uid);\n                },\n              ),\n          ],\n        ),\n      ),\n    );\n  }\n\n  String _formatLastSeen(DateTime lastSeen) {\n    final diff = DateTime.now().difference(lastSeen);\n    if (diff.inMinutes &lt; 1) {\n      return 'Vừa mới hoạt động';\n    } else if (diff.inHours &lt; 1) {\n      return 'Hoạt động ${diff.inMinutes} phút trước';\n    } else if (diff.inDays &lt; 1) {\n      return 'Hoạt động ${diff.inHours} giờ trước';\n    } else {\n      return 'Hoạt động ${diff.inDays} ngày trước';\n    }\n  }\n\n  @override\n  Widget build(BuildContext context) {\n    final user = authRepository.currentUser();\n    if (user == null) {\n      return const Scaffold(\n        body: Center(child: Text('Không tìm thấy người dùng.')),\n      );\n    }\n\n    return Scaffold(\n      appBar: AppBar(\n        title: const Text(\n          'Hồ sơ của bạn',\n          style: TextStyle(color: AppColors.primaryPink),\n        ),\n        iconTheme: const IconThemeData(color: AppColors.primaryPink),\n        actions: [\n          IconButton(\n            icon: const Icon(Icons.menu),\n            onPressed: () {\n              _showProfileOptionsSheet(user);\n            },\n          ),\n        ],\n      ),\n      body: StreamBuilder&lt;UserProfile?&gt;(\n        stream: userProfileRepository.watchProfile(user.uid),\n        builder: (context, snapshot) {\n          final profile = snapshot.data;\n          if (!_loadedInitial &amp;&amp; profile != null) {\n            displayNameController.text = profile.displayName ?? '';\n            photoUrlController.text = profile.photoUrl ?? '';\n            bioController.text = profile.bio ?? '';\n          noteController.text = profile.note ?? '';\n            _isPrivate = profile.isPrivate;\n            _themeColor = profile.themeColor;\n            _links = List&lt;ProfileLink&gt;.from(profile.links);\n            _loadedInitial = true;\n          }\n\n          final themeColor = _themeColor != null ? _parseColor(_themeColor!) : null;\n          final displayName = displayNameController.text.isNotEmpty\n              ? displayNameController.text\n              : (user.email ?? user.uid);\n          final statusText = profile?.isOnline == true\n              ? 'Đang hoạt động'\n              : profile?.lastSeen != null\n                  ? _formatLastSeen(profile!.lastSeen!)\n                  : 'Ngoại tuyến';\n\n          return SingleChildScrollView(\n            padding: const EdgeInsets.symmetric(horizontal: 16, vertical: 20),\n            child: Column(\n              crossAxisAlignment: CrossAxisAlignment.stretch,\n              children: [\n                FutureBuilder&lt;StoryRingStatus&gt;(\n                  future: StoryRepository().fetchStoryRingStatus(\n                    ownerUid: user.uid,\n                    viewerUid: user.uid,\n                  ),\n                  builder: (context, ringSnapshot) {\n                    final ringStatus =\n                        ringSnapshot.data ?? StoryRingStatus.none;\n                    final hasActiveStory =\n                        ringStatus != StoryRingStatus.none;\n                    Color? ringColor;\n                    if (ringStatus == StoryRingStatus.unseen) {\n                      ringColor = AppColors.primaryPink;\n                    } else if (ringStatus == StoryRingStatus.allSeen) {\n                      // Vòng tròn xám đậm hơn để dễ thấy khi đã xem hết story\n                      ringColor = Colors.grey.shade600;\n                    }\n\n                    return _EditProfileHeader(\n                      displayName: displayName,\n                      photoUrl: photoUrlController.text,\n                      statusText: statusText,\n                      themeColor: themeColor,\n                      isUploading: isUploading,\n                      hasActiveStory: hasActiveStory,\n                      storyRingColor: ringColor,\n                      onAddPressed: _showCreateChooser,\n                      onAccountMenuPressed: _showAccountMenu,\n                      // Khi chạm avatar: mở sheet mới với tuỳ chọn xem tin + đổi ảnh\n                      onAvatarTap: () =&gt; _handleAvatarTap(user.uid, ringStatus),\n                      note: noteController.text,\n                      onNoteTap: () =&gt; _showEditNoteDialog(user.uid),\n                    );\n                  },\n                ),\n                const SizedBox(height: 16),\n                if (profile != null) ...[\n                  Row(\n                    mainAxisAlignment: MainAxisAlignment.spaceEvenly,\n                    children: [\n                      _StatChip(\n                        label: 'Người theo dõi',\n                        value: profile.followersCount,\n                      ),\n                      _StatChip(\n                        label: 'Đang theo dõi',\n                        value: profile.followingCount,\n                      ),\n                    ],\n                  ),\n                  const SizedBox(height: 24),\n                ],\n                // Highlight Stories section\n                StreamBuilder&lt;UserProfile?&gt;(\n                  stream: userProfileRepository.watchProfile(user.uid),\n                  builder: (context, profileSnapshot) {\n                    final profile = profileSnapshot.data;\n                    final highlightedStories = profile?.highlightedStories ?? [];\n                    if (highlightedStories.isEmpty) {\n                      return const SizedBox.shrink();\n                    }\n                    return StreamBuilder&lt;List&lt;Story&gt;&gt;(\n                      stream: StoryRepository().fetchStoriesByAuthor(user.uid),\n                      builder: (context, storiesSnapshot) {\n                        final allStories = storiesSnapshot.data ?? [];\n                        \n                        // Filter highlights để chỉ hiển thị những highlight có ít nhất 1 story tồn tại\n                        final validHighlights = highlightedStories\n                            .where((h) =&gt; h.storyIds.any((id) =&gt;\n                                allStories.any((s) =&gt; s.id == id)))\n                            .toList();\n                        \n                        if (validHighlights.isEmpty) {\n                          return const SizedBox.shrink();\n                        }\n                        \n                        return Column(\n                          crossAxisAlignment: CrossAxisAlignment.start,\n                          children: [\n                            const Padding(\n                              padding: EdgeInsets.symmetric(horizontal: 4),\n                              child: Row(\n                                children: [\n                                  Icon(Icons.auto_awesome, size: 20, color: Colors.purple),\n                                  SizedBox(width: 8),\n                                  Text(\n                                    'Highlight Stories',\n                                    style: TextStyle(\n                                      fontSize: 16,\n                                      fontWeight: FontWeight.bold,\n                                    ),\n                                  ),\n                                ],\n                              ),\n                            ),\n                            const SizedBox(height: 8),\n                            SizedBox(\n                              height: 100,\n                              child: ListView.builder(\n                                scrollDirection: Axis.horizontal,\n                                padding: const EdgeInsets.symmetric(horizontal: 4),\n                                itemCount: validHighlights.length,\n                                itemBuilder: (context, index) {\n                                  final highlight = validHighlights[index];\n                                  final highlightStories = allStories\n                                      .where((s) =&gt; highlight.storyIds.contains(s.id))\n                                      .toList();\n                                  if (highlightStories.isEmpty) {\n                                    return const SizedBox.shrink();\n                                  }\n                                  return _HighlightStoryBubble(\n                                    highlight: highlight,\n                                    firstStory: highlightStories.first,\n                                    authorUid: user.uid,\n                                    onTap: () {\n                                      // Navigate to story viewer với stories của highlight\n                                      Navigator.of(context).push(\n                                        MaterialPageRoute(\n                                          builder: (_) =&gt; StoryViewerPage(\n                                            initialAuthorUid: user.uid,\n                                            userIdsWithStories: [user.uid],\n                                            initialStoryIds: highlight.storyIds,\n                                            highlightId: highlight.id,\n                                          ),\n                                        ),\n                                      );\n                                    },\n                                  );\n                                },\n                              ),\n                            ),\n                            const SizedBox(height: 16),\n                          ],\n                        );\n                      },\n                    );\n                  },\n                ),\n                // Pinned posts section\n                if (_pinnedPosts.isNotEmpty) ...[\n                const SizedBox(height: 8),\n                  const Padding(\n                    padding: EdgeInsets.symmetric(horizontal: 4),\n                    child: Row(\n                      children: [\n                        Icon(Icons.push_pin, size: 20, color: Colors.orange),\n                        SizedBox(width: 8),\n                        Text(\n                          'Bài viết đã ghim',\n                  style: TextStyle(\n                            fontSize: 16,\n                    fontWeight: FontWeight.bold,\n                  ),\n                ),\n                      ],\n                    ),\n                  ),\n                  const SizedBox(height: 8),\n                  SizedBox(\n                    height: 120,\n                    child: ListView.builder(\n                      scrollDirection: Axis.horizontal,\n                      padding: const EdgeInsets.symmetric(horizontal: 4),\n                      itemCount: _pinnedPosts.length,\n                      itemBuilder: (context, index) {\n                        final post = _pinnedPosts[index];\n                        return ProfilePinnedPostItem(\n                          post: post,\n                          onTap: () {\n                            Navigator.of(context).push(\n                              MaterialPageRoute(\n                                builder: (_) =&gt; PostPermalinkPage(postId: post.id),\n                              ),\n                            );\n                          },\n                        );\n                      },\n                    ),\n                  ),\n                  const SizedBox(height: 16),\n                ],\n                // Posts grid section\n                const Padding(\n                  padding: EdgeInsets.symmetric(horizontal: 4),\n                  child: Row(\n                    children: [\n                      Icon(Icons.grid_on, size: 20),\n                      SizedBox(width: 8),\n                      Text(\n                        'Bài viết',\n                        style: TextStyle(\n                          fontSize: 16,\n                          fontWeight: FontWeight.bold,\n                        ),\n                      ),\n                    ],\n                  ),\n                ),\n                const SizedBox(height: 8),\n                if (_isLoadingPosts)\n                  const Padding(\n                    padding: EdgeInsets.all(32),\n                    child: Center(child: CircularProgressIndicator()),\n                  )\n                else if (_allPosts.isEmpty)\n                  const Padding(\n                    padding: EdgeInsets.all(32),\n                    child: Center(\n                      child: Text(\n                        'Chưa có bài viết nào',\n                        style: TextStyle(color: Colors.grey),\n                      ),\n                    ),\n                  )\n                else\n                  GridView.builder(\n                    shrinkWrap: true,\n                    physics: const NeverScrollableScrollPhysics(),\n                    padding: const EdgeInsets.all(8),\n                    gridDelegate: const SliverGridDelegateWithFixedCrossAxisCount(\n                      crossAxisCount: 3,\n                      crossAxisSpacing: 4,\n                      mainAxisSpacing: 4,\n                    ),\n                    itemCount: _allPosts.length,\n                    itemBuilder: (context, index) {\n                      final post = _allPosts[index];\n                      return ProfilePostGridItem(\n                        post: post,\n                        onTap: () {\n                          Navigator.of(context).push(\n                            MaterialPageRoute(\n                              builder: (_) =&gt; PostPermalinkPage(postId: post.id),\n                            ),\n                          );\n                        },\n                      );\n                    },\n                  ),\n                // Follow requests section\n                if (profile != null &amp;&amp; _isPrivate)\n                  StreamBuilder&lt;List&lt;FollowRequestEntry&gt;&gt;(\n                    stream: _followService.watchIncomingRequestEntries(user.uid),\n                    builder: (context, requestSnapshot) {\n                      final requests = requestSnapshot.data ?? [];\n                      if (requests.isEmpty) {\n                          return const SizedBox.shrink();\n                        }\n                      return Card(\n                        child: Padding(\n                          padding: const EdgeInsets.all(16),\n                          child: Column(\n                        crossAxisAlignment: CrossAxisAlignment.start,\n                        children: [\n                              Row(\n                                children: [\n                                  const Icon(Icons.person_add, color: AppColors.primaryPink),\n                                  const SizedBox(width: 8),\n                                  Text(\n                                    'Yêu cầu theo dõi (${requests.length})',\n                                    style: const TextStyle(\n                              fontSize: 16,\n                                      fontWeight: FontWeight.bold,\n                            ),\n                          ),\n                                ],\n                              ),\n                              const SizedBox(height: 12),\n                          ...requests.map(\n                            (entry) =&gt; Card(\n                                  margin: const EdgeInsets.only(bottom: 8),\n                              child: ListTile(\n                                leading: CircleAvatar(\n                                      backgroundImage: entry.profile?.photoUrl != null\n                                      ? NetworkImage(entry.profile!.photoUrl!)\n                                      : null,\n                                  child: entry.profile?.photoUrl == null\n                                      ? const Icon(Icons.person)\n                                      : null,\n                                ),\n                                title: Text(\n                                      entry.profile?.displayName?.isNotEmpty == true\n                                      ? entry.profile!.displayName!\n                                          : (entry.profile?.email?.isNotEmpty == true\n                                          ? entry.profile!.email!\n                                          : entry.uid),\n                                ),\n                                subtitle: entry.createdAt != null\n                                        ? Text('Yêu cầu lúc ${entry.createdAt}')\n                                    : null,\n                                    trailing: Row(\n                                      mainAxisSize: MainAxisSize.min,\n                                  children: [\n                                    TextButton(\n                                          onPressed: () =&gt; _followService.acceptRequest(entry.uid),\n                                          style: TextButton.styleFrom(\n                                            foregroundColor: Colors.green,\n                                          ),\n                                      child: const Text('Chấp nhận'),\n                                    ),\n                                    TextButton(\n                                          onPressed: () =&gt; _followService.declineRequest(entry.uid),\n                                          style: TextButton.styleFrom(\n                                            foregroundColor: Colors.red,\n                                          ),\n                                      child: const Text('Từ chối'),\n                                    ),\n                                  ],\n                                ),\n                              ),\n                            ),\n                          ),\n                        ],\n                          ),\n                        ),\n                      );\n                    },\n                  ),\n              ],\n            ),\n          );\n        },\n      ),\n    );\n  }\n\n  Color _parseColor(String hexColor) {\n    try {\n      return Color(int.parse(hexColor.replaceFirst('#', '0xFF')));\n    } catch (e) {\n      return Colors.blue;\n    }\n  }\n\n  void _showColorPicker(BuildContext context) {\n    final presetColors = [\n      '#FF5733', '#33FF57', '#3357FF', '#FF33F5', '#F5FF33',\n      '#33FFF5', '#FF8C33', '#8C33FF', '#33FF8C', '#FF3333',\n      '#33FF33', '#3333FF', '#FFFF33', '#FF33FF', '#33FFFF',\n    ];\n\n    showModalBottomSheet(\n      context: context,\n      builder: (context) =&gt; Container(\n        padding: const EdgeInsets.all(16),\n        child: Column(\n          mainAxisSize: MainAxisSize.min,\n          crossAxisAlignment: CrossAxisAlignment.start,\n          children: [\n            const Text(\n              'Chọn màu chủ đạo',\n              style: TextStyle(fontSize: 18, fontWeight: FontWeight.bold),\n            ),\n            const SizedBox(height: 16),\n            Wrap(\n              spacing: 12,\n              runSpacing: 12,\n              children: [\n                // Preset colors\n                ...presetColors.map((color) {\n                  return GestureDetector(\n                    onTap: () {\n                      setState(() {\n                        _themeColor = color;\n                      });\n                      Navigator.pop(context);\n                    },\n                    child: Container(\n                      width: 48,\n                      height: 48,\n                      decoration: BoxDecoration(\n                        color: _parseColor(color),\n                        shape: BoxShape.circle,\n                        border: Border.all(color: Colors.grey.shade300),\n                      ),\n                    ),\n                  );\n                }),\n                // Custom color picker (simple text input)\n                GestureDetector(\n                  onTap: () =&gt; _showCustomColorDialog(context),\n                  child: Container(\n                    width: 48,\n                    height: 48,\n                    decoration: BoxDecoration(\n                      color: Colors.grey.shade200,\n                      shape: BoxShape.circle,\n                      border: Border.all(color: Colors.grey.shade300),\n                    ),\n                    child: const Icon(Icons.tune),\n                  ),\n                ),\n              ],\n            ),\n            const SizedBox(height: 16),\n            TextButton(\n              onPressed: () {\n                setState(() {\n                  _themeColor = null;\n                });\n                Navigator.pop(context);\n              },\n              child: const Text('Xóa màu'),\n            ),\n          ],\n        ),\n      ),\n    );\n  }\n\n  void _showCustomColorDialog(BuildContext context) {\n    final controller = TextEditingController(text: _themeColor ?? '#');\n    showDialog(\n      context: context,\n      builder: (context) =&gt; AlertDialog(\n        title: const Text('Màu tùy chỉnh'),\n        content: TextField(\n          controller: controller,\n          decoration: const InputDecoration(\n            labelText: 'Mã màu hex (ví dụ: #FF5733)',\n            hintText: '#FF5733',\n          ),\n        ),\n        actions: [\n          TextButton(\n            onPressed: () =&gt; Navigator.pop(context),\n            child: const Text('Hủy'),\n          ),\n          FilledButton(\n            onPressed: () {\n              final color = controller.text.trim();\n              if (color.isNotEmpty &amp;&amp; color.startsWith('#')) {\n                try {\n                  _parseColor(color); // Validate\n                  setState(() {\n                    _themeColor = color;\n                  });\n                  Navigator.pop(context);\n                  Navigator.pop(context); // Close color picker too\n                } catch (e) {\n                  ScaffoldMessenger.of(context).showSnackBar(\n                    const SnackBar(content: Text('Mã màu không hợp lệ')),\n                  );\n                }\n              } else {\n                ScaffoldMessenger.of(context).showSnackBar(\n                  const SnackBar(content: Text('Mã màu phải bắt đầu bằng #')),\n                );\n              }\n            },\n            child: const Text('Lưu'),\n          ),\n        ],\n      ),\n    );\n  }\n\n  void _showAddLinkDialog(BuildContext context) {\n    final labelController = TextEditingController();\n    final urlController = TextEditingController();\n\n    showDialog(\n      context: context,\n      builder: (context) =&gt; AlertDialog(\n        title: const Text('Thêm liên kết'),\n        content: Column(\n          mainAxisSize: MainAxisSize.min,\n          children: [\n            TextField(\n              controller: labelController,\n              decoration: const InputDecoration(\n                labelText: 'Nhãn (ví dụ: Website, Instagram)',\n              ),\n            ),\n            const SizedBox(height: 12),\n            TextField(\n              controller: urlController,\n              decoration: const InputDecoration(\n                labelText: 'URL',\n                hintText: 'https://example.com',\n              ),\n              keyboardType: TextInputType.url,\n            ),\n          ],\n        ),\n        actions: [\n          TextButton(\n            onPressed: () =&gt; Navigator.pop(context),\n            child: const Text('Hủy'),\n          ),\n          FilledButton(\n            onPressed: () {\n              final label = labelController.text.trim();\n              final url = urlController.text.trim();\n              if (label.isEmpty || url.isEmpty) {\n                ScaffoldMessenger.of(context).showSnackBar(\n                  const SnackBar(content: Text('Vui lòng điền đầy đủ thông tin')),\n                );\n                return;\n              }\n              if (!url.startsWith('http://') &amp;&amp; !url.startsWith('https://')) {\n                ScaffoldMessenger.of(context).showSnackBar(\n                  const SnackBar(content: Text('URL phải bắt đầu bằng http:// hoặc https://')),\n                );\n                return;\n              }\n              setState(() {\n                _links.add(ProfileLink(url: url, label: label));\n              });\n              Navigator.pop(context);\n            },\n            child: const Text('Thêm'),\n          ),\n        ],\n      ),\n    );\n  }\n\n  Future&lt;void&gt; _showEditNoteDialog(String uid) async {\n    final controller = TextEditingController(text: noteController.text);\n    final result = await showDialog&lt;String&gt;(\n      context: context,\n      builder: (context) =&gt; AlertDialog(\n        title: const Text('Cập nhật ghi chú'),\n        content: TextField(\n          controller: controller,\n          maxLength: 50,\n          decoration: const InputDecoration(\n            hintText: 'Nhập ghi chú (tối đa 50 ký tự)',\n          ),\n        ),\n        actions: [\n          TextButton(\n            onPressed: () =&gt; Navigator.pop(context),\n            child: const Text('Hủy'),\n          ),\n          FilledButton(\n            onPressed: () {\n              final text = controller.text.trim();\n              if (text.length &gt; 50) {\n                ScaffoldMessenger.of(context).showSnackBar(\n                  const SnackBar(\n                    content: Text('Ghi chú tối đa 50 ký tự'),\n                  ),\n                );\n                return;\n              }\n              Navigator.pop(context, text);\n            },\n            child: const Text('Lưu'),\n          ),\n        ],\n      ),\n    );\n\n    if (result == null) return;\n\n    try {\n      await userProfileRepository.updateProfile(uid, note: result);\n      setState(() {\n        noteController.text = result;\n      });\n      if (mounted) {\n        ScaffoldMessenger.of(context).showSnackBar(\n          const SnackBar(content: Text('Đã cập nhật ghi chú.')),\n        );\n      }\n    } catch (e) {\n      if (!mounted) return;\n      ScaffoldMessenger.of(context).showSnackBar(\n        SnackBar(content: Text('Không thể cập nhật ghi chú: $e')),\n      );\n    }\n  }\n\n  Future&lt;void&gt; _handleMenuAction(_ProfileMenuAction action) async {\n    final user = authRepository.currentUser();\n    if (user == null) return;\n\n    switch (action) {\n      case _ProfileMenuAction.personalInfo:\n        await _showPersonalInfoModal(user.uid);\n        break;\n      case _ProfileMenuAction.privateAccount:\n        await _togglePrivateAccount(user.uid);\n        break;\n      case _ProfileMenuAction.highlightStories:\n        await Navigator.of(context).push(\n          MaterialPageRoute(\n            builder: (_) =&gt; ManageHighlightStoriesPage(uid: user.uid),\n          ),\n        );\n        break;\n      case _ProfileMenuAction.privacySettings:\n        await Navigator.of(context).push(\n          MaterialPageRoute(builder: (_) =&gt; PrivacySettingsPage()),\n        );\n        break;\n      case _ProfileMenuAction.savedPosts:\n        await Navigator.of(context).push(\n          MaterialPageRoute(builder: (_) =&gt; const SavedPostsPage()),\n        );\n        break;\n      case _ProfileMenuAction.changePassword:\n        await Navigator.of(context).push(\n          MaterialPageRoute(builder: (_) =&gt; const ChangePasswordPage()),\n        );\n        break;\n      case _ProfileMenuAction.adminDashboard:\n        await Navigator.of(context).push(\n          MaterialPageRoute(builder: (_) =&gt; const AdminDashboardPage()),\n        );\n        break;\n      case _ProfileMenuAction.logout:\n        await _confirmLogoutAndMaybeSave(currentUser: user);\n        break;\n    }\n  }\n\n  Future&lt;void&gt; _showPersonalInfoModal(String uid) async {\n    final displayNameCtrl = TextEditingController(text: displayNameController.text);\n    final bioCtrl = TextEditingController(text: bioController.text);\n    final photoUrlCtrl = TextEditingController(text: photoUrlController.text);\n\n    await showDialog(\n      context: context,\n      builder: (context) =&gt; AlertDialog(\n        title: const Text('Thông tin cá nhân'),\n        content: SingleChildScrollView(\n          child: Column(\n            mainAxisSize: MainAxisSize.min,\n            children: [\n              TextField(\n                controller: displayNameCtrl,\n                decoration: const InputDecoration(\n                  labelText: 'Tên hiển thị',\n                  prefixIcon: Icon(Icons.person),\n                ),\n              ),\n              const SizedBox(height: 16),\n              TextField(\n                controller: bioCtrl,\n                minLines: 1,\n                maxLines: 4,\n                decoration: const InputDecoration(\n                  labelText: 'Tiểu sử (bio)',\n                  prefixIcon: Icon(Icons.description),\n                ),\n              ),\n              const SizedBox(height: 16),\n              TextField(\n                controller: photoUrlCtrl,\n                decoration: const InputDecoration(\n                  labelText: 'Ảnh đại diện (URL)',\n                  prefixIcon: Icon(Icons.image),\n                ),\n              ),\n              const SizedBox(height: 16),\n              OutlinedButton.icon(\n                onPressed: () {\n                  Navigator.pop(context);\n                  _showAvatarOptions(uid);\n                },\n                icon: const Icon(Icons.photo_library),\n                label: const Text('Chọn ảnh từ thiết bị'),\n              ),\n            ],\n          ),\n        ),\n        actions: [\n          TextButton(\n            onPressed: () =&gt; Navigator.pop(context),\n            child: const Text('Hủy'),\n          ),\n          FilledButton(\n            onPressed: () async {\n              Navigator.pop(context);\n              displayNameController.text = displayNameCtrl.text;\n              bioController.text = bioCtrl.text;\n              photoUrlController.text = photoUrlCtrl.text;\n              await _saveProfile(uid);\n            },\n            child: const Text('Lưu'),\n          ),\n        ],\n      ),\n    );\n  }\n\n  Future&lt;void&gt; _togglePrivateAccount(String uid) async {\n    final newValue = !_isPrivate;\n    setState(() {\n      _isPrivate = newValue;\n    });\n    try {\n      await userProfileRepository.updateProfile(uid, isPrivate: newValue);\n      if (mounted) {\n        ScaffoldMessenger.of(context).showSnackBar(\n          SnackBar(\n            content: Text(\n              newValue\n                  ? 'Đã bật tài khoản riêng tư'\n                  : 'Đã tắt tài khoản riêng tư',\n            ),\n          ),\n        );\n      }\n    } catch (e) {\n      setState(() {\n        _isPrivate = !newValue;\n      });\n      if (mounted) {\n        ScaffoldMessenger.of(context).showSnackBar(\n          SnackBar(content: Text('Lỗi cập nhật: $e')),\n        );\n      }\n    }\n  }\n\n  Future&lt;void&gt; _showCustomizationModal(String uid) async {\n    await showDialog(\n      context: context,\n      builder: (context) =&gt; AlertDialog(\n        title: const Text('Tùy biến'),\n        content: SingleChildScrollView(\n          child: Column(\n            mainAxisSize: MainAxisSize.min,\n            crossAxisAlignment: CrossAxisAlignment.start,\n            children: [\n              ListTile(\n                contentPadding: EdgeInsets.zero,\n                title: const Text('Màu chủ đạo'),\n                subtitle: Text(_themeColor ?? 'Chưa chọn màu'),\n                trailing: Row(\n                  mainAxisSize: MainAxisSize.min,\n                  children: [\n                    if (_themeColor != null)\n                      Container(\n                        width: 32,\n                        height: 32,\n                        decoration: BoxDecoration(\n                          color: _parseColor(_themeColor!),\n                          shape: BoxShape.circle,\n                          border: Border.all(color: Colors.grey),\n                        ),\n                      ),\n                    const SizedBox(width: 8),\n                    IconButton(\n                      icon: const Icon(Icons.color_lens, color: AppColors.primaryPink),\n                      onPressed: () {\n                        Navigator.pop(context);\n                        _showColorPicker(context);\n                      },\n                    ),\n                    if (_themeColor != null)\n                      IconButton(\n                        icon: const Icon(Icons.clear),\n                        onPressed: () {\n                          setState(() {\n                            _themeColor = null;\n                          });\n                          Navigator.pop(context);\n                          _saveProfile(uid);\n                        },\n                      ),\n                  ],\n                ),\n              ),\n              const SizedBox(height: 16),\n              const Text(\n                'Liên kết ngoài',\n                style: TextStyle(fontWeight: FontWeight.w600),\n              ),\n              const SizedBox(height: 8),\n              if (_links.isEmpty)\n                const Text(\n                  'Chưa có liên kết nào',\n                  style: TextStyle(color: Colors.grey),\n                )\n              else\n                Wrap(\n                  spacing: 8,\n                  runSpacing: 8,\n                  children: _links.asMap().entries.map((entry) {\n                    final index = entry.key;\n                    final link = entry.value;\n                    return Chip(\n                      label: Text(link.label),\n                      deleteIcon: const Icon(Icons.close, size: 18),\n                      onDeleted: () {\n                        setState(() {\n                          _links.removeAt(index);\n                        });\n                        _saveProfile(uid);\n                      },\n                    );\n                  }).toList(),\n                ),\n              if (_links.length &lt; 5) ...[\n                const SizedBox(height: 8),\n                OutlinedButton.icon(\n                  onPressed: () {\n                    Navigator.pop(context);\n                    _showAddLinkDialog(context);\n                  },\n                  icon: const Icon(Icons.add, color: AppColors.primaryPink),\n                  label: const Text('Thêm liên kết'),\n                ),\n              ],\n            ],\n          ),\n        ),\n        actions: [\n          TextButton(\n            onPressed: () =&gt; Navigator.pop(context),\n            child: const Text('Đóng'),\n          ),\n        ],\n      ),\n    );\n  }\n\n  void _showProfileOptionsSheet(User user) {\n    showModalBottomSheet(\n      context: context,\n      builder: (context) =&gt; SafeArea(\n        child: Column(\n          mainAxisSize: MainAxisSize.min,\n          children: [\n            const ListTile(\n              title: Text(\n                'Tùy chọn tài khoản',\n                style: TextStyle(fontWeight: FontWeight.bold),\n              ),\n            ),\n            ListTile(\n              leading: const Icon(Icons.person, color: AppColors.primaryPink),\n              title: const Text('Thông tin cá nhân'),\n              trailing: const Icon(Icons.chevron_right),\n              onTap: () {\n                Navigator.pop(context);\n                _handleMenuAction(_ProfileMenuAction.personalInfo);\n              },\n            ),\n            ListTile(\n              leading: const Icon(Icons.lock_outline, color: AppColors.primaryPink),\n              title: const Text('Tài khoản riêng tư'),\n              trailing: StreamBuilder&lt;UserProfile?&gt;(\n                stream: userProfileRepository.watchProfile(user.uid),\n                builder: (context, snapshot) {\n                  final isPrivate = snapshot.data?.isPrivate ?? false;\n                  return Switch(\n                    value: isPrivate,\n                    onChanged: (value) {\n                      Navigator.pop(context);\n                      _handleMenuAction(_ProfileMenuAction.privateAccount);\n                    },\n                  );\n                },\n              ),\n            ),\n            ListTile(\n              leading: const Icon(Icons.auto_awesome, color: AppColors.primaryPink),\n              title: const Text('Highlight Stories'),\n              trailing: const Icon(Icons.chevron_right),\n              onTap: () {\n                Navigator.pop(context);\n                _handleMenuAction(_ProfileMenuAction.highlightStories);\n              },\n            ),\n            const Divider(),\n            ListTile(\n              leading: const Icon(Icons.privacy_tip, color: AppColors.primaryPink),\n              title: const Text('Quyền riêng tư'),\n              trailing: const Icon(Icons.chevron_right),\n              onTap: () {\n                Navigator.pop(context);\n                _handleMenuAction(_ProfileMenuAction.privacySettings);\n              },\n            ),\n            ListTile(\n              leading: const Icon(Icons.bookmark, color: AppColors.primaryPink),\n              title: const Text('Đã lưu'),\n              trailing: const Icon(Icons.chevron_right),\n              onTap: () {\n                Navigator.pop(context);\n                _handleMenuAction(_ProfileMenuAction.savedPosts);\n              },\n            ),\n            if (user.email != null &amp;&amp;\n                user.providerData.any((p) =&gt; p.providerId == 'password'))\n              ListTile(\n                leading: const Icon(Icons.lock, color: AppColors.primaryPink),\n                title: const Text('Đổi mật khẩu'),\n                trailing: const Icon(Icons.chevron_right),\n                onTap: () {\n                  Navigator.pop(context);\n                  _handleMenuAction(_ProfileMenuAction.changePassword);\n                },\n              ),\n            if (_isAdmin)\n              ListTile(\n                leading:\n                    const Icon(Icons.admin_panel_settings, color: AppColors.primaryPink),\n                title: const Text('Admin Dashboard'),\n                trailing: const Icon(Icons.chevron_right),\n                onTap: () {\n                  Navigator.pop(context);\n                  _handleMenuAction(_ProfileMenuAction.adminDashboard);\n                },\n              ),\n          ],\n        ),\n      ),\n    );\n  }\n}\n\nclass _EditProfileHeader extends StatelessWidget {\n  const _EditProfileHeader({\n    required this.displayName,\n    required this.photoUrl,\n    required this.statusText,\n    required this.onAddPressed,\n    required this.onAccountMenuPressed,\n    required this.onAvatarTap,\n    required this.note,\n    required this.onNoteTap,\n    required this.hasActiveStory,\n    required this.storyRingColor,\n    this.themeColor,\n    this.isUploading = false,\n  });\n\n  final String displayName;\n  final String photoUrl;\n  final String statusText;\n  final String note;\n  final Color? themeColor;\n  final bool isUploading;\n  final VoidCallback onAddPressed;\n  final VoidCallback onAccountMenuPressed;\n  final VoidCallback onAvatarTap;\n  final VoidCallback onNoteTap;\n  final bool hasActiveStory;\n  final Color? storyRingColor;\n\n  @override\n  Widget build(BuildContext context) {\n    return Column(\n      crossAxisAlignment: CrossAxisAlignment.stretch,\n      children: [\n        Center(\n          child: Row(\n            mainAxisSize: MainAxisSize.min,\n            children: [\n              // Icon ảo bên trái để cân đối layout, không nhận tương tác\n              IgnorePointer(\n                child: Opacity(\n                  opacity: 0,\n                  child: IconButton(\n                    onPressed: () {},\n                    icon: const Icon(Icons.keyboard_arrow_down, size: 22),\n                    padding: EdgeInsets.zero,\n                    constraints: const BoxConstraints(),\n                    splashRadius: 20,\n                  ),\n                ),\n              ),\n              const SizedBox(width: 6),\n              Flexible(\n                child: Text(\n                  displayName,\n                  style: const TextStyle(\n                    fontSize: 20,\n                    fontWeight: FontWeight.w800,\n                  ),\n                  maxLines: 1,\n                  overflow: TextOverflow.ellipsis,\n                  textAlign: TextAlign.center,\n                ),\n              ),\n              const SizedBox(width: 6),\n              IconButton(\n                onPressed: onAccountMenuPressed,\n                icon: const Icon(Icons.keyboard_arrow_down, size: 22),\n                padding: EdgeInsets.zero,\n                constraints: const BoxConstraints(),\n                splashRadius: 20,\n              ),\n            ],\n          ),\n        ),\n        const SizedBox(height: 16),\n        Center(\n          child: Stack(\n            clipBehavior: Clip.none,\n            children: [\n              // Avatar (tap để đổi ảnh) + vòng story (hồng/xám)\n              GestureDetector(\n                onTap: onAvatarTap,\n                child: Hero(\n                  tag: 'profile_avatar_fullscreen',\n                  child: Container(\n                    decoration: hasActiveStory &amp;&amp; storyRingColor != null\n                        ? BoxDecoration(\n                            shape: BoxShape.circle,\n                            border: Border.all(\n                              color: storyRingColor!,\n                              width: 3.5,\n                            ),\n                          )\n                        : null,\n                    child: CircleAvatar(\n                      radius: 48,\n                      backgroundImage:\n                          photoUrl.isNotEmpty ? NetworkImage(photoUrl) : null,\n                      child: photoUrl.isEmpty\n                          ? const Icon(Icons.person, size: 48)\n                          : isUploading\n                              ? Container(\n                                  color: Colors.black54,\n                                  child: const Center(\n                                    child: CircularProgressIndicator(\n                                      valueColor: AlwaysStoppedAnimation&lt;Color&gt;(\n                                        Colors.white,\n                                      ),\n                                    ),\n                                  ),\n                                )\n                              : null,\n                    ),\n                  ),\n                ),\n              ),\n              // Nút + đăng story/post\n              Positioned(\n                right: -6,\n                bottom: -6,\n                child: GestureDetector(\n                  // Dấu + để đăng story / post\n                  onTap: onAddPressed,\n                  child: Container(\n                    padding: const EdgeInsets.all(8),\n                    decoration: BoxDecoration(\n                      shape: BoxShape.circle,\n                      color: AppColors.primaryPink,\n                      border: Border.all(color: Colors.white, width: 3),\n                    ),\n                    child: const Icon(Icons.add, color: Colors.white, size: 20),\n                  ),\n                ),\n              ),\n              // Bong bóng ghi chú đè lên avatar\n              Positioned(\n                top: 6,\n                left: 0,\n                right: 0,\n                child: GestureDetector(\n                  behavior: HitTestBehavior.translucent,\n                  onTap: onNoteTap,\n                  child: TweenAnimationBuilder&lt;double&gt;(\n                    tween: Tween(begin: 0.95, end: 1.0),\n                    duration: const Duration(milliseconds: 800),\n                    curve: Curves.easeInOut,\n                    builder: (context, value, child) {\n                      return Transform.scale(scale: value, child: child);\n                    },\n                    child: Center(\n                      child: Container(\n                        constraints: const BoxConstraints(maxWidth: 180),\n                        padding: const EdgeInsets.symmetric(\n                          horizontal: 12,\n                          vertical: 6,\n                        ),\n                        decoration: BoxDecoration(\n                          color: Colors.white,\n                          borderRadius: BorderRadius.circular(18),\n                          boxShadow: [\n                            BoxShadow(\n                              color: Colors.black.withOpacity(0.08),\n                              blurRadius: 8,\n                              offset: const Offset(0, 4),\n                            ),\n                          ],\n                        ),\n                        child: Text(\n                          note.isNotEmpty ? note : 'Thêm ghi chú...',\n                          maxLines: 1,\n                          overflow: TextOverflow.ellipsis,\n                          style: const TextStyle(\n                            fontSize: 12,\n                            fontWeight: FontWeight.w600,\n                          ),\n                        ),\n                      ),\n                    ),\n                  ),\n                ),\n              ),\n            ],\n          ),\n        ),\n        const SizedBox(height: 12),\n        Center(\n          child: Text(\n            displayName,\n            style: const TextStyle(\n              fontSize: 20,\n              fontWeight: FontWeight.bold,\n            ),\n          ),\n        ),\n        const SizedBox(height: 4),\n        Center(\n          child: Text(\n            statusText,\n            style: TextStyle(\n              fontSize: 14,\n              color: Theme.of(context).colorScheme.onSurfaceVariant,\n            ),\n          ),\n        ),\n      ],\n    );\n  }\n}\n\nclass _HighlightStoryBubble extends StatelessWidget {\n  const _HighlightStoryBubble({\n    required this.highlight,\n    required this.firstStory,\n    required this.authorUid,\n    required this.onTap,\n  });\n\n  final HighlightStory highlight;\n  final Story firstStory;\n  final String authorUid;\n  final VoidCallback onTap;\n\n  @override\n  Widget build(BuildContext context) {\n    return GestureDetector(\n      onTap: onTap,\n      child: Container(\n        width: 70,\n        margin: const EdgeInsets.symmetric(horizontal: 6),\n        child: Column(\n          mainAxisSize: MainAxisSize.min,\n          children: [\n            Container(\n              width: 70,\n              height: 70,\n              decoration: BoxDecoration(\n                shape: BoxShape.circle,\n                border: Border.all(color: Colors.purple, width: 2.5),\n              ),\n              child: ClipOval(\n                child: firstStory.thumbnailUrl != null\n                    ? Image.network(\n                        firstStory.thumbnailUrl!,\n                        fit: BoxFit.cover,\n                        errorBuilder: (_, __, ___) =&gt; _buildPlaceholder(),\n                      )\n                    : firstStory.type == StoryMediaType.image\n                        ? Image.network(\n                            firstStory.mediaUrl,\n                            fit: BoxFit.cover,\n                            errorBuilder: (_, __, ___) =&gt; _buildPlaceholder(),\n                          )\n                        : _buildPlaceholder(),\n              ),\n            ),\n            const SizedBox(height: 6),\n            Text(\n              highlight.name,\n              style: const TextStyle(\n                fontSize: 11,\n                fontWeight: FontWeight.w500,\n              ),\n              maxLines: 1,\n              overflow: TextOverflow.ellipsis,\n              textAlign: TextAlign.center,\n            ),\n          ],\n        ),\n      ),\n    );\n  }\n\n  Widget _buildPlaceholder() {\n    return Container(\n      color: Colors.grey[300],\n      child: Icon(\n        firstStory.type == StoryMediaType.video ? Icons.videocam : Icons.image,\n        color: Colors.grey[600],\n        size: 30,\n      ),\n    );\n  }\n}\n\nclass _StatChip extends StatelessWidget {\n  const _StatChip({\n    required this.label,\n    required this.value,\n  });\n\n  final String label;\n  final int value;\n\n  @override\n  Widget build(BuildContext context) {\n    return Container(\n      padding: const EdgeInsets.symmetric(horizontal: 24, vertical: 12),\n      decoration: BoxDecoration(\n        color: AppColors.primaryPink.withOpacity(0.1),\n        borderRadius: BorderRadius.circular(20),\n        border: Border.all(color: AppColors.primaryPink.withOpacity(0.3)),\n      ),\n      child: Column(\n      children: [\n        Text(\n          '$value',\n          style: const TextStyle(\n              fontSize: 20,\n            fontWeight: FontWeight.bold,\n              color: AppColors.primaryPink,\n          ),\n        ),\n        const SizedBox(height: 4),\n          Text(\n            label,\n            style: const TextStyle(\n              fontSize: 12,\n              color: AppColors.primaryPink,\n            ),\n          ),\n        ],\n      ),\n    );\n  }\n}\n\n\n",
    "languageId": "dart"
  }
}
```
Result:

```json
{
  "diff": {
    "chunks": [
      {
        "diffString": "                GestureDetector(\n                  onTap: onAvatarTap,\n-                 child: Container(\n-                   decoration: hasActiveStory &amp;&amp; storyRingColor != null\n-                       ? BoxDecoration(\n-                           shape: BoxShape.circle,\n-                           border: Border.all(\n-                             color: storyRingColor!,\n-                             width: 3.5,\n-                           ),\n-                         )\n-                       : null,\n-                   child: CircleAvatar(\n-                     radius: 48,\n-                     backgroundImage:\n-                         photoUrl.isNotEmpty ? NetworkImage(photoUrl) : null,\n-                     child: photoUrl.isEmpty\n-                         ? const Icon(Icons.person, size: 48)\n-                         : isUploading\n-                             ? Container(\n-                                 color: Colors.black54,\n-                                 child: const Center(\n-                                   child: CircularProgressIndicator(\n-                                     valueColor:\n-                                         AlwaysStoppedAnimation&lt;Color&gt;(Colors.white),\n-                                   ),\n-                                 ),\n-                               )\n-                             : null,\n+                 child: Hero(\n+                   tag: 'profile_avatar_fullscreen',\n+                   child: Container(\n+                     decoration: hasActiveStory &amp;&amp; storyRingColor != null\n+                         ? BoxDecoration(\n+                             shape: BoxShape.circle,\n+                             border: Border.all(\n+                               color: storyRingColor!,\n+                               width: 3.5,\n+                             ),\n+                           )\n+                         : null,\n+                     child: CircleAvatar(\n+                       radius: 48,\n+                       backgroundImage:\n+                           photoUrl.isNotEmpty ? NetworkImage(photoUrl) : null,\n+                       child: photoUrl.isEmpty\n+                           ? const Icon(Icons.person, size: 48)\n+                           : isUploading\n+                               ? Container(\n+                                   color: Colors.black54,\n+                                   child: const Center(\n+                                     child: CircularProgressIndicator(\n+                                       valueColor: AlwaysStoppedAnimation&lt;Color&gt;(\n+                                         Colors.white,\n+                                       ),\n+                                     ),\n+                                   ),\n+                                 )\n+                               : null,\n+                     ),\n                    ),\n                  ),",
        "oldStart": 1787,
        "newStart": 1787,
        "oldLines": 31,
        "newLines": 35,
        "linesRemoved": 27,
        "linesAdded": 31
      }
    ],
    "editor": "EDITOR_AI"
  },
  "shouldAutoFixLints": true,
  "resultForModel": "Success. Updated the following files:\nM lib/features/profile/profile_screen.dart",
  "contentsAfterEdit": "import 'dart:async';\nimport 'dart:io';\n\nimport 'package:firebase_storage/firebase_storage.dart';\nimport 'package:flutter/foundation.dart';\nimport 'package:flutter/material.dart';\nimport 'package:image_picker/image_picker.dart';\n\nimport 'user_profile_repository.dart';\nimport '../admin/pages/admin_dashboard_page.dart';\nimport '../admin/repositories/admin_repository.dart';\nimport 'package:firebase_auth/firebase_auth.dart';\n\nimport '../auth/auth_gate.dart';\nimport '../auth/auth_repository.dart';\nimport '../auth/login_screen.dart';\nimport '../auth/saved_accounts_repository.dart';\nimport '../auth/saved_credentials_repository.dart';\nimport '../follow/services/follow_service.dart';\nimport '../../services/cloudinary_service.dart';\nimport '../saved_posts/pages/saved_posts_page.dart';\nimport '../settings/pages/privacy_settings_page.dart';\nimport '../auth/pages/change_password_page.dart';\nimport '../stories/pages/story_create_page.dart';\nimport '../stories/pages/story_viewer_page.dart';\nimport '../stories/repositories/story_repository.dart';\nimport '../stories/models/story.dart';\nimport '../posts/pages/post_create_page.dart';\nimport '../posts/pages/post_permalink_page.dart';\nimport '../posts/repositories/post_repository.dart';\nimport '../posts/models/post.dart';\nimport 'widgets/profile_posts_widgets.dart';\nimport 'widgets/avatar_fullscreen_viewer.dart';\nimport 'pages/manage_highlight_stories_page.dart';\nimport '../../theme/colors.dart';\n\nenum _ProfileMenuAction {\n  personalInfo,\n  privacySettings,\n  privateAccount,\n  highlightStories,\n  savedPosts,\n  changePassword,\n  adminDashboard,\n  logout,\n}\n\nenum _LogoutChoice {\n  saveAndSignOut,\n  signOutOnly,\n}\n\nenum _CreateAction { story, post }\nenum _AccountMenuAction { switchAccount, logout }\n\nclass ProfileScreen extends StatefulWidget {\n  const ProfileScreen({super.key});\n\n  @override\n  State&lt;ProfileScreen&gt; createState() =&gt; _ProfileScreenState();\n}\n\nclass _ProfileScreenState extends State&lt;ProfileScreen&gt; {\n  final TextEditingController displayNameController = TextEditingController();\n  final TextEditingController photoUrlController = TextEditingController();\n  final TextEditingController bioController = TextEditingController();\n  final TextEditingController noteController = TextEditingController();\n  final ImagePicker _picker = ImagePicker();\n  final AdminRepository _adminRepository = AdminRepository();\n  final PostRepository _postRepository = PostRepository();\n  bool isSaving = false;\n  bool isUploading = false;\n  bool _loadedInitial = false;\n  bool _isPrivate = false;\n  String? _themeColor;\n  List&lt;ProfileLink&gt; _links = [];\n  bool _isAdmin = false;\n  late final FollowService _followService;\n  List&lt;Post&gt; _pinnedPosts = [];\n  List&lt;Post&gt; _allPosts = [];\n  bool _isLoadingPosts = false;\n\n  @override\n  void initState() {\n    super.initState();\n    _followService = FollowService();\n    _checkAdminStatus();\n    _loadPinnedPosts();\n    _loadAllPosts();\n  }\n\n  Future&lt;void&gt; _loadPinnedPosts() async {\n    try {\n      final user = authRepository.currentUser();\n      if (user == null) return;\n      final profile = await userProfileRepository.fetchProfile(user.uid);\n      if (profile == null || profile.pinnedPostIds.isEmpty) {\n        if (mounted) {\n          setState(() {\n            _pinnedPosts = [];\n          });\n        }\n        return;\n      }\n\n      final posts = &lt;Post&gt;[];\n      for (final postId in profile.pinnedPostIds) {\n        try {\n          final post = await _postRepository.watchPost(postId).first;\n          posts.add(post);\n        } catch (_) {\n          continue;\n        }\n      }\n\n      if (mounted) {\n        setState(() {\n          _pinnedPosts = posts;\n        });\n      }\n    } catch (_) {\n      // ignore\n    }\n  }\n\n  Future&lt;void&gt; _loadAllPosts() async {\n    final user = authRepository.currentUser();\n    if (user == null) return;\n\n    setState(() {\n      _isLoadingPosts = true;\n    });\n\n    try {\n      final pageResult = await _postRepository.fetchPostsByAuthor(\n        authorUid: user.uid,\n        limit: 50,\n      );\n\n      final posts = pageResult.docs.map((doc) =&gt; Post.fromDoc(doc)).toList();\n\n      if (mounted) {\n        setState(() {\n          _allPosts = posts;\n          _isLoadingPosts = false;\n        });\n      }\n    } catch (_) {\n      if (mounted) {\n        setState(() {\n          _isLoadingPosts = false;\n        });\n      }\n    }\n  }\n\n  Future&lt;void&gt; _checkAdminStatus() async {\n    final user = authRepository.currentUser();\n    if (user != null) {\n      final isAdmin = await _adminRepository.isAdmin(user.uid);\n      if (mounted) {\n        setState(() {\n          _isAdmin = isAdmin;\n        });\n      }\n    }\n  }\n\n  @override\n  void dispose() {\n    displayNameController.dispose();\n    photoUrlController.dispose();\n    bioController.dispose();\n    noteController.dispose();\n    super.dispose();\n  }\n\n  Future&lt;void&gt; _saveProfile(String uid) async {\n    setState(() {\n      isSaving = true;\n    });\n    try {\n      await userProfileRepository.updateProfile(\n        uid,\n        displayName: displayNameController.text.trim(),\n        photoUrl: photoUrlController.text.trim().isEmpty\n            ? null\n            : photoUrlController.text.trim(),\n        removePhoto: photoUrlController.text.trim().isEmpty,\n        bio: bioController.text.trim(),\n        note: noteController.text.trim(),\n        isPrivate: _isPrivate,\n        themeColor: _themeColor,\n        links: _links,\n      );\n      _loadedInitial = false;\n      if (!mounted) return;\n      ScaffoldMessenger.of(context).showSnackBar(\n        const SnackBar(content: Text('Đã cập nhật hồ sơ.')),\n      );\n    } catch (e) {\n      if (!mounted) return;\n      ScaffoldMessenger.of(context).showSnackBar(\n        SnackBar(content: Text('Lỗi cập nhật: $e')),\n      );\n    } finally {\n      if (mounted) {\n        setState(() {\n          isSaving = false;\n        });\n      }\n    }\n  }\n\n  /// Chọn storage backend: 'firebase' hoặc 'cloudinary'\n  /// Phải khớp với PostService.storageBackend\n  static const String storageBackend = 'cloudinary'; // Thay đổi thành 'firebase' nếu muốn dùng Firebase Storage\n\n  Future&lt;void&gt; _pickAndUploadImage(String uid, ImageSource source) async {\n    setState(() {\n      isUploading = true;\n    });\n    try {\n      final XFile? picked = await _picker.pickImage(\n        source: source,\n        maxWidth: 1024,\n        imageQuality: 85,\n      );\n      if (picked == null) {\n        setState(() {\n          isUploading = false;\n        });\n        return;\n      }\n\n      String url;\n      \n      if (storageBackend == 'cloudinary') {\n        // Dùng Cloudinary\n        final result = await CloudinaryService.uploadImage(\n          file: picked,\n          folder: 'user_profiles/$uid',\n          publicId: 'avatar',\n        );\n        url = result['url']!;\n      } else {\n        // Dùng Firebase Storage (code cũ)\n        final storageRef =\n            FirebaseStorage.instance.ref().child('user_profiles/$uid/avatar.jpg');\n\n        if (kIsWeb) {\n          final bytes = await picked.readAsBytes();\n          await storageRef.putData(\n            bytes,\n            SettableMetadata(contentType: picked.mimeType ?? 'image/jpeg'),\n          );\n        } else {\n          final file = File(picked.path);\n          await storageRef.putFile(\n            file,\n            SettableMetadata(contentType: 'image/jpeg'),\n          );\n        }\n\n        url = await storageRef.getDownloadURL();\n      }\n\n      await userProfileRepository.updateProfile(uid, photoUrl: url);\n      _loadedInitial = false;\n      if (mounted) {\n        photoUrlController.text = url;\n        ScaffoldMessenger.of(context).showSnackBar(\n          const SnackBar(content: Text('Đã cập nhật ảnh đại diện.')),\n        );\n      }\n    } catch (e) {\n      if (mounted) {\n        ScaffoldMessenger.of(context).showSnackBar(\n          SnackBar(content: Text('Lỗi tải ảnh: $e')),\n        );\n      }\n    } finally {\n      if (mounted) {\n        setState(() {\n          isUploading = false;\n        });\n      }\n    }\n  }\n\n  Future&lt;void&gt; _removePhoto(String uid) async {\n    setState(() {\n      isUploading = true;\n    });\n    try {\n      await userProfileRepository.updateProfile(\n        uid,\n        photoUrl: '',\n        removePhoto: true,\n      );\n      _loadedInitial = false;\n      if (mounted) {\n        photoUrlController.clear();\n        ScaffoldMessenger.of(context).showSnackBar(\n          const SnackBar(content: Text('Đã xoá ảnh đại diện.')),\n        );\n      }\n    } catch (e) {\n      if (mounted) {\n        ScaffoldMessenger.of(context).showSnackBar(\n          SnackBar(content: Text('Không thể xoá ảnh: $e')),\n        );\n      }\n    } finally {\n      if (mounted) {\n        setState(() {\n          isUploading = false;\n        });\n      }\n    }\n  }\n\n  Future&lt;void&gt; _showCreateChooser() async {\n    final action = await showModalBottomSheet&lt;_CreateAction&gt;(\n      context: context,\n      builder: (context) =&gt; SafeArea(\n        child: Column(\n          mainAxisSize: MainAxisSize.min,\n          children: [\n            ListTile(\n              leading: const Icon(Icons.history_edu),\n              title: const Text('Đăng story'),\n              onTap: () =&gt; Navigator.pop(context, _CreateAction.story),\n            ),\n            ListTile(\n              leading: const Icon(Icons.add_photo_alternate_outlined),\n              title: const Text('Thêm bài viết'),\n              onTap: () =&gt; Navigator.pop(context, _CreateAction.post),\n            ),\n          ],\n        ),\n      ),\n    );\n\n    if (!mounted || action == null) return;\n    switch (action) {\n      case _CreateAction.story:\n              Navigator.of(context).push(\n          MaterialPageRoute(builder: (_) =&gt; const StoryCreatePage()),\n        );\n        break;\n      case _CreateAction.post:\n              Navigator.of(context).push(\n          MaterialPageRoute(builder: (_) =&gt; const PostCreatePage()),\n        );\n        break;\n    }\n  }\n\n  Future&lt;void&gt; _showAccountMenu() async {\n    final action = await showModalBottomSheet&lt;_AccountMenuAction&gt;(\n      context: context,\n      builder: (context) =&gt; SafeArea(\n        child: Column(\n          mainAxisSize: MainAxisSize.min,\n          children: [\n            ListTile(\n              leading: const Icon(Icons.switch_account),\n              title: const Text('Chuyển tài khoản'),\n              onTap: () =&gt; Navigator.pop(context, _AccountMenuAction.switchAccount),\n            ),\n            ListTile(\n              leading: const Icon(Icons.logout),\n              title: const Text('Đăng xuất'),\n              onTap: () =&gt; Navigator.pop(context, _AccountMenuAction.logout),\n            ),\n          ],\n        ),\n      ),\n    );\n\n    if (!mounted || action == null) return;\n    switch (action) {\n      case _AccountMenuAction.switchAccount:\n        await _showSwitchAccountSheet();\n        break;\n      case _AccountMenuAction.logout:\n        await _confirmLogoutAndMaybeSave(\n          currentUser: authRepository.currentUser(),\n          forSwitchAccount: false,\n        );\n        break;\n    }\n  }\n\n  Future&lt;void&gt; _confirmLogoutAndMaybeSave({\n    User? currentUser,\n    bool forSwitchAccount = false,\n  }) async {\n    final user = currentUser ?? authRepository.currentUser();\n    if (user == null) return;\n\n    final choice = await showDialog&lt;_LogoutChoice&gt;(\n      context: context,\n      builder: (ctx) =&gt; AlertDialog(\n        title: const Text('Đăng xuất'),\n        content: const Text('Bạn có muốn lưu tài khoản này để chuyển đổi nhanh sau này không?'),\n        actions: [\n          TextButton(\n            onPressed: () =&gt; Navigator.pop(ctx, _LogoutChoice.signOutOnly),\n            child: const Text('Đăng xuất'),\n          ),\n          FilledButton(\n            onPressed: () =&gt; Navigator.pop(ctx, _LogoutChoice.saveAndSignOut),\n            child: const Text('Lưu tài khoản'),\n          ),\n        ],\n      ),\n    );\n\n    if (!mounted || choice == null) return;\n\n    if (choice == _LogoutChoice.saveAndSignOut) {\n      await SavedAccountsRepository.instance.saveAccountFromUser(user);\n      ScaffoldMessenger.of(context).showSnackBar(\n        const SnackBar(content: Text('Đã lưu tài khoản trên thiết bị.')),\n      );\n    } else {\n      await SavedAccountsRepository.instance.removeAccount(user.uid);\n      await SavedCredentialsRepository.instance.removePassword(user.uid);\n    }\n\n    await userProfileRepository.setPresence(user.uid, false);\n    // Với flow đăng xuất bình thường: set offline + signOut để quay về màn hình login/AuthGate\n    // Với flow chuyển đổi tài khoản: chỉ set offline, KHÔNG signOut, sẽ signIn tài khoản khác ngay sau đó\n    if (!forSwitchAccount) {\n      await authRepository.signOut();\n    }\n    if (mounted) {\n      Navigator.of(context).pop();\n    }\n  }\n\n  Future&lt;void&gt; _showSwitchAccountSheet() async {\n    final accounts = await SavedAccountsRepository.instance.getAccounts();\n    if (!mounted) return;\n\n    if (accounts.isEmpty) {\n      ScaffoldMessenger.of(context).showSnackBar(\n        const SnackBar(content: Text('Chưa có tài khoản nào được lưu trên thiết bị.')),\n      );\n      return;\n    }\n\n    final selected = await showModalBottomSheet&lt;SavedAccount&gt;(\n      context: context,\n      builder: (ctx) =&gt; SafeArea(\n        child: Column(\n          mainAxisSize: MainAxisSize.min,\n          children: [\n            const ListTile(\n              title: Text(\n                'Chuyển đổi tài khoản',\n                style: TextStyle(fontWeight: FontWeight.bold),\n              ),\n            ),\n            ...accounts.map(\n              (acc) =&gt; ListTile(\n                leading: CircleAvatar(\n                  backgroundImage:\n                      acc.photoUrl != null &amp;&amp; acc.photoUrl!.isNotEmpty ? NetworkImage(acc.photoUrl!) : null,\n                  child: acc.photoUrl == null || acc.photoUrl!.isEmpty\n                      ? const Icon(Icons.person)\n                      : null,\n                ),\n                title: Text(acc.displayName ?? acc.email ?? acc.uid),\n                subtitle: acc.email != null ? Text(acc.email!) : null,\n                onTap: () =&gt; Navigator.pop(ctx, acc),\n              ),\n            ),\n            const SizedBox(height: 8),\n          ],\n        ),\n      ),\n    );\n\n    if (!mounted || selected == null) return;\n\n    // Khi chọn tài khoản khác: hỏi có lưu tài khoản hiện tại không\n    final current = authRepository.currentUser();\n    if (current != null) {\n      await _confirmLogoutAndMaybeSave(\n        currentUser: current,\n        forSwitchAccount: true,\n      );\n    }\n\n    if (!mounted) return;\n\n    // Thử đăng nhập nhanh vào tài khoản đã lưu\n    final quickSuccess = await _quickSignInToSavedAccount(selected);\n\n    if (!mounted) return;\n\n    if (quickSuccess) {\n      // Điều hướng về AuthGate để toàn bộ app rebuild theo user mới\n      Navigator.of(context).pushAndRemoveUntil(\n                MaterialPageRoute(\n          builder: (_) =&gt; const AuthGate(),\n        ),\n        (route) =&gt; false,\n      );\n    } else {\n      // Fallback: chuyển sang màn hình login với email được điền sẵn\n      final identifier = selected.email ?? selected.displayName ?? selected.uid;\n      ScaffoldMessenger.of(context).showSnackBar(\n        const SnackBar(\n          content: Text(\n            'Tài khoản này chưa lưu mật khẩu an toàn. Vui lòng đăng nhập lại một lần.',\n          ),\n        ),\n      );\n      Navigator.of(context).pushAndRemoveUntil(\n                MaterialPageRoute(\n          builder: (_) =&gt; LoginScreen(initialIdentifier: identifier),\n        ),\n        (route) =&gt; false,\n      );\n    }\n  }\n\n  Future&lt;bool&gt; _quickSignInToSavedAccount(SavedAccount account) async {\n    try {\n      // Chỉ hỗ trợ auto-login nhanh cho tài khoản đăng nhập bằng email/mật khẩu\n      if (account.providerId == 'password' &amp;&amp; account.email != null) {\n        final password =\n            await SavedCredentialsRepository.instance.getPassword(account.uid);\n        if (password == null || password.isEmpty) {\n          return false;\n        }\n\n        // SignIn vào tài khoản mới\n        await authRepository.signInWithEmail(account.email!, password);\n\n        // Đợi auth state thay đổi để đảm bảo signIn hoàn tất\n        // Sử dụng Stream để đợi auth state change hoặc timeout sau 3 giây\n        final completer = Completer&lt;bool&gt;();\n        StreamSubscription&lt;User?&gt;? subscription;\n        Timer? timeoutTimer;\n\n        subscription = authRepository.authState().listen((user) {\n          if (user != null &amp;&amp; user.uid == account.uid) {\n            subscription?.cancel();\n            timeoutTimer?.cancel();\n            if (!completer.isCompleted) {\n              completer.complete(true);\n            }\n          }\n        });\n\n        // Timeout sau 3 giây nếu không nhận được auth state change\n        timeoutTimer = Timer(const Duration(seconds: 3), () {\n          subscription?.cancel();\n          final currentUser = authRepository.currentUser();\n          final success = currentUser != null &amp;&amp; currentUser.uid == account.uid;\n          if (!completer.isCompleted) {\n            completer.complete(success);\n          }\n        });\n\n        // Đợi kết quả\n        final result = await completer.future;\n        subscription.cancel();\n        timeoutTimer.cancel();\n\n        return result;\n      }\n      // Các provider khác (Google/Facebook) hiện tại không auto-login để tránh chọn sai account\n      return false;\n    } catch (_) {\n      return false;\n    }\n  }\n\n  /// Hiển thị bottom sheet khi chạm avatar trên trang hồ sơ\n  /// - Nếu người dùng có story (kể cả đã xem hết): thêm hành động \"Xem tin\"\n  /// - Dù có story hay không, luôn có tuỳ chọn \"Xem ảnh đại diện\" (nếu có ảnh)\n  void _handleAvatarTap(String uid, StoryRingStatus ringStatus) {\n    final hasStory = ringStatus != StoryRingStatus.none;\n\n    if (!hasStory) {\n      // Không có story -&gt; dùng sheet ảnh đại diện (vẫn có Xem ảnh đại diện)\n      _showAvatarOptions(uid);\n      return;\n    }\n\n    showModalBottomSheet(\n      context: context,\n      builder: (context) =&gt; SafeArea(\n        child: Column(\n          mainAxisSize: MainAxisSize.min,\n          children: [\n            ListTile(\n              leading: const Icon(Icons.history_edu),\n              title: const Text('Xem tin'),\n              onTap: () {\n                Navigator.pop(context);\n                Navigator.of(context).push(\n                  MaterialPageRoute(\n                    builder: (_) =&gt; StoryViewerPage(\n                      initialAuthorUid: uid,\n                      userIdsWithStories: [uid],\n                    ),\n                  ),\n                );\n              },\n            ),\n            if (photoUrlController.text.isNotEmpty)\n              ListTile(\n                leading: const Icon(Icons.remove_red_eye),\n                title: const Text('Xem ảnh đại diện'),\n                onTap: () {\n                  Navigator.pop(context);\n                  Navigator.of(context).push(\n                    MaterialPageRoute(\n                      builder: (_) =&gt; AvatarFullscreenViewer(\n                        photoUrl: photoUrlController.text,\n                      ),\n                    ),\n                  );\n                },\n              ),\n            ListTile(\n              leading: const Icon(Icons.photo_library),\n              title: const Text('Chọn ảnh từ thư viện'),\n              onTap: () {\n                Navigator.pop(context);\n                _pickAndUploadImage(uid, ImageSource.gallery);\n              },\n            ),\n            ListTile(\n              leading: const Icon(Icons.camera_alt),\n              title: const Text('Chụp ảnh'),\n              onTap: () {\n                Navigator.pop(context);\n                _pickAndUploadImage(uid, ImageSource.camera);\n              },\n            ),\n            if (photoUrlController.text.isNotEmpty)\n              ListTile(\n                leading: const Icon(Icons.delete_outline, color: Colors.red),\n                title: const Text(\n                  'Xoá ảnh đại diện',\n                  style: TextStyle(color: Colors.red),\n                ),\n                onTap: () {\n                  Navigator.pop(context);\n                  _removePhoto(uid);\n                },\n              ),\n          ],\n        ),\n      ),\n    );\n  }\n\n  void _showAvatarOptions(String uid) {\n    showModalBottomSheet(\n      context: context,\n      builder: (context) =&gt; SafeArea(\n        child: Column(\n          mainAxisSize: MainAxisSize.min,\n          children: [\n            if (photoUrlController.text.isNotEmpty)\n              ListTile(\n                leading: const Icon(Icons.remove_red_eye),\n                title: const Text('Xem ảnh đại diện'),\n                onTap: () {\n                  Navigator.pop(context);\n                  Navigator.of(context).push(\n                    MaterialPageRoute(\n                      builder: (_) =&gt; AvatarFullscreenViewer(\n                        photoUrl: photoUrlController.text,\n                      ),\n                    ),\n                  );\n                },\n              ),\n            ListTile(\n              leading: const Icon(Icons.photo_library),\n              title: const Text('Chọn ảnh từ thư viện'),\n              onTap: () {\n                Navigator.pop(context);\n                _pickAndUploadImage(uid, ImageSource.gallery);\n              },\n            ),\n            ListTile(\n              leading: const Icon(Icons.camera_alt),\n              title: const Text('Chụp ảnh'),\n              onTap: () {\n                Navigator.pop(context);\n                _pickAndUploadImage(uid, ImageSource.camera);\n              },\n            ),\n            if (photoUrlController.text.isNotEmpty)\n              ListTile(\n                leading: const Icon(Icons.delete_outline, color: Colors.red),\n                title: const Text('Xoá ảnh đại diện', style: TextStyle(color: Colors.red)),\n                onTap: () {\n                  Navigator.pop(context);\n                  _removePhoto(uid);\n                },\n              ),\n          ],\n        ),\n      ),\n    );\n  }\n\n  String _formatLastSeen(DateTime lastSeen) {\n    final diff = DateTime.now().difference(lastSeen);\n    if (diff.inMinutes &lt; 1) {\n      return 'Vừa mới hoạt động';\n    } else if (diff.inHours &lt; 1) {\n      return 'Hoạt động ${diff.inMinutes} phút trước';\n    } else if (diff.inDays &lt; 1) {\n      return 'Hoạt động ${diff.inHours} giờ trước';\n    } else {\n      return 'Hoạt động ${diff.inDays} ngày trước';\n    }\n  }\n\n  @override\n  Widget build(BuildContext context) {\n    final user = authRepository.currentUser();\n    if (user == null) {\n      return const Scaffold(\n        body: Center(child: Text('Không tìm thấy người dùng.')),\n      );\n    }\n\n    return Scaffold(\n      appBar: AppBar(\n        title: const Text(\n          'Hồ sơ của bạn',\n          style: TextStyle(color: AppColors.primaryPink),\n        ),\n        iconTheme: const IconThemeData(color: AppColors.primaryPink),\n        actions: [\n          IconButton(\n            icon: const Icon(Icons.menu),\n            onPressed: () {\n              _showProfileOptionsSheet(user);\n            },\n          ),\n        ],\n      ),\n      body: StreamBuilder&lt;UserProfile?&gt;(\n        stream: userProfileRepository.watchProfile(user.uid),\n        builder: (context, snapshot) {\n          final profile = snapshot.data;\n          if (!_loadedInitial &amp;&amp; profile != null) {\n            displayNameController.text = profile.displayName ?? '';\n            photoUrlController.text = profile.photoUrl ?? '';\n            bioController.text = profile.bio ?? '';\n          noteController.text = profile.note ?? '';\n            _isPrivate = profile.isPrivate;\n            _themeColor = profile.themeColor;\n            _links = List&lt;ProfileLink&gt;.from(profile.links);\n            _loadedInitial = true;\n          }\n\n          final themeColor = _themeColor != null ? _parseColor(_themeColor!) : null;\n          final displayName = displayNameController.text.isNotEmpty\n              ? displayNameController.text\n              : (user.email ?? user.uid);\n          final statusText = profile?.isOnline == true\n              ? 'Đang hoạt động'\n              : profile?.lastSeen != null\n                  ? _formatLastSeen(profile!.lastSeen!)\n                  : 'Ngoại tuyến';\n\n          return SingleChildScrollView(\n            padding: const EdgeInsets.symmetric(horizontal: 16, vertical: 20),\n            child: Column(\n              crossAxisAlignment: CrossAxisAlignment.stretch,\n              children: [\n                FutureBuilder&lt;StoryRingStatus&gt;(\n                  future: StoryRepository().fetchStoryRingStatus(\n                    ownerUid: user.uid,\n                    viewerUid: user.uid,\n                  ),\n                  builder: (context, ringSnapshot) {\n                    final ringStatus =\n                        ringSnapshot.data ?? StoryRingStatus.none;\n                    final hasActiveStory =\n                        ringStatus != StoryRingStatus.none;\n                    Color? ringColor;\n                    if (ringStatus == StoryRingStatus.unseen) {\n                      ringColor = AppColors.primaryPink;\n                    } else if (ringStatus == StoryRingStatus.allSeen) {\n                      // Vòng tròn xám đậm hơn để dễ thấy khi đã xem hết story\n                      ringColor = Colors.grey.shade600;\n                    }\n\n                    return _EditProfileHeader(\n                      displayName: displayName,\n                      photoUrl: photoUrlController.text,\n                      statusText: statusText,\n                      themeColor: themeColor,\n                      isUploading: isUploading,\n                      hasActiveStory: hasActiveStory,\n                      storyRingColor: ringColor,\n                      onAddPressed: _showCreateChooser,\n                      onAccountMenuPressed: _showAccountMenu,\n                      // Khi chạm avatar: mở sheet mới với tuỳ chọn xem tin + đổi ảnh\n                      onAvatarTap: () =&gt; _handleAvatarTap(user.uid, ringStatus),\n                      note: noteController.text,\n                      onNoteTap: () =&gt; _showEditNoteDialog(user.uid),\n                    );\n                  },\n                ),\n                const SizedBox(height: 16),\n                if (profile != null) ...[\n                  Row(\n                    mainAxisAlignment: MainAxisAlignment.spaceEvenly,\n                    children: [\n                      _StatChip(\n                        label: 'Người theo dõi',\n                        value: profile.followersCount,\n                      ),\n                      _StatChip(\n                        label: 'Đang theo dõi',\n                        value: profile.followingCount,\n                      ),\n                    ],\n                  ),\n                  const SizedBox(height: 24),\n                ],\n                // Highlight Stories section\n                StreamBuilder&lt;UserProfile?&gt;(\n                  stream: userProfileRepository.watchProfile(user.uid),\n                  builder: (context, profileSnapshot) {\n                    final profile = profileSnapshot.data;\n                    final highlightedStories = profile?.highlightedStories ?? [];\n                    if (highlightedStories.isEmpty) {\n                      return const SizedBox.shrink();\n                    }\n                    return StreamBuilder&lt;List&lt;Story&gt;&gt;(\n                      stream: StoryRepository().fetchStoriesByAuthor(user.uid),\n                      builder: (context, storiesSnapshot) {\n                        final allStories = storiesSnapshot.data ?? [];\n                        \n                        // Filter highlights để chỉ hiển thị những highlight có ít nhất 1 story tồn tại\n                        final validHighlights = highlightedStories\n                            .where((h) =&gt; h.storyIds.any((id) =&gt;\n                                allStories.any((s) =&gt; s.id == id)))\n                            .toList();\n                        \n                        if (validHighlights.isEmpty) {\n                          return const SizedBox.shrink();\n                        }\n                        \n                        return Column(\n                          crossAxisAlignment: CrossAxisAlignment.start,\n                          children: [\n                            const Padding(\n                              padding: EdgeInsets.symmetric(horizontal: 4),\n                              child: Row(\n                                children: [\n                                  Icon(Icons.auto_awesome, size: 20, color: Colors.purple),\n                                  SizedBox(width: 8),\n                                  Text(\n                                    'Highlight Stories',\n                                    style: TextStyle(\n                                      fontSize: 16,\n                                      fontWeight: FontWeight.bold,\n                                    ),\n                                  ),\n                                ],\n                              ),\n                            ),\n                            const SizedBox(height: 8),\n                            SizedBox(\n                              height: 100,\n                              child: ListView.builder(\n                                scrollDirection: Axis.horizontal,\n                                padding: const EdgeInsets.symmetric(horizontal: 4),\n                                itemCount: validHighlights.length,\n                                itemBuilder: (context, index) {\n                                  final highlight = validHighlights[index];\n                                  final highlightStories = allStories\n                                      .where((s) =&gt; highlight.storyIds.contains(s.id))\n                                      .toList();\n                                  if (highlightStories.isEmpty) {\n                                    return const SizedBox.shrink();\n                                  }\n                                  return _HighlightStoryBubble(\n                                    highlight: highlight,\n                                    firstStory: highlightStories.first,\n                                    authorUid: user.uid,\n                                    onTap: () {\n                                      // Navigate to story viewer với stories của highlight\n                                      Navigator.of(context).push(\n                                        MaterialPageRoute(\n                                          builder: (_) =&gt; StoryViewerPage(\n                                            initialAuthorUid: user.uid,\n                                            userIdsWithStories: [user.uid],\n                                            initialStoryIds: highlight.storyIds,\n                                            highlightId: highlight.id,\n                                          ),\n                                        ),\n                                      );\n                                    },\n                                  );\n                                },\n                              ),\n                            ),\n                            const SizedBox(height: 16),\n                          ],\n                        );\n                      },\n                    );\n                  },\n                ),\n                // Pinned posts section\n                if (_pinnedPosts.isNotEmpty) ...[\n                const SizedBox(height: 8),\n                  const Padding(\n                    padding: EdgeInsets.symmetric(horizontal: 4),\n                    child: Row(\n                      children: [\n                        Icon(Icons.push_pin, size: 20, color: Colors.orange),\n                        SizedBox(width: 8),\n                        Text(\n                          'Bài viết đã ghim',\n                  style: TextStyle(\n                            fontSize: 16,\n                    fontWeight: FontWeight.bold,\n                  ),\n                ),\n                      ],\n                    ),\n                  ),\n                  const SizedBox(height: 8),\n                  SizedBox(\n                    height: 120,\n                    child: ListView.builder(\n                      scrollDirection: Axis.horizontal,\n                      padding: const EdgeInsets.symmetric(horizontal: 4),\n                      itemCount: _pinnedPosts.length,\n                      itemBuilder: (context, index) {\n                        final post = _pinnedPosts[index];\n                        return ProfilePinnedPostItem(\n                          post: post,\n                          onTap: () {\n                            Navigator.of(context).push(\n                              MaterialPageRoute(\n                                builder: (_) =&gt; PostPermalinkPage(postId: post.id),\n                              ),\n                            );\n                          },\n                        );\n                      },\n                    ),\n                  ),\n                  const SizedBox(height: 16),\n                ],\n                // Posts grid section\n                const Padding(\n                  padding: EdgeInsets.symmetric(horizontal: 4),\n                  child: Row(\n                    children: [\n                      Icon(Icons.grid_on, size: 20),\n                      SizedBox(width: 8),\n                      Text(\n                        'Bài viết',\n                        style: TextStyle(\n                          fontSize: 16,\n                          fontWeight: FontWeight.bold,\n                        ),\n                      ),\n                    ],\n                  ),\n                ),\n                const SizedBox(height: 8),\n                if (_isLoadingPosts)\n                  const Padding(\n                    padding: EdgeInsets.all(32),\n                    child: Center(child: CircularProgressIndicator()),\n                  )\n                else if (_allPosts.isEmpty)\n                  const Padding(\n                    padding: EdgeInsets.all(32),\n                    child: Center(\n                      child: Text(\n                        'Chưa có bài viết nào',\n                        style: TextStyle(color: Colors.grey),\n                      ),\n                    ),\n                  )\n                else\n                  GridView.builder(\n                    shrinkWrap: true,\n                    physics: const NeverScrollableScrollPhysics(),\n                    padding: const EdgeInsets.all(8),\n                    gridDelegate: const SliverGridDelegateWithFixedCrossAxisCount(\n                      crossAxisCount: 3,\n                      crossAxisSpacing: 4,\n                      mainAxisSpacing: 4,\n                    ),\n                    itemCount: _allPosts.length,\n                    itemBuilder: (context, index) {\n                      final post = _allPosts[index];\n                      return ProfilePostGridItem(\n                        post: post,\n                        onTap: () {\n                          Navigator.of(context).push(\n                            MaterialPageRoute(\n                              builder: (_) =&gt; PostPermalinkPage(postId: post.id),\n                            ),\n                          );\n                        },\n                      );\n                    },\n                  ),\n                // Follow requests section\n                if (profile != null &amp;&amp; _isPrivate)\n                  StreamBuilder&lt;List&lt;FollowRequestEntry&gt;&gt;(\n                    stream: _followService.watchIncomingRequestEntries(user.uid),\n                    builder: (context, requestSnapshot) {\n                      final requests = requestSnapshot.data ?? [];\n                      if (requests.isEmpty) {\n                          return const SizedBox.shrink();\n                        }\n                      return Card(\n                        child: Padding(\n                          padding: const EdgeInsets.all(16),\n                          child: Column(\n                        crossAxisAlignment: CrossAxisAlignment.start,\n                        children: [\n                              Row(\n                                children: [\n                                  const Icon(Icons.person_add, color: AppColors.primaryPink),\n                                  const SizedBox(width: 8),\n                                  Text(\n                                    'Yêu cầu theo dõi (${requests.length})',\n                                    style: const TextStyle(\n                              fontSize: 16,\n                                      fontWeight: FontWeight.bold,\n                            ),\n                          ),\n                                ],\n                              ),\n                              const SizedBox(height: 12),\n                          ...requests.map(\n                            (entry) =&gt; Card(\n                                  margin: const EdgeInsets.only(bottom: 8),\n                              child: ListTile(\n                                leading: CircleAvatar(\n                                      backgroundImage: entry.profile?.photoUrl != null\n                                      ? NetworkImage(entry.profile!.photoUrl!)\n                                      : null,\n                                  child: entry.profile?.photoUrl == null\n                                      ? const Icon(Icons.person)\n                                      : null,\n                                ),\n                                title: Text(\n                                      entry.profile?.displayName?.isNotEmpty == true\n                                      ? entry.profile!.displayName!\n                                          : (entry.profile?.email?.isNotEmpty == true\n                                          ? entry.profile!.email!\n                                          : entry.uid),\n                                ),\n                                subtitle: entry.createdAt != null\n                                        ? Text('Yêu cầu lúc ${entry.createdAt}')\n                                    : null,\n                                    trailing: Row(\n                                      mainAxisSize: MainAxisSize.min,\n                                  children: [\n                                    TextButton(\n                                          onPressed: () =&gt; _followService.acceptRequest(entry.uid),\n                                          style: TextButton.styleFrom(\n                                            foregroundColor: Colors.green,\n                                          ),\n                                      child: const Text('Chấp nhận'),\n                                    ),\n                                    TextButton(\n                                          onPressed: () =&gt; _followService.declineRequest(entry.uid),\n                                          style: TextButton.styleFrom(\n                                            foregroundColor: Colors.red,\n                                          ),\n                                      child: const Text('Từ chối'),\n                                    ),\n                                  ],\n                                ),\n                              ),\n                            ),\n                          ),\n                        ],\n                          ),\n                        ),\n                      );\n                    },\n                  ),\n              ],\n            ),\n          );\n        },\n      ),\n    );\n  }\n\n  Color _parseColor(String hexColor) {\n    try {\n      return Color(int.parse(hexColor.replaceFirst('#', '0xFF')));\n    } catch (e) {\n      return Colors.blue;\n    }\n  }\n\n  void _showColorPicker(BuildContext context) {\n    final presetColors = [\n      '#FF5733', '#33FF57', '#3357FF', '#FF33F5', '#F5FF33',\n      '#33FFF5', '#FF8C33', '#8C33FF', '#33FF8C', '#FF3333',\n      '#33FF33', '#3333FF', '#FFFF33', '#FF33FF', '#33FFFF',\n    ];\n\n    showModalBottomSheet(\n      context: context,\n      builder: (context) =&gt; Container(\n        padding: const EdgeInsets.all(16),\n        child: Column(\n          mainAxisSize: MainAxisSize.min,\n          crossAxisAlignment: CrossAxisAlignment.start,\n          children: [\n            const Text(\n              'Chọn màu chủ đạo',\n              style: TextStyle(fontSize: 18, fontWeight: FontWeight.bold),\n            ),\n            const SizedBox(height: 16),\n            Wrap(\n              spacing: 12,\n              runSpacing: 12,\n              children: [\n                // Preset colors\n                ...presetColors.map((color) {\n                  return GestureDetector(\n                    onTap: () {\n                      setState(() {\n                        _themeColor = color;\n                      });\n                      Navigator.pop(context);\n                    },\n                    child: Container(\n                      width: 48,\n                      height: 48,\n                      decoration: BoxDecoration(\n                        color: _parseColor(color),\n                        shape: BoxShape.circle,\n                        border: Border.all(color: Colors.grey.shade300),\n                      ),\n                    ),\n                  );\n                }),\n                // Custom color picker (simple text input)\n                GestureDetector(\n                  onTap: () =&gt; _showCustomColorDialog(context),\n                  child: Container(\n                    width: 48,\n                    height: 48,\n                    decoration: BoxDecoration(\n                      color: Colors.grey.shade200,\n                      shape: BoxShape.circle,\n                      border: Border.all(color: Colors.grey.shade300),\n                    ),\n                    child: const Icon(Icons.tune),\n                  ),\n                ),\n              ],\n            ),\n            const SizedBox(height: 16),\n            TextButton(\n              onPressed: () {\n                setState(() {\n                  _themeColor = null;\n                });\n                Navigator.pop(context);\n              },\n              child: const Text('Xóa màu'),\n            ),\n          ],\n        ),\n      ),\n    );\n  }\n\n  void _showCustomColorDialog(BuildContext context) {\n    final controller = TextEditingController(text: _themeColor ?? '#');\n    showDialog(\n      context: context,\n      builder: (context) =&gt; AlertDialog(\n        title: const Text('Màu tùy chỉnh'),\n        content: TextField(\n          controller: controller,\n          decoration: const InputDecoration(\n            labelText: 'Mã màu hex (ví dụ: #FF5733)',\n            hintText: '#FF5733',\n          ),\n        ),\n        actions: [\n          TextButton(\n            onPressed: () =&gt; Navigator.pop(context),\n            child: const Text('Hủy'),\n          ),\n          FilledButton(\n            onPressed: () {\n              final color = controller.text.trim();\n              if (color.isNotEmpty &amp;&amp; color.startsWith('#')) {\n                try {\n                  _parseColor(color); // Validate\n                  setState(() {\n                    _themeColor = color;\n                  });\n                  Navigator.pop(context);\n                  Navigator.pop(context); // Close color picker too\n                } catch (e) {\n                  ScaffoldMessenger.of(context).showSnackBar(\n                    const SnackBar(content: Text('Mã màu không hợp lệ')),\n                  );\n                }\n              } else {\n                ScaffoldMessenger.of(context).showSnackBar(\n                  const SnackBar(content: Text('Mã màu phải bắt đầu bằng #')),\n                );\n              }\n            },\n            child: const Text('Lưu'),\n          ),\n        ],\n      ),\n    );\n  }\n\n  void _showAddLinkDialog(BuildContext context) {\n    final labelController = TextEditingController();\n    final urlController = TextEditingController();\n\n    showDialog(\n      context: context,\n      builder: (context) =&gt; AlertDialog(\n        title: const Text('Thêm liên kết'),\n        content: Column(\n          mainAxisSize: MainAxisSize.min,\n          children: [\n            TextField(\n              controller: labelController,\n              decoration: const InputDecoration(\n                labelText: 'Nhãn (ví dụ: Website, Instagram)',\n              ),\n            ),\n            const SizedBox(height: 12),\n            TextField(\n              controller: urlController,\n              decoration: const InputDecoration(\n                labelText: 'URL',\n                hintText: 'https://example.com',\n              ),\n              keyboardType: TextInputType.url,\n            ),\n          ],\n        ),\n        actions: [\n          TextButton(\n            onPressed: () =&gt; Navigator.pop(context),\n            child: const Text('Hủy'),\n          ),\n          FilledButton(\n            onPressed: () {\n              final label = labelController.text.trim();\n              final url = urlController.text.trim();\n              if (label.isEmpty || url.isEmpty) {\n                ScaffoldMessenger.of(context).showSnackBar(\n                  const SnackBar(content: Text('Vui lòng điền đầy đủ thông tin')),\n                );\n                return;\n              }\n              if (!url.startsWith('http://') &amp;&amp; !url.startsWith('https://')) {\n                ScaffoldMessenger.of(context).showSnackBar(\n                  const SnackBar(content: Text('URL phải bắt đầu bằng http:// hoặc https://')),\n                );\n                return;\n              }\n              setState(() {\n                _links.add(ProfileLink(url: url, label: label));\n              });\n              Navigator.pop(context);\n            },\n            child: const Text('Thêm'),\n          ),\n        ],\n      ),\n    );\n  }\n\n  Future&lt;void&gt; _showEditNoteDialog(String uid) async {\n    final controller = TextEditingController(text: noteController.text);\n    final result = await showDialog&lt;String&gt;(\n      context: context,\n      builder: (context) =&gt; AlertDialog(\n        title: const Text('Cập nhật ghi chú'),\n        content: TextField(\n          controller: controller,\n          maxLength: 50,\n          decoration: const InputDecoration(\n            hintText: 'Nhập ghi chú (tối đa 50 ký tự)',\n          ),\n        ),\n        actions: [\n          TextButton(\n            onPressed: () =&gt; Navigator.pop(context),\n            child: const Text('Hủy'),\n          ),\n          FilledButton(\n            onPressed: () {\n              final text = controller.text.trim();\n              if (text.length &gt; 50) {\n                ScaffoldMessenger.of(context).showSnackBar(\n                  const SnackBar(\n                    content: Text('Ghi chú tối đa 50 ký tự'),\n                  ),\n                );\n                return;\n              }\n              Navigator.pop(context, text);\n            },\n            child: const Text('Lưu'),\n          ),\n        ],\n      ),\n    );\n\n    if (result == null) return;\n\n    try {\n      await userProfileRepository.updateProfile(uid, note: result);\n      setState(() {\n        noteController.text = result;\n      });\n      if (mounted) {\n        ScaffoldMessenger.of(context).showSnackBar(\n          const SnackBar(content: Text('Đã cập nhật ghi chú.')),\n        );\n      }\n    } catch (e) {\n      if (!mounted) return;\n      ScaffoldMessenger.of(context).showSnackBar(\n        SnackBar(content: Text('Không thể cập nhật ghi chú: $e')),\n      );\n    }\n  }\n\n  Future&lt;void&gt; _handleMenuAction(_ProfileMenuAction action) async {\n    final user = authRepository.currentUser();\n    if (user == null) return;\n\n    switch (action) {\n      case _ProfileMenuAction.personalInfo:\n        await _showPersonalInfoModal(user.uid);\n        break;\n      case _ProfileMenuAction.privateAccount:\n        await _togglePrivateAccount(user.uid);\n        break;\n      case _ProfileMenuAction.highlightStories:\n        await Navigator.of(context).push(\n          MaterialPageRoute(\n            builder: (_) =&gt; ManageHighlightStoriesPage(uid: user.uid),\n          ),\n        );\n        break;\n      case _ProfileMenuAction.privacySettings:\n        await Navigator.of(context).push(\n          MaterialPageRoute(builder: (_) =&gt; PrivacySettingsPage()),\n        );\n        break;\n      case _ProfileMenuAction.savedPosts:\n        await Navigator.of(context).push(\n          MaterialPageRoute(builder: (_) =&gt; const SavedPostsPage()),\n        );\n        break;\n      case _ProfileMenuAction.changePassword:\n        await Navigator.of(context).push(\n          MaterialPageRoute(builder: (_) =&gt; const ChangePasswordPage()),\n        );\n        break;\n      case _ProfileMenuAction.adminDashboard:\n        await Navigator.of(context).push(\n          MaterialPageRoute(builder: (_) =&gt; const AdminDashboardPage()),\n        );\n        break;\n      case _ProfileMenuAction.logout:\n        await _confirmLogoutAndMaybeSave(currentUser: user);\n        break;\n    }\n  }\n\n  Future&lt;void&gt; _showPersonalInfoModal(String uid) async {\n    final displayNameCtrl = TextEditingController(text: displayNameController.text);\n    final bioCtrl = TextEditingController(text: bioController.text);\n    final photoUrlCtrl = TextEditingController(text: photoUrlController.text);\n\n    await showDialog(\n      context: context,\n      builder: (context) =&gt; AlertDialog(\n        title: const Text('Thông tin cá nhân'),\n        content: SingleChildScrollView(\n          child: Column(\n            mainAxisSize: MainAxisSize.min,\n            children: [\n              TextField(\n                controller: displayNameCtrl,\n                decoration: const InputDecoration(\n                  labelText: 'Tên hiển thị',\n                  prefixIcon: Icon(Icons.person),\n                ),\n              ),\n              const SizedBox(height: 16),\n              TextField(\n                controller: bioCtrl,\n                minLines: 1,\n                maxLines: 4,\n                decoration: const InputDecoration(\n                  labelText: 'Tiểu sử (bio)',\n                  prefixIcon: Icon(Icons.description),\n                ),\n              ),\n              const SizedBox(height: 16),\n              TextField(\n                controller: photoUrlCtrl,\n                decoration: const InputDecoration(\n                  labelText: 'Ảnh đại diện (URL)',\n                  prefixIcon: Icon(Icons.image),\n                ),\n              ),\n              const SizedBox(height: 16),\n              OutlinedButton.icon(\n                onPressed: () {\n                  Navigator.pop(context);\n                  _showAvatarOptions(uid);\n                },\n                icon: const Icon(Icons.photo_library),\n                label: const Text('Chọn ảnh từ thiết bị'),\n              ),\n            ],\n          ),\n        ),\n        actions: [\n          TextButton(\n            onPressed: () =&gt; Navigator.pop(context),\n            child: const Text('Hủy'),\n          ),\n          FilledButton(\n            onPressed: () async {\n              Navigator.pop(context);\n              displayNameController.text = displayNameCtrl.text;\n              bioController.text = bioCtrl.text;\n              photoUrlController.text = photoUrlCtrl.text;\n              await _saveProfile(uid);\n            },\n            child: const Text('Lưu'),\n          ),\n        ],\n      ),\n    );\n  }\n\n  Future&lt;void&gt; _togglePrivateAccount(String uid) async {\n    final newValue = !_isPrivate;\n    setState(() {\n      _isPrivate = newValue;\n    });\n    try {\n      await userProfileRepository.updateProfile(uid, isPrivate: newValue);\n      if (mounted) {\n        ScaffoldMessenger.of(context).showSnackBar(\n          SnackBar(\n            content: Text(\n              newValue\n                  ? 'Đã bật tài khoản riêng tư'\n                  : 'Đã tắt tài khoản riêng tư',\n            ),\n          ),\n        );\n      }\n    } catch (e) {\n      setState(() {\n        _isPrivate = !newValue;\n      });\n      if (mounted) {\n        ScaffoldMessenger.of(context).showSnackBar(\n          SnackBar(content: Text('Lỗi cập nhật: $e')),\n        );\n      }\n    }\n  }\n\n  Future&lt;void&gt; _showCustomizationModal(String uid) async {\n    await showDialog(\n      context: context,\n      builder: (context) =&gt; AlertDialog(\n        title: const Text('Tùy biến'),\n        content: SingleChildScrollView(\n          child: Column(\n            mainAxisSize: MainAxisSize.min,\n            crossAxisAlignment: CrossAxisAlignment.start,\n            children: [\n              ListTile(\n                contentPadding: EdgeInsets.zero,\n                title: const Text('Màu chủ đạo'),\n                subtitle: Text(_themeColor ?? 'Chưa chọn màu'),\n                trailing: Row(\n                  mainAxisSize: MainAxisSize.min,\n                  children: [\n                    if (_themeColor != null)\n                      Container(\n                        width: 32,\n                        height: 32,\n                        decoration: BoxDecoration(\n                          color: _parseColor(_themeColor!),\n                          shape: BoxShape.circle,\n                          border: Border.all(color: Colors.grey),\n                        ),\n                      ),\n                    const SizedBox(width: 8),\n                    IconButton(\n                      icon: const Icon(Icons.color_lens, color: AppColors.primaryPink),\n                      onPressed: () {\n                        Navigator.pop(context);\n                        _showColorPicker(context);\n                      },\n                    ),\n                    if (_themeColor != null)\n                      IconButton(\n                        icon: const Icon(Icons.clear),\n                        onPressed: () {\n                          setState(() {\n                            _themeColor = null;\n                          });\n                          Navigator.pop(context);\n                          _saveProfile(uid);\n                        },\n                      ),\n                  ],\n                ),\n              ),\n              const SizedBox(height: 16),\n              const Text(\n                'Liên kết ngoài',\n                style: TextStyle(fontWeight: FontWeight.w600),\n              ),\n              const SizedBox(height: 8),\n              if (_links.isEmpty)\n                const Text(\n                  'Chưa có liên kết nào',\n                  style: TextStyle(color: Colors.grey),\n                )\n              else\n                Wrap(\n                  spacing: 8,\n                  runSpacing: 8,\n                  children: _links.asMap().entries.map((entry) {\n                    final index = entry.key;\n                    final link = entry.value;\n                    return Chip(\n                      label: Text(link.label),\n                      deleteIcon: const Icon(Icons.close, size: 18),\n                      onDeleted: () {\n                        setState(() {\n                          _links.removeAt(index);\n                        });\n                        _saveProfile(uid);\n                      },\n                    );\n                  }).toList(),\n                ),\n              if (_links.length &lt; 5) ...[\n                const SizedBox(height: 8),\n                OutlinedButton.icon(\n                  onPressed: () {\n                    Navigator.pop(context);\n                    _showAddLinkDialog(context);\n                  },\n                  icon: const Icon(Icons.add, color: AppColors.primaryPink),\n                  label: const Text('Thêm liên kết'),\n                ),\n              ],\n            ],\n          ),\n        ),\n        actions: [\n          TextButton(\n            onPressed: () =&gt; Navigator.pop(context),\n            child: const Text('Đóng'),\n          ),\n        ],\n      ),\n    );\n  }\n\n  void _showProfileOptionsSheet(User user) {\n    showModalBottomSheet(\n      context: context,\n      builder: (context) =&gt; SafeArea(\n        child: Column(\n          mainAxisSize: MainAxisSize.min,\n          children: [\n            const ListTile(\n              title: Text(\n                'Tùy chọn tài khoản',\n                style: TextStyle(fontWeight: FontWeight.bold),\n              ),\n            ),\n            ListTile(\n              leading: const Icon(Icons.person, color: AppColors.primaryPink),\n              title: const Text('Thông tin cá nhân'),\n              trailing: const Icon(Icons.chevron_right),\n              onTap: () {\n                Navigator.pop(context);\n                _handleMenuAction(_ProfileMenuAction.personalInfo);\n              },\n            ),\n            ListTile(\n              leading: const Icon(Icons.lock_outline, color: AppColors.primaryPink),\n              title: const Text('Tài khoản riêng tư'),\n              trailing: StreamBuilder&lt;UserProfile?&gt;(\n                stream: userProfileRepository.watchProfile(user.uid),\n                builder: (context, snapshot) {\n                  final isPrivate = snapshot.data?.isPrivate ?? false;\n                  return Switch(\n                    value: isPrivate,\n                    onChanged: (value) {\n                      Navigator.pop(context);\n                      _handleMenuAction(_ProfileMenuAction.privateAccount);\n                    },\n                  );\n                },\n              ),\n            ),\n            ListTile(\n              leading: const Icon(Icons.auto_awesome, color: AppColors.primaryPink),\n              title: const Text('Highlight Stories'),\n              trailing: const Icon(Icons.chevron_right),\n              onTap: () {\n                Navigator.pop(context);\n                _handleMenuAction(_ProfileMenuAction.highlightStories);\n              },\n            ),\n            const Divider(),\n            ListTile(\n              leading: const Icon(Icons.privacy_tip, color: AppColors.primaryPink),\n              title: const Text('Quyền riêng tư'),\n              trailing: const Icon(Icons.chevron_right),\n              onTap: () {\n                Navigator.pop(context);\n                _handleMenuAction(_ProfileMenuAction.privacySettings);\n              },\n            ),\n            ListTile(\n              leading: const Icon(Icons.bookmark, color: AppColors.primaryPink),\n              title: const Text('Đã lưu'),\n              trailing: const Icon(Icons.chevron_right),\n              onTap: () {\n                Navigator.pop(context);\n                _handleMenuAction(_ProfileMenuAction.savedPosts);\n              },\n            ),\n            if (user.email != null &amp;&amp;\n                user.providerData.any((p) =&gt; p.providerId == 'password'))\n              ListTile(\n                leading: const Icon(Icons.lock, color: AppColors.primaryPink),\n                title: const Text('Đổi mật khẩu'),\n                trailing: const Icon(Icons.chevron_right),\n                onTap: () {\n                  Navigator.pop(context);\n                  _handleMenuAction(_ProfileMenuAction.changePassword);\n                },\n              ),\n            if (_isAdmin)\n              ListTile(\n                leading:\n                    const Icon(Icons.admin_panel_settings, color: AppColors.primaryPink),\n                title: const Text('Admin Dashboard'),\n                trailing: const Icon(Icons.chevron_right),\n                onTap: () {\n                  Navigator.pop(context);\n                  _handleMenuAction(_ProfileMenuAction.adminDashboard);\n                },\n              ),\n          ],\n        ),\n      ),\n    );\n  }\n}\n\nclass _EditProfileHeader extends StatelessWidget {\n  const _EditProfileHeader({\n    required this.displayName,\n    required this.photoUrl,\n    required this.statusText,\n    required this.onAddPressed,\n    required this.onAccountMenuPressed,\n    required this.onAvatarTap,\n    required this.note,\n    required this.onNoteTap,\n    required this.hasActiveStory,\n    required this.storyRingColor,\n    this.themeColor,\n    this.isUploading = false,\n  });\n\n  final String displayName;\n  final String photoUrl;\n  final String statusText;\n  final String note;\n  final Color? themeColor;\n  final bool isUploading;\n  final VoidCallback onAddPressed;\n  final VoidCallback onAccountMenuPressed;\n  final VoidCallback onAvatarTap;\n  final VoidCallback onNoteTap;\n  final bool hasActiveStory;\n  final Color? storyRingColor;\n\n  @override\n  Widget build(BuildContext context) {\n    return Column(\n      crossAxisAlignment: CrossAxisAlignment.stretch,\n      children: [\n        Center(\n          child: Row(\n            mainAxisSize: MainAxisSize.min,\n            children: [\n              // Icon ảo bên trái để cân đối layout, không nhận tương tác\n              IgnorePointer(\n                child: Opacity(\n                  opacity: 0,\n                  child: IconButton(\n                    onPressed: () {},\n                    icon: const Icon(Icons.keyboard_arrow_down, size: 22),\n                    padding: EdgeInsets.zero,\n                    constraints: const BoxConstraints(),\n                    splashRadius: 20,\n                  ),\n                ),\n              ),\n              const SizedBox(width: 6),\n              Flexible(\n                child: Text(\n                  displayName,\n                  style: const TextStyle(\n                    fontSize: 20,\n                    fontWeight: FontWeight.w800,\n                  ),\n                  maxLines: 1,\n                  overflow: TextOverflow.ellipsis,\n                  textAlign: TextAlign.center,\n                ),\n              ),\n              const SizedBox(width: 6),\n              IconButton(\n                onPressed: onAccountMenuPressed,\n                icon: const Icon(Icons.keyboard_arrow_down, size: 22),\n                padding: EdgeInsets.zero,\n                constraints: const BoxConstraints(),\n                splashRadius: 20,\n              ),\n            ],\n          ),\n        ),\n        const SizedBox(height: 16),\n        Center(\n          child: Stack(\n            clipBehavior: Clip.none,\n            children: [\n              // Avatar (tap để đổi ảnh) + vòng story (hồng/xám)\n              GestureDetector(\n                onTap: onAvatarTap,\n                child: Hero(\n                  tag: 'profile_avatar_fullscreen',\n                  child: Container(\n                    decoration: hasActiveStory &amp;&amp; storyRingColor != null\n                        ? BoxDecoration(\n                            shape: BoxShape.circle,\n                            border: Border.all(\n                              color: storyRingColor!,\n                              width: 3.5,\n                            ),\n                          )\n                        : null,\n                    child: CircleAvatar(\n                      radius: 48,\n                      backgroundImage:\n                          photoUrl.isNotEmpty ? NetworkImage(photoUrl) : null,\n                      child: photoUrl.isEmpty\n                          ? const Icon(Icons.person, size: 48)\n                          : isUploading\n                              ? Container(\n                                  color: Colors.black54,\n                                  child: const Center(\n                                    child: CircularProgressIndicator(\n                                      valueColor: AlwaysStoppedAnimation&lt;Color&gt;(\n                                        Colors.white,\n                                      ),\n                                    ),\n                                  ),\n                                )\n                              : null,\n                    ),\n                  ),\n                ),\n              ),\n              // Nút + đăng story/post\n              Positioned(\n                right: -6,\n                bottom: -6,\n                child: GestureDetector(\n                  // Dấu + để đăng story / post\n                  onTap: onAddPressed,\n                  child: Container(\n                    padding: const EdgeInsets.all(8),\n                    decoration: BoxDecoration(\n                      shape: BoxShape.circle,\n                      color: AppColors.primaryPink,\n                      border: Border.all(color: Colors.white, width: 3),\n                    ),\n                    child: const Icon(Icons.add, color: Colors.white, size: 20),\n                  ),\n                ),\n              ),\n              // Bong bóng ghi chú đè lên avatar\n              Positioned(\n                top: 6,\n                left: 0,\n                right: 0,\n                child: GestureDetector(\n                  behavior: HitTestBehavior.translucent,\n                  onTap: onNoteTap,\n                  child: TweenAnimationBuilder&lt;double&gt;(\n                    tween: Tween(begin: 0.95, end: 1.0),\n                    duration: const Duration(milliseconds: 800),\n                    curve: Curves.easeInOut,\n                    builder: (context, value, child) {\n                      return Transform.scale(scale: value, child: child);\n                    },\n                    child: Center(\n                      child: Container(\n                        constraints: const BoxConstraints(maxWidth: 180),\n                        padding: const EdgeInsets.symmetric(\n                          horizontal: 12,\n                          vertical: 6,\n                        ),\n                        decoration: BoxDecoration(\n                          color: Colors.white,\n                          borderRadius: BorderRadius.circular(18),\n                          boxShadow: [\n                            BoxShadow(\n                              color: Colors.black.withOpacity(0.08),\n                              blurRadius: 8,\n                              offset: const Offset(0, 4),\n                            ),\n                          ],\n                        ),\n                        child: Text(\n                          note.isNotEmpty ? note : 'Thêm ghi chú...',\n                          maxLines: 1,\n                          overflow: TextOverflow.ellipsis,\n                          style: const TextStyle(\n                            fontSize: 12,\n                            fontWeight: FontWeight.w600,\n                          ),\n                        ),\n                      ),\n                    ),\n                  ),\n                ),\n              ),\n            ],\n          ),\n        ),\n        const SizedBox(height: 12),\n        Center(\n          child: Text(\n            displayName,\n            style: const TextStyle(\n              fontSize: 20,\n              fontWeight: FontWeight.bold,\n            ),\n          ),\n        ),\n        const SizedBox(height: 4),\n        Center(\n          child: Text(\n            statusText,\n            style: TextStyle(\n              fontSize: 14,\n              color: Theme.of(context).colorScheme.onSurfaceVariant,\n            ),\n          ),\n        ),\n      ],\n    );\n  }\n}\n\nclass _HighlightStoryBubble extends StatelessWidget {\n  const _HighlightStoryBubble({\n    required this.highlight,\n    required this.firstStory,\n    required this.authorUid,\n    required this.onTap,\n  });\n\n  final HighlightStory highlight;\n  final Story firstStory;\n  final String authorUid;\n  final VoidCallback onTap;\n\n  @override\n  Widget build(BuildContext context) {\n    return GestureDetector(\n      onTap: onTap,\n      child: Container(\n        width: 70,\n        margin: const EdgeInsets.symmetric(horizontal: 6),\n        child: Column(\n          mainAxisSize: MainAxisSize.min,\n          children: [\n            Container(\n              width: 70,\n              height: 70,\n              decoration: BoxDecoration(\n                shape: BoxShape.circle,\n                border: Border.all(color: Colors.purple, width: 2.5),\n              ),\n              child: ClipOval(\n                child: firstStory.thumbnailUrl != null\n                    ? Image.network(\n                        firstStory.thumbnailUrl!,\n                        fit: BoxFit.cover,\n                        errorBuilder: (_, __, ___) =&gt; _buildPlaceholder(),\n                      )\n                    : firstStory.type == StoryMediaType.image\n                        ? Image.network(\n                            firstStory.mediaUrl,\n                            fit: BoxFit.cover,\n                            errorBuilder: (_, __, ___) =&gt; _buildPlaceholder(),\n                          )\n                        : _buildPlaceholder(),\n              ),\n            ),\n            const SizedBox(height: 6),\n            Text(\n              highlight.name,\n              style: const TextStyle(\n                fontSize: 11,\n                fontWeight: FontWeight.w500,\n              ),\n              maxLines: 1,\n              overflow: TextOverflow.ellipsis,\n              textAlign: TextAlign.center,\n            ),\n          ],\n        ),\n      ),\n    );\n  }\n\n  Widget _buildPlaceholder() {\n    return Container(\n      color: Colors.grey[300],\n      child: Icon(\n        firstStory.type == StoryMediaType.video ? Icons.videocam : Icons.image,\n        color: Colors.grey[600],\n        size: 30,\n      ),\n    );\n  }\n}\n\nclass _StatChip extends StatelessWidget {\n  const _StatChip({\n    required this.label,\n    required this.value,\n  });\n\n  final String label;\n  final int value;\n\n  @override\n  Widget build(BuildContext context) {\n    return Container(\n      padding: const EdgeInsets.symmetric(horizontal: 24, vertical: 12),\n      decoration: BoxDecoration(\n        color: AppColors.primaryPink.withOpacity(0.1),\n        borderRadius: BorderRadius.circular(20),\n        border: Border.all(color: AppColors.primaryPink.withOpacity(0.3)),\n      ),\n      child: Column(\n      children: [\n        Text(\n          '$value',\n          style: const TextStyle(\n              fontSize: 20,\n            fontWeight: FontWeight.bold,\n              color: AppColors.primaryPink,\n          ),\n        ),\n        const SizedBox(height: 4),\n          Text(\n            label,\n            style: const TextStyle(\n              fontSize: 12,\n              color: AppColors.primaryPink,\n            ),\n          ),\n        ],\n      ),\n    );\n  }\n}\n\n\n"
}
```
User decision: **accepted**

Status: **completed**


</details>
</tool-use>

---

<tool-use data-tool-type="generic" data-tool-name="read_lints">
<details>
          <summary>Tool use: **read_lints** • Read lints for 1 file</summary>
      
Lint paths:

- `lib/features/profile/profile_screen.dart`

Lint results

Lint errors for `lib/features/profile/profile_screen.dart`


| Message | Range | Severity |
|-------|-------|----------|
| 'withOpacity' is deprecated and shouldn't be used. Use .withValues() to avoid precision loss.<br/>Try replacing the use of the deprecated member with the replacement. | 1868:51-1868:62 | DIAGNOSTIC_SEVERITY_INFORMATION |
| 'withOpacity' is deprecated and shouldn't be used. Use .withValues() to avoid precision loss.<br/>Try replacing the use of the deprecated member with the replacement. | 2005:38-2005:49 | DIAGNOSTIC_SEVERITY_INFORMATION |
| 'withOpacity' is deprecated and shouldn't be used. Use .withValues() to avoid precision loss.<br/>Try replacing the use of the deprecated member with the replacement. | 2007:57-2007:68 | DIAGNOSTIC_SEVERITY_INFORMATION |
| The declaration '_showCustomizationModal' isn't referenced.<br/>Try removing the declaration of '_showCustomizationModal'. | 1507:16-1507:39 | DIAGNOSTIC_SEVERITY_WARNING |
| Don't use 'BuildContext's across async gaps.<br/>Try rewriting the code to not use the 'BuildContext', or guard the use with a 'mounted' check. | 425:28-425:35 | DIAGNOSTIC_SEVERITY_INFORMATION |
| Unnecessary use of multiple underscores.<br/>Try using '_'. | 1951:43-1951:45 | DIAGNOSTIC_SEVERITY_INFORMATION |
| Unnecessary use of multiple underscores.<br/>Try using '_'. | 1951:47-1951:50 | DIAGNOSTIC_SEVERITY_INFORMATION |
| Unnecessary use of multiple underscores.<br/>Try using '_'. | 1957:47-1957:49 | DIAGNOSTIC_SEVERITY_INFORMATION |
| Unnecessary use of multiple underscores.<br/>Try using '_'. | 1957:51-1957:54 | DIAGNOSTIC_SEVERITY_INFORMATION |
| "nhật": Unknown word. | 199:46-199:50 | DIAGNOSTIC_SEVERITY_HINT |
| "nhật": Unknown word. | 204:41-204:45 | DIAGNOSTIC_SEVERITY_HINT |
| "Chọn": Unknown word. | 215:7-215:11 | DIAGNOSTIC_SEVERITY_HINT |
| "hoặc": Unknown word. | 215:40-215:44 | DIAGNOSTIC_SEVERITY_HINT |
| "Phải": Unknown word. | 216:7-216:11 | DIAGNOSTIC_SEVERITY_HINT |
| "khớp": Unknown word. | 216:12-216:16 | DIAGNOSTIC_SEVERITY_HINT |
| "Thay": Misspelled word. | 217:57-217:61 | DIAGNOSTIC_SEVERITY_HINT |
| "thành": Unknown word. | 217:66-217:71 | DIAGNOSTIC_SEVERITY_HINT |
| "muốn": Unknown word. | 217:87-217:91 | DIAGNOSTIC_SEVERITY_HINT |
| "dùng": Unknown word. | 217:92-217:96 | DIAGNOSTIC_SEVERITY_HINT |
| "Dùng": Unknown word. | 239:12-239:16 | DIAGNOSTIC_SEVERITY_HINT |
| "Dùng": Unknown word. | 247:12-247:16 | DIAGNOSTIC_SEVERITY_HINT |
| "nhật": Unknown word. | 273:48-273:52 | DIAGNOSTIC_SEVERITY_HINT |
| "diện": Unknown word. | 273:61-273:65 | DIAGNOSTIC_SEVERITY_HINT |
| "diện": Unknown word. | 305:56-305:60 | DIAGNOSTIC_SEVERITY_HINT |
| "Không": Unknown word. | 311:35-311:40 | DIAGNOSTIC_SEVERITY_HINT |
| "Đăng": Unknown word. | 332:34-332:38 | DIAGNOSTIC_SEVERITY_HINT |
| "Thêm": Unknown word. | 337:34-337:38 | DIAGNOSTIC_SEVERITY_HINT |
| "viết": Unknown word. | 337:43-337:47 | DIAGNOSTIC_SEVERITY_HINT |
| "Chuyển": Unknown word. | 369:34-369:40 | DIAGNOSTIC_SEVERITY_HINT |
| "khoản": Unknown word. | 369:45-369:50 | DIAGNOSTIC_SEVERITY_HINT |
| "Đăng": Unknown word. | 374:34-374:38 | DIAGNOSTIC_SEVERITY_HINT |
| "xuất": Unknown word. | 374:39-374:43 | DIAGNOSTIC_SEVERITY_HINT |
| "Đăng": Unknown word. | 406:28-406:32 | DIAGNOSTIC_SEVERITY_HINT |
| "xuất": Unknown word. | 406:33-406:37 | DIAGNOSTIC_SEVERITY_HINT |
| "muốn": Unknown word. | 407:37-407:41 | DIAGNOSTIC_SEVERITY_HINT |
| "khoản": Unknown word. | 407:50-407:55 | DIAGNOSTIC_SEVERITY_HINT |
| "chuyển": Unknown word. | 407:63-407:69 | DIAGNOSTIC_SEVERITY_HINT |
| "nhanh": Unknown word. | 407:74-407:79 | DIAGNOSTIC_SEVERITY_HINT |
| "không": Unknown word. | 407:88-407:93 | DIAGNOSTIC_SEVERITY_HINT |
| "Đăng": Unknown word. | 411:32-411:36 | DIAGNOSTIC_SEVERITY_HINT |
| "xuất": Unknown word. | 411:37-411:41 | DIAGNOSTIC_SEVERITY_HINT |
| "khoản": Unknown word. | 415:40-415:45 | DIAGNOSTIC_SEVERITY_HINT |
| "khoản": Unknown word. | 426:50-426:55 | DIAGNOSTIC_SEVERITY_HINT |
| "trên": Unknown word. | 426:56-426:60 | DIAGNOSTIC_SEVERITY_HINT |
| "thiết": Unknown word. | 426:61-426:66 | DIAGNOSTIC_SEVERITY_HINT |
| "đăng": Unknown word. | 434:17-434:21 | DIAGNOSTIC_SEVERITY_HINT |
| "xuất": Unknown word. | 434:22-434:26 | DIAGNOSTIC_SEVERITY_HINT |
| "bình": Unknown word. | 434:27-434:31 | DIAGNOSTIC_SEVERITY_HINT |
| "thường": Unknown word. | 434:32-434:38 | DIAGNOSTIC_SEVERITY_HINT |
| "hình": Unknown word. | 434:77-434:81 | DIAGNOSTIC_SEVERITY_HINT |
| "chuyển": Unknown word. | 435:17-435:23 | DIAGNOSTIC_SEVERITY_HINT |
| "khoản": Unknown word. | 435:32-435:37 | DIAGNOSTIC_SEVERITY_HINT |
| "KHÔNG": Unknown word. | 435:56-435:61 | DIAGNOSTIC_SEVERITY_HINT |
| "khoản": Unknown word. | 435:85-435:90 | DIAGNOSTIC_SEVERITY_HINT |
| "khác": Unknown word. | 435:91-435:95 | DIAGNOSTIC_SEVERITY_HINT |
| "ngay": Unknown word. | 435:96-435:100 | DIAGNOSTIC_SEVERITY_HINT |
| "Chưa": Unknown word. | 450:39-450:43 | DIAGNOSTIC_SEVERITY_HINT |
| "khoản": Unknown word. | 450:51-450:56 | DIAGNOSTIC_SEVERITY_HINT |
| "được": Unknown word. | 450:61-450:65 | DIAGNOSTIC_SEVERITY_HINT |
| "trên": Unknown word. | 450:70-450:74 | DIAGNOSTIC_SEVERITY_HINT |
| "thiết": Unknown word. | 450:75-450:80 | DIAGNOSTIC_SEVERITY_HINT |
| "Chuyển": Unknown word. | 463:18-463:24 | DIAGNOSTIC_SEVERITY_HINT |
| "khoản": Unknown word. | 463:33-463:38 | DIAGNOSTIC_SEVERITY_HINT |
| "chọn": Unknown word. | 489:12-489:16 | DIAGNOSTIC_SEVERITY_HINT |
| "khoản": Unknown word. | 489:21-489:26 | DIAGNOSTIC_SEVERITY_HINT |
| "khác": Unknown word. | 489:27-489:31 | DIAGNOSTIC_SEVERITY_HINT |
| "khoản": Unknown word. | 489:48-489:53 | DIAGNOSTIC_SEVERITY_HINT |
| "hiện": Unknown word. | 489:54-489:58 | DIAGNOSTIC_SEVERITY_HINT |
| "không": Unknown word. | 489:63-489:68 | DIAGNOSTIC_SEVERITY_HINT |
| "đăng": Unknown word. | 500:12-500:16 | DIAGNOSTIC_SEVERITY_HINT |
| "nhập": Unknown word. | 500:17-500:21 | DIAGNOSTIC_SEVERITY_HINT |
| "nhanh": Unknown word. | 500:22-500:27 | DIAGNOSTIC_SEVERITY_HINT |
| "khoản": Unknown word. | 500:36-500:41 | DIAGNOSTIC_SEVERITY_HINT |
| "Điều": Unknown word. | 506:10-506:14 | DIAGNOSTIC_SEVERITY_HINT |
| "hướng": Unknown word. | 506:15-506:20 | DIAGNOSTIC_SEVERITY_HINT |
| "toàn": Unknown word. | 506:36-506:40 | DIAGNOSTIC_SEVERITY_HINT |
| "theo": Unknown word. | 506:56-506:60 | DIAGNOSTIC_SEVERITY_HINT |
| "chuyển": Unknown word. | 514:20-514:26 | DIAGNOSTIC_SEVERITY_HINT |
| "hình": Unknown word. | 514:36-514:40 | DIAGNOSTIC_SEVERITY_HINT |
| "được": Unknown word. | 514:57-514:61 | DIAGNOSTIC_SEVERITY_HINT |
| "điền": Unknown word. | 514:62-514:66 | DIAGNOSTIC_SEVERITY_HINT |
| "khoản": Unknown word. | 519:18-519:23 | DIAGNOSTIC_SEVERITY_HINT |
| "chưa": Unknown word. | 519:28-519:32 | DIAGNOSTIC_SEVERITY_HINT |
| "khẩu": Unknown word. | 519:41-519:45 | DIAGNOSTIC_SEVERITY_HINT |
| "toàn": Unknown word. | 519:49-519:53 | DIAGNOSTIC_SEVERITY_HINT |
| "lòng": Unknown word. | 519:59-519:63 | DIAGNOSTIC_SEVERITY_HINT |
| "đăng": Unknown word. | 519:64-519:68 | DIAGNOSTIC_SEVERITY_HINT |
| "nhập": Unknown word. | 519:69-519:73 | DIAGNOSTIC_SEVERITY_HINT |
| "nhanh": Unknown word. | 534:32-534:37 | DIAGNOSTIC_SEVERITY_HINT |
| "khoản": Unknown word. | 534:46-534:51 | DIAGNOSTIC_SEVERITY_HINT |
| "đăng": Unknown word. | 534:52-534:56 | DIAGNOSTIC_SEVERITY_HINT |
| "nhập": Unknown word. | 534:57-534:61 | DIAGNOSTIC_SEVERITY_HINT |
| "bằng": Unknown word. | 534:62-534:66 | DIAGNOSTIC_SEVERITY_HINT |
| "khẩu": Unknown word. | 534:77-534:81 | DIAGNOSTIC_SEVERITY_HINT |
| "khoản": Unknown word. | 542:27-542:32 | DIAGNOSTIC_SEVERITY_HINT |
| "thay": Misspelled word. | 545:27-545:31 | DIAGNOSTIC_SEVERITY_HINT |
| "hoàn": Unknown word. | 545:54-545:58 | DIAGNOSTIC_SEVERITY_HINT |
| "dụng": Unknown word. | 546:15-546:19 | DIAGNOSTIC_SEVERITY_HINT |
| "hoặc": Unknown word. | 546:52-546:56 | DIAGNOSTIC_SEVERITY_HINT |
| "giây": Unknown word. | 546:71-546:75 | DIAGNOSTIC_SEVERITY_HINT |
| "giây": Unknown word. | 561:26-561:30 | DIAGNOSTIC_SEVERITY_HINT |
| "không": Unknown word. | 561:35-561:40 | DIAGNOSTIC_SEVERITY_HINT |
| "nhận": Unknown word. | 561:41-561:45 | DIAGNOSTIC_SEVERITY_HINT |
| "được": Unknown word. | 561:46-561:50 | DIAGNOSTIC_SEVERITY_HINT |
| "khác": Unknown word. | 578:23-578:27 | DIAGNOSTIC_SEVERITY_HINT |
| "hiện": Unknown word. | 578:46-578:50 | DIAGNOSTIC_SEVERITY_HINT |
| "không": Unknown word. | 578:55-578:60 | DIAGNOSTIC_SEVERITY_HINT |
| "tránh": Unknown word. | 578:75-578:80 | DIAGNOSTIC_SEVERITY_HINT |
| "chọn": Unknown word. | 578:81-578:85 | DIAGNOSTIC_SEVERITY_HINT |


</details>
</tool-use>

---

### Cập nhật theo yêu cầu của bạn

- **Khi không có story vẫn xem được ảnh đại diện**  
  Hàm `_showAvatarOptions` (dùng cho trường hợp không có story) đã được thêm option **“Xem ảnh đại diện”** nếu đang có avatar:

```584:620:lib/features/profile/profile_screen.dart
  void _showAvatarOptions(String uid) {
    showModalBottomSheet(
      context: context,
      builder: (context) => SafeArea(
        child: Column(
          mainAxisSize: MainAxisSize.min,
          children: [
            if (photoUrlController.text.isNotEmpty)
              ListTile(
                leading: const Icon(Icons.remove_red_eye),
                title: const Text('Xem ảnh đại diện'),
                onTap: () {
                  Navigator.pop(context);
                  Navigator.of(context).push(
                    MaterialPageRoute(
                      builder: (_) => AvatarFullscreenViewer(
                        photoUrl: photoUrlController.text,
                      ),
                    ),
                  );
                },
              ),
            ListTile(
              leading: const Icon(Icons.photo_library),
              title: const Text('Chọn ảnh từ thư viện'),
              onTap: () {
                Navigator.pop(context);
                _pickAndUploadImage(uid, ImageSource.gallery);
              },
            ),
            ...
```

- **Logic chạm avatar vẫn dùng cùng entry point**  
  `_handleAvatarTap` giờ chỉ phân biệt có story hay không, nhưng **cả hai nhánh đều có “Xem ảnh đại diện”** (vì:
  - Có story: sheet đã có “Xem tin” + “Xem ảnh đại diện”.
  - Không story: gọi `_showAvatarOptions` ở trên, cũng có “Xem ảnh đại diện”).

```576:586:lib/features/profile/profile_screen.dart
  void _handleAvatarTap(String uid, StoryRingStatus ringStatus) {
    final hasStory = ringStatus != StoryRingStatus.none;

    if (!hasStory) {
      // Không có story -> dùng sheet ảnh đại diện (vẫn có Xem ảnh đại diện)
      _showAvatarOptions(uid);
      return;
    }
    // ... sheet có cả Xem tin + Xem ảnh đại diện ...
```

- **Thêm hiệu ứng Hero từ avatar -> fullscreen**  
  Avatar trên trang hồ sơ được bọc `Hero` với tag trùng khớp `'profile_avatar_fullscreen'` với màn hình fullscreen:

```1686:1715:lib/features/profile/profile_screen.dart
              GestureDetector(
                onTap: onAvatarTap,
                child: Hero(
                  tag: 'profile_avatar_fullscreen',
                  child: Container(
                    decoration: hasActiveStory && storyRingColor != null
                        ? BoxDecoration(
                            shape: BoxShape.circle,
                            border: Border.all(
                              color: storyRingColor!,
                              width: 3.5,
                            ),
                          )
                        : null,
                    child: CircleAvatar(
                      radius: 48,
                      backgroundImage:
                          photoUrl.isNotEmpty ? NetworkImage(photoUrl) : null,
                      child: photoUrl.isEmpty
                          ? const Icon(Icons.person, size: 48)
                          : isUploading
                              ? Container(
                                  color: Colors.black54,
                                  child: const Center(
                                    child: CircularProgressIndicator(
                                      valueColor: AlwaysStoppedAnimation<Color>(
                                        Colors.white,
                                      ),
                                    ),
                                  ),
                                )
                              : null,
                    ),
                  ),
                ),
              ),
```

Kết quả:  
- Có hoặc không có story, khi bấm avatar là luôn có **“Xem ảnh đại diện”** (nếu có ảnh).  
- Khi chọn “Xem ảnh đại diện”, avatar trên profile **bay mượt** sang màn hình fullscreen nhờ Hero animation.

---

_**User (2025-12-22 08:33Z)**_

Tại trang kết nối, các tài khoản user của các tab đang bị lỗi UI/UX xấu, tên bị xuống dòng. Tôi cần bạn thiết kế lại UI/UX và thêm hiệu ứng animation cho tôi

---

_**Agent (model claude-4.5-opus-high-thinking, mode Agent)**_

<think><details><summary>Thought Process</summary>
**Searching for connection options**

I need to find information about "trang kết nối." I'll probably start by following a list page related to it, but I need to be careful to gather the right information. Using a search should help me find the relevant code or resources. It's intriguing how an efficient search can lead to the answers I need. Let's see what I can discover!</details></think>

---

Tôi sẽ tìm màn hình “Kết nối” và danh sách user trong code, sau đó thiết kế lại layout item để tên hiển thị gọn, tránh xuống dòng xấu, và thêm animation mượt khi load/danh sách xuất hiện.

---

<tool-use data-tool-type="search" data-tool-name="grep">
<details>
<summary>Tool use: **grep** • Grep for "Kết nối" • 1 match</summary>

Output mode: content


| File | Content | Line |
|------|------|------|
| `.\lib\features\contacts\pages\contacts_page.dart` | `'Kết nối',` | L63 |


</details>
</tool-use>

---

<tool-use data-tool-type="read" data-tool-name="read_file">
<details><summary>Tool use: **read_file** • Read file: lib/features/contacts/pages/contacts_page.dart</summary>

</details>
</tool-use>

---

<think><details><summary>Thought Process</summary>
**Evaluating UI redesign**

The user has raised concerns about how names are line-broken vertically in a narrow container. The screenshot shows the card's width is fine, but the text column might be too narrow because of excessive padding. They’re requesting a redesign with more animation. To improve layout, I could redesign the _AnimatedFollowItem row, using a Column for names and compressing action buttons. For the text, I can set maxLines: 1 with an overflow ellipsis. For animation, perhaps I could add a slight scale or ripple effect.
**Considering animation and layout changes**

The user asked for more features, so I could consider adding a slight scale-in effect when the card appears, using AnimatedScale. That might be extra work, but I can certainly keep the current fade/slide animations. I think they’d be satisfied with the transition from multi-line to single-line text and improved card styling, like a gradient background and avatar shadow. I also plan to modify the text configuration to set maxLines to 1 and add overflow ellipsis, while maybe incorporating a subtitle with '@username.' Finally, I can tweak the animation with a small scale transformation using ScaleTransition.
**Adjusting follow request item**

I’m considering adjusting the _AnimatedFollowRequestItem for consistency, but it seems less urgent since the user didn’t provide a screenshot of that part. However, adding a scale effect there could enhance the overall appearance. I think I’ll go ahead and patch that too, just to ensure everything looks cohesive and polished. It might not have been a priority, but it feels good to make those improvements!</details></think>

---

The model made no changes to the file.

---

<tool-use data-tool-type="search" data-tool-name="grep">
<details>
<summary>Tool use: **grep** • Grep for "contact_title_" in "lib/features/contacts/pages/contacts_page.dart" • 1 match</summary>

Output mode: content


| File | Content | Line |
|------|------|------|
| `lib/features/contacts/pages/contacts_page.dart` | `tag: 'contact_title_$\{widget.entry.uid\}',` | L704 |


</details>
</tool-use>

---

<tool-use data-tool-type="read" data-tool-name="read_file">
<details><summary>Tool use: **read_file** • Read file: lib/features/contacts/pages/contacts_page.dart</summary>

</details>
</tool-use>

---

<tool-use data-tool-type="unknown" data-tool-name="apply_patch">
<details>
<summary>Tool use: **apply_patch**</summary>


Parameters:

```json
{
  "relativeWorkspacePath": "lib/features/contacts/pages/contacts_page.dart"
}
```
Additional data:

```json
{
  "codeblockId": "840dec26-33c1-4ae9-bda3-484e09e8fd4c",
  "codeblock": {
    "uri": {
      "scheme": "file",
      "authority": "",
      "path": "/c:/Users/Admin/StudioProjects/duan_kmessapp/lib/features/contacts/pages/contacts_page.dart",
      "query": "",
      "fragment": "",
      "_formatted": "file:///c%3A/Users/Admin/StudioProjects/duan_kmessapp/lib/features/contacts/pages/contacts_page.dart",
      "_fsPath": null
    },
    "codeblockId": "840dec26-33c1-4ae9-bda3-484e09e8fd4c",
    "codeBlockIdx": 0,
    "content": "import 'package:cloud_firestore/cloud_firestore.dart';\nimport 'package:flutter/material.dart';\nimport 'package:flutter/services.dart';\n\nimport '../../auth/auth_repository.dart';\nimport '../../../theme/colors.dart';\nimport '../../chat/pages/chat_detail_page.dart';\nimport '../../chat/repositories/chat_repository.dart';\nimport '../../follow/services/follow_service.dart';\nimport '../../profile/public_profile_page.dart';\nimport '../widgets/contact_search_delegate.dart';\n\nclass ContactsPage extends StatefulWidget {\n  const ContactsPage({super.key});\n\n  @override\n  State&lt;ContactsPage&gt; createState() =&gt; _ContactsPageState();\n}\n\nclass _ContactsPageState extends State&lt;ContactsPage&gt;\n    with SingleTickerProviderStateMixin {\n  late final FollowService _followService;\n  late final ChatRepository _chatRepository;\n  late final TabController _tabController;\n  String? _errorMessage;\n\n  @override\n  void initState() {\n    super.initState();\n    _followService = FollowService();\n    _chatRepository = ChatRepository();\n    _tabController = TabController(length: 4, vsync: this);\n  }\n\n  @override\n  void dispose() {\n    _tabController.dispose();\n    super.dispose();\n  }\n\n  String get _currentUid =&gt; authRepository.currentUser()?.uid ?? '';\n\n  void _showError(Object error) {\n    final message = error.toString();\n    setState(() =&gt; _errorMessage = message);\n    ScaffoldMessenger.of(context).showSnackBar(\n      SnackBar(content: Text(message)),\n    );\n  }\n\n  @override\n  Widget build(BuildContext context) {\n    final uid = _currentUid;\n    if (uid.isEmpty) {\n      return const Scaffold(\n        body: Center(child: Text('Bạn chưa đăng nhập.')),\n      );\n    }\n\n    return Scaffold(\n      appBar: AppBar(\n        title: const Text(\n          'Kết nối',\n          style: TextStyle(color: AppColors.primaryPink),\n        ),\n        iconTheme: const IconThemeData(color: AppColors.primaryPink),\n        actions: [\n          _AnimatedSearchButton(\n            onPressed: () {\n              HapticFeedback.lightImpact();\n              showSearch(\n                context: context,\n                delegate: ContactSearchDelegate(service: _followService),\n              );\n            },\n          ),\n        ],\n        bottom: _ModernTabBar(\n          controller: _tabController,\n        ),\n      ),\n      body: Column(\n        children: [\n          if (_errorMessage != null)\n            Padding(\n              padding: const EdgeInsets.all(8),\n              child: Text(\n                _errorMessage!,\n                style: const TextStyle(color: Colors.red),\n              ),\n            ),\n          Expanded(\n            child: TabBarView(\n              controller: _tabController,\n              children: [\n                _ModernFollowList(\n                  stream: _followService.watchFollowingEntries(uid),\n                  emptyLabel: 'Bạn chưa theo dõi ai.',\n                  actionBuilder: (entry) =&gt; [\n                    _ModernActionButton(\n                      icon: Icons.chat_bubble_outline,\n                      tooltip: 'Nhắn tin',\n                      onPressed: () async {\n                        try {\n                          final conversationId =\n                              await _chatRepository.createOrGetDirectConversation(\n                            currentUid: uid,\n                            otherUid: entry.uid,\n                          );\n                          if (!mounted) return;\n                          Navigator.of(context).push(\n                            MaterialPageRoute(\n                              builder: (_) =&gt; ChatDetailPage(\n                                conversationId: conversationId,\n                                otherUid: entry.uid,\n                              ),\n                            ),\n                          );\n                        } catch (e) {\n                          _showError(e);\n                        }\n                      },\n                    ),\n                    _ModernActionButton(\n                      icon: Icons.person,\n                      tooltip: 'Xem trang cá nhân',\n                      onPressed: () {\n                        Navigator.of(context).push(\n                          MaterialPageRoute(\n                            builder: (_) =&gt; PublicProfilePage(uid: entry.uid),\n                          ),\n                        );\n                      },\n                    ),\n                    _ModernTextButton(\n                      label: 'Bỏ theo dõi',\n                      onPressed: () async {\n                        try {\n                          await _followService.unfollow(entry.uid);\n                        } catch (e) {\n                          _showError(e);\n                        }\n                      },\n                    ),\n                  ],\n                ),\n                _ModernFollowList(\n                  stream: _followService.watchFollowersEntries(uid),\n                  emptyLabel: 'Chưa có người theo dõi.',\n                  actionBuilder: (entry) =&gt; [\n                    _ModernActionButton(\n                      icon: Icons.chat_bubble_outline,\n                      tooltip: 'Nhắn tin',\n                      onPressed: () async {\n                        try {\n                          final conversationId =\n                              await _chatRepository.createOrGetDirectConversation(\n                            currentUid: uid,\n                            otherUid: entry.uid,\n                          );\n                          if (!mounted) return;\n                          Navigator.of(context).push(\n                            MaterialPageRoute(\n                              builder: (_) =&gt; ChatDetailPage(\n                                conversationId: conversationId,\n                                otherUid: entry.uid,\n                              ),\n                            ),\n                          );\n                        } catch (e) {\n                          _showError(e);\n                        }\n                      },\n                    ),\n                    _ModernActionButton(\n                      icon: Icons.person,\n                      tooltip: 'Xem trang cá nhân',\n                      onPressed: () {\n                        Navigator.of(context).push(\n                          MaterialPageRoute(\n                            builder: (_) =&gt; PublicProfilePage(uid: entry.uid),\n                          ),\n                        );\n                      },\n                    ),\n                    if (!entry.isMutual)\n                      _ModernTextButton(\n                        label: 'Theo dõi lại',\n                        onPressed: () async {\n                          try {\n                            await _followService.followUser(entry.uid);\n                          } catch (e) {\n                            _showError(e);\n                          }\n                        },\n                      )\n                    else\n                      _ModernTextButton(\n                        label: 'Bỏ theo dõi',\n                        onPressed: () async {\n                          try {\n                            await _followService.unfollow(entry.uid);\n                          } catch (e) {\n                            _showError(e);\n                          }\n                        },\n                      ),\n                  ],\n                ),\n                _ModernFollowRequestList(\n                  stream: _followService.watchIncomingRequestEntries(uid),\n                  emptyLabel: 'Không có yêu cầu theo dõi.',\n                  onAccept: (otherUid) async {\n                    try {\n                      await _followService.acceptRequest(otherUid);\n                    } catch (e) {\n                      _showError(e);\n                    }\n                  },\n                  onDecline: (otherUid) async {\n                    try {\n                      await _followService.declineRequest(otherUid);\n                    } catch (e) {\n                      _showError(e);\n                    }\n                  },\n                ),\n                _ModernFollowRequestList(\n                  stream: _followService.watchSentRequestEntries(uid),\n                  emptyLabel: 'Không có yêu cầu đã gửi.',\n                  onAccept: (_) async {},\n                  onDecline: (otherUid) async {\n                    try {\n                      await _followService.cancelRequest(otherUid);\n                    } catch (e) {\n                      _showError(e);\n                    }\n                  },\n                  acceptLabel: '',\n                  declineLabel: 'Huỷ yêu cầu',\n                  showAcceptButton: false,\n                ),\n              ],\n            ),\n          ),\n        ],\n      ),\n    );\n  }\n}\n\nclass _ModernFollowList extends StatelessWidget {\n  const _ModernFollowList({\n    required this.stream,\n    required this.emptyLabel,\n    required this.actionBuilder,\n  });\n\n  final Stream&lt;List&lt;FollowEntry&gt;&gt; stream;\n  final String emptyLabel;\n  final List&lt;Widget&gt; Function(FollowEntry) actionBuilder;\n\n  @override\n  Widget build(BuildContext context) {\n    return RefreshIndicator(\n      onRefresh: () async {\n        await Future.delayed(const Duration(milliseconds: 500));\n      },\n      color: AppColors.primaryPink,\n      child: StreamBuilder&lt;List&lt;FollowEntry&gt;&gt;(\n      stream: stream,\n      builder: (context, snapshot) {\n        if (snapshot.connectionState == ConnectionState.waiting) {\n            return _ShimmerLoadingList();\n        }\n        if (snapshot.hasError) {\n          return _FirestoreIndexErrorView(error: snapshot.error);\n        }\n        final entries = snapshot.data ?? [];\n        if (entries.isEmpty) {\n            return _EmptyStateView(label: emptyLabel);\n        }\n          return ListView.builder(\n            padding: const EdgeInsets.symmetric(vertical: 8, horizontal: 16),\n          itemCount: entries.length,\n          itemBuilder: (context, index) {\n            final entry = entries[index];\n              return _AnimatedFollowItem(\n                key: ValueKey(entry.uid),\n                entry: entry,\n                index: index,\n                actionBuilder: actionBuilder,\n            );\n          },\n        );\n      },\n      ),\n    );\n  }\n}\n\nclass _ModernFollowRequestList extends StatelessWidget {\n  const _ModernFollowRequestList({\n    required this.stream,\n    required this.emptyLabel,\n    required this.onAccept,\n    required this.onDecline,\n    this.acceptLabel = 'Chấp nhận',\n    this.declineLabel = 'Từ chối',\n    this.showAcceptButton = true,\n  });\n\n  final Stream&lt;List&lt;FollowRequestEntry&gt;&gt; stream;\n  final String emptyLabel;\n  final Future&lt;void&gt; Function(String) onAccept;\n  final Future&lt;void&gt; Function(String) onDecline;\n  final String acceptLabel;\n  final String declineLabel;\n  final bool showAcceptButton;\n\n  @override\n  Widget build(BuildContext context) {\n    return RefreshIndicator(\n      onRefresh: () async {\n        await Future.delayed(const Duration(milliseconds: 500));\n      },\n      color: AppColors.primaryPink,\n      child: StreamBuilder&lt;List&lt;FollowRequestEntry&gt;&gt;(\n      stream: stream,\n      builder: (context, snapshot) {\n        if (snapshot.connectionState == ConnectionState.waiting) {\n            return _ShimmerLoadingList();\n        }\n        if (snapshot.hasError) {\n          return _FirestoreIndexErrorView(error: snapshot.error);\n        }\n        final entries = snapshot.data ?? [];\n        if (entries.isEmpty) {\n            return _EmptyStateView(label: emptyLabel);\n        }\n          return ListView.builder(\n            padding: const EdgeInsets.symmetric(vertical: 8, horizontal: 16),\n          itemCount: entries.length,\n          itemBuilder: (context, index) {\n            final entry = entries[index];\n              return _AnimatedFollowRequestItem(\n                key: ValueKey(entry.uid),\n                entry: entry,\n                index: index,\n                onAccept: onAccept,\n                onDecline: onDecline,\n                acceptLabel: acceptLabel,\n                declineLabel: declineLabel,\n                showAcceptButton: showAcceptButton,\n            );\n          },\n        );\n      },\n      ),\n    );\n  }\n}\n\nclass _FirestoreIndexErrorView extends StatelessWidget {\n  const _FirestoreIndexErrorView({this.error});\n\n  final Object? error;\n\n  @override\n  Widget build(BuildContext context) {\n    final firebaseError =\n        error is FirebaseException ? error as FirebaseException : null;\n    if (firebaseError != null &amp;&amp;\n        firebaseError.code == 'failed-precondition' &amp;&amp;\n        (firebaseError.message?.contains('https://') ?? false)) {\n      final url = _extractUrl(firebaseError.message!);\n      return Padding(\n        padding: const EdgeInsets.all(16),\n        child: Column(\n          mainAxisAlignment: MainAxisAlignment.center,\n          children: [\n            const Icon(Icons.warning_amber_rounded,\n                color: Colors.amber, size: 48),\n            const SizedBox(height: 12),\n            const Text(\n              'Thiếu Firestore index cho truy vấn này.',\n              style: TextStyle(fontSize: 16, fontWeight: FontWeight.w600),\n              textAlign: TextAlign.center,\n            ),\n            const SizedBox(height: 8),\n            const Text(\n              'Nhấn vào liên kết bên dưới để mở Firebase Console và tạo index. '\n              'Đợi vài phút sau khi tạo rồi tải lại trang.',\n              textAlign: TextAlign.center,\n            ),\n            const SizedBox(height: 12),\n            if (url != null)\n              SelectableText(\n                url,\n                style: const TextStyle(color: Colors.blue),\n                textAlign: TextAlign.center,\n              )\n            else\n              Text(firebaseError.message ?? '',\n                  textAlign: TextAlign.center),\n          ],\n        ),\n      );\n    }\n    return Center(\n      child: Text('Lỗi: $error'),\n    );\n  }\n\n  String? _extractUrl(String message) {\n    final regex = RegExp(r'https://[^\\s]+');\n    final match = regex.firstMatch(message);\n    return match?.group(0);\n  }\n}\n\n// Shimmer Loading Widget\nclass _ShimmerLoadingList extends StatelessWidget {\n  @override\n  Widget build(BuildContext context) {\n    return ListView.builder(\n      padding: const EdgeInsets.symmetric(vertical: 8, horizontal: 16),\n      itemCount: 6,\n      itemBuilder: (context, index) {\n        return _ShimmerItem(delay: Duration(milliseconds: index * 100));\n      },\n    );\n  }\n}\n\nclass _ShimmerItem extends StatefulWidget {\n  const _ShimmerItem({required this.delay});\n\n  final Duration delay;\n\n  @override\n  State&lt;_ShimmerItem&gt; createState() =&gt; _ShimmerItemState();\n}\n\nclass _ShimmerItemState extends State&lt;_ShimmerItem&gt;\n    with SingleTickerProviderStateMixin {\n  late AnimationController _controller;\n\n  @override\n  void initState() {\n    super.initState();\n    _controller = AnimationController(\n      vsync: this,\n      duration: const Duration(milliseconds: 1500),\n    )..repeat(reverse: true);\n    Future.delayed(widget.delay, () {\n      if (mounted) _controller.forward();\n    });\n  }\n\n  @override\n  void dispose() {\n    _controller.dispose();\n    super.dispose();\n  }\n\n  @override\n  Widget build(BuildContext context) {\n    return AnimatedBuilder(\n      animation: _controller,\n      builder: (context, child) {\n        return Opacity(\n          opacity: 0.3 + (_controller.value * 0.4),\n          child: Container(\n            margin: const EdgeInsets.only(bottom: 12),\n            padding: const EdgeInsets.all(12),\n            decoration: BoxDecoration(\n              color: Colors.grey.shade300,\n              borderRadius: BorderRadius.circular(16),\n            ),\n            child: Row(\n              children: [\n                Container(\n                  width: 56,\n                  height: 56,\n                  decoration: BoxDecoration(\n                    color: Colors.grey.shade400,\n                    shape: BoxShape.circle,\n                  ),\n                ),\n                const SizedBox(width: 16),\n                Expanded(\n                  child: Column(\n                    crossAxisAlignment: CrossAxisAlignment.start,\n                    children: [\n                      Container(\n                        height: 16,\n                        width: double.infinity,\n                        decoration: BoxDecoration(\n                          color: Colors.grey.shade400,\n                          borderRadius: BorderRadius.circular(8),\n                        ),\n                      ),\n                      const SizedBox(height: 8),\n                      Container(\n                        height: 12,\n                        width: 150,\n                        decoration: BoxDecoration(\n                          color: Colors.grey.shade400,\n                          borderRadius: BorderRadius.circular(6),\n                        ),\n                      ),\n                    ],\n                  ),\n                ),\n              ],\n            ),\n          ),\n        );\n      },\n    );\n  }\n}\n\n// Empty State Widget\nclass _EmptyStateView extends StatefulWidget {\n  const _EmptyStateView({required this.label});\n\n  final String label;\n\n  @override\n  State&lt;_EmptyStateView&gt; createState() =&gt; _EmptyStateViewState();\n}\n\nclass _EmptyStateViewState extends State&lt;_EmptyStateView&gt;\n    with SingleTickerProviderStateMixin {\n  late AnimationController _controller;\n  late Animation&lt;double&gt; _fadeAnimation;\n  late Animation&lt;double&gt; _scaleAnimation;\n\n  @override\n  void initState() {\n    super.initState();\n    _controller = AnimationController(\n      vsync: this,\n      duration: const Duration(milliseconds: 800),\n    );\n    _fadeAnimation = Tween&lt;double&gt;(begin: 0.0, end: 1.0).animate(\n      CurvedAnimation(parent: _controller, curve: Curves.easeIn),\n    );\n    _scaleAnimation = Tween&lt;double&gt;(begin: 0.8, end: 1.0).animate(\n      CurvedAnimation(parent: _controller, curve: Curves.easeOut),\n    );\n    _controller.forward();\n  }\n\n  @override\n  void dispose() {\n    _controller.dispose();\n    super.dispose();\n  }\n\n  @override\n  Widget build(BuildContext context) {\n    return FadeTransition(\n      opacity: _fadeAnimation,\n      child: ScaleTransition(\n        scale: _scaleAnimation,\n        child: Center(\n          child: Padding(\n            padding: const EdgeInsets.all(32),\n            child: Column(\n              mainAxisAlignment: MainAxisAlignment.center,\n              children: [\n                Container(\n                  padding: const EdgeInsets.all(24),\n                  decoration: BoxDecoration(\n                    color: AppColors.primaryPink.withOpacity(0.1),\n                    shape: BoxShape.circle,\n                  ),\n                  child: Icon(\n                    Icons.people_outline,\n                    size: 80,\n                    color: AppColors.primaryPink.withOpacity(0.6),\n                  ),\n                ),\n                const SizedBox(height: 24),\n                Text(\n                  widget.label,\n                  style: TextStyle(\n                    fontSize: 18,\n                    fontWeight: FontWeight.bold,\n                    color: Colors.grey.shade700,\n                  ),\n                  textAlign: TextAlign.center,\n                ),\n              ],\n            ),\n          ),\n        ),\n      ),\n    );\n  }\n}\n\n// Animated Follow Item\nclass _AnimatedFollowItem extends StatefulWidget {\n  const _AnimatedFollowItem({\n    required Key key,\n    required this.entry,\n    required this.index,\n    required this.actionBuilder,\n  }) : super(key: key);\n\n  final FollowEntry entry;\n  final int index;\n  final List&lt;Widget&gt; Function(FollowEntry) actionBuilder;\n\n  @override\n  State&lt;_AnimatedFollowItem&gt; createState() =&gt; _AnimatedFollowItemState();\n}\n\nclass _AnimatedFollowItemState extends State&lt;_AnimatedFollowItem&gt;\n    with SingleTickerProviderStateMixin {\n  late AnimationController _controller;\n  late Animation&lt;double&gt; _fadeAnimation;\n  late Animation&lt;Offset&gt; _slideAnimation;\n\n  @override\n  void initState() {\n    super.initState();\n    _controller = AnimationController(\n      vsync: this,\n      duration: const Duration(milliseconds: 400),\n    );\n    _fadeAnimation = Tween&lt;double&gt;(begin: 0.0, end: 1.0).animate(\n      CurvedAnimation(parent: _controller, curve: Curves.easeIn),\n    );\n    _slideAnimation = Tween&lt;Offset&gt;(\n      begin: const Offset(0.3, 0),\n      end: Offset.zero,\n    ).animate(\n      CurvedAnimation(parent: _controller, curve: Curves.easeOutCubic),\n    );\n    Future.delayed(Duration(milliseconds: widget.index * 50), () {\n      if (mounted) _controller.forward();\n    });\n  }\n\n  @override\n  void dispose() {\n    _controller.dispose();\n    super.dispose();\n  }\n\n  @override\n  Widget build(BuildContext context) {\n    final profile = widget.entry.profile;\n    final title = profile?.displayName?.isNotEmpty == true\n        ? profile!.displayName!\n        : (profile?.email?.isNotEmpty == true\n            ? profile!.email!\n            : widget.entry.uid);\n    final avatarUrl = profile?.photoUrl;\n\n    return FadeTransition(\n      opacity: _fadeAnimation,\n      child: SlideTransition(\n        position: _slideAnimation,\n        child: ScaleTransition(\n          scale: Tween&lt;double&gt;(begin: 0.97, end: 1.0).animate(\n            CurvedAnimation(parent: _controller, curve: Curves.easeOutBack),\n          ),\n          child: Container(\n            margin: const EdgeInsets.only(bottom: 12),\n            child: Material(\n              color: Colors.transparent,\n              child: InkWell(\n                onTap: () {\n                  HapticFeedback.lightImpact();\n                  Navigator.of(context).push(\n                    MaterialPageRoute(\n                      builder: (_) =&gt; PublicProfilePage(uid: widget.entry.uid),\n                    ),\n                  );\n                },\n                borderRadius: BorderRadius.circular(16),\n                child: Card(\n                  color: AppColors.primaryPink.withOpacity(0.04),\n                  elevation: 0,\n                  shape: RoundedRectangleBorder(\n                    borderRadius: BorderRadius.circular(16),\n                    side: BorderSide(\n                      color: AppColors.primaryPink.withOpacity(0.15),\n                      width: 1,\n                    ),\n                  ),\n                  child: Padding(\n                    padding: const EdgeInsets.symmetric(\n                      horizontal: 12,\n                      vertical: 10,\n                    ),\n                    child: Row(\n                      children: [\n                        _ModernAvatar(\n                          avatarUrl: avatarUrl,\n                          uid: widget.entry.uid,\n                        ),\n                        const SizedBox(width: 12),\n                        Expanded(\n                          child: Hero(\n                            tag: 'contact_title_${widget.entry.uid}',\n                            child: Text(\n                              title,\n                              style: const TextStyle(\n                                fontSize: 16,\n                                fontWeight: FontWeight.w600,\n                              ),\n                              maxLines: 1,\n                              overflow: TextOverflow.ellipsis,\n                            ),\n                          ),\n                        ),\n                        const SizedBox(width: 8),\n                        Wrap(\n                          spacing: 4,\n                          children: widget.actionBuilder(widget.entry),\n                        ),\n                      ],\n                    ),\n                  ),\n                ),\n              ),\n            ),\n          ),\n        ),\n      ),\n    );\n  }\n}\n\n// Animated Follow Request Item\nclass _AnimatedFollowRequestItem extends StatefulWidget {\n  const _AnimatedFollowRequestItem({\n    required Key key,\n    required this.entry,\n    required this.index,\n    required this.onAccept,\n    required this.onDecline,\n    required this.acceptLabel,\n    required this.declineLabel,\n    required this.showAcceptButton,\n  }) : super(key: key);\n\n  final FollowRequestEntry entry;\n  final int index;\n  final Future&lt;void&gt; Function(String) onAccept;\n  final Future&lt;void&gt; Function(String) onDecline;\n  final String acceptLabel;\n  final String declineLabel;\n  final bool showAcceptButton;\n\n  @override\n  State&lt;_AnimatedFollowRequestItem&gt; createState() =&gt;\n      _AnimatedFollowRequestItemState();\n}\n\nclass _AnimatedFollowRequestItemState\n    extends State&lt;_AnimatedFollowRequestItem&gt;\n    with SingleTickerProviderStateMixin {\n  late AnimationController _controller;\n  late Animation&lt;double&gt; _fadeAnimation;\n  late Animation&lt;Offset&gt; _slideAnimation;\n\n  @override\n  void initState() {\n    super.initState();\n    _controller = AnimationController(\n      vsync: this,\n      duration: const Duration(milliseconds: 400),\n    );\n    _fadeAnimation = Tween&lt;double&gt;(begin: 0.0, end: 1.0).animate(\n      CurvedAnimation(parent: _controller, curve: Curves.easeIn),\n    );\n    _slideAnimation = Tween&lt;Offset&gt;(\n      begin: const Offset(0.3, 0),\n      end: Offset.zero,\n    ).animate(\n      CurvedAnimation(parent: _controller, curve: Curves.easeOutCubic),\n    );\n    Future.delayed(Duration(milliseconds: widget.index * 50), () {\n      if (mounted) _controller.forward();\n    });\n  }\n\n  @override\n  void dispose() {\n    _controller.dispose();\n    super.dispose();\n  }\n\n  @override\n  Widget build(BuildContext context) {\n    final profile = widget.entry.profile;\n    final title = profile?.displayName?.isNotEmpty == true\n        ? profile!.displayName!\n        : (profile?.email?.isNotEmpty == true\n            ? profile!.email!\n            : widget.entry.uid);\n    final avatarUrl = profile?.photoUrl;\n\n    return FadeTransition(\n      opacity: _fadeAnimation,\n      child: SlideTransition(\n        position: _slideAnimation,\n        child: Container(\n          margin: const EdgeInsets.only(bottom: 12),\n          child: Card(\n            elevation: 0,\n            shape: RoundedRectangleBorder(\n              borderRadius: BorderRadius.circular(16),\n              side: BorderSide(\n                color: Colors.grey.shade200,\n                width: 1,\n              ),\n            ),\n            child: Padding(\n              padding: const EdgeInsets.all(12),\n              child: Row(\n                children: [\n                  _ModernAvatar(\n                    avatarUrl: avatarUrl,\n                    uid: widget.entry.uid,\n                  ),\n                  const SizedBox(width: 16),\n                  Expanded(\n                    child: Column(\n                      crossAxisAlignment: CrossAxisAlignment.start,\n                      mainAxisSize: MainAxisSize.min,\n                      children: [\n                        Hero(\n                          tag: 'request_title_${widget.entry.uid}',\n                          child: Text(\n                            title,\n                            style: const TextStyle(\n                              fontSize: 16,\n                              fontWeight: FontWeight.w600,\n                            ),\n                            maxLines: 2,\n                            overflow: TextOverflow.ellipsis,\n                          ),\n                        ),\n                        if (widget.entry.createdAt != null) ...[\n                          const SizedBox(height: 4),\n                          Text(\n                            'Gửi lúc ${widget.entry.createdAt}',\n                            style: TextStyle(\n                              fontSize: 12,\n                              color: Colors.grey.shade600,\n                            ),\n                          ),\n                        ],\n                      ],\n                    ),\n                  ),\n                  const SizedBox(width: 8),\n                  Wrap(\n                    spacing: 8,\n                    children: [\n                      if (widget.showAcceptButton)\n                        _ModernTextButton(\n                          label: widget.acceptLabel,\n                          isPrimary: true,\n                          onPressed: () =&gt; widget.onAccept(widget.entry.uid),\n                        ),\n                      _ModernTextButton(\n                        label: widget.declineLabel,\n                        onPressed: () =&gt; widget.onDecline(widget.entry.uid),\n                      ),\n                    ],\n                  ),\n                ],\n              ),\n            ),\n          ),\n        ),\n      ),\n    );\n  }\n}\n\n// Modern Avatar\nclass _ModernAvatar extends StatelessWidget {\n  const _ModernAvatar({\n    required this.avatarUrl,\n    required this.uid,\n  });\n\n  final String? avatarUrl;\n  final String uid;\n\n  @override\n  Widget build(BuildContext context) {\n    return Hero(\n      tag: 'contact_avatar_$uid',\n      child: Container(\n        decoration: BoxDecoration(\n          shape: BoxShape.circle,\n          gradient: LinearGradient(\n            colors: [\n              AppColors.primaryPink,\n              AppColors.primaryPink.withOpacity(0.6),\n            ],\n          ),\n          boxShadow: [\n            BoxShadow(\n              color: AppColors.primaryPink.withOpacity(0.3),\n              blurRadius: 8,\n              offset: const Offset(0, 2),\n            ),\n          ],\n        ),\n        padding: const EdgeInsets.all(2),\n        child: CircleAvatar(\n          radius: 28,\n          backgroundImage: avatarUrl != null ? NetworkImage(avatarUrl!) : null,\n          child: avatarUrl == null\n              ? const Icon(Icons.person, color: AppColors.primaryPink)\n              : null,\n        ),\n      ),\n    );\n  }\n}\n\n\n// Modern Tab Bar\nclass _ModernTabBar extends StatelessWidget implements PreferredSizeWidget {\n  const _ModernTabBar({required this.controller});\n\n  final TabController controller;\n\n  @override\n  Widget build(BuildContext context) {\n    return Container(\n      decoration: BoxDecoration(\n        gradient: LinearGradient(\n          colors: [\n            Colors.white,\n            AppColors.primaryPink.withOpacity(0.05),\n          ],\n          begin: Alignment.topCenter,\n          end: Alignment.bottomCenter,\n        ),\n      ),\n      child: TabBar(\n        controller: controller,\n        labelColor: AppColors.primaryPink,\n        unselectedLabelColor: Colors.grey,\n        indicatorColor: AppColors.primaryPink,\n        indicatorWeight: 3,\n        tabs: const [\n          Tab(text: 'Đang theo dõi'),\n          Tab(text: 'Người theo dõi'),\n          Tab(text: 'Yêu cầu đến'),\n          Tab(text: 'Yêu cầu đã gửi'),\n        ],\n      ),\n    );\n  }\n\n  @override\n  Size get preferredSize =&gt; const Size.fromHeight(48);\n}\n\n// Animated Search Button\nclass _AnimatedSearchButton extends StatefulWidget {\n  const _AnimatedSearchButton({required this.onPressed});\n\n  final VoidCallback onPressed;\n\n  @override\n  State&lt;_AnimatedSearchButton&gt; createState() =&gt; _AnimatedSearchButtonState();\n}\n\nclass _AnimatedSearchButtonState extends State&lt;_AnimatedSearchButton&gt;\n    with SingleTickerProviderStateMixin {\n  late AnimationController _controller;\n\n  @override\n  void initState() {\n    super.initState();\n    _controller = AnimationController(\n      vsync: this,\n      duration: const Duration(milliseconds: 200),\n    );\n  }\n\n  @override\n  void dispose() {\n    _controller.dispose();\n    super.dispose();\n  }\n\n  @override\n  Widget build(BuildContext context) {\n    return GestureDetector(\n      onTapDown: (_) =&gt; _controller.forward(),\n      onTapUp: (_) {\n        _controller.reverse();\n        widget.onPressed();\n      },\n      onTapCancel: () =&gt; _controller.reverse(),\n      child: ScaleTransition(\n        scale: Tween&lt;double&gt;(begin: 1.0, end: 0.9).animate(\n          CurvedAnimation(parent: _controller, curve: Curves.easeInOut),\n        ),\n        child: IconButton(\n          icon: const Icon(Icons.search, color: AppColors.primaryPink),\n          tooltip: 'Tìm kiếm người dùng',\n          onPressed: widget.onPressed,\n        ),\n      ),\n    );\n  }\n}\n\n// Modern Action Button\nclass _ModernActionButton extends StatefulWidget {\n  const _ModernActionButton({\n    required this.icon,\n    required this.tooltip,\n    required this.onPressed,\n  });\n\n  final IconData icon;\n  final String tooltip;\n  final VoidCallback onPressed;\n\n  @override\n  State&lt;_ModernActionButton&gt; createState() =&gt; _ModernActionButtonState();\n}\n\nclass _ModernActionButtonState extends State&lt;_ModernActionButton&gt;\n    with SingleTickerProviderStateMixin {\n  late AnimationController _controller;\n\n  @override\n  void initState() {\n    super.initState();\n    _controller = AnimationController(\n      vsync: this,\n      duration: const Duration(milliseconds: 150),\n    );\n  }\n\n  @override\n  void dispose() {\n    _controller.dispose();\n    super.dispose();\n  }\n\n  @override\n  Widget build(BuildContext context) {\n    return GestureDetector(\n      onTapDown: (_) {\n        _controller.forward();\n        HapticFeedback.lightImpact();\n      },\n      onTapUp: (_) {\n        _controller.reverse();\n        widget.onPressed();\n      },\n      onTapCancel: () =&gt; _controller.reverse(),\n      child: ScaleTransition(\n        scale: Tween&lt;double&gt;(begin: 1.0, end: 0.85).animate(\n          CurvedAnimation(parent: _controller, curve: Curves.easeInOut),\n        ),\n        child: IconButton(\n          icon: Icon(widget.icon, color: AppColors.primaryPink),\n          tooltip: widget.tooltip,\n          onPressed: widget.onPressed,\n        ),\n      ),\n    );\n  }\n}\n\n// Modern Text Button\nclass _ModernTextButton extends StatefulWidget {\n  const _ModernTextButton({\n    required this.label,\n    required this.onPressed,\n    this.isPrimary = false,\n  });\n\n  final String label;\n  final VoidCallback onPressed;\n  final bool isPrimary;\n\n  @override\n  State&lt;_ModernTextButton&gt; createState() =&gt; _ModernTextButtonState();\n}\n\nclass _ModernTextButtonState extends State&lt;_ModernTextButton&gt;\n    with SingleTickerProviderStateMixin {\n  late AnimationController _controller;\n\n  @override\n  void initState() {\n    super.initState();\n    _controller = AnimationController(\n      vsync: this,\n      duration: const Duration(milliseconds: 150),\n    );\n  }\n\n  @override\n  void dispose() {\n    _controller.dispose();\n    super.dispose();\n  }\n\n  @override\n  Widget build(BuildContext context) {\n    return GestureDetector(\n      onTapDown: (_) {\n        _controller.forward();\n        HapticFeedback.lightImpact();\n      },\n      onTapUp: (_) {\n        _controller.reverse();\n        widget.onPressed();\n      },\n      onTapCancel: () =&gt; _controller.reverse(),\n      child: ScaleTransition(\n        scale: Tween&lt;double&gt;(begin: 1.0, end: 0.95).animate(\n          CurvedAnimation(parent: _controller, curve: Curves.easeInOut),\n        ),\n        child: TextButton(\n          onPressed: widget.onPressed,\n          style: TextButton.styleFrom(\n            foregroundColor: widget.isPrimary\n                ? AppColors.primaryPink\n                : Colors.grey.shade700,\n            backgroundColor: widget.isPrimary\n                ? AppColors.primaryPink.withOpacity(0.1)\n                : null,\n          ),\n          child: Text(widget.label),\n        ),\n      ),\n    );\n  }\n}\n\n",
    "languageId": "dart"
  }
}
```
Result:

```json
{
  "diff": {
    "chunks": [
      {
        "diffString": "        child: SlideTransition(\n          position: _slideAnimation,\n-         child: Container(\n-           margin: const EdgeInsets.only(bottom: 12),\n-           child: Material(\n-             color: Colors.transparent,\n-             child: InkWell(\n-               onTap: () {\n-                 HapticFeedback.lightImpact();\n-                 Navigator.of(context).push(\n-                   MaterialPageRoute(\n-                     builder: (_) =&gt; PublicProfilePage(uid: widget.entry.uid),\n-                   ),\n-                 );\n-               },\n-               borderRadius: BorderRadius.circular(16),\n-               child: Card(\n-                 elevation: 0,\n-                 shape: RoundedRectangleBorder(\n-                   borderRadius: BorderRadius.circular(16),\n-                   side: BorderSide(\n-                     color: Colors.grey.shade200,\n-                     width: 1,\n-                   ),\n-                 ),\n-                 child: Padding(\n-                   padding: const EdgeInsets.all(12),\n-                   child: Row(\n-                     children: [\n-                       _ModernAvatar(\n-                         avatarUrl: avatarUrl,\n-                         uid: widget.entry.uid,\n-                       ),\n-                       const SizedBox(width: 16),\n-                       Expanded(\n-                         child: Hero(\n-                           tag: 'contact_title_${widget.entry.uid}',\n-                           child: Text(\n-                             title,\n-                             style: const TextStyle(\n-                               fontSize: 16,\n-                               fontWeight: FontWeight.w600,\n-                             ),\n-                             // Cho phép tên hiển thị xuống nhiều dòng,\n-                             // tránh bị cắt mất trên màn hình nhỏ.\n-                             softWrap: true,\n-                           ),\n-                         ),\n-                       ),\n-                       const SizedBox(width: 8),\n-                       Wrap(\n-                         spacing: 4,\n-                         children: widget.actionBuilder(widget.entry),\n-                       ),\n-                     ],\n+         child: ScaleTransition(\n+           scale: Tween&lt;double&gt;(begin: 0.97, end: 1.0).animate(\n+             CurvedAnimation(parent: _controller, curve: Curves.easeOutBack),\n+           ),\n+           child: Container(\n+             margin: const EdgeInsets.only(bottom: 12),\n+             child: Material(\n+               color: Colors.transparent,\n+               child: InkWell(\n+                 onTap: () {\n+                   HapticFeedback.lightImpact();\n+                   Navigator.of(context).push(\n+                     MaterialPageRoute(\n+                       builder: (_) =&gt; PublicProfilePage(uid: widget.entry.uid),\n+                     ),\n+                   );\n+                 },\n+                 borderRadius: BorderRadius.circular(16),\n+                 child: Card(\n+                   color: AppColors.primaryPink.withOpacity(0.04),\n+                   elevation: 0,\n+                   shape: RoundedRectangleBorder(\n+                     borderRadius: BorderRadius.circular(16),\n+                     side: BorderSide(\n+                       color: AppColors.primaryPink.withOpacity(0.15),\n+                       width: 1,\n+                     ),\n+                   ),\n+                   child: Padding(\n+                     padding: const EdgeInsets.symmetric(\n+                       horizontal: 12,\n+                       vertical: 10,\n+                     ),\n+                     child: Row(\n+                       children: [\n+                         _ModernAvatar(\n+                           avatarUrl: avatarUrl,\n+                           uid: widget.entry.uid,\n+                         ),\n+                         const SizedBox(width: 12),\n+                         Expanded(\n+                           child: Hero(\n+                             tag: 'contact_title_${widget.entry.uid}',\n+                             child: Text(\n+                               title,\n+                               style: const TextStyle(\n+                                 fontSize: 16,\n+                                 fontWeight: FontWeight.w600,\n+                               ),\n+                               maxLines: 1,\n+                               overflow: TextOverflow.ellipsis,\n+                             ),\n+                           ),\n+                         ),\n+                         const SizedBox(width: 8),\n+                         Wrap(\n+                           spacing: 4,\n+                           children: widget.actionBuilder(widget.entry),\n+                         ),\n+                       ],\n+                     ),\n                    ),\n                  ),",
        "oldStart": 668,
        "newStart": 668,
        "oldLines": 57,
        "newLines": 65,
        "linesRemoved": 53,
        "linesAdded": 61
      }
    ],
    "editor": "EDITOR_AI"
  },
  "shouldAutoFixLints": true,
  "resultForModel": "Success. Updated the following files:\nM lib/features/contacts/pages/contacts_page.dart",
  "contentsAfterEdit": "import 'package:cloud_firestore/cloud_firestore.dart';\nimport 'package:flutter/material.dart';\nimport 'package:flutter/services.dart';\n\nimport '../../auth/auth_repository.dart';\nimport '../../../theme/colors.dart';\nimport '../../chat/pages/chat_detail_page.dart';\nimport '../../chat/repositories/chat_repository.dart';\nimport '../../follow/services/follow_service.dart';\nimport '../../profile/public_profile_page.dart';\nimport '../widgets/contact_search_delegate.dart';\n\nclass ContactsPage extends StatefulWidget {\n  const ContactsPage({super.key});\n\n  @override\n  State&lt;ContactsPage&gt; createState() =&gt; _ContactsPageState();\n}\n\nclass _ContactsPageState extends State&lt;ContactsPage&gt;\n    with SingleTickerProviderStateMixin {\n  late final FollowService _followService;\n  late final ChatRepository _chatRepository;\n  late final TabController _tabController;\n  String? _errorMessage;\n\n  @override\n  void initState() {\n    super.initState();\n    _followService = FollowService();\n    _chatRepository = ChatRepository();\n    _tabController = TabController(length: 4, vsync: this);\n  }\n\n  @override\n  void dispose() {\n    _tabController.dispose();\n    super.dispose();\n  }\n\n  String get _currentUid =&gt; authRepository.currentUser()?.uid ?? '';\n\n  void _showError(Object error) {\n    final message = error.toString();\n    setState(() =&gt; _errorMessage = message);\n    ScaffoldMessenger.of(context).showSnackBar(\n      SnackBar(content: Text(message)),\n    );\n  }\n\n  @override\n  Widget build(BuildContext context) {\n    final uid = _currentUid;\n    if (uid.isEmpty) {\n      return const Scaffold(\n        body: Center(child: Text('Bạn chưa đăng nhập.')),\n      );\n    }\n\n    return Scaffold(\n      appBar: AppBar(\n        title: const Text(\n          'Kết nối',\n          style: TextStyle(color: AppColors.primaryPink),\n        ),\n        iconTheme: const IconThemeData(color: AppColors.primaryPink),\n        actions: [\n          _AnimatedSearchButton(\n            onPressed: () {\n              HapticFeedback.lightImpact();\n              showSearch(\n                context: context,\n                delegate: ContactSearchDelegate(service: _followService),\n              );\n            },\n          ),\n        ],\n        bottom: _ModernTabBar(\n          controller: _tabController,\n        ),\n      ),\n      body: Column(\n        children: [\n          if (_errorMessage != null)\n            Padding(\n              padding: const EdgeInsets.all(8),\n              child: Text(\n                _errorMessage!,\n                style: const TextStyle(color: Colors.red),\n              ),\n            ),\n          Expanded(\n            child: TabBarView(\n              controller: _tabController,\n              children: [\n                _ModernFollowList(\n                  stream: _followService.watchFollowingEntries(uid),\n                  emptyLabel: 'Bạn chưa theo dõi ai.',\n                  actionBuilder: (entry) =&gt; [\n                    _ModernActionButton(\n                      icon: Icons.chat_bubble_outline,\n                      tooltip: 'Nhắn tin',\n                      onPressed: () async {\n                        try {\n                          final conversationId =\n                              await _chatRepository.createOrGetDirectConversation(\n                            currentUid: uid,\n                            otherUid: entry.uid,\n                          );\n                          if (!mounted) return;\n                          Navigator.of(context).push(\n                            MaterialPageRoute(\n                              builder: (_) =&gt; ChatDetailPage(\n                                conversationId: conversationId,\n                                otherUid: entry.uid,\n                              ),\n                            ),\n                          );\n                        } catch (e) {\n                          _showError(e);\n                        }\n                      },\n                    ),\n                    _ModernActionButton(\n                      icon: Icons.person,\n                      tooltip: 'Xem trang cá nhân',\n                      onPressed: () {\n                        Navigator.of(context).push(\n                          MaterialPageRoute(\n                            builder: (_) =&gt; PublicProfilePage(uid: entry.uid),\n                          ),\n                        );\n                      },\n                    ),\n                    _ModernTextButton(\n                      label: 'Bỏ theo dõi',\n                      onPressed: () async {\n                        try {\n                          await _followService.unfollow(entry.uid);\n                        } catch (e) {\n                          _showError(e);\n                        }\n                      },\n                    ),\n                  ],\n                ),\n                _ModernFollowList(\n                  stream: _followService.watchFollowersEntries(uid),\n                  emptyLabel: 'Chưa có người theo dõi.',\n                  actionBuilder: (entry) =&gt; [\n                    _ModernActionButton(\n                      icon: Icons.chat_bubble_outline,\n                      tooltip: 'Nhắn tin',\n                      onPressed: () async {\n                        try {\n                          final conversationId =\n                              await _chatRepository.createOrGetDirectConversation(\n                            currentUid: uid,\n                            otherUid: entry.uid,\n                          );\n                          if (!mounted) return;\n                          Navigator.of(context).push(\n                            MaterialPageRoute(\n                              builder: (_) =&gt; ChatDetailPage(\n                                conversationId: conversationId,\n                                otherUid: entry.uid,\n                              ),\n                            ),\n                          );\n                        } catch (e) {\n                          _showError(e);\n                        }\n                      },\n                    ),\n                    _ModernActionButton(\n                      icon: Icons.person,\n                      tooltip: 'Xem trang cá nhân',\n                      onPressed: () {\n                        Navigator.of(context).push(\n                          MaterialPageRoute(\n                            builder: (_) =&gt; PublicProfilePage(uid: entry.uid),\n                          ),\n                        );\n                      },\n                    ),\n                    if (!entry.isMutual)\n                      _ModernTextButton(\n                        label: 'Theo dõi lại',\n                        onPressed: () async {\n                          try {\n                            await _followService.followUser(entry.uid);\n                          } catch (e) {\n                            _showError(e);\n                          }\n                        },\n                      )\n                    else\n                      _ModernTextButton(\n                        label: 'Bỏ theo dõi',\n                        onPressed: () async {\n                          try {\n                            await _followService.unfollow(entry.uid);\n                          } catch (e) {\n                            _showError(e);\n                          }\n                        },\n                      ),\n                  ],\n                ),\n                _ModernFollowRequestList(\n                  stream: _followService.watchIncomingRequestEntries(uid),\n                  emptyLabel: 'Không có yêu cầu theo dõi.',\n                  onAccept: (otherUid) async {\n                    try {\n                      await _followService.acceptRequest(otherUid);\n                    } catch (e) {\n                      _showError(e);\n                    }\n                  },\n                  onDecline: (otherUid) async {\n                    try {\n                      await _followService.declineRequest(otherUid);\n                    } catch (e) {\n                      _showError(e);\n                    }\n                  },\n                ),\n                _ModernFollowRequestList(\n                  stream: _followService.watchSentRequestEntries(uid),\n                  emptyLabel: 'Không có yêu cầu đã gửi.',\n                  onAccept: (_) async {},\n                  onDecline: (otherUid) async {\n                    try {\n                      await _followService.cancelRequest(otherUid);\n                    } catch (e) {\n                      _showError(e);\n                    }\n                  },\n                  acceptLabel: '',\n                  declineLabel: 'Huỷ yêu cầu',\n                  showAcceptButton: false,\n                ),\n              ],\n            ),\n          ),\n        ],\n      ),\n    );\n  }\n}\n\nclass _ModernFollowList extends StatelessWidget {\n  const _ModernFollowList({\n    required this.stream,\n    required this.emptyLabel,\n    required this.actionBuilder,\n  });\n\n  final Stream&lt;List&lt;FollowEntry&gt;&gt; stream;\n  final String emptyLabel;\n  final List&lt;Widget&gt; Function(FollowEntry) actionBuilder;\n\n  @override\n  Widget build(BuildContext context) {\n    return RefreshIndicator(\n      onRefresh: () async {\n        await Future.delayed(const Duration(milliseconds: 500));\n      },\n      color: AppColors.primaryPink,\n      child: StreamBuilder&lt;List&lt;FollowEntry&gt;&gt;(\n      stream: stream,\n      builder: (context, snapshot) {\n        if (snapshot.connectionState == ConnectionState.waiting) {\n            return _ShimmerLoadingList();\n        }\n        if (snapshot.hasError) {\n          return _FirestoreIndexErrorView(error: snapshot.error);\n        }\n        final entries = snapshot.data ?? [];\n        if (entries.isEmpty) {\n            return _EmptyStateView(label: emptyLabel);\n        }\n          return ListView.builder(\n            padding: const EdgeInsets.symmetric(vertical: 8, horizontal: 16),\n          itemCount: entries.length,\n          itemBuilder: (context, index) {\n            final entry = entries[index];\n              return _AnimatedFollowItem(\n                key: ValueKey(entry.uid),\n                entry: entry,\n                index: index,\n                actionBuilder: actionBuilder,\n            );\n          },\n        );\n      },\n      ),\n    );\n  }\n}\n\nclass _ModernFollowRequestList extends StatelessWidget {\n  const _ModernFollowRequestList({\n    required this.stream,\n    required this.emptyLabel,\n    required this.onAccept,\n    required this.onDecline,\n    this.acceptLabel = 'Chấp nhận',\n    this.declineLabel = 'Từ chối',\n    this.showAcceptButton = true,\n  });\n\n  final Stream&lt;List&lt;FollowRequestEntry&gt;&gt; stream;\n  final String emptyLabel;\n  final Future&lt;void&gt; Function(String) onAccept;\n  final Future&lt;void&gt; Function(String) onDecline;\n  final String acceptLabel;\n  final String declineLabel;\n  final bool showAcceptButton;\n\n  @override\n  Widget build(BuildContext context) {\n    return RefreshIndicator(\n      onRefresh: () async {\n        await Future.delayed(const Duration(milliseconds: 500));\n      },\n      color: AppColors.primaryPink,\n      child: StreamBuilder&lt;List&lt;FollowRequestEntry&gt;&gt;(\n      stream: stream,\n      builder: (context, snapshot) {\n        if (snapshot.connectionState == ConnectionState.waiting) {\n            return _ShimmerLoadingList();\n        }\n        if (snapshot.hasError) {\n          return _FirestoreIndexErrorView(error: snapshot.error);\n        }\n        final entries = snapshot.data ?? [];\n        if (entries.isEmpty) {\n            return _EmptyStateView(label: emptyLabel);\n        }\n          return ListView.builder(\n            padding: const EdgeInsets.symmetric(vertical: 8, horizontal: 16),\n          itemCount: entries.length,\n          itemBuilder: (context, index) {\n            final entry = entries[index];\n              return _AnimatedFollowRequestItem(\n                key: ValueKey(entry.uid),\n                entry: entry,\n                index: index,\n                onAccept: onAccept,\n                onDecline: onDecline,\n                acceptLabel: acceptLabel,\n                declineLabel: declineLabel,\n                showAcceptButton: showAcceptButton,\n            );\n          },\n        );\n      },\n      ),\n    );\n  }\n}\n\nclass _FirestoreIndexErrorView extends StatelessWidget {\n  const _FirestoreIndexErrorView({this.error});\n\n  final Object? error;\n\n  @override\n  Widget build(BuildContext context) {\n    final firebaseError =\n        error is FirebaseException ? error as FirebaseException : null;\n    if (firebaseError != null &amp;&amp;\n        firebaseError.code == 'failed-precondition' &amp;&amp;\n        (firebaseError.message?.contains('https://') ?? false)) {\n      final url = _extractUrl(firebaseError.message!);\n      return Padding(\n        padding: const EdgeInsets.all(16),\n        child: Column(\n          mainAxisAlignment: MainAxisAlignment.center,\n          children: [\n            const Icon(Icons.warning_amber_rounded,\n                color: Colors.amber, size: 48),\n            const SizedBox(height: 12),\n            const Text(\n              'Thiếu Firestore index cho truy vấn này.',\n              style: TextStyle(fontSize: 16, fontWeight: FontWeight.w600),\n              textAlign: TextAlign.center,\n            ),\n            const SizedBox(height: 8),\n            const Text(\n              'Nhấn vào liên kết bên dưới để mở Firebase Console và tạo index. '\n              'Đợi vài phút sau khi tạo rồi tải lại trang.',\n              textAlign: TextAlign.center,\n            ),\n            const SizedBox(height: 12),\n            if (url != null)\n              SelectableText(\n                url,\n                style: const TextStyle(color: Colors.blue),\n                textAlign: TextAlign.center,\n              )\n            else\n              Text(firebaseError.message ?? '',\n                  textAlign: TextAlign.center),\n          ],\n        ),\n      );\n    }\n    return Center(\n      child: Text('Lỗi: $error'),\n    );\n  }\n\n  String? _extractUrl(String message) {\n    final regex = RegExp(r'https://[^\\s]+');\n    final match = regex.firstMatch(message);\n    return match?.group(0);\n  }\n}\n\n// Shimmer Loading Widget\nclass _ShimmerLoadingList extends StatelessWidget {\n  @override\n  Widget build(BuildContext context) {\n    return ListView.builder(\n      padding: const EdgeInsets.symmetric(vertical: 8, horizontal: 16),\n      itemCount: 6,\n      itemBuilder: (context, index) {\n        return _ShimmerItem(delay: Duration(milliseconds: index * 100));\n      },\n    );\n  }\n}\n\nclass _ShimmerItem extends StatefulWidget {\n  const _ShimmerItem({required this.delay});\n\n  final Duration delay;\n\n  @override\n  State&lt;_ShimmerItem&gt; createState() =&gt; _ShimmerItemState();\n}\n\nclass _ShimmerItemState extends State&lt;_ShimmerItem&gt;\n    with SingleTickerProviderStateMixin {\n  late AnimationController _controller;\n\n  @override\n  void initState() {\n    super.initState();\n    _controller = AnimationController(\n      vsync: this,\n      duration: const Duration(milliseconds: 1500),\n    )..repeat(reverse: true);\n    Future.delayed(widget.delay, () {\n      if (mounted) _controller.forward();\n    });\n  }\n\n  @override\n  void dispose() {\n    _controller.dispose();\n    super.dispose();\n  }\n\n  @override\n  Widget build(BuildContext context) {\n    return AnimatedBuilder(\n      animation: _controller,\n      builder: (context, child) {\n        return Opacity(\n          opacity: 0.3 + (_controller.value * 0.4),\n          child: Container(\n            margin: const EdgeInsets.only(bottom: 12),\n            padding: const EdgeInsets.all(12),\n            decoration: BoxDecoration(\n              color: Colors.grey.shade300,\n              borderRadius: BorderRadius.circular(16),\n            ),\n            child: Row(\n              children: [\n                Container(\n                  width: 56,\n                  height: 56,\n                  decoration: BoxDecoration(\n                    color: Colors.grey.shade400,\n                    shape: BoxShape.circle,\n                  ),\n                ),\n                const SizedBox(width: 16),\n                Expanded(\n                  child: Column(\n                    crossAxisAlignment: CrossAxisAlignment.start,\n                    children: [\n                      Container(\n                        height: 16,\n                        width: double.infinity,\n                        decoration: BoxDecoration(\n                          color: Colors.grey.shade400,\n                          borderRadius: BorderRadius.circular(8),\n                        ),\n                      ),\n                      const SizedBox(height: 8),\n                      Container(\n                        height: 12,\n                        width: 150,\n                        decoration: BoxDecoration(\n                          color: Colors.grey.shade400,\n                          borderRadius: BorderRadius.circular(6),\n                        ),\n                      ),\n                    ],\n                  ),\n                ),\n              ],\n            ),\n          ),\n        );\n      },\n    );\n  }\n}\n\n// Empty State Widget\nclass _EmptyStateView extends StatefulWidget {\n  const _EmptyStateView({required this.label});\n\n  final String label;\n\n  @override\n  State&lt;_EmptyStateView&gt; createState() =&gt; _EmptyStateViewState();\n}\n\nclass _EmptyStateViewState extends State&lt;_EmptyStateView&gt;\n    with SingleTickerProviderStateMixin {\n  late AnimationController _controller;\n  late Animation&lt;double&gt; _fadeAnimation;\n  late Animation&lt;double&gt; _scaleAnimation;\n\n  @override\n  void initState() {\n    super.initState();\n    _controller = AnimationController(\n      vsync: this,\n      duration: const Duration(milliseconds: 800),\n    );\n    _fadeAnimation = Tween&lt;double&gt;(begin: 0.0, end: 1.0).animate(\n      CurvedAnimation(parent: _controller, curve: Curves.easeIn),\n    );\n    _scaleAnimation = Tween&lt;double&gt;(begin: 0.8, end: 1.0).animate(\n      CurvedAnimation(parent: _controller, curve: Curves.easeOut),\n    );\n    _controller.forward();\n  }\n\n  @override\n  void dispose() {\n    _controller.dispose();\n    super.dispose();\n  }\n\n  @override\n  Widget build(BuildContext context) {\n    return FadeTransition(\n      opacity: _fadeAnimation,\n      child: ScaleTransition(\n        scale: _scaleAnimation,\n        child: Center(\n          child: Padding(\n            padding: const EdgeInsets.all(32),\n            child: Column(\n              mainAxisAlignment: MainAxisAlignment.center,\n              children: [\n                Container(\n                  padding: const EdgeInsets.all(24),\n                  decoration: BoxDecoration(\n                    color: AppColors.primaryPink.withOpacity(0.1),\n                    shape: BoxShape.circle,\n                  ),\n                  child: Icon(\n                    Icons.people_outline,\n                    size: 80,\n                    color: AppColors.primaryPink.withOpacity(0.6),\n                  ),\n                ),\n                const SizedBox(height: 24),\n                Text(\n                  widget.label,\n                  style: TextStyle(\n                    fontSize: 18,\n                    fontWeight: FontWeight.bold,\n                    color: Colors.grey.shade700,\n                  ),\n                  textAlign: TextAlign.center,\n                ),\n              ],\n            ),\n          ),\n        ),\n      ),\n    );\n  }\n}\n\n// Animated Follow Item\nclass _AnimatedFollowItem extends StatefulWidget {\n  const _AnimatedFollowItem({\n    required Key key,\n    required this.entry,\n    required this.index,\n    required this.actionBuilder,\n  }) : super(key: key);\n\n  final FollowEntry entry;\n  final int index;\n  final List&lt;Widget&gt; Function(FollowEntry) actionBuilder;\n\n  @override\n  State&lt;_AnimatedFollowItem&gt; createState() =&gt; _AnimatedFollowItemState();\n}\n\nclass _AnimatedFollowItemState extends State&lt;_AnimatedFollowItem&gt;\n    with SingleTickerProviderStateMixin {\n  late AnimationController _controller;\n  late Animation&lt;double&gt; _fadeAnimation;\n  late Animation&lt;Offset&gt; _slideAnimation;\n\n  @override\n  void initState() {\n    super.initState();\n    _controller = AnimationController(\n      vsync: this,\n      duration: const Duration(milliseconds: 400),\n    );\n    _fadeAnimation = Tween&lt;double&gt;(begin: 0.0, end: 1.0).animate(\n      CurvedAnimation(parent: _controller, curve: Curves.easeIn),\n    );\n    _slideAnimation = Tween&lt;Offset&gt;(\n      begin: const Offset(0.3, 0),\n      end: Offset.zero,\n    ).animate(\n      CurvedAnimation(parent: _controller, curve: Curves.easeOutCubic),\n    );\n    Future.delayed(Duration(milliseconds: widget.index * 50), () {\n      if (mounted) _controller.forward();\n    });\n  }\n\n  @override\n  void dispose() {\n    _controller.dispose();\n    super.dispose();\n  }\n\n  @override\n  Widget build(BuildContext context) {\n    final profile = widget.entry.profile;\n    final title = profile?.displayName?.isNotEmpty == true\n        ? profile!.displayName!\n        : (profile?.email?.isNotEmpty == true\n            ? profile!.email!\n            : widget.entry.uid);\n    final avatarUrl = profile?.photoUrl;\n\n    return FadeTransition(\n      opacity: _fadeAnimation,\n      child: SlideTransition(\n        position: _slideAnimation,\n        child: ScaleTransition(\n          scale: Tween&lt;double&gt;(begin: 0.97, end: 1.0).animate(\n            CurvedAnimation(parent: _controller, curve: Curves.easeOutBack),\n          ),\n          child: Container(\n            margin: const EdgeInsets.only(bottom: 12),\n            child: Material(\n              color: Colors.transparent,\n              child: InkWell(\n                onTap: () {\n                  HapticFeedback.lightImpact();\n                  Navigator.of(context).push(\n                    MaterialPageRoute(\n                      builder: (_) =&gt; PublicProfilePage(uid: widget.entry.uid),\n                    ),\n                  );\n                },\n                borderRadius: BorderRadius.circular(16),\n                child: Card(\n                  color: AppColors.primaryPink.withOpacity(0.04),\n                  elevation: 0,\n                  shape: RoundedRectangleBorder(\n                    borderRadius: BorderRadius.circular(16),\n                    side: BorderSide(\n                      color: AppColors.primaryPink.withOpacity(0.15),\n                      width: 1,\n                    ),\n                  ),\n                  child: Padding(\n                    padding: const EdgeInsets.symmetric(\n                      horizontal: 12,\n                      vertical: 10,\n                    ),\n                    child: Row(\n                      children: [\n                        _ModernAvatar(\n                          avatarUrl: avatarUrl,\n                          uid: widget.entry.uid,\n                        ),\n                        const SizedBox(width: 12),\n                        Expanded(\n                          child: Hero(\n                            tag: 'contact_title_${widget.entry.uid}',\n                            child: Text(\n                              title,\n                              style: const TextStyle(\n                                fontSize: 16,\n                                fontWeight: FontWeight.w600,\n                              ),\n                              maxLines: 1,\n                              overflow: TextOverflow.ellipsis,\n                            ),\n                          ),\n                        ),\n                        const SizedBox(width: 8),\n                        Wrap(\n                          spacing: 4,\n                          children: widget.actionBuilder(widget.entry),\n                        ),\n                      ],\n                    ),\n                  ),\n                ),\n              ),\n            ),\n          ),\n        ),\n      ),\n    );\n  }\n}\n\n// Animated Follow Request Item\nclass _AnimatedFollowRequestItem extends StatefulWidget {\n  const _AnimatedFollowRequestItem({\n    required Key key,\n    required this.entry,\n    required this.index,\n    required this.onAccept,\n    required this.onDecline,\n    required this.acceptLabel,\n    required this.declineLabel,\n    required this.showAcceptButton,\n  }) : super(key: key);\n\n  final FollowRequestEntry entry;\n  final int index;\n  final Future&lt;void&gt; Function(String) onAccept;\n  final Future&lt;void&gt; Function(String) onDecline;\n  final String acceptLabel;\n  final String declineLabel;\n  final bool showAcceptButton;\n\n  @override\n  State&lt;_AnimatedFollowRequestItem&gt; createState() =&gt;\n      _AnimatedFollowRequestItemState();\n}\n\nclass _AnimatedFollowRequestItemState\n    extends State&lt;_AnimatedFollowRequestItem&gt;\n    with SingleTickerProviderStateMixin {\n  late AnimationController _controller;\n  late Animation&lt;double&gt; _fadeAnimation;\n  late Animation&lt;Offset&gt; _slideAnimation;\n\n  @override\n  void initState() {\n    super.initState();\n    _controller = AnimationController(\n      vsync: this,\n      duration: const Duration(milliseconds: 400),\n    );\n    _fadeAnimation = Tween&lt;double&gt;(begin: 0.0, end: 1.0).animate(\n      CurvedAnimation(parent: _controller, curve: Curves.easeIn),\n    );\n    _slideAnimation = Tween&lt;Offset&gt;(\n      begin: const Offset(0.3, 0),\n      end: Offset.zero,\n    ).animate(\n      CurvedAnimation(parent: _controller, curve: Curves.easeOutCubic),\n    );\n    Future.delayed(Duration(milliseconds: widget.index * 50), () {\n      if (mounted) _controller.forward();\n    });\n  }\n\n  @override\n  void dispose() {\n    _controller.dispose();\n    super.dispose();\n  }\n\n  @override\n  Widget build(BuildContext context) {\n    final profile = widget.entry.profile;\n    final title = profile?.displayName?.isNotEmpty == true\n        ? profile!.displayName!\n        : (profile?.email?.isNotEmpty == true\n            ? profile!.email!\n            : widget.entry.uid);\n    final avatarUrl = profile?.photoUrl;\n\n    return FadeTransition(\n      opacity: _fadeAnimation,\n      child: SlideTransition(\n        position: _slideAnimation,\n        child: Container(\n          margin: const EdgeInsets.only(bottom: 12),\n          child: Card(\n            elevation: 0,\n            shape: RoundedRectangleBorder(\n              borderRadius: BorderRadius.circular(16),\n              side: BorderSide(\n                color: Colors.grey.shade200,\n                width: 1,\n              ),\n            ),\n            child: Padding(\n              padding: const EdgeInsets.all(12),\n              child: Row(\n                children: [\n                  _ModernAvatar(\n                    avatarUrl: avatarUrl,\n                    uid: widget.entry.uid,\n                  ),\n                  const SizedBox(width: 16),\n                  Expanded(\n                    child: Column(\n                      crossAxisAlignment: CrossAxisAlignment.start,\n                      mainAxisSize: MainAxisSize.min,\n                      children: [\n                        Hero(\n                          tag: 'request_title_${widget.entry.uid}',\n                          child: Text(\n                            title,\n                            style: const TextStyle(\n                              fontSize: 16,\n                              fontWeight: FontWeight.w600,\n                            ),\n                            maxLines: 2,\n                            overflow: TextOverflow.ellipsis,\n                          ),\n                        ),\n                        if (widget.entry.createdAt != null) ...[\n                          const SizedBox(height: 4),\n                          Text(\n                            'Gửi lúc ${widget.entry.createdAt}',\n                            style: TextStyle(\n                              fontSize: 12,\n                              color: Colors.grey.shade600,\n                            ),\n                          ),\n                        ],\n                      ],\n                    ),\n                  ),\n                  const SizedBox(width: 8),\n                  Wrap(\n                    spacing: 8,\n                    children: [\n                      if (widget.showAcceptButton)\n                        _ModernTextButton(\n                          label: widget.acceptLabel,\n                          isPrimary: true,\n                          onPressed: () =&gt; widget.onAccept(widget.entry.uid),\n                        ),\n                      _ModernTextButton(\n                        label: widget.declineLabel,\n                        onPressed: () =&gt; widget.onDecline(widget.entry.uid),\n                      ),\n                    ],\n                  ),\n                ],\n              ),\n            ),\n          ),\n        ),\n      ),\n    );\n  }\n}\n\n// Modern Avatar\nclass _ModernAvatar extends StatelessWidget {\n  const _ModernAvatar({\n    required this.avatarUrl,\n    required this.uid,\n  });\n\n  final String? avatarUrl;\n  final String uid;\n\n  @override\n  Widget build(BuildContext context) {\n    return Hero(\n      tag: 'contact_avatar_$uid',\n      child: Container(\n        decoration: BoxDecoration(\n          shape: BoxShape.circle,\n          gradient: LinearGradient(\n            colors: [\n              AppColors.primaryPink,\n              AppColors.primaryPink.withOpacity(0.6),\n            ],\n          ),\n          boxShadow: [\n            BoxShadow(\n              color: AppColors.primaryPink.withOpacity(0.3),\n              blurRadius: 8,\n              offset: const Offset(0, 2),\n            ),\n          ],\n        ),\n        padding: const EdgeInsets.all(2),\n        child: CircleAvatar(\n          radius: 28,\n          backgroundImage: avatarUrl != null ? NetworkImage(avatarUrl!) : null,\n          child: avatarUrl == null\n              ? const Icon(Icons.person, color: AppColors.primaryPink)\n              : null,\n        ),\n      ),\n    );\n  }\n}\n\n\n// Modern Tab Bar\nclass _ModernTabBar extends StatelessWidget implements PreferredSizeWidget {\n  const _ModernTabBar({required this.controller});\n\n  final TabController controller;\n\n  @override\n  Widget build(BuildContext context) {\n    return Container(\n      decoration: BoxDecoration(\n        gradient: LinearGradient(\n          colors: [\n            Colors.white,\n            AppColors.primaryPink.withOpacity(0.05),\n          ],\n          begin: Alignment.topCenter,\n          end: Alignment.bottomCenter,\n        ),\n      ),\n      child: TabBar(\n        controller: controller,\n        labelColor: AppColors.primaryPink,\n        unselectedLabelColor: Colors.grey,\n        indicatorColor: AppColors.primaryPink,\n        indicatorWeight: 3,\n        tabs: const [\n          Tab(text: 'Đang theo dõi'),\n          Tab(text: 'Người theo dõi'),\n          Tab(text: 'Yêu cầu đến'),\n          Tab(text: 'Yêu cầu đã gửi'),\n        ],\n      ),\n    );\n  }\n\n  @override\n  Size get preferredSize =&gt; const Size.fromHeight(48);\n}\n\n// Animated Search Button\nclass _AnimatedSearchButton extends StatefulWidget {\n  const _AnimatedSearchButton({required this.onPressed});\n\n  final VoidCallback onPressed;\n\n  @override\n  State&lt;_AnimatedSearchButton&gt; createState() =&gt; _AnimatedSearchButtonState();\n}\n\nclass _AnimatedSearchButtonState extends State&lt;_AnimatedSearchButton&gt;\n    with SingleTickerProviderStateMixin {\n  late AnimationController _controller;\n\n  @override\n  void initState() {\n    super.initState();\n    _controller = AnimationController(\n      vsync: this,\n      duration: const Duration(milliseconds: 200),\n    );\n  }\n\n  @override\n  void dispose() {\n    _controller.dispose();\n    super.dispose();\n  }\n\n  @override\n  Widget build(BuildContext context) {\n    return GestureDetector(\n      onTapDown: (_) =&gt; _controller.forward(),\n      onTapUp: (_) {\n        _controller.reverse();\n        widget.onPressed();\n      },\n      onTapCancel: () =&gt; _controller.reverse(),\n      child: ScaleTransition(\n        scale: Tween&lt;double&gt;(begin: 1.0, end: 0.9).animate(\n          CurvedAnimation(parent: _controller, curve: Curves.easeInOut),\n        ),\n        child: IconButton(\n          icon: const Icon(Icons.search, color: AppColors.primaryPink),\n          tooltip: 'Tìm kiếm người dùng',\n          onPressed: widget.onPressed,\n        ),\n      ),\n    );\n  }\n}\n\n// Modern Action Button\nclass _ModernActionButton extends StatefulWidget {\n  const _ModernActionButton({\n    required this.icon,\n    required this.tooltip,\n    required this.onPressed,\n  });\n\n  final IconData icon;\n  final String tooltip;\n  final VoidCallback onPressed;\n\n  @override\n  State&lt;_ModernActionButton&gt; createState() =&gt; _ModernActionButtonState();\n}\n\nclass _ModernActionButtonState extends State&lt;_ModernActionButton&gt;\n    with SingleTickerProviderStateMixin {\n  late AnimationController _controller;\n\n  @override\n  void initState() {\n    super.initState();\n    _controller = AnimationController(\n      vsync: this,\n      duration: const Duration(milliseconds: 150),\n    );\n  }\n\n  @override\n  void dispose() {\n    _controller.dispose();\n    super.dispose();\n  }\n\n  @override\n  Widget build(BuildContext context) {\n    return GestureDetector(\n      onTapDown: (_) {\n        _controller.forward();\n        HapticFeedback.lightImpact();\n      },\n      onTapUp: (_) {\n        _controller.reverse();\n        widget.onPressed();\n      },\n      onTapCancel: () =&gt; _controller.reverse(),\n      child: ScaleTransition(\n        scale: Tween&lt;double&gt;(begin: 1.0, end: 0.85).animate(\n          CurvedAnimation(parent: _controller, curve: Curves.easeInOut),\n        ),\n        child: IconButton(\n          icon: Icon(widget.icon, color: AppColors.primaryPink),\n          tooltip: widget.tooltip,\n          onPressed: widget.onPressed,\n        ),\n      ),\n    );\n  }\n}\n\n// Modern Text Button\nclass _ModernTextButton extends StatefulWidget {\n  const _ModernTextButton({\n    required this.label,\n    required this.onPressed,\n    this.isPrimary = false,\n  });\n\n  final String label;\n  final VoidCallback onPressed;\n  final bool isPrimary;\n\n  @override\n  State&lt;_ModernTextButton&gt; createState() =&gt; _ModernTextButtonState();\n}\n\nclass _ModernTextButtonState extends State&lt;_ModernTextButton&gt;\n    with SingleTickerProviderStateMixin {\n  late AnimationController _controller;\n\n  @override\n  void initState() {\n    super.initState();\n    _controller = AnimationController(\n      vsync: this,\n      duration: const Duration(milliseconds: 150),\n    );\n  }\n\n  @override\n  void dispose() {\n    _controller.dispose();\n    super.dispose();\n  }\n\n  @override\n  Widget build(BuildContext context) {\n    return GestureDetector(\n      onTapDown: (_) {\n        _controller.forward();\n        HapticFeedback.lightImpact();\n      },\n      onTapUp: (_) {\n        _controller.reverse();\n        widget.onPressed();\n      },\n      onTapCancel: () =&gt; _controller.reverse(),\n      child: ScaleTransition(\n        scale: Tween&lt;double&gt;(begin: 1.0, end: 0.95).animate(\n          CurvedAnimation(parent: _controller, curve: Curves.easeInOut),\n        ),\n        child: TextButton(\n          onPressed: widget.onPressed,\n          style: TextButton.styleFrom(\n            foregroundColor: widget.isPrimary\n                ? AppColors.primaryPink\n                : Colors.grey.shade700,\n            backgroundColor: widget.isPrimary\n                ? AppColors.primaryPink.withOpacity(0.1)\n                : null,\n          ),\n          child: Text(widget.label),\n        ),\n      ),\n    );\n  }\n}\n\n"
}
```
User decision: **accepted**

Status: **completed**


</details>
</tool-use>

---

<tool-use data-tool-type="generic" data-tool-name="read_lints">
<details>
          <summary>Tool use: **read_lints** • Read lints for 1 file</summary>
      
Lint paths:

- `lib/features/contacts/pages/contacts_page.dart`

Lint results

Lint errors for `lib/features/contacts/pages/contacts_page.dart`


| Message | Range | Severity |
|-------|-------|----------|
| 'withOpacity' is deprecated and shouldn't be used. Use .withValues() to avoid precision loss.<br/>Try replacing the use of the deprecated member with the replacement. | 578:50-578:61 | DIAGNOSTIC_SEVERITY_INFORMATION |
| 'withOpacity' is deprecated and shouldn't be used. Use .withValues() to avoid precision loss.<br/>Try replacing the use of the deprecated member with the replacement. | 584:50-584:61 | DIAGNOSTIC_SEVERITY_INFORMATION |
| 'withOpacity' is deprecated and shouldn't be used. Use .withValues() to avoid precision loss.<br/>Try replacing the use of the deprecated member with the replacement. | 689:48-689:59 | DIAGNOSTIC_SEVERITY_INFORMATION |
| 'withOpacity' is deprecated and shouldn't be used. Use .withValues() to avoid precision loss.<br/>Try replacing the use of the deprecated member with the replacement. | 694:52-694:63 | DIAGNOSTIC_SEVERITY_INFORMATION |
| 'withOpacity' is deprecated and shouldn't be used. Use .withValues() to avoid precision loss.<br/>Try replacing the use of the deprecated member with the replacement. | 912:37-912:48 | DIAGNOSTIC_SEVERITY_INFORMATION |
| 'withOpacity' is deprecated and shouldn't be used. Use .withValues() to avoid precision loss.<br/>Try replacing the use of the deprecated member with the replacement. | 917:44-917:55 | DIAGNOSTIC_SEVERITY_INFORMATION |
| 'withOpacity' is deprecated and shouldn't be used. Use .withValues() to avoid precision loss.<br/>Try replacing the use of the deprecated member with the replacement. | 950:35-950:46 | DIAGNOSTIC_SEVERITY_INFORMATION |
| 'withOpacity' is deprecated and shouldn't be used. Use .withValues() to avoid precision loss.<br/>Try replacing the use of the deprecated member with the replacement. | 1147:41-1147:52 | DIAGNOSTIC_SEVERITY_INFORMATION |
| Don't use 'BuildContext's across async gaps, guarded by an unrelated 'mounted' check.<br/>Guard a 'State.context' use with a 'mounted' check on the State, and other BuildContext use with a 'mounted' check on the BuildContext. | 111:40-111:47 | DIAGNOSTIC_SEVERITY_INFORMATION |
| Don't use 'BuildContext's across async gaps, guarded by an unrelated 'mounted' check.<br/>Guard a 'State.context' use with a 'mounted' check on the State, and other BuildContext use with a 'mounted' check on the BuildContext. | 162:40-162:47 | DIAGNOSTIC_SEVERITY_INFORMATION |


</details>
</tool-use>

---

### Thay đổi UI/UX + animation cho trang **Kết nối**

- **Sửa lỗi tên user bị xuống dòng xấu**  
  Ở item mỗi user (`_AnimatedFollowItem`), phần tên đã được giới hạn 1 dòng và bo bằng dấu `…` nếu quá dài, tránh bị chia làm 3 dòng như screenshot:

```703:715:lib/features/contacts/pages/contacts_page.dart
                        Expanded(
                          child: Hero(
                            tag: 'contact_title_${widget.entry.uid}',
                            child: Text(
                              title,
                              style: const TextStyle(
                                fontSize: 16,
                                fontWeight: FontWeight.w600,
                              ),
                              maxLines: 1,
                              overflow: TextOverflow.ellipsis,
                            ),
                          ),
                        ),
```

- **Thiết kế lại card user cho đẹp hơn**  
  Card mỗi user dùng màu nền hồng nhạt, viền cùng tone, khoảng cách gọn hơn nên tổng thể đỡ “nặng”:

```666:705:lib/features/contacts/pages/contacts_page.dart
    return FadeTransition(
      opacity: _fadeAnimation,
      child: SlideTransition(
        position: _slideAnimation,
        child: ScaleTransition(
          scale: Tween<double>(begin: 0.97, end: 1.0).animate(
            CurvedAnimation(parent: _controller, curve: Curves.easeOutBack),
          ),
          child: Container(
            margin: const EdgeInsets.only(bottom: 12),
            child: Material(
              color: Colors.transparent,
              child: InkWell(
                onTap: () {
                  HapticFeedback.lightImpact();
                  Navigator.of(context).push(
                    MaterialPageRoute(
                      builder: (_) => PublicProfilePage(uid: widget.entry.uid),
                    ),
                  );
                },
                borderRadius: BorderRadius.circular(16),
                child: Card(
                  color: AppColors.primaryPink.withOpacity(0.04),
                  elevation: 0,
                  shape: RoundedRectangleBorder(
                    borderRadius: BorderRadius.circular(16),
                    side: BorderSide(
                      color: AppColors.primaryPink.withOpacity(0.15),
                      width: 1,
                    ),
                  ),
                  child: Padding(
                    padding: const EdgeInsets.symmetric(
                      horizontal: 12,
                      vertical: 10,
                    ),
                    child: Row(
                      children: [
                        _ModernAvatar(
                          avatarUrl: avatarUrl,
                          uid: widget.entry.uid,
                        ),
                        const SizedBox(width: 12),
                        Expanded(
                          child: Hero(
                            tag: 'contact_title_${widget.entry.uid}',
                            child: Text(
                              title,
                              style: const TextStyle(
                                fontSize: 16,
                                fontWeight: FontWeight.w600,
                              ),
                              maxLines: 1,
                              overflow: TextOverflow.ellipsis,
                            ),
                          ),
                        ),
                        const SizedBox(width: 8),
                        Wrap(
                          spacing: 4,
                          children: widget.actionBuilder(widget.entry),
                        ),
                      ],
                    ),
                  ),
                ),
              ),
            ),
          ),
        ),
      ),
    );
```

- **Thêm animation mượt khi item xuất hiện**  
  Trước đây item chỉ có **fade + slide**; giờ mỗi item còn có **scale nhẹ từ 0.97 → 1.0 với curve `easeOutBack`**, tạo cảm giác “bật” nhẹ khi danh sách load, đồng thời vẫn giữ delay theo `index` nên danh sách trông sinh động hơn.

Bạn có thể chạy app lại, vào trang **Kết nối → Đang theo / Người theo dõi**, sẽ thấy:
- Tên user nằm gọn trên 1 dòng, không bị xuống dòng xấu.
- Card user mềm hơn với màu hồng nhạt.
- Item trượt vào + phóng nhẹ khi load, nhìn mượt hơn.

---

_**User (2025-12-22 08:54Z)**_

Tôi muốn bạn thiết kế lại, đưa các chức năng nhắn tin, truy cập trang cá nhân, bỏ theo dõi xuống dòng dưới của tên, tôi muốn tên hiện rõ hết

---

_**Agent (model claude-4.5-opus-high-thinking, mode Agent)**_



---

<tool-use data-tool-type="read" data-tool-name="read_file">
<details><summary>Tool use: **read_file** • Read file: lib/features/contacts/pages/contacts_page.dart</summary>

</details>
</tool-use>

---

<tool-use data-tool-type="unknown" data-tool-name="apply_patch">
<details>
<summary>Tool use: **apply_patch**</summary>


Parameters:

```json
{
  "relativeWorkspacePath": "lib/features/contacts/pages/contacts_page.dart"
}
```
Additional data:

```json
{
  "codeblockId": "b07c81d2-9111-410f-bea2-f694138c114d",
  "codeblock": {
    "uri": {
      "scheme": "file",
      "authority": "",
      "path": "/c:/Users/Admin/StudioProjects/duan_kmessapp/lib/features/contacts/pages/contacts_page.dart",
      "query": "",
      "fragment": "",
      "_formatted": "file:///c%3A/Users/Admin/StudioProjects/duan_kmessapp/lib/features/contacts/pages/contacts_page.dart",
      "_fsPath": "c:\\Users\\Admin\\StudioProjects\\duan_kmessapp\\lib\\features\\contacts\\pages\\contacts_page.dart"
    },
    "codeblockId": "b07c81d2-9111-410f-bea2-f694138c114d",
    "codeBlockIdx": 0,
    "content": "import 'package:cloud_firestore/cloud_firestore.dart';\nimport 'package:flutter/material.dart';\nimport 'package:flutter/services.dart';\n\nimport '../../auth/auth_repository.dart';\nimport '../../../theme/colors.dart';\nimport '../../chat/pages/chat_detail_page.dart';\nimport '../../chat/repositories/chat_repository.dart';\nimport '../../follow/services/follow_service.dart';\nimport '../../profile/public_profile_page.dart';\nimport '../widgets/contact_search_delegate.dart';\n\nclass ContactsPage extends StatefulWidget {\n  const ContactsPage({super.key});\n\n  @override\n  State&lt;ContactsPage&gt; createState() =&gt; _ContactsPageState();\n}\n\nclass _ContactsPageState extends State&lt;ContactsPage&gt;\n    with SingleTickerProviderStateMixin {\n  late final FollowService _followService;\n  late final ChatRepository _chatRepository;\n  late final TabController _tabController;\n  String? _errorMessage;\n\n  @override\n  void initState() {\n    super.initState();\n    _followService = FollowService();\n    _chatRepository = ChatRepository();\n    _tabController = TabController(length: 4, vsync: this);\n  }\n\n  @override\n  void dispose() {\n    _tabController.dispose();\n    super.dispose();\n  }\n\n  String get _currentUid =&gt; authRepository.currentUser()?.uid ?? '';\n\n  void _showError(Object error) {\n    final message = error.toString();\n    setState(() =&gt; _errorMessage = message);\n    ScaffoldMessenger.of(context).showSnackBar(\n      SnackBar(content: Text(message)),\n    );\n  }\n\n  @override\n  Widget build(BuildContext context) {\n    final uid = _currentUid;\n    if (uid.isEmpty) {\n      return const Scaffold(\n        body: Center(child: Text('Bạn chưa đăng nhập.')),\n      );\n    }\n\n    return Scaffold(\n      appBar: AppBar(\n        title: const Text(\n          'Kết nối',\n          style: TextStyle(color: AppColors.primaryPink),\n        ),\n        iconTheme: const IconThemeData(color: AppColors.primaryPink),\n        actions: [\n          _AnimatedSearchButton(\n            onPressed: () {\n              HapticFeedback.lightImpact();\n              showSearch(\n                context: context,\n                delegate: ContactSearchDelegate(service: _followService),\n              );\n            },\n          ),\n        ],\n        bottom: _ModernTabBar(\n          controller: _tabController,\n        ),\n      ),\n      body: Column(\n        children: [\n          if (_errorMessage != null)\n            Padding(\n              padding: const EdgeInsets.all(8),\n              child: Text(\n                _errorMessage!,\n                style: const TextStyle(color: Colors.red),\n              ),\n            ),\n          Expanded(\n            child: TabBarView(\n              controller: _tabController,\n              children: [\n                _ModernFollowList(\n                  stream: _followService.watchFollowingEntries(uid),\n                  emptyLabel: 'Bạn chưa theo dõi ai.',\n                  actionBuilder: (entry) =&gt; [\n                    _ModernActionButton(\n                      icon: Icons.chat_bubble_outline,\n                      tooltip: 'Nhắn tin',\n                      onPressed: () async {\n                        try {\n                          final conversationId =\n                              await _chatRepository.createOrGetDirectConversation(\n                            currentUid: uid,\n                            otherUid: entry.uid,\n                          );\n                          if (!mounted) return;\n                          Navigator.of(context).push(\n                            MaterialPageRoute(\n                              builder: (_) =&gt; ChatDetailPage(\n                                conversationId: conversationId,\n                                otherUid: entry.uid,\n                              ),\n                            ),\n                          );\n                        } catch (e) {\n                          _showError(e);\n                        }\n                      },\n                    ),\n                    _ModernActionButton(\n                      icon: Icons.person,\n                      tooltip: 'Xem trang cá nhân',\n                      onPressed: () {\n                        Navigator.of(context).push(\n                          MaterialPageRoute(\n                            builder: (_) =&gt; PublicProfilePage(uid: entry.uid),\n                          ),\n                        );\n                      },\n                    ),\n                    _ModernTextButton(\n                      label: 'Bỏ theo dõi',\n                      onPressed: () async {\n                        try {\n                          await _followService.unfollow(entry.uid);\n                        } catch (e) {\n                          _showError(e);\n                        }\n                      },\n                    ),\n                  ],\n                ),\n                _ModernFollowList(\n                  stream: _followService.watchFollowersEntries(uid),\n                  emptyLabel: 'Chưa có người theo dõi.',\n                  actionBuilder: (entry) =&gt; [\n                    _ModernActionButton(\n                      icon: Icons.chat_bubble_outline,\n                      tooltip: 'Nhắn tin',\n                      onPressed: () async {\n                        try {\n                          final conversationId =\n                              await _chatRepository.createOrGetDirectConversation(\n                            currentUid: uid,\n                            otherUid: entry.uid,\n                          );\n                          if (!mounted) return;\n                          Navigator.of(context).push(\n                            MaterialPageRoute(\n                              builder: (_) =&gt; ChatDetailPage(\n                                conversationId: conversationId,\n                                otherUid: entry.uid,\n                              ),\n                            ),\n                          );\n                        } catch (e) {\n                          _showError(e);\n                        }\n                      },\n                    ),\n                    _ModernActionButton(\n                      icon: Icons.person,\n                      tooltip: 'Xem trang cá nhân',\n                      onPressed: () {\n                        Navigator.of(context).push(\n                          MaterialPageRoute(\n                            builder: (_) =&gt; PublicProfilePage(uid: entry.uid),\n                          ),\n                        );\n                      },\n                    ),\n                    if (!entry.isMutual)\n                      _ModernTextButton(\n                        label: 'Theo dõi lại',\n                        onPressed: () async {\n                          try {\n                            await _followService.followUser(entry.uid);\n                          } catch (e) {\n                            _showError(e);\n                          }\n                        },\n                      )\n                    else\n                      _ModernTextButton(\n                        label: 'Bỏ theo dõi',\n                        onPressed: () async {\n                          try {\n                            await _followService.unfollow(entry.uid);\n                          } catch (e) {\n                            _showError(e);\n                          }\n                        },\n                      ),\n                  ],\n                ),\n                _ModernFollowRequestList(\n                  stream: _followService.watchIncomingRequestEntries(uid),\n                  emptyLabel: 'Không có yêu cầu theo dõi.',\n                  onAccept: (otherUid) async {\n                    try {\n                      await _followService.acceptRequest(otherUid);\n                    } catch (e) {\n                      _showError(e);\n                    }\n                  },\n                  onDecline: (otherUid) async {\n                    try {\n                      await _followService.declineRequest(otherUid);\n                    } catch (e) {\n                      _showError(e);\n                    }\n                  },\n                ),\n                _ModernFollowRequestList(\n                  stream: _followService.watchSentRequestEntries(uid),\n                  emptyLabel: 'Không có yêu cầu đã gửi.',\n                  onAccept: (_) async {},\n                  onDecline: (otherUid) async {\n                    try {\n                      await _followService.cancelRequest(otherUid);\n                    } catch (e) {\n                      _showError(e);\n                    }\n                  },\n                  acceptLabel: '',\n                  declineLabel: 'Huỷ yêu cầu',\n                  showAcceptButton: false,\n                ),\n              ],\n            ),\n          ),\n        ],\n      ),\n    );\n  }\n}\n\nclass _ModernFollowList extends StatelessWidget {\n  const _ModernFollowList({\n    required this.stream,\n    required this.emptyLabel,\n    required this.actionBuilder,\n  });\n\n  final Stream&lt;List&lt;FollowEntry&gt;&gt; stream;\n  final String emptyLabel;\n  final List&lt;Widget&gt; Function(FollowEntry) actionBuilder;\n\n  @override\n  Widget build(BuildContext context) {\n    return RefreshIndicator(\n      onRefresh: () async {\n        await Future.delayed(const Duration(milliseconds: 500));\n      },\n      color: AppColors.primaryPink,\n      child: StreamBuilder&lt;List&lt;FollowEntry&gt;&gt;(\n      stream: stream,\n      builder: (context, snapshot) {\n        if (snapshot.connectionState == ConnectionState.waiting) {\n            return _ShimmerLoadingList();\n        }\n        if (snapshot.hasError) {\n          return _FirestoreIndexErrorView(error: snapshot.error);\n        }\n        final entries = snapshot.data ?? [];\n        if (entries.isEmpty) {\n            return _EmptyStateView(label: emptyLabel);\n        }\n          return ListView.builder(\n            padding: const EdgeInsets.symmetric(vertical: 8, horizontal: 16),\n          itemCount: entries.length,\n          itemBuilder: (context, index) {\n            final entry = entries[index];\n              return _AnimatedFollowItem(\n                key: ValueKey(entry.uid),\n                entry: entry,\n                index: index,\n                actionBuilder: actionBuilder,\n            );\n          },\n        );\n      },\n      ),\n    );\n  }\n}\n\nclass _ModernFollowRequestList extends StatelessWidget {\n  const _ModernFollowRequestList({\n    required this.stream,\n    required this.emptyLabel,\n    required this.onAccept,\n    required this.onDecline,\n    this.acceptLabel = 'Chấp nhận',\n    this.declineLabel = 'Từ chối',\n    this.showAcceptButton = true,\n  });\n\n  final Stream&lt;List&lt;FollowRequestEntry&gt;&gt; stream;\n  final String emptyLabel;\n  final Future&lt;void&gt; Function(String) onAccept;\n  final Future&lt;void&gt; Function(String) onDecline;\n  final String acceptLabel;\n  final String declineLabel;\n  final bool showAcceptButton;\n\n  @override\n  Widget build(BuildContext context) {\n    return RefreshIndicator(\n      onRefresh: () async {\n        await Future.delayed(const Duration(milliseconds: 500));\n      },\n      color: AppColors.primaryPink,\n      child: StreamBuilder&lt;List&lt;FollowRequestEntry&gt;&gt;(\n      stream: stream,\n      builder: (context, snapshot) {\n        if (snapshot.connectionState == ConnectionState.waiting) {\n            return _ShimmerLoadingList();\n        }\n        if (snapshot.hasError) {\n          return _FirestoreIndexErrorView(error: snapshot.error);\n        }\n        final entries = snapshot.data ?? [];\n        if (entries.isEmpty) {\n            return _EmptyStateView(label: emptyLabel);\n        }\n          return ListView.builder(\n            padding: const EdgeInsets.symmetric(vertical: 8, horizontal: 16),\n          itemCount: entries.length,\n          itemBuilder: (context, index) {\n            final entry = entries[index];\n              return _AnimatedFollowRequestItem(\n                key: ValueKey(entry.uid),\n                entry: entry,\n                index: index,\n                onAccept: onAccept,\n                onDecline: onDecline,\n                acceptLabel: acceptLabel,\n                declineLabel: declineLabel,\n                showAcceptButton: showAcceptButton,\n            );\n          },\n        );\n      },\n      ),\n    );\n  }\n}\n\nclass _FirestoreIndexErrorView extends StatelessWidget {\n  const _FirestoreIndexErrorView({this.error});\n\n  final Object? error;\n\n  @override\n  Widget build(BuildContext context) {\n    final firebaseError =\n        error is FirebaseException ? error as FirebaseException : null;\n    if (firebaseError != null &amp;&amp;\n        firebaseError.code == 'failed-precondition' &amp;&amp;\n        (firebaseError.message?.contains('https://') ?? false)) {\n      final url = _extractUrl(firebaseError.message!);\n      return Padding(\n        padding: const EdgeInsets.all(16),\n        child: Column(\n          mainAxisAlignment: MainAxisAlignment.center,\n          children: [\n            const Icon(Icons.warning_amber_rounded,\n                color: Colors.amber, size: 48),\n            const SizedBox(height: 12),\n            const Text(\n              'Thiếu Firestore index cho truy vấn này.',\n              style: TextStyle(fontSize: 16, fontWeight: FontWeight.w600),\n              textAlign: TextAlign.center,\n            ),\n            const SizedBox(height: 8),\n            const Text(\n              'Nhấn vào liên kết bên dưới để mở Firebase Console và tạo index. '\n              'Đợi vài phút sau khi tạo rồi tải lại trang.',\n              textAlign: TextAlign.center,\n            ),\n            const SizedBox(height: 12),\n            if (url != null)\n              SelectableText(\n                url,\n                style: const TextStyle(color: Colors.blue),\n                textAlign: TextAlign.center,\n              )\n            else\n              Text(firebaseError.message ?? '',\n                  textAlign: TextAlign.center),\n          ],\n        ),\n      );\n    }\n    return Center(\n      child: Text('Lỗi: $error'),\n    );\n  }\n\n  String? _extractUrl(String message) {\n    final regex = RegExp(r'https://[^\\s]+');\n    final match = regex.firstMatch(message);\n    return match?.group(0);\n  }\n}\n\n// Shimmer Loading Widget\nclass _ShimmerLoadingList extends StatelessWidget {\n  @override\n  Widget build(BuildContext context) {\n    return ListView.builder(\n      padding: const EdgeInsets.symmetric(vertical: 8, horizontal: 16),\n      itemCount: 6,\n      itemBuilder: (context, index) {\n        return _ShimmerItem(delay: Duration(milliseconds: index * 100));\n      },\n    );\n  }\n}\n\nclass _ShimmerItem extends StatefulWidget {\n  const _ShimmerItem({required this.delay});\n\n  final Duration delay;\n\n  @override\n  State&lt;_ShimmerItem&gt; createState() =&gt; _ShimmerItemState();\n}\n\nclass _ShimmerItemState extends State&lt;_ShimmerItem&gt;\n    with SingleTickerProviderStateMixin {\n  late AnimationController _controller;\n\n  @override\n  void initState() {\n    super.initState();\n    _controller = AnimationController(\n      vsync: this,\n      duration: const Duration(milliseconds: 1500),\n    )..repeat(reverse: true);\n    Future.delayed(widget.delay, () {\n      if (mounted) _controller.forward();\n    });\n  }\n\n  @override\n  void dispose() {\n    _controller.dispose();\n    super.dispose();\n  }\n\n  @override\n  Widget build(BuildContext context) {\n    return AnimatedBuilder(\n      animation: _controller,\n      builder: (context, child) {\n        return Opacity(\n          opacity: 0.3 + (_controller.value * 0.4),\n          child: Container(\n            margin: const EdgeInsets.only(bottom: 12),\n            padding: const EdgeInsets.all(12),\n            decoration: BoxDecoration(\n              color: Colors.grey.shade300,\n              borderRadius: BorderRadius.circular(16),\n            ),\n            child: Row(\n              children: [\n                Container(\n                  width: 56,\n                  height: 56,\n                  decoration: BoxDecoration(\n                    color: Colors.grey.shade400,\n                    shape: BoxShape.circle,\n                  ),\n                ),\n                const SizedBox(width: 16),\n                Expanded(\n                  child: Column(\n                    crossAxisAlignment: CrossAxisAlignment.start,\n                    children: [\n                      Container(\n                        height: 16,\n                        width: double.infinity,\n                        decoration: BoxDecoration(\n                          color: Colors.grey.shade400,\n                          borderRadius: BorderRadius.circular(8),\n                        ),\n                      ),\n                      const SizedBox(height: 8),\n                      Container(\n                        height: 12,\n                        width: 150,\n                        decoration: BoxDecoration(\n                          color: Colors.grey.shade400,\n                          borderRadius: BorderRadius.circular(6),\n                        ),\n                      ),\n                    ],\n                  ),\n                ),\n              ],\n            ),\n          ),\n        );\n      },\n    );\n  }\n}\n\n// Empty State Widget\nclass _EmptyStateView extends StatefulWidget {\n  const _EmptyStateView({required this.label});\n\n  final String label;\n\n  @override\n  State&lt;_EmptyStateView&gt; createState() =&gt; _EmptyStateViewState();\n}\n\nclass _EmptyStateViewState extends State&lt;_EmptyStateView&gt;\n    with SingleTickerProviderStateMixin {\n  late AnimationController _controller;\n  late Animation&lt;double&gt; _fadeAnimation;\n  late Animation&lt;double&gt; _scaleAnimation;\n\n  @override\n  void initState() {\n    super.initState();\n    _controller = AnimationController(\n      vsync: this,\n      duration: const Duration(milliseconds: 800),\n    );\n    _fadeAnimation = Tween&lt;double&gt;(begin: 0.0, end: 1.0).animate(\n      CurvedAnimation(parent: _controller, curve: Curves.easeIn),\n    );\n    _scaleAnimation = Tween&lt;double&gt;(begin: 0.8, end: 1.0).animate(\n      CurvedAnimation(parent: _controller, curve: Curves.easeOut),\n    );\n    _controller.forward();\n  }\n\n  @override\n  void dispose() {\n    _controller.dispose();\n    super.dispose();\n  }\n\n  @override\n  Widget build(BuildContext context) {\n    return FadeTransition(\n      opacity: _fadeAnimation,\n      child: ScaleTransition(\n        scale: _scaleAnimation,\n        child: Center(\n          child: Padding(\n            padding: const EdgeInsets.all(32),\n            child: Column(\n              mainAxisAlignment: MainAxisAlignment.center,\n              children: [\n                Container(\n                  padding: const EdgeInsets.all(24),\n                  decoration: BoxDecoration(\n                    color: AppColors.primaryPink.withOpacity(0.1),\n                    shape: BoxShape.circle,\n                  ),\n                  child: Icon(\n                    Icons.people_outline,\n                    size: 80,\n                    color: AppColors.primaryPink.withOpacity(0.6),\n                  ),\n                ),\n                const SizedBox(height: 24),\n                Text(\n                  widget.label,\n                  style: TextStyle(\n                    fontSize: 18,\n                    fontWeight: FontWeight.bold,\n                    color: Colors.grey.shade700,\n                  ),\n                  textAlign: TextAlign.center,\n                ),\n              ],\n            ),\n          ),\n        ),\n      ),\n    );\n  }\n}\n\n// Animated Follow Item\nclass _AnimatedFollowItem extends StatefulWidget {\n  const _AnimatedFollowItem({\n    required Key key,\n    required this.entry,\n    required this.index,\n    required this.actionBuilder,\n  }) : super(key: key);\n\n  final FollowEntry entry;\n  final int index;\n  final List&lt;Widget&gt; Function(FollowEntry) actionBuilder;\n\n  @override\n  State&lt;_AnimatedFollowItem&gt; createState() =&gt; _AnimatedFollowItemState();\n}\n\nclass _AnimatedFollowItemState extends State&lt;_AnimatedFollowItem&gt;\n    with SingleTickerProviderStateMixin {\n  late AnimationController _controller;\n  late Animation&lt;double&gt; _fadeAnimation;\n  late Animation&lt;Offset&gt; _slideAnimation;\n\n  @override\n  void initState() {\n    super.initState();\n    _controller = AnimationController(\n      vsync: this,\n      duration: const Duration(milliseconds: 400),\n    );\n    _fadeAnimation = Tween&lt;double&gt;(begin: 0.0, end: 1.0).animate(\n      CurvedAnimation(parent: _controller, curve: Curves.easeIn),\n    );\n    _slideAnimation = Tween&lt;Offset&gt;(\n      begin: const Offset(0.3, 0),\n      end: Offset.zero,\n    ).animate(\n      CurvedAnimation(parent: _controller, curve: Curves.easeOutCubic),\n    );\n    Future.delayed(Duration(milliseconds: widget.index * 50), () {\n      if (mounted) _controller.forward();\n    });\n  }\n\n  @override\n  void dispose() {\n    _controller.dispose();\n    super.dispose();\n  }\n\n  @override\n  Widget build(BuildContext context) {\n    final profile = widget.entry.profile;\n    final title = profile?.displayName?.isNotEmpty == true\n        ? profile!.displayName!\n        : (profile?.email?.isNotEmpty == true\n            ? profile!.email!\n            : widget.entry.uid);\n    final avatarUrl = profile?.photoUrl;\n\n    return FadeTransition(\n      opacity: _fadeAnimation,\n      child: SlideTransition(\n        position: _slideAnimation,\n        child: ScaleTransition(\n          scale: Tween&lt;double&gt;(begin: 0.97, end: 1.0).animate(\n            CurvedAnimation(parent: _controller, curve: Curves.easeOutBack),\n          ),\n          child: Container(\n            margin: const EdgeInsets.only(bottom: 12),\n            child: Material(\n              color: Colors.transparent,\n              child: InkWell(\n                onTap: () {\n                  HapticFeedback.lightImpact();\n                  Navigator.of(context).push(\n                    MaterialPageRoute(\n                      builder: (_) =&gt; PublicProfilePage(uid: widget.entry.uid),\n                    ),\n                  );\n                },\n                borderRadius: BorderRadius.circular(16),\n                child: Card(\n                  color: AppColors.primaryPink.withOpacity(0.04),\n                  elevation: 0,\n                  shape: RoundedRectangleBorder(\n                    borderRadius: BorderRadius.circular(16),\n                    side: BorderSide(\n                      color: AppColors.primaryPink.withOpacity(0.15),\n                      width: 1,\n                    ),\n                  ),\n                  child: Padding(\n                    padding: const EdgeInsets.symmetric(\n                      horizontal: 12,\n                      vertical: 10,\n                    ),\n                    child: Row(\n                      crossAxisAlignment: CrossAxisAlignment.start,\n                      children: [\n                        _ModernAvatar(\n                          avatarUrl: avatarUrl,\n                          uid: widget.entry.uid,\n                        ),\n                        const SizedBox(width: 12),\n                        Expanded(\n                          child: Column(\n                            crossAxisAlignment: CrossAxisAlignment.start,\n                            mainAxisSize: MainAxisSize.min,\n                            children: [\n                              Hero(\n                                tag: 'contact_title_${widget.entry.uid}',\n                                child: Text(\n                                  title,\n                                  style: const TextStyle(\n                                    fontSize: 16,\n                                    fontWeight: FontWeight.w600,\n                                  ),\n                                  softWrap: true,\n                                ),\n                              ),\n                              const SizedBox(height: 6),\n                              Wrap(\n                                spacing: 4,\n                                runSpacing: 4,\n                                children: widget.actionBuilder(widget.entry),\n                              ),\n                            ],\n                          ),\n                        ),\n                      ],\n                    ),\n                  ),\n                ),\n              ),\n            ),\n          ),\n        ),\n      ),\n    );\n  }\n}\n\n// Animated Follow Request Item\nclass _AnimatedFollowRequestItem extends StatefulWidget {\n  const _AnimatedFollowRequestItem({\n    required Key key,\n    required this.entry,\n    required this.index,\n    required this.onAccept,\n    required this.onDecline,\n    required this.acceptLabel,\n    required this.declineLabel,\n    required this.showAcceptButton,\n  }) : super(key: key);\n\n  final FollowRequestEntry entry;\n  final int index;\n  final Future&lt;void&gt; Function(String) onAccept;\n  final Future&lt;void&gt; Function(String) onDecline;\n  final String acceptLabel;\n  final String declineLabel;\n  final bool showAcceptButton;\n\n  @override\n  State&lt;_AnimatedFollowRequestItem&gt; createState() =&gt;\n      _AnimatedFollowRequestItemState();\n}\n\nclass _AnimatedFollowRequestItemState\n    extends State&lt;_AnimatedFollowRequestItem&gt;\n    with SingleTickerProviderStateMixin {\n  late AnimationController _controller;\n  late Animation&lt;double&gt; _fadeAnimation;\n  late Animation&lt;Offset&gt; _slideAnimation;\n\n  @override\n  void initState() {\n    super.initState();\n    _controller = AnimationController(\n      vsync: this,\n      duration: const Duration(milliseconds: 400),\n    );\n    _fadeAnimation = Tween&lt;double&gt;(begin: 0.0, end: 1.0).animate(\n      CurvedAnimation(parent: _controller, curve: Curves.easeIn),\n    );\n    _slideAnimation = Tween&lt;Offset&gt;(\n      begin: const Offset(0.3, 0),\n      end: Offset.zero,\n    ).animate(\n      CurvedAnimation(parent: _controller, curve: Curves.easeOutCubic),\n    );\n    Future.delayed(Duration(milliseconds: widget.index * 50), () {\n      if (mounted) _controller.forward();\n    });\n  }\n\n  @override\n  void dispose() {\n    _controller.dispose();\n    super.dispose();\n  }\n\n  @override\n  Widget build(BuildContext context) {\n    final profile = widget.entry.profile;\n    final title = profile?.displayName?.isNotEmpty == true\n        ? profile!.displayName!\n        : (profile?.email?.isNotEmpty == true\n            ? profile!.email!\n            : widget.entry.uid);\n    final avatarUrl = profile?.photoUrl;\n\n    return FadeTransition(\n      opacity: _fadeAnimation,\n      child: SlideTransition(\n        position: _slideAnimation,\n        child: Container(\n          margin: const EdgeInsets.only(bottom: 12),\n          child: Card(\n            elevation: 0,\n            shape: RoundedRectangleBorder(\n              borderRadius: BorderRadius.circular(16),\n              side: BorderSide(\n                color: Colors.grey.shade200,\n                width: 1,\n              ),\n            ),\n            child: Padding(\n              padding: const EdgeInsets.all(12),\n              child: Row(\n                children: [\n                  _ModernAvatar(\n                    avatarUrl: avatarUrl,\n                    uid: widget.entry.uid,\n                  ),\n                  const SizedBox(width: 16),\n                  Expanded(\n                    child: Column(\n                      crossAxisAlignment: CrossAxisAlignment.start,\n                      mainAxisSize: MainAxisSize.min,\n                      children: [\n                        Hero(\n                          tag: 'request_title_${widget.entry.uid}',\n                          child: Text(\n                            title,\n                            style: const TextStyle(\n                              fontSize: 16,\n                              fontWeight: FontWeight.w600,\n                            ),\n                            maxLines: 2,\n                            overflow: TextOverflow.ellipsis,\n                          ),\n                        ),\n                        if (widget.entry.createdAt != null) ...[\n                          const SizedBox(height: 4),\n                          Text(\n                            'Gửi lúc ${widget.entry.createdAt}',\n                            style: TextStyle(\n                              fontSize: 12,\n                              color: Colors.grey.shade600,\n                            ),\n                          ),\n                        ],\n                      ],\n                    ),\n                  ),\n                  const SizedBox(width: 8),\n                  Wrap(\n                    spacing: 8,\n                    children: [\n                      if (widget.showAcceptButton)\n                        _ModernTextButton(\n                          label: widget.acceptLabel,\n                          isPrimary: true,\n                          onPressed: () =&gt; widget.onAccept(widget.entry.uid),\n                        ),\n                      _ModernTextButton(\n                        label: widget.declineLabel,\n                        onPressed: () =&gt; widget.onDecline(widget.entry.uid),\n                      ),\n                    ],\n                  ),\n                ],\n              ),\n            ),\n          ),\n        ),\n      ),\n    );\n  }\n}\n\n// Modern Avatar\nclass _ModernAvatar extends StatelessWidget {\n  const _ModernAvatar({\n    required this.avatarUrl,\n    required this.uid,\n  });\n\n  final String? avatarUrl;\n  final String uid;\n\n  @override\n  Widget build(BuildContext context) {\n    return Hero(\n      tag: 'contact_avatar_$uid',\n      child: Container(\n        decoration: BoxDecoration(\n          shape: BoxShape.circle,\n          gradient: LinearGradient(\n            colors: [\n              AppColors.primaryPink,\n              AppColors.primaryPink.withOpacity(0.6),\n            ],\n          ),\n          boxShadow: [\n            BoxShadow(\n              color: AppColors.primaryPink.withOpacity(0.3),\n              blurRadius: 8,\n              offset: const Offset(0, 2),\n            ),\n          ],\n        ),\n        padding: const EdgeInsets.all(2),\n        child: CircleAvatar(\n          radius: 28,\n          backgroundImage: avatarUrl != null ? NetworkImage(avatarUrl!) : null,\n          child: avatarUrl == null\n              ? const Icon(Icons.person, color: AppColors.primaryPink)\n              : null,\n        ),\n      ),\n    );\n  }\n}\n\n\n// Modern Tab Bar\nclass _ModernTabBar extends StatelessWidget implements PreferredSizeWidget {\n  const _ModernTabBar({required this.controller});\n\n  final TabController controller;\n\n  @override\n  Widget build(BuildContext context) {\n    return Container(\n      decoration: BoxDecoration(\n        gradient: LinearGradient(\n          colors: [\n            Colors.white,\n            AppColors.primaryPink.withOpacity(0.05),\n          ],\n          begin: Alignment.topCenter,\n          end: Alignment.bottomCenter,\n        ),\n      ),\n      child: TabBar(\n        controller: controller,\n        labelColor: AppColors.primaryPink,\n        unselectedLabelColor: Colors.grey,\n        indicatorColor: AppColors.primaryPink,\n        indicatorWeight: 3,\n        tabs: const [\n          Tab(text: 'Đang theo dõi'),\n          Tab(text: 'Người theo dõi'),\n          Tab(text: 'Yêu cầu đến'),\n          Tab(text: 'Yêu cầu đã gửi'),\n        ],\n      ),\n    );\n  }\n\n  @override\n  Size get preferredSize =&gt; const Size.fromHeight(48);\n}\n\n// Animated Search Button\nclass _AnimatedSearchButton extends StatefulWidget {\n  const _AnimatedSearchButton({required this.onPressed});\n\n  final VoidCallback onPressed;\n\n  @override\n  State&lt;_AnimatedSearchButton&gt; createState() =&gt; _AnimatedSearchButtonState();\n}\n\nclass _AnimatedSearchButtonState extends State&lt;_AnimatedSearchButton&gt;\n    with SingleTickerProviderStateMixin {\n  late AnimationController _controller;\n\n  @override\n  void initState() {\n    super.initState();\n    _controller = AnimationController(\n      vsync: this,\n      duration: const Duration(milliseconds: 200),\n    );\n  }\n\n  @override\n  void dispose() {\n    _controller.dispose();\n    super.dispose();\n  }\n\n  @override\n  Widget build(BuildContext context) {\n    return GestureDetector(\n      onTapDown: (_) =&gt; _controller.forward(),\n      onTapUp: (_) {\n        _controller.reverse();\n        widget.onPressed();\n      },\n      onTapCancel: () =&gt; _controller.reverse(),\n      child: ScaleTransition(\n        scale: Tween&lt;double&gt;(begin: 1.0, end: 0.9).animate(\n          CurvedAnimation(parent: _controller, curve: Curves.easeInOut),\n        ),\n        child: IconButton(\n          icon: const Icon(Icons.search, color: AppColors.primaryPink),\n          tooltip: 'Tìm kiếm người dùng',\n          onPressed: widget.onPressed,\n        ),\n      ),\n    );\n  }\n}\n\n// Modern Action Button\nclass _ModernActionButton extends StatefulWidget {\n  const _ModernActionButton({\n    required this.icon,\n    required this.tooltip,\n    required this.onPressed,\n  });\n\n  final IconData icon;\n  final String tooltip;\n  final VoidCallback onPressed;\n\n  @override\n  State&lt;_ModernActionButton&gt; createState() =&gt; _ModernActionButtonState();\n}\n\nclass _ModernActionButtonState extends State&lt;_ModernActionButton&gt;\n    with SingleTickerProviderStateMixin {\n  late AnimationController _controller;\n\n  @override\n  void initState() {\n    super.initState();\n    _controller = AnimationController(\n      vsync: this,\n      duration: const Duration(milliseconds: 150),\n    );\n  }\n\n  @override\n  void dispose() {\n    _controller.dispose();\n    super.dispose();\n  }\n\n  @override\n  Widget build(BuildContext context) {\n    return GestureDetector(\n      onTapDown: (_) {\n        _controller.forward();\n        HapticFeedback.lightImpact();\n      },\n      onTapUp: (_) {\n        _controller.reverse();\n        widget.onPressed();\n      },\n      onTapCancel: () =&gt; _controller.reverse(),\n      child: ScaleTransition(\n        scale: Tween&lt;double&gt;(begin: 1.0, end: 0.85).animate(\n          CurvedAnimation(parent: _controller, curve: Curves.easeInOut),\n        ),\n        child: IconButton(\n          icon: Icon(widget.icon, color: AppColors.primaryPink),\n          tooltip: widget.tooltip,\n          onPressed: widget.onPressed,\n        ),\n      ),\n    );\n  }\n}\n\n// Modern Text Button\nclass _ModernTextButton extends StatefulWidget {\n  const _ModernTextButton({\n    required this.label,\n    required this.onPressed,\n    this.isPrimary = false,\n  });\n\n  final String label;\n  final VoidCallback onPressed;\n  final bool isPrimary;\n\n  @override\n  State&lt;_ModernTextButton&gt; createState() =&gt; _ModernTextButtonState();\n}\n\nclass _ModernTextButtonState extends State&lt;_ModernTextButton&gt;\n    with SingleTickerProviderStateMixin {\n  late AnimationController _controller;\n\n  @override\n  void initState() {\n    super.initState();\n    _controller = AnimationController(\n      vsync: this,\n      duration: const Duration(milliseconds: 150),\n    );\n  }\n\n  @override\n  void dispose() {\n    _controller.dispose();\n    super.dispose();\n  }\n\n  @override\n  Widget build(BuildContext context) {\n    return GestureDetector(\n      onTapDown: (_) {\n        _controller.forward();\n        HapticFeedback.lightImpact();\n      },\n      onTapUp: (_) {\n        _controller.reverse();\n        widget.onPressed();\n      },\n      onTapCancel: () =&gt; _controller.reverse(),\n      child: ScaleTransition(\n        scale: Tween&lt;double&gt;(begin: 1.0, end: 0.95).animate(\n          CurvedAnimation(parent: _controller, curve: Curves.easeInOut),\n        ),\n        child: TextButton(\n          onPressed: widget.onPressed,\n          style: TextButton.styleFrom(\n            foregroundColor: widget.isPrimary\n                ? AppColors.primaryPink\n                : Colors.grey.shade700,\n            backgroundColor: widget.isPrimary\n                ? AppColors.primaryPink.withOpacity(0.1)\n                : null,\n          ),\n          child: Text(widget.label),\n        ),\n      ),\n    );\n  }\n}\n\n",
    "languageId": "dart"
  }
}
```
Result:

```json
{
  "diff": {
    "chunks": [
      {
        "diffString": "                      ),\n                      child: Row(\n+                       crossAxisAlignment: CrossAxisAlignment.start,\n                        children: [\n                          _ModernAvatar(",
        "oldStart": 702,
        "newStart": 702,
        "oldLines": 4,
        "newLines": 5,
        "linesAdded": 1
      },
      {
        "diffString": "                          const SizedBox(width: 12),\n                          Expanded(\n-                           child: Hero(\n-                             tag: 'contact_title_${widget.entry.uid}',\n-                             child: Text(\n-                               title,\n-                               style: const TextStyle(\n-                                 fontSize: 16,\n-                                 fontWeight: FontWeight.w600,\n-                               ),\n-                               maxLines: 1,\n-                               overflow: TextOverflow.ellipsis,\n-                             ),\n-                           ),\n-                         ),\n-                         const SizedBox(width: 8),\n-                         Wrap(\n-                           spacing: 4,\n-                           children: widget.actionBuilder(widget.entry),\n-                         ),\n-                       ],\n-                     ),\n-                   ),\n+                           child: Column(\n+                             crossAxisAlignment: CrossAxisAlignment.start,\n+                             mainAxisSize: MainAxisSize.min,\n+                             children: [\n+                               Hero(\n+                                 tag: 'contact_title_${widget.entry.uid}',\n+                                 child: Text(\n+                                   title,\n+                                   style: const TextStyle(\n+                                     fontSize: 16,\n+                                     fontWeight: FontWeight.w600,\n+                                   ),\n+                                   softWrap: true,\n+                                 ),\n+                               ),\n+                               const SizedBox(height: 6),\n+                               Wrap(\n+                                 spacing: 4,\n+                                 runSpacing: 4,\n+                                 children: widget.actionBuilder(widget.entry),\n+                               ),\n+                             ],\n+                           ),\n+                         ),\n+                       ],\n+                     ),\n+                   ),\n                  ),\n                ),",
        "oldStart": 709,
        "newStart": 710,
        "oldLines": 25,
        "newLines": 31,
        "linesRemoved": 21,
        "linesAdded": 27
      }
    ],
    "editor": "EDITOR_AI"
  },
  "shouldAutoFixLints": true,
  "resultForModel": "Success. Updated the following files:\nM lib/features/contacts/pages/contacts_page.dart",
  "contentsAfterEdit": "import 'package:cloud_firestore/cloud_firestore.dart';\nimport 'package:flutter/material.dart';\nimport 'package:flutter/services.dart';\n\nimport '../../auth/auth_repository.dart';\nimport '../../../theme/colors.dart';\nimport '../../chat/pages/chat_detail_page.dart';\nimport '../../chat/repositories/chat_repository.dart';\nimport '../../follow/services/follow_service.dart';\nimport '../../profile/public_profile_page.dart';\nimport '../widgets/contact_search_delegate.dart';\n\nclass ContactsPage extends StatefulWidget {\n  const ContactsPage({super.key});\n\n  @override\n  State&lt;ContactsPage&gt; createState() =&gt; _ContactsPageState();\n}\n\nclass _ContactsPageState extends State&lt;ContactsPage&gt;\n    with SingleTickerProviderStateMixin {\n  late final FollowService _followService;\n  late final ChatRepository _chatRepository;\n  late final TabController _tabController;\n  String? _errorMessage;\n\n  @override\n  void initState() {\n    super.initState();\n    _followService = FollowService();\n    _chatRepository = ChatRepository();\n    _tabController = TabController(length: 4, vsync: this);\n  }\n\n  @override\n  void dispose() {\n    _tabController.dispose();\n    super.dispose();\n  }\n\n  String get _currentUid =&gt; authRepository.currentUser()?.uid ?? '';\n\n  void _showError(Object error) {\n    final message = error.toString();\n    setState(() =&gt; _errorMessage = message);\n    ScaffoldMessenger.of(context).showSnackBar(\n      SnackBar(content: Text(message)),\n    );\n  }\n\n  @override\n  Widget build(BuildContext context) {\n    final uid = _currentUid;\n    if (uid.isEmpty) {\n      return const Scaffold(\n        body: Center(child: Text('Bạn chưa đăng nhập.')),\n      );\n    }\n\n    return Scaffold(\n      appBar: AppBar(\n        title: const Text(\n          'Kết nối',\n          style: TextStyle(color: AppColors.primaryPink),\n        ),\n        iconTheme: const IconThemeData(color: AppColors.primaryPink),\n        actions: [\n          _AnimatedSearchButton(\n            onPressed: () {\n              HapticFeedback.lightImpact();\n              showSearch(\n                context: context,\n                delegate: ContactSearchDelegate(service: _followService),\n              );\n            },\n          ),\n        ],\n        bottom: _ModernTabBar(\n          controller: _tabController,\n        ),\n      ),\n      body: Column(\n        children: [\n          if (_errorMessage != null)\n            Padding(\n              padding: const EdgeInsets.all(8),\n              child: Text(\n                _errorMessage!,\n                style: const TextStyle(color: Colors.red),\n              ),\n            ),\n          Expanded(\n            child: TabBarView(\n              controller: _tabController,\n              children: [\n                _ModernFollowList(\n                  stream: _followService.watchFollowingEntries(uid),\n                  emptyLabel: 'Bạn chưa theo dõi ai.',\n                  actionBuilder: (entry) =&gt; [\n                    _ModernActionButton(\n                      icon: Icons.chat_bubble_outline,\n                      tooltip: 'Nhắn tin',\n                      onPressed: () async {\n                        try {\n                          final conversationId =\n                              await _chatRepository.createOrGetDirectConversation(\n                            currentUid: uid,\n                            otherUid: entry.uid,\n                          );\n                          if (!mounted) return;\n                          Navigator.of(context).push(\n                            MaterialPageRoute(\n                              builder: (_) =&gt; ChatDetailPage(\n                                conversationId: conversationId,\n                                otherUid: entry.uid,\n                              ),\n                            ),\n                          );\n                        } catch (e) {\n                          _showError(e);\n                        }\n                      },\n                    ),\n                    _ModernActionButton(\n                      icon: Icons.person,\n                      tooltip: 'Xem trang cá nhân',\n                      onPressed: () {\n                        Navigator.of(context).push(\n                          MaterialPageRoute(\n                            builder: (_) =&gt; PublicProfilePage(uid: entry.uid),\n                          ),\n                        );\n                      },\n                    ),\n                    _ModernTextButton(\n                      label: 'Bỏ theo dõi',\n                      onPressed: () async {\n                        try {\n                          await _followService.unfollow(entry.uid);\n                        } catch (e) {\n                          _showError(e);\n                        }\n                      },\n                    ),\n                  ],\n                ),\n                _ModernFollowList(\n                  stream: _followService.watchFollowersEntries(uid),\n                  emptyLabel: 'Chưa có người theo dõi.',\n                  actionBuilder: (entry) =&gt; [\n                    _ModernActionButton(\n                      icon: Icons.chat_bubble_outline,\n                      tooltip: 'Nhắn tin',\n                      onPressed: () async {\n                        try {\n                          final conversationId =\n                              await _chatRepository.createOrGetDirectConversation(\n                            currentUid: uid,\n                            otherUid: entry.uid,\n                          );\n                          if (!mounted) return;\n                          Navigator.of(context).push(\n                            MaterialPageRoute(\n                              builder: (_) =&gt; ChatDetailPage(\n                                conversationId: conversationId,\n                                otherUid: entry.uid,\n                              ),\n                            ),\n                          );\n                        } catch (e) {\n                          _showError(e);\n                        }\n                      },\n                    ),\n                    _ModernActionButton(\n                      icon: Icons.person,\n                      tooltip: 'Xem trang cá nhân',\n                      onPressed: () {\n                        Navigator.of(context).push(\n                          MaterialPageRoute(\n                            builder: (_) =&gt; PublicProfilePage(uid: entry.uid),\n                          ),\n                        );\n                      },\n                    ),\n                    if (!entry.isMutual)\n                      _ModernTextButton(\n                        label: 'Theo dõi lại',\n                        onPressed: () async {\n                          try {\n                            await _followService.followUser(entry.uid);\n                          } catch (e) {\n                            _showError(e);\n                          }\n                        },\n                      )\n                    else\n                      _ModernTextButton(\n                        label: 'Bỏ theo dõi',\n                        onPressed: () async {\n                          try {\n                            await _followService.unfollow(entry.uid);\n                          } catch (e) {\n                            _showError(e);\n                          }\n                        },\n                      ),\n                  ],\n                ),\n                _ModernFollowRequestList(\n                  stream: _followService.watchIncomingRequestEntries(uid),\n                  emptyLabel: 'Không có yêu cầu theo dõi.',\n                  onAccept: (otherUid) async {\n                    try {\n                      await _followService.acceptRequest(otherUid);\n                    } catch (e) {\n                      _showError(e);\n                    }\n                  },\n                  onDecline: (otherUid) async {\n                    try {\n                      await _followService.declineRequest(otherUid);\n                    } catch (e) {\n                      _showError(e);\n                    }\n                  },\n                ),\n                _ModernFollowRequestList(\n                  stream: _followService.watchSentRequestEntries(uid),\n                  emptyLabel: 'Không có yêu cầu đã gửi.',\n                  onAccept: (_) async {},\n                  onDecline: (otherUid) async {\n                    try {\n                      await _followService.cancelRequest(otherUid);\n                    } catch (e) {\n                      _showError(e);\n                    }\n                  },\n                  acceptLabel: '',\n                  declineLabel: 'Huỷ yêu cầu',\n                  showAcceptButton: false,\n                ),\n              ],\n            ),\n          ),\n        ],\n      ),\n    );\n  }\n}\n\nclass _ModernFollowList extends StatelessWidget {\n  const _ModernFollowList({\n    required this.stream,\n    required this.emptyLabel,\n    required this.actionBuilder,\n  });\n\n  final Stream&lt;List&lt;FollowEntry&gt;&gt; stream;\n  final String emptyLabel;\n  final List&lt;Widget&gt; Function(FollowEntry) actionBuilder;\n\n  @override\n  Widget build(BuildContext context) {\n    return RefreshIndicator(\n      onRefresh: () async {\n        await Future.delayed(const Duration(milliseconds: 500));\n      },\n      color: AppColors.primaryPink,\n      child: StreamBuilder&lt;List&lt;FollowEntry&gt;&gt;(\n      stream: stream,\n      builder: (context, snapshot) {\n        if (snapshot.connectionState == ConnectionState.waiting) {\n            return _ShimmerLoadingList();\n        }\n        if (snapshot.hasError) {\n          return _FirestoreIndexErrorView(error: snapshot.error);\n        }\n        final entries = snapshot.data ?? [];\n        if (entries.isEmpty) {\n            return _EmptyStateView(label: emptyLabel);\n        }\n          return ListView.builder(\n            padding: const EdgeInsets.symmetric(vertical: 8, horizontal: 16),\n          itemCount: entries.length,\n          itemBuilder: (context, index) {\n            final entry = entries[index];\n              return _AnimatedFollowItem(\n                key: ValueKey(entry.uid),\n                entry: entry,\n                index: index,\n                actionBuilder: actionBuilder,\n            );\n          },\n        );\n      },\n      ),\n    );\n  }\n}\n\nclass _ModernFollowRequestList extends StatelessWidget {\n  const _ModernFollowRequestList({\n    required this.stream,\n    required this.emptyLabel,\n    required this.onAccept,\n    required this.onDecline,\n    this.acceptLabel = 'Chấp nhận',\n    this.declineLabel = 'Từ chối',\n    this.showAcceptButton = true,\n  });\n\n  final Stream&lt;List&lt;FollowRequestEntry&gt;&gt; stream;\n  final String emptyLabel;\n  final Future&lt;void&gt; Function(String) onAccept;\n  final Future&lt;void&gt; Function(String) onDecline;\n  final String acceptLabel;\n  final String declineLabel;\n  final bool showAcceptButton;\n\n  @override\n  Widget build(BuildContext context) {\n    return RefreshIndicator(\n      onRefresh: () async {\n        await Future.delayed(const Duration(milliseconds: 500));\n      },\n      color: AppColors.primaryPink,\n      child: StreamBuilder&lt;List&lt;FollowRequestEntry&gt;&gt;(\n      stream: stream,\n      builder: (context, snapshot) {\n        if (snapshot.connectionState == ConnectionState.waiting) {\n            return _ShimmerLoadingList();\n        }\n        if (snapshot.hasError) {\n          return _FirestoreIndexErrorView(error: snapshot.error);\n        }\n        final entries = snapshot.data ?? [];\n        if (entries.isEmpty) {\n            return _EmptyStateView(label: emptyLabel);\n        }\n          return ListView.builder(\n            padding: const EdgeInsets.symmetric(vertical: 8, horizontal: 16),\n          itemCount: entries.length,\n          itemBuilder: (context, index) {\n            final entry = entries[index];\n              return _AnimatedFollowRequestItem(\n                key: ValueKey(entry.uid),\n                entry: entry,\n                index: index,\n                onAccept: onAccept,\n                onDecline: onDecline,\n                acceptLabel: acceptLabel,\n                declineLabel: declineLabel,\n                showAcceptButton: showAcceptButton,\n            );\n          },\n        );\n      },\n      ),\n    );\n  }\n}\n\nclass _FirestoreIndexErrorView extends StatelessWidget {\n  const _FirestoreIndexErrorView({this.error});\n\n  final Object? error;\n\n  @override\n  Widget build(BuildContext context) {\n    final firebaseError =\n        error is FirebaseException ? error as FirebaseException : null;\n    if (firebaseError != null &amp;&amp;\n        firebaseError.code == 'failed-precondition' &amp;&amp;\n        (firebaseError.message?.contains('https://') ?? false)) {\n      final url = _extractUrl(firebaseError.message!);\n      return Padding(\n        padding: const EdgeInsets.all(16),\n        child: Column(\n          mainAxisAlignment: MainAxisAlignment.center,\n          children: [\n            const Icon(Icons.warning_amber_rounded,\n                color: Colors.amber, size: 48),\n            const SizedBox(height: 12),\n            const Text(\n              'Thiếu Firestore index cho truy vấn này.',\n              style: TextStyle(fontSize: 16, fontWeight: FontWeight.w600),\n              textAlign: TextAlign.center,\n            ),\n            const SizedBox(height: 8),\n            const Text(\n              'Nhấn vào liên kết bên dưới để mở Firebase Console và tạo index. '\n              'Đợi vài phút sau khi tạo rồi tải lại trang.',\n              textAlign: TextAlign.center,\n            ),\n            const SizedBox(height: 12),\n            if (url != null)\n              SelectableText(\n                url,\n                style: const TextStyle(color: Colors.blue),\n                textAlign: TextAlign.center,\n              )\n            else\n              Text(firebaseError.message ?? '',\n                  textAlign: TextAlign.center),\n          ],\n        ),\n      );\n    }\n    return Center(\n      child: Text('Lỗi: $error'),\n    );\n  }\n\n  String? _extractUrl(String message) {\n    final regex = RegExp(r'https://[^\\s]+');\n    final match = regex.firstMatch(message);\n    return match?.group(0);\n  }\n}\n\n// Shimmer Loading Widget\nclass _ShimmerLoadingList extends StatelessWidget {\n  @override\n  Widget build(BuildContext context) {\n    return ListView.builder(\n      padding: const EdgeInsets.symmetric(vertical: 8, horizontal: 16),\n      itemCount: 6,\n      itemBuilder: (context, index) {\n        return _ShimmerItem(delay: Duration(milliseconds: index * 100));\n      },\n    );\n  }\n}\n\nclass _ShimmerItem extends StatefulWidget {\n  const _ShimmerItem({required this.delay});\n\n  final Duration delay;\n\n  @override\n  State&lt;_ShimmerItem&gt; createState() =&gt; _ShimmerItemState();\n}\n\nclass _ShimmerItemState extends State&lt;_ShimmerItem&gt;\n    with SingleTickerProviderStateMixin {\n  late AnimationController _controller;\n\n  @override\n  void initState() {\n    super.initState();\n    _controller = AnimationController(\n      vsync: this,\n      duration: const Duration(milliseconds: 1500),\n    )..repeat(reverse: true);\n    Future.delayed(widget.delay, () {\n      if (mounted) _controller.forward();\n    });\n  }\n\n  @override\n  void dispose() {\n    _controller.dispose();\n    super.dispose();\n  }\n\n  @override\n  Widget build(BuildContext context) {\n    return AnimatedBuilder(\n      animation: _controller,\n      builder: (context, child) {\n        return Opacity(\n          opacity: 0.3 + (_controller.value * 0.4),\n          child: Container(\n            margin: const EdgeInsets.only(bottom: 12),\n            padding: const EdgeInsets.all(12),\n            decoration: BoxDecoration(\n              color: Colors.grey.shade300,\n              borderRadius: BorderRadius.circular(16),\n            ),\n            child: Row(\n              children: [\n                Container(\n                  width: 56,\n                  height: 56,\n                  decoration: BoxDecoration(\n                    color: Colors.grey.shade400,\n                    shape: BoxShape.circle,\n                  ),\n                ),\n                const SizedBox(width: 16),\n                Expanded(\n                  child: Column(\n                    crossAxisAlignment: CrossAxisAlignment.start,\n                    children: [\n                      Container(\n                        height: 16,\n                        width: double.infinity,\n                        decoration: BoxDecoration(\n                          color: Colors.grey.shade400,\n                          borderRadius: BorderRadius.circular(8),\n                        ),\n                      ),\n                      const SizedBox(height: 8),\n                      Container(\n                        height: 12,\n                        width: 150,\n                        decoration: BoxDecoration(\n                          color: Colors.grey.shade400,\n                          borderRadius: BorderRadius.circular(6),\n                        ),\n                      ),\n                    ],\n                  ),\n                ),\n              ],\n            ),\n          ),\n        );\n      },\n    );\n  }\n}\n\n// Empty State Widget\nclass _EmptyStateView extends StatefulWidget {\n  const _EmptyStateView({required this.label});\n\n  final String label;\n\n  @override\n  State&lt;_EmptyStateView&gt; createState() =&gt; _EmptyStateViewState();\n}\n\nclass _EmptyStateViewState extends State&lt;_EmptyStateView&gt;\n    with SingleTickerProviderStateMixin {\n  late AnimationController _controller;\n  late Animation&lt;double&gt; _fadeAnimation;\n  late Animation&lt;double&gt; _scaleAnimation;\n\n  @override\n  void initState() {\n    super.initState();\n    _controller = AnimationController(\n      vsync: this,\n      duration: const Duration(milliseconds: 800),\n    );\n    _fadeAnimation = Tween&lt;double&gt;(begin: 0.0, end: 1.0).animate(\n      CurvedAnimation(parent: _controller, curve: Curves.easeIn),\n    );\n    _scaleAnimation = Tween&lt;double&gt;(begin: 0.8, end: 1.0).animate(\n      CurvedAnimation(parent: _controller, curve: Curves.easeOut),\n    );\n    _controller.forward();\n  }\n\n  @override\n  void dispose() {\n    _controller.dispose();\n    super.dispose();\n  }\n\n  @override\n  Widget build(BuildContext context) {\n    return FadeTransition(\n      opacity: _fadeAnimation,\n      child: ScaleTransition(\n        scale: _scaleAnimation,\n        child: Center(\n          child: Padding(\n            padding: const EdgeInsets.all(32),\n            child: Column(\n              mainAxisAlignment: MainAxisAlignment.center,\n              children: [\n                Container(\n                  padding: const EdgeInsets.all(24),\n                  decoration: BoxDecoration(\n                    color: AppColors.primaryPink.withOpacity(0.1),\n                    shape: BoxShape.circle,\n                  ),\n                  child: Icon(\n                    Icons.people_outline,\n                    size: 80,\n                    color: AppColors.primaryPink.withOpacity(0.6),\n                  ),\n                ),\n                const SizedBox(height: 24),\n                Text(\n                  widget.label,\n                  style: TextStyle(\n                    fontSize: 18,\n                    fontWeight: FontWeight.bold,\n                    color: Colors.grey.shade700,\n                  ),\n                  textAlign: TextAlign.center,\n                ),\n              ],\n            ),\n          ),\n        ),\n      ),\n    );\n  }\n}\n\n// Animated Follow Item\nclass _AnimatedFollowItem extends StatefulWidget {\n  const _AnimatedFollowItem({\n    required Key key,\n    required this.entry,\n    required this.index,\n    required this.actionBuilder,\n  }) : super(key: key);\n\n  final FollowEntry entry;\n  final int index;\n  final List&lt;Widget&gt; Function(FollowEntry) actionBuilder;\n\n  @override\n  State&lt;_AnimatedFollowItem&gt; createState() =&gt; _AnimatedFollowItemState();\n}\n\nclass _AnimatedFollowItemState extends State&lt;_AnimatedFollowItem&gt;\n    with SingleTickerProviderStateMixin {\n  late AnimationController _controller;\n  late Animation&lt;double&gt; _fadeAnimation;\n  late Animation&lt;Offset&gt; _slideAnimation;\n\n  @override\n  void initState() {\n    super.initState();\n    _controller = AnimationController(\n      vsync: this,\n      duration: const Duration(milliseconds: 400),\n    );\n    _fadeAnimation = Tween&lt;double&gt;(begin: 0.0, end: 1.0).animate(\n      CurvedAnimation(parent: _controller, curve: Curves.easeIn),\n    );\n    _slideAnimation = Tween&lt;Offset&gt;(\n      begin: const Offset(0.3, 0),\n      end: Offset.zero,\n    ).animate(\n      CurvedAnimation(parent: _controller, curve: Curves.easeOutCubic),\n    );\n    Future.delayed(Duration(milliseconds: widget.index * 50), () {\n      if (mounted) _controller.forward();\n    });\n  }\n\n  @override\n  void dispose() {\n    _controller.dispose();\n    super.dispose();\n  }\n\n  @override\n  Widget build(BuildContext context) {\n    final profile = widget.entry.profile;\n    final title = profile?.displayName?.isNotEmpty == true\n        ? profile!.displayName!\n        : (profile?.email?.isNotEmpty == true\n            ? profile!.email!\n            : widget.entry.uid);\n    final avatarUrl = profile?.photoUrl;\n\n    return FadeTransition(\n      opacity: _fadeAnimation,\n      child: SlideTransition(\n        position: _slideAnimation,\n        child: ScaleTransition(\n          scale: Tween&lt;double&gt;(begin: 0.97, end: 1.0).animate(\n            CurvedAnimation(parent: _controller, curve: Curves.easeOutBack),\n          ),\n          child: Container(\n            margin: const EdgeInsets.only(bottom: 12),\n            child: Material(\n              color: Colors.transparent,\n              child: InkWell(\n                onTap: () {\n                  HapticFeedback.lightImpact();\n                  Navigator.of(context).push(\n                    MaterialPageRoute(\n                      builder: (_) =&gt; PublicProfilePage(uid: widget.entry.uid),\n                    ),\n                  );\n                },\n                borderRadius: BorderRadius.circular(16),\n                child: Card(\n                  color: AppColors.primaryPink.withOpacity(0.04),\n                  elevation: 0,\n                  shape: RoundedRectangleBorder(\n                    borderRadius: BorderRadius.circular(16),\n                    side: BorderSide(\n                      color: AppColors.primaryPink.withOpacity(0.15),\n                      width: 1,\n                    ),\n                  ),\n                  child: Padding(\n                    padding: const EdgeInsets.symmetric(\n                      horizontal: 12,\n                      vertical: 10,\n                    ),\n                    child: Row(\n                      crossAxisAlignment: CrossAxisAlignment.start,\n                      children: [\n                        _ModernAvatar(\n                          avatarUrl: avatarUrl,\n                          uid: widget.entry.uid,\n                        ),\n                        const SizedBox(width: 12),\n                        Expanded(\n                          child: Column(\n                            crossAxisAlignment: CrossAxisAlignment.start,\n                            mainAxisSize: MainAxisSize.min,\n                            children: [\n                              Hero(\n                                tag: 'contact_title_${widget.entry.uid}',\n                                child: Text(\n                                  title,\n                                  style: const TextStyle(\n                                    fontSize: 16,\n                                    fontWeight: FontWeight.w600,\n                                  ),\n                                  softWrap: true,\n                                ),\n                              ),\n                              const SizedBox(height: 6),\n                              Wrap(\n                                spacing: 4,\n                                runSpacing: 4,\n                                children: widget.actionBuilder(widget.entry),\n                              ),\n                            ],\n                          ),\n                        ),\n                      ],\n                    ),\n                  ),\n                ),\n              ),\n            ),\n          ),\n        ),\n      ),\n    );\n  }\n}\n\n// Animated Follow Request Item\nclass _AnimatedFollowRequestItem extends StatefulWidget {\n  const _AnimatedFollowRequestItem({\n    required Key key,\n    required this.entry,\n    required this.index,\n    required this.onAccept,\n    required this.onDecline,\n    required this.acceptLabel,\n    required this.declineLabel,\n    required this.showAcceptButton,\n  }) : super(key: key);\n\n  final FollowRequestEntry entry;\n  final int index;\n  final Future&lt;void&gt; Function(String) onAccept;\n  final Future&lt;void&gt; Function(String) onDecline;\n  final String acceptLabel;\n  final String declineLabel;\n  final bool showAcceptButton;\n\n  @override\n  State&lt;_AnimatedFollowRequestItem&gt; createState() =&gt;\n      _AnimatedFollowRequestItemState();\n}\n\nclass _AnimatedFollowRequestItemState\n    extends State&lt;_AnimatedFollowRequestItem&gt;\n    with SingleTickerProviderStateMixin {\n  late AnimationController _controller;\n  late Animation&lt;double&gt; _fadeAnimation;\n  late Animation&lt;Offset&gt; _slideAnimation;\n\n  @override\n  void initState() {\n    super.initState();\n    _controller = AnimationController(\n      vsync: this,\n      duration: const Duration(milliseconds: 400),\n    );\n    _fadeAnimation = Tween&lt;double&gt;(begin: 0.0, end: 1.0).animate(\n      CurvedAnimation(parent: _controller, curve: Curves.easeIn),\n    );\n    _slideAnimation = Tween&lt;Offset&gt;(\n      begin: const Offset(0.3, 0),\n      end: Offset.zero,\n    ).animate(\n      CurvedAnimation(parent: _controller, curve: Curves.easeOutCubic),\n    );\n    Future.delayed(Duration(milliseconds: widget.index * 50), () {\n      if (mounted) _controller.forward();\n    });\n  }\n\n  @override\n  void dispose() {\n    _controller.dispose();\n    super.dispose();\n  }\n\n  @override\n  Widget build(BuildContext context) {\n    final profile = widget.entry.profile;\n    final title = profile?.displayName?.isNotEmpty == true\n        ? profile!.displayName!\n        : (profile?.email?.isNotEmpty == true\n            ? profile!.email!\n            : widget.entry.uid);\n    final avatarUrl = profile?.photoUrl;\n\n    return FadeTransition(\n      opacity: _fadeAnimation,\n      child: SlideTransition(\n        position: _slideAnimation,\n        child: Container(\n          margin: const EdgeInsets.only(bottom: 12),\n          child: Card(\n            elevation: 0,\n            shape: RoundedRectangleBorder(\n              borderRadius: BorderRadius.circular(16),\n              side: BorderSide(\n                color: Colors.grey.shade200,\n                width: 1,\n              ),\n            ),\n            child: Padding(\n              padding: const EdgeInsets.all(12),\n              child: Row(\n                children: [\n                  _ModernAvatar(\n                    avatarUrl: avatarUrl,\n                    uid: widget.entry.uid,\n                  ),\n                  const SizedBox(width: 16),\n                  Expanded(\n                    child: Column(\n                      crossAxisAlignment: CrossAxisAlignment.start,\n                      mainAxisSize: MainAxisSize.min,\n                      children: [\n                        Hero(\n                          tag: 'request_title_${widget.entry.uid}',\n                          child: Text(\n                            title,\n                            style: const TextStyle(\n                              fontSize: 16,\n                              fontWeight: FontWeight.w600,\n                            ),\n                            maxLines: 2,\n                            overflow: TextOverflow.ellipsis,\n                          ),\n                        ),\n                        if (widget.entry.createdAt != null) ...[\n                          const SizedBox(height: 4),\n                          Text(\n                            'Gửi lúc ${widget.entry.createdAt}',\n                            style: TextStyle(\n                              fontSize: 12,\n                              color: Colors.grey.shade600,\n                            ),\n                          ),\n                        ],\n                      ],\n                    ),\n                  ),\n                  const SizedBox(width: 8),\n                  Wrap(\n                    spacing: 8,\n                    children: [\n                      if (widget.showAcceptButton)\n                        _ModernTextButton(\n                          label: widget.acceptLabel,\n                          isPrimary: true,\n                          onPressed: () =&gt; widget.onAccept(widget.entry.uid),\n                        ),\n                      _ModernTextButton(\n                        label: widget.declineLabel,\n                        onPressed: () =&gt; widget.onDecline(widget.entry.uid),\n                      ),\n                    ],\n                  ),\n                ],\n              ),\n            ),\n          ),\n        ),\n      ),\n    );\n  }\n}\n\n// Modern Avatar\nclass _ModernAvatar extends StatelessWidget {\n  const _ModernAvatar({\n    required this.avatarUrl,\n    required this.uid,\n  });\n\n  final String? avatarUrl;\n  final String uid;\n\n  @override\n  Widget build(BuildContext context) {\n    return Hero(\n      tag: 'contact_avatar_$uid',\n      child: Container(\n        decoration: BoxDecoration(\n          shape: BoxShape.circle,\n          gradient: LinearGradient(\n            colors: [\n              AppColors.primaryPink,\n              AppColors.primaryPink.withOpacity(0.6),\n            ],\n          ),\n          boxShadow: [\n            BoxShadow(\n              color: AppColors.primaryPink.withOpacity(0.3),\n              blurRadius: 8,\n              offset: const Offset(0, 2),\n            ),\n          ],\n        ),\n        padding: const EdgeInsets.all(2),\n        child: CircleAvatar(\n          radius: 28,\n          backgroundImage: avatarUrl != null ? NetworkImage(avatarUrl!) : null,\n          child: avatarUrl == null\n              ? const Icon(Icons.person, color: AppColors.primaryPink)\n              : null,\n        ),\n      ),\n    );\n  }\n}\n\n\n// Modern Tab Bar\nclass _ModernTabBar extends StatelessWidget implements PreferredSizeWidget {\n  const _ModernTabBar({required this.controller});\n\n  final TabController controller;\n\n  @override\n  Widget build(BuildContext context) {\n    return Container(\n      decoration: BoxDecoration(\n        gradient: LinearGradient(\n          colors: [\n            Colors.white,\n            AppColors.primaryPink.withOpacity(0.05),\n          ],\n          begin: Alignment.topCenter,\n          end: Alignment.bottomCenter,\n        ),\n      ),\n      child: TabBar(\n        controller: controller,\n        labelColor: AppColors.primaryPink,\n        unselectedLabelColor: Colors.grey,\n        indicatorColor: AppColors.primaryPink,\n        indicatorWeight: 3,\n        tabs: const [\n          Tab(text: 'Đang theo dõi'),\n          Tab(text: 'Người theo dõi'),\n          Tab(text: 'Yêu cầu đến'),\n          Tab(text: 'Yêu cầu đã gửi'),\n        ],\n      ),\n    );\n  }\n\n  @override\n  Size get preferredSize =&gt; const Size.fromHeight(48);\n}\n\n// Animated Search Button\nclass _AnimatedSearchButton extends StatefulWidget {\n  const _AnimatedSearchButton({required this.onPressed});\n\n  final VoidCallback onPressed;\n\n  @override\n  State&lt;_AnimatedSearchButton&gt; createState() =&gt; _AnimatedSearchButtonState();\n}\n\nclass _AnimatedSearchButtonState extends State&lt;_AnimatedSearchButton&gt;\n    with SingleTickerProviderStateMixin {\n  late AnimationController _controller;\n\n  @override\n  void initState() {\n    super.initState();\n    _controller = AnimationController(\n      vsync: this,\n      duration: const Duration(milliseconds: 200),\n    );\n  }\n\n  @override\n  void dispose() {\n    _controller.dispose();\n    super.dispose();\n  }\n\n  @override\n  Widget build(BuildContext context) {\n    return GestureDetector(\n      onTapDown: (_) =&gt; _controller.forward(),\n      onTapUp: (_) {\n        _controller.reverse();\n        widget.onPressed();\n      },\n      onTapCancel: () =&gt; _controller.reverse(),\n      child: ScaleTransition(\n        scale: Tween&lt;double&gt;(begin: 1.0, end: 0.9).animate(\n          CurvedAnimation(parent: _controller, curve: Curves.easeInOut),\n        ),\n        child: IconButton(\n          icon: const Icon(Icons.search, color: AppColors.primaryPink),\n          tooltip: 'Tìm kiếm người dùng',\n          onPressed: widget.onPressed,\n        ),\n      ),\n    );\n  }\n}\n\n// Modern Action Button\nclass _ModernActionButton extends StatefulWidget {\n  const _ModernActionButton({\n    required this.icon,\n    required this.tooltip,\n    required this.onPressed,\n  });\n\n  final IconData icon;\n  final String tooltip;\n  final VoidCallback onPressed;\n\n  @override\n  State&lt;_ModernActionButton&gt; createState() =&gt; _ModernActionButtonState();\n}\n\nclass _ModernActionButtonState extends State&lt;_ModernActionButton&gt;\n    with SingleTickerProviderStateMixin {\n  late AnimationController _controller;\n\n  @override\n  void initState() {\n    super.initState();\n    _controller = AnimationController(\n      vsync: this,\n      duration: const Duration(milliseconds: 150),\n    );\n  }\n\n  @override\n  void dispose() {\n    _controller.dispose();\n    super.dispose();\n  }\n\n  @override\n  Widget build(BuildContext context) {\n    return GestureDetector(\n      onTapDown: (_) {\n        _controller.forward();\n        HapticFeedback.lightImpact();\n      },\n      onTapUp: (_) {\n        _controller.reverse();\n        widget.onPressed();\n      },\n      onTapCancel: () =&gt; _controller.reverse(),\n      child: ScaleTransition(\n        scale: Tween&lt;double&gt;(begin: 1.0, end: 0.85).animate(\n          CurvedAnimation(parent: _controller, curve: Curves.easeInOut),\n        ),\n        child: IconButton(\n          icon: Icon(widget.icon, color: AppColors.primaryPink),\n          tooltip: widget.tooltip,\n          onPressed: widget.onPressed,\n        ),\n      ),\n    );\n  }\n}\n\n// Modern Text Button\nclass _ModernTextButton extends StatefulWidget {\n  const _ModernTextButton({\n    required this.label,\n    required this.onPressed,\n    this.isPrimary = false,\n  });\n\n  final String label;\n  final VoidCallback onPressed;\n  final bool isPrimary;\n\n  @override\n  State&lt;_ModernTextButton&gt; createState() =&gt; _ModernTextButtonState();\n}\n\nclass _ModernTextButtonState extends State&lt;_ModernTextButton&gt;\n    with SingleTickerProviderStateMixin {\n  late AnimationController _controller;\n\n  @override\n  void initState() {\n    super.initState();\n    _controller = AnimationController(\n      vsync: this,\n      duration: const Duration(milliseconds: 150),\n    );\n  }\n\n  @override\n  void dispose() {\n    _controller.dispose();\n    super.dispose();\n  }\n\n  @override\n  Widget build(BuildContext context) {\n    return GestureDetector(\n      onTapDown: (_) {\n        _controller.forward();\n        HapticFeedback.lightImpact();\n      },\n      onTapUp: (_) {\n        _controller.reverse();\n        widget.onPressed();\n      },\n      onTapCancel: () =&gt; _controller.reverse(),\n      child: ScaleTransition(\n        scale: Tween&lt;double&gt;(begin: 1.0, end: 0.95).animate(\n          CurvedAnimation(parent: _controller, curve: Curves.easeInOut),\n        ),\n        child: TextButton(\n          onPressed: widget.onPressed,\n          style: TextButton.styleFrom(\n            foregroundColor: widget.isPrimary\n                ? AppColors.primaryPink\n                : Colors.grey.shade700,\n            backgroundColor: widget.isPrimary\n                ? AppColors.primaryPink.withOpacity(0.1)\n                : null,\n          ),\n          child: Text(widget.label),\n        ),\n      ),\n    );\n  }\n}\n\n"
}
```
User decision: **accepted**

Status: **completed**


</details>
</tool-use>

---

<tool-use data-tool-type="generic" data-tool-name="read_lints">
<details>
          <summary>Tool use: **read_lints** • Read lints for 1 file</summary>
      
Lint paths:

- `lib/features/contacts/pages/contacts_page.dart`

Lint results

Lint errors for `lib/features/contacts/pages/contacts_page.dart`


| Message | Range | Severity |
|-------|-------|----------|
| "chưa": Unknown word. | 56:39-56:43 | DIAGNOSTIC_SEVERITY_HINT |
| "đăng": Unknown word. | 56:44-56:48 | DIAGNOSTIC_SEVERITY_HINT |
| "nhập": Unknown word. | 56:49-56:53 | DIAGNOSTIC_SEVERITY_HINT |
| "chưa": Unknown word. | 98:36-98:40 | DIAGNOSTIC_SEVERITY_HINT |
| "theo": Unknown word. | 98:41-98:45 | DIAGNOSTIC_SEVERITY_HINT |
| "Nhắn": Unknown word. | 102:33-102:37 | DIAGNOSTIC_SEVERITY_HINT |
| "trang": Unknown word. | 126:37-126:42 | DIAGNOSTIC_SEVERITY_HINT |
| "nhân": Unknown word. | 126:46-126:50 | DIAGNOSTIC_SEVERITY_HINT |
| "theo": Unknown word. | 136:34-136:38 | DIAGNOSTIC_SEVERITY_HINT |
| "Chưa": Unknown word. | 149:32-149:36 | DIAGNOSTIC_SEVERITY_HINT |
| "người": Unknown word. | 149:40-149:45 | DIAGNOSTIC_SEVERITY_HINT |
| "theo": Unknown word. | 149:46-149:50 | DIAGNOSTIC_SEVERITY_HINT |
| "Nhắn": Unknown word. | 153:33-153:37 | DIAGNOSTIC_SEVERITY_HINT |
| "trang": Unknown word. | 177:37-177:42 | DIAGNOSTIC_SEVERITY_HINT |
| "nhân": Unknown word. | 177:46-177:50 | DIAGNOSTIC_SEVERITY_HINT |
| "Theo": Unknown word. | 188:33-188:37 | DIAGNOSTIC_SEVERITY_HINT |
| "theo": Unknown word. | 199:36-199:40 | DIAGNOSTIC_SEVERITY_HINT |
| "Không": Unknown word. | 212:32-212:37 | DIAGNOSTIC_SEVERITY_HINT |
| "theo": Unknown word. | 212:49-212:53 | DIAGNOSTIC_SEVERITY_HINT |
| "Không": Unknown word. | 230:32-230:37 | DIAGNOSTIC_SEVERITY_HINT |
| "Chấp": Unknown word. | 308:25-308:29 | DIAGNOSTIC_SEVERITY_HINT |
| "nhận": Unknown word. | 308:30-308:34 | DIAGNOSTIC_SEVERITY_HINT |
| "chối": Unknown word. | 309:29-309:33 | DIAGNOSTIC_SEVERITY_HINT |
| "Thiếu": Unknown word. | 386:16-386:21 | DIAGNOSTIC_SEVERITY_HINT |
| "truy": Unknown word. | 386:42-386:46 | DIAGNOSTIC_SEVERITY_HINT |
| "Nhấn": Unknown word. | 392:16-392:20 | DIAGNOSTIC_SEVERITY_HINT |
| "liên": Unknown word. | 392:25-392:29 | DIAGNOSTIC_SEVERITY_HINT |
| "dưới": Unknown word. | 392:38-392:42 | DIAGNOSTIC_SEVERITY_HINT |
| "phút": Unknown word. | 393:24-393:28 | DIAGNOSTIC_SEVERITY_HINT |
| "trang": Unknown word. | 393:53-393:58 | DIAGNOSTIC_SEVERITY_HINT |
| "Đang": Unknown word. | 970:22-970:26 | DIAGNOSTIC_SEVERITY_HINT |
| "theo": Unknown word. | 970:27-970:31 | DIAGNOSTIC_SEVERITY_HINT |
| "Người": Unknown word. | 971:22-971:27 | DIAGNOSTIC_SEVERITY_HINT |
| "theo": Unknown word. | 971:28-971:32 | DIAGNOSTIC_SEVERITY_HINT |
| "kiếm": Unknown word. | 1027:25-1027:29 | DIAGNOSTIC_SEVERITY_HINT |
| "người": Unknown word. | 1027:30-1027:35 | DIAGNOSTIC_SEVERITY_HINT |
| "dùng": Unknown word. | 1027:36-1027:40 | DIAGNOSTIC_SEVERITY_HINT |


</details>
</tool-use>

---

### Thiết kế mới cho item ở trang **Kết nối**

Tôi đã chỉnh lại layout của mỗi user trong `_AnimatedFollowItem` để:

- **Tên hiển thị rõ ràng**: nằm trên 1 dòng hoặc tự xuống dòng đầy đủ, không bị cắt `Võ ...`.
- **Các chức năng (nhắn tin, xem trang cá nhân, bỏ theo dõi)** được **đưa xuống dưới tên**, gọn trong một hàng riêng.

Đoạn code quan trọng:

```666:736:lib/features/contacts/pages/contacts_page.dart
    return FadeTransition(
      opacity: _fadeAnimation,
      child: SlideTransition(
        position: _slideAnimation,
        child: ScaleTransition(
          scale: Tween<double>(begin: 0.97, end: 1.0).animate(
            CurvedAnimation(parent: _controller, curve: Curves.easeOutBack),
          ),
          child: Container(
            margin: const EdgeInsets.only(bottom: 12),
            child: Material(
              color: Colors.transparent,
              child: InkWell(
                onTap: () {
                  HapticFeedback.lightImpact();
                  Navigator.of(context).push(
                    MaterialPageRoute(
                      builder: (_) => PublicProfilePage(uid: widget.entry.uid),
                    ),
                  );
                },
                borderRadius: BorderRadius.circular(16),
                child: Card(
                  color: AppColors.primaryPink.withOpacity(0.04),
                  elevation: 0,
                  shape: RoundedRectangleBorder(
                    borderRadius: BorderRadius.circular(16),
                    side: BorderSide(
                      color: AppColors.primaryPink.withOpacity(0.15),
                      width: 1,
                    ),
                  ),
                  child: Padding(
                    padding: const EdgeInsets.symmetric(
                      horizontal: 12,
                      vertical: 10,
                    ),
                    child: Row(
                      crossAxisAlignment: CrossAxisAlignment.start,
                      children: [
                        _ModernAvatar(
                          avatarUrl: avatarUrl,
                          uid: widget.entry.uid,
                        ),
                        const SizedBox(width: 12),
                        Expanded(
                          child: Column(
                            crossAxisAlignment: CrossAxisAlignment.start,
                            mainAxisSize: MainAxisSize.min,
                            children: [
                              Hero(
                                tag: 'contact_title_${widget.entry.uid}',
                                child: Text(
                                  title,
                                  style: const TextStyle(
                                    fontSize: 16,
                                    fontWeight: FontWeight.w600,
                                  ),
                                  softWrap: true,
                                ),
                              ),
                              const SizedBox(height: 6),
                              Wrap(
                                spacing: 4,
                                runSpacing: 4,
                                children: widget.actionBuilder(widget.entry),
                              ),
                            ],
                          ),
                        ),
                      ],
                    ),
                  ),
                ),
              ),
            ),
          ),
        ),
      ),
    );
```

Bây giờ:

- Tên user sẽ hiển thị đầy đủ (tự xuống dòng nếu dài).
- Ngay bên dưới tên là hàng icon **nhắn tin**, **xem trang cá nhân**, và nút **Bỏ theo dõi**, nên bố cục gọn và rõ ràng hơn giống yêu cầu của bạn.

---

_**User (2025-12-22 08:54Z)**_

Tôi muốn bạn chỉnh sửa lại tại Trang thông báo, hiện tại nếu nhận thông báo thì thông báo đó sẽ hiện rõ tên của user, avartar và nội dung thông báo. Bắt đầu thực hiện cho tôi\

---

_**Agent (model claude-4.5-opus-high-thinking, mode Agent)**_



---



---

